I"9ß<h2 id="ä¸€recyclerviewä¸æ€§èƒ½">ä¸€ã€RecyclerViewä¸æ€§èƒ½</h2>

<p>ä½¿ç”¨ <strong>RecyclerView</strong> çš„éš¾åº¦å¯å¤§å¯å°ï¼Œè‹¥ä»…å±•ç¤ºå•ç±»å‹åˆ—è¡¨ï¼Œåªè¦ä¼˜åŒ–è§†å›¾ç»˜åˆ¶æ€§èƒ½ã€é™ä½å¸ƒå±€å¤æ‚åº¦ï¼Œå°±èƒ½ä¿è¯æ€§èƒ½ã€‚</p>

<p>è‹¥åˆ—è¡¨åˆ†ç±»å¤šã€æ ·å¼å·®å¼‚å¤§ï¼Œç±»ä¼¼å¾®ä¿¡èŠå¤©æ¶ˆæ¯ç•Œé¢ï¼Œé‡åˆ°é—®é¢˜çš„éš¾åº¦å°†å¤§å¹…å¢åŠ ã€‚éœ€è¦åœ¨é¢„åŠ è½½ã€å¤ç”¨ä¸Šåšè¿›ä¸€æ­¥è°ƒä¼˜ï¼Œå•çº¯å®ç° <strong>onCreateViewHolder()</strong> å’Œ <strong>onBindViewHolder()</strong> å¹¶ä¸èƒ½æ»¡è¶³éœ€æ±‚ã€‚æ€»çš„æ¥è¯´ï¼Œè¦ä»¥è¿½æ±‚è§†å›¾å‡ºç°åœ¨å±å¹•å‰è€—è´¹æœ€å°‘æ—¶é—´ä¸ºç›®æ ‡ã€‚</p>

<p><strong>RecyclerView</strong> ç¼“å­˜åˆ†ä¸º3çº§ï¼Œæ¯çº§æœ‰å„è‡ªçš„ç¼“å­˜æ•°é‡å’Œç­–ç•¥ã€‚</p>

<p><img src="/img/android/RecyclerView/RecyclerView_cache_level.png" alt="RecyclerView_cache_level" /></p>

<p>å½“æ‰€æœ‰ç¼“å­˜å±‚å‡æ²¡æœ‰æ‰€éœ€å®ä¾‹ï¼Œæœ€åç”± <strong>onCreateViewHolder()</strong> åˆ›å»ºå¹¶ç»‘å®šæ•°æ®ã€‚æºç ç‰ˆæœ¬ï¼šAndroid 27.1.1</p>

<h2 id="äºŒä¸€çº§ç¼“å­˜">äºŒã€ä¸€çº§ç¼“å­˜</h2>

<p>ä¸€çº§ç¼“å­˜åŒ…å«ä¸‰ä¸ªå®¹å™¨å®ä¾‹ï¼š<strong>mAttachedScrap</strong>ã€<strong>mChangedScrap</strong>ã€<strong>mCachedViews</strong>ã€‚æ ¹æ®ä¸åŒåœºæ™¯ <strong>ViewHolder</strong> ç¼“å­˜åˆ°ä¸åŒå®¹å™¨ã€‚</p>

<p><strong>mAttachedScrap</strong> ä¿å­˜ä¾é™„äº <strong>RecyclerView</strong> çš„ <strong>ViewHolder</strong>ã€‚åŒ…å«ç§»å‡ºå±å¹•ä½†æœªä» <strong>RecyclerView</strong> ç§»é™¤çš„ <strong>ViewHolder</strong>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">RecyclerView</span><span class="o">.</span><span class="na">ViewHolder</span><span class="o">&gt;</span> <span class="n">mAttachedScrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>mChangedScrap</strong> ä¿å­˜æ•°æ®å‘ç”Ÿæ”¹å˜çš„ <strong>ViewHolder</strong>ï¼Œå³è°ƒç”¨ <strong>notifyDataSetChanged()</strong> ç­‰ç³»åˆ—æ–¹æ³•åéœ€è¦æ›´æ–°çš„ <strong>ViewHolder</strong>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">RecyclerView</span><span class="o">.</span><span class="na">ViewHolder</span><span class="o">&gt;</span> <span class="n">mChangedScrap</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>mCachedViews</strong> ç”¨äºè§£å†³æ»‘åŠ¨æŠ–åŠ¨çš„é—®é¢˜ï¼Œé»˜è®¤å®¹é‡ä¸º2ï¼Œå¯æ ¹æ®éœ€è¦è°ƒä¼˜ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">RecyclerView</span><span class="o">.</span><span class="na">ViewHolder</span><span class="o">&gt;</span> <span class="n">mCachedViews</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸‰äºŒçº§ç¼“å­˜">ä¸‰ã€äºŒçº§ç¼“å­˜</h2>

<p>å¼€å‘è€…è‡ªå®šä¹‰çš„ç¼“å­˜ï¼Œéœ€å®ç° <strong>ViewCacheExtension</strong> æŠ½è±¡ç±»ã€‚è‹¥æ²¡æœ‰å®šä¹‰æ­¤ç¼“å­˜é»˜è®¤ä¸ºnullã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">RecyclerView</span><span class="o">.</span><span class="na">ViewCacheExtension</span> <span class="n">mViewCacheExtension</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å››ä¸‰çº§ç¼“å­˜">å››ã€ä¸‰çº§ç¼“å­˜</h2>

<p><strong>mCachedViews</strong> æ— æ³•ä¿å­˜å±å¹•ä¸Šæ‰€æœ‰ç§»é™¤çš„ <strong>ViewHolder</strong> æ—¶ï¼Œå‰©ä½™çš„ <strong>ViewHolder</strong> æ ¹æ® <strong>type</strong> åˆ†ç±»æ”¾å…¥ç¼“å­˜æ± ä¸­ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">RecyclerView</span><span class="o">.</span><span class="na">RecycledViewPool</span> <span class="n">mRecyclerPool</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="äº”recycler">äº”ã€Recycler</h2>

<h4 id="51-trygetviewholderforpositionbydeadline">5.1 tryGetViewHolderForPositionByDeadline()</h4>

<p>ä»¥ä¸‹æ˜¯ <strong>RecyclerView</strong> çš„å†…éƒ¨ç±» <strong>Recycler</strong> å»é™¤ç±»ç­¾åçš„æºç ã€‚<strong>Adapter</strong> åˆ©ç”¨positionè·å– <strong>ViewHolder</strong>ï¼šè‹¥ä¸€çº§ç¼“å­˜å‘½å¤±ã€<strong>mViewCacheExtension</strong> ä¸ºç©ºï¼Œåˆ™ä»ç¼“å­˜æ± æŸ¥æ‰¾å¯¹è±¡ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
</pre></td><td class="rouge-code"><pre><span class="nd">@Nullable</span>
<span class="nc">ViewHolder</span> <span class="nf">tryGetViewHolderForPositionByDeadline</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span>
        <span class="kt">boolean</span> <span class="n">dryRun</span><span class="o">,</span> <span class="kt">long</span> <span class="n">deadlineNs</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// è¶Šç•Œæ£€æŸ¥</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">position</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">position</span> <span class="o">&gt;=</span> <span class="n">mState</span><span class="o">.</span><span class="na">getItemCount</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="s">"Invalid item position "</span> <span class="o">+</span> <span class="n">position</span>
                <span class="o">+</span> <span class="s">"("</span> <span class="o">+</span> <span class="n">position</span> <span class="o">+</span> <span class="s">"). Item count:"</span> <span class="o">+</span> <span class="n">mState</span><span class="o">.</span><span class="na">getItemCount</span><span class="o">()</span>
                <span class="o">+</span> <span class="n">exceptionLabel</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="n">fromScrapOrHiddenOrCache</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">ViewHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="c1">// 0) ä»mChangedScrapè·å–ViewHolder</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mState</span><span class="o">.</span><span class="na">isPreLayout</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// ç”¨positionä½œä¸ºå‚æ•°</span>
        <span class="n">holder</span> <span class="o">=</span> <span class="n">getChangedScrapViewForPosition</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
        <span class="c1">// from scrap.</span>
        <span class="n">fromScrapOrHiddenOrCache</span> <span class="o">=</span> <span class="n">holder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 1) ç”¨positionä»scrapã€hidden listã€cacheä¸­è·å–</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">holder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ä»ç¬¬ä¸€çº§ç¼“å­˜ä¸­è·å–ï¼Œä»mAttachedScrapå’ŒmCachedViewsä¸­è·å–ViewHolder</span>
        <span class="n">holder</span> <span class="o">=</span> <span class="n">getScrapOrHiddenOrCachedHolderForPosition</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="n">dryRun</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">holder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">validateViewHolderForOffsetPosition</span><span class="o">(</span><span class="n">holder</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// recycle holder (and unscrap if relevant) since it can't be used</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">dryRun</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// we would like to recycle this but need to make sure it is not used by</span>
                    <span class="c1">// animation logic etc.</span>
                    <span class="n">holder</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="nc">ViewHolder</span><span class="o">.</span><span class="na">FLAG_INVALID</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">isScrap</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">removeDetachedView</span><span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">itemView</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                        <span class="n">holder</span><span class="o">.</span><span class="na">unScrap</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">wasReturnedFromScrap</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">holder</span><span class="o">.</span><span class="na">clearReturnedFromScrapFlag</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="n">recycleViewHolderInternal</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">holder</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">fromScrapOrHiddenOrCache</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="c1">// ç”¨posotionæŸ¥æ‰¾ç¼“å­˜å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨stable idsè·å–ç¼“å­˜</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">holder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">offsetPosition</span> <span class="o">=</span> <span class="n">mAdapterHelper</span><span class="o">.</span><span class="na">findPositionOffset</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">offsetPosition</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">offsetPosition</span> <span class="o">&gt;=</span> <span class="n">mAdapter</span><span class="o">.</span><span class="na">getItemCount</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="s">"Inconsistency detected. Invalid item "</span>
                    <span class="o">+</span> <span class="s">"position "</span> <span class="o">+</span> <span class="n">position</span> <span class="o">+</span> <span class="s">"(offset:"</span> <span class="o">+</span> <span class="n">offsetPosition</span> <span class="o">+</span> <span class="s">")."</span>
                    <span class="o">+</span> <span class="s">"state:"</span> <span class="o">+</span> <span class="n">mState</span><span class="o">.</span><span class="na">getItemCount</span><span class="o">()</span> <span class="o">+</span> <span class="n">exceptionLabel</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="c1">// ç”¨offsetPositionè·å–ViewType</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">mAdapter</span><span class="o">.</span><span class="na">getItemViewType</span><span class="o">(</span><span class="n">offsetPosition</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mAdapter</span><span class="o">.</span><span class="na">hasStableIds</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// 2) é€šè¿‡stable idså’Œtypeä»scrap/cacheæŸ¥æ‰¾</span>
            <span class="n">holder</span> <span class="o">=</span> <span class="n">getScrapOrCachedViewForId</span><span class="o">(</span><span class="n">mAdapter</span><span class="o">.</span><span class="na">getItemId</span><span class="o">(</span><span class="n">offsetPosition</span><span class="o">),</span>
                    <span class="n">type</span><span class="o">,</span> <span class="n">dryRun</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">holder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// æ›´æ–°position</span>
                <span class="n">holder</span><span class="o">.</span><span class="na">mPosition</span> <span class="o">=</span> <span class="n">offsetPosition</span><span class="o">;</span>
                <span class="n">fromScrapOrHiddenOrCache</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        
        <span class="c1">// ä»ç¬¬äºŒçº§ç¼“å­˜ViewCacheExtensionä¸­è·å–ç¼“å­˜å†…å®¹ï¼Œå³mViewCacheExtension</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">holder</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mViewCacheExtension</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// We are NOT sending the offsetPosition because LayoutManager does not</span>
            <span class="c1">// know it.</span>
            <span class="kd">final</span> <span class="nc">View</span> <span class="n">view</span> <span class="o">=</span> <span class="n">mViewCacheExtension</span>
                    <span class="o">.</span><span class="na">getViewForPositionAndType</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">position</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">view</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">holder</span> <span class="o">=</span> <span class="n">getChildViewHolder</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">holder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"getViewForPositionAndType returned"</span>
                            <span class="o">+</span> <span class="s">" a view which does not have a ViewHolder"</span>
                            <span class="o">+</span> <span class="n">exceptionLabel</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">shouldIgnore</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"getViewForPositionAndType returned"</span>
                            <span class="o">+</span> <span class="s">" a view that is ignored. You must call stopIgnoring before"</span>
                            <span class="o">+</span> <span class="s">" returning this view."</span> <span class="o">+</span> <span class="n">exceptionLabel</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        
        <span class="c1">// ä»ä¸‰çº§ç¼“å­˜RecycledViewPoolä¸­è·å–ç¼“å­˜å†…å®¹</span>
        <span class="c1">// ViewHolderå†…layoutå¯é‡ç”¨ï¼Œä½†æ˜¯æ•°æ®éœ€é‡æ–°ç»‘å®š</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">holder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// æ ¹æ®ç›®æ ‡ç±»å‹è·å–ViewHolder</span>
            <span class="n">holder</span> <span class="o">=</span> <span class="n">getRecycledViewPool</span><span class="o">().</span><span class="na">getRecycledView</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">holder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">holder</span><span class="o">.</span><span class="na">resetInternal</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="no">FORCE_INVALIDATE_DISPLAY_LIST</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">invalidateDisplayListInt</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        
        <span class="c1">// ä»æ‰€æœ‰ç¼“å­˜ä¸­å‡æ²¡æ³•è·å–å¯¹åº”æ•°æ®ï¼Œåªèƒ½é€šè¿‡Adapteræ„é€ æ–°çš„ViewHolder</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">holder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">getNanoTime</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">deadlineNs</span> <span class="o">!=</span> <span class="no">FOREVER_NS</span>
                    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mRecyclerPool</span><span class="o">.</span><span class="na">willCreateInTime</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">start</span><span class="o">,</span> <span class="n">deadlineNs</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// abort - we have a deadline we can't meet</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// è¿™é‡Œè°ƒç”¨ç»§æ‰¿Adapteråå®ç°çš„createViewHolderæ–¹æ³•</span>
            <span class="n">holder</span> <span class="o">=</span> <span class="n">mAdapter</span><span class="o">.</span><span class="na">createViewHolder</span><span class="o">(</span><span class="nc">RecyclerView</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="no">ALLOW_THREAD_GAP_WORK</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// only bother finding nested RV if prefetching</span>
                <span class="nc">RecyclerView</span> <span class="n">innerView</span> <span class="o">=</span> <span class="n">findNestedRecyclerView</span><span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">itemView</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">innerView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">holder</span><span class="o">.</span><span class="na">mNestedRecyclerView</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WeakReference</span><span class="o">&lt;&gt;(</span><span class="n">innerView</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">getNanoTime</span><span class="o">();</span>
            <span class="n">mRecyclerPool</span><span class="o">.</span><span class="na">factorInCreateTime</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// This is very ugly but the only place we can grab this information</span>
    <span class="c1">// before the View is rebound and returned to the LayoutManager for post layout ops.</span>
    <span class="c1">// We don't need this in pre-layout since the VH is not updated by the LM.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">fromScrapOrHiddenOrCache</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mState</span><span class="o">.</span><span class="na">isPreLayout</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">holder</span>
            <span class="o">.</span><span class="na">hasAnyOfTheFlags</span><span class="o">(</span><span class="nc">ViewHolder</span><span class="o">.</span><span class="na">FLAG_BOUNCED_FROM_HIDDEN_LIST</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">holder</span><span class="o">.</span><span class="na">setFlags</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nc">ViewHolder</span><span class="o">.</span><span class="na">FLAG_BOUNCED_FROM_HIDDEN_LIST</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mState</span><span class="o">.</span><span class="na">mRunSimpleAnimations</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">changeFlags</span> <span class="o">=</span> <span class="nc">ItemAnimator</span>
                    <span class="o">.</span><span class="na">buildAdapterChangeFlagsForAnimations</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
            <span class="n">changeFlags</span> <span class="o">|=</span> <span class="nc">ItemAnimator</span><span class="o">.</span><span class="na">FLAG_APPEARED_IN_PRE_LAYOUT</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">ItemHolderInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="n">mItemAnimator</span><span class="o">.</span><span class="na">recordPreLayoutInformation</span><span class="o">(</span><span class="n">mState</span><span class="o">,</span>
                    <span class="n">holder</span><span class="o">,</span> <span class="n">changeFlags</span><span class="o">,</span> <span class="n">holder</span><span class="o">.</span><span class="na">getUnmodifiedPayloads</span><span class="o">());</span>
            <span class="n">recordAnimationInfoIfBouncedHiddenView</span><span class="o">(</span><span class="n">holder</span><span class="o">,</span> <span class="n">info</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="n">bound</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mState</span><span class="o">.</span><span class="na">isPreLayout</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">holder</span><span class="o">.</span><span class="na">isBound</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// do not update unless we absolutely have to.</span>
        <span class="n">holder</span><span class="o">.</span><span class="na">mPreLayoutPosition</span> <span class="o">=</span> <span class="n">position</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">holder</span><span class="o">.</span><span class="na">isBound</span><span class="o">()</span> <span class="o">||</span> <span class="n">holder</span><span class="o">.</span><span class="na">needsUpdate</span><span class="o">()</span> <span class="o">||</span> <span class="n">holder</span><span class="o">.</span><span class="na">isInvalid</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG</span> <span class="o">&amp;&amp;</span> <span class="n">holder</span><span class="o">.</span><span class="na">isRemoved</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Removed holder should be bound and it should"</span>
                    <span class="o">+</span> <span class="s">" come here only in pre-layout. Holder: "</span> <span class="o">+</span> <span class="n">holder</span>
                    <span class="o">+</span> <span class="n">exceptionLabel</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">offsetPosition</span> <span class="o">=</span> <span class="n">mAdapterHelper</span><span class="o">.</span><span class="na">findPositionOffset</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
        <span class="c1">// ä»¥ä¸‹æ–¹æ³•è°ƒç”¨mAdapter.bindViewHolderæŠŠå†…å®¹ç»‘å®šåˆ°ViewHolder</span>
        <span class="n">bound</span> <span class="o">=</span> <span class="n">tryBindViewHolderByDeadline</span><span class="o">(</span><span class="n">holder</span><span class="o">,</span> <span class="n">offsetPosition</span><span class="o">,</span> <span class="n">position</span><span class="o">,</span> <span class="n">deadlineNs</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="nc">ViewGroup</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">lp</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">itemView</span><span class="o">.</span><span class="na">getLayoutParams</span><span class="o">();</span>
    <span class="kd">final</span> <span class="nc">LayoutParams</span> <span class="n">rvLayoutParams</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">lp</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">rvLayoutParams</span> <span class="o">=</span> <span class="o">(</span><span class="nc">LayoutParams</span><span class="o">)</span> <span class="n">generateDefaultLayoutParams</span><span class="o">();</span>
        <span class="n">holder</span><span class="o">.</span><span class="na">itemView</span><span class="o">.</span><span class="na">setLayoutParams</span><span class="o">(</span><span class="n">rvLayoutParams</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">checkLayoutParams</span><span class="o">(</span><span class="n">lp</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">rvLayoutParams</span> <span class="o">=</span> <span class="o">(</span><span class="nc">LayoutParams</span><span class="o">)</span> <span class="n">generateLayoutParams</span><span class="o">(</span><span class="n">lp</span><span class="o">);</span>
        <span class="n">holder</span><span class="o">.</span><span class="na">itemView</span><span class="o">.</span><span class="na">setLayoutParams</span><span class="o">(</span><span class="n">rvLayoutParams</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">rvLayoutParams</span> <span class="o">=</span> <span class="o">(</span><span class="nc">LayoutParams</span><span class="o">)</span> <span class="n">lp</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">rvLayoutParams</span><span class="o">.</span><span class="na">mViewHolder</span> <span class="o">=</span> <span class="n">holder</span><span class="o">;</span>
    <span class="n">rvLayoutParams</span><span class="o">.</span><span class="na">mPendingInvalidate</span> <span class="o">=</span> <span class="n">fromScrapOrHiddenOrCache</span> <span class="o">&amp;&amp;</span> <span class="n">bound</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">holder</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="52-getscraporhiddenorcachedholderforposition">5.2 getScrapOrHiddenOrCachedHolderForPosition()</h4>

<p>ä» <strong>attach scrap</strong>ã€<strong>hidden children</strong> æˆ– <strong>cache</strong> æ ¹æ® <strong>position</strong> è¿”å› <strong>ViewHolder</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="c1">// @param position æ¡ç›®ä½ç½®</span>
<span class="c1">// @param dryRun   ç©ºè½¬ï¼ŒåªæŸ¥æ‰¾ViewHolderè€Œä¸ç§»é™¤</span>
<span class="nc">ViewHolder</span> <span class="nf">getScrapOrHiddenOrCachedHolderForPosition</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">dryRun</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">scrapCount</span> <span class="o">=</span> <span class="n">mAttachedScrap</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>

    <span class="c1">// Try first for an exact, non-invalid match from scrap.</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">scrapCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ViewHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="n">mAttachedScrap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">holder</span><span class="o">.</span><span class="na">wasReturnedFromScrap</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">holder</span><span class="o">.</span><span class="na">getLayoutPosition</span><span class="o">()</span> <span class="o">==</span> <span class="n">position</span>
                <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">holder</span><span class="o">.</span><span class="na">isInvalid</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">mState</span><span class="o">.</span><span class="na">mInPreLayout</span> <span class="o">||</span> <span class="o">!</span><span class="n">holder</span><span class="o">.</span><span class="na">isRemoved</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">holder</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="nc">ViewHolder</span><span class="o">.</span><span class="na">FLAG_RETURNED_FROM_SCRAP</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">holder</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">dryRun</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">View</span> <span class="n">view</span> <span class="o">=</span> <span class="n">mChildHelper</span><span class="o">.</span><span class="na">findHiddenNonRemovedView</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">view</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// This View is good to be used. We just need to unhide, detach and move to the</span>
            <span class="c1">// scrap list.</span>
            <span class="kd">final</span> <span class="nc">ViewHolder</span> <span class="n">vh</span> <span class="o">=</span> <span class="n">getChildViewHolderInt</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
            <span class="n">mChildHelper</span><span class="o">.</span><span class="na">unhide</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">layoutIndex</span> <span class="o">=</span> <span class="n">mChildHelper</span><span class="o">.</span><span class="na">indexOfChild</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">layoutIndex</span> <span class="o">==</span> <span class="nc">RecyclerView</span><span class="o">.</span><span class="na">NO_POSITION</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"layout index should not be -1 after "</span>
                        <span class="o">+</span> <span class="s">"unhiding a view:"</span> <span class="o">+</span> <span class="n">vh</span> <span class="o">+</span> <span class="n">exceptionLabel</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="n">mChildHelper</span><span class="o">.</span><span class="na">detachViewFromParent</span><span class="o">(</span><span class="n">layoutIndex</span><span class="o">);</span>
            <span class="n">scrapView</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
            <span class="n">vh</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="nc">ViewHolder</span><span class="o">.</span><span class="na">FLAG_RETURNED_FROM_SCRAP</span>
                    <span class="o">|</span> <span class="nc">ViewHolder</span><span class="o">.</span><span class="na">FLAG_BOUNCED_FROM_HIDDEN_LIST</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">vh</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// ä»ä¸€çº§ç¼“å­˜æŸ¥æ‰¾å·²å›æ”¶çš„è§†å›¾ç¼“å­˜</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">cacheSize</span> <span class="o">=</span> <span class="n">mCachedViews</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cacheSize</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ViewHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="n">mCachedViews</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="c1">// invalid view holders may be in cache if adapter has stable ids as they can be</span>
        <span class="c1">// retrieved via getScrapOrCachedViewForId</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">holder</span><span class="o">.</span><span class="na">isInvalid</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">holder</span><span class="o">.</span><span class="na">getLayoutPosition</span><span class="o">()</span> <span class="o">==</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">dryRun</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mCachedViews</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">holder</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="53-trybindviewholderbydeadline">5.3 tryBindViewHolderByDeadline()</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">tryBindViewHolderByDeadline</span><span class="o">(</span><span class="nc">ViewHolder</span> <span class="n">holder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offsetPosition</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">long</span> <span class="n">deadlineNs</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// è®¾ç½®holderçš„RecyclerView</span>
    <span class="n">holder</span><span class="o">.</span><span class="na">mOwnerRecyclerView</span> <span class="o">=</span> <span class="nc">RecyclerView</span><span class="o">.</span><span class="na">this</span><span class="o">;</span>
    <span class="c1">// holderçš„viewType</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">viewType</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getItemViewType</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">startBindNs</span> <span class="o">=</span> <span class="n">getNanoTime</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">deadlineNs</span> <span class="o">!=</span> <span class="no">FOREVER_NS</span>
            <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mRecyclerPool</span><span class="o">.</span><span class="na">willBindInTime</span><span class="o">(</span><span class="n">viewType</span><span class="o">,</span> <span class="n">startBindNs</span><span class="o">,</span> <span class="n">deadlineNs</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// abort - we have a deadline we can't meet</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// ç»‘å®šè§†å›¾æ•°æ®</span>
    <span class="n">mAdapter</span><span class="o">.</span><span class="na">bindViewHolder</span><span class="o">(</span><span class="n">holder</span><span class="o">,</span> <span class="n">offsetPosition</span><span class="o">);</span>
    <span class="kt">long</span> <span class="n">endBindNs</span> <span class="o">=</span> <span class="n">getNanoTime</span><span class="o">();</span>
    <span class="n">mRecyclerPool</span><span class="o">.</span><span class="na">factorInBindTime</span><span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">getItemViewType</span><span class="o">(),</span> <span class="n">endBindNs</span> <span class="o">-</span> <span class="n">startBindNs</span><span class="o">);</span>
    <span class="n">attachAccessibilityDelegateOnBind</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mState</span><span class="o">.</span><span class="na">isPreLayout</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">holder</span><span class="o">.</span><span class="na">mPreLayoutPosition</span> <span class="o">=</span> <span class="n">position</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å…­recycledviewpool">å…­ã€RecycledViewPool</h2>

<p>è‹¥è¦æŠŠ <strong>RecycledViewPool</strong> åœ¨å¤šä¸ª <strong>RecyclerViews</strong> é—´å…±äº«ï¼Œåªéœ€ä¸»åŠ¨åˆ›å»ºè¯¥å®ä¾‹ï¼Œé€šè¿‡ <strong>RecyclerView.setRecycledViewPool(RecycledViewPool)</strong> ç»‘å®šåˆ° <strong>RecyclerView</strong> ä¸Šã€‚å¦‚æœæ²¡æœ‰ç»™ <strong>RecyclerView</strong> æŒ‡å®šä»»ä½• <strong>RecycledViewPool</strong>ï¼Œåˆ™ä¼šè‡ªè¡Œåˆ›å»ºè¯¥å®ä¾‹ã€‚</p>

<p>æ¯ä¸ª <strong>type</strong> é»˜è®¤ç¼“å­˜5ä¸ª <strong>ViewHolder</strong>ï¼Œå¯é’ˆå¯¹ä¸åŒ <strong>type</strong> ä¿®æ”¹éœ€ç¼“å­˜æ•°é‡ã€‚ä¾‹å¦‚ï¼šå¢åŠ æ˜¾ç¤ºé¢ç§¯è¾ƒå° <strong>ViewHolder</strong> ç¼“å­˜çš„æ•°é‡ï¼Œä¿è¯ç¼“å­˜å¯¹è±¡è¶³å¤Ÿå¡«æ»¡å±å¹•åˆæ— éœ€åˆ›å»ºæ–°å¯¹è±¡ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_MAX_SCRAP</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>ScrapData</strong> æ˜¯ <strong>RecycledViewPool</strong> çš„å†…éƒ¨ç±»</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">class</span> <span class="nc">ScrapData</span> <span class="o">{</span>
    <span class="c1">// ä¿å­˜ViewHolderçš„åˆ—è¡¨</span>
    <span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ViewHolder</span><span class="o">&gt;</span> <span class="n">mScrapHeap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="c1">// æœ¬ç±»å‹æœ€å¤šå¯ä¿ç•™å¤šå°‘ViewHolder</span>
    <span class="kt">int</span> <span class="n">mMaxScrap</span> <span class="o">=</span> <span class="no">DEFAULT_MAX_SCRAP</span><span class="o">;</span>
    <span class="c1">// è®°å½•åˆ›å»ºè§†å›¾çš„å¹³å‡æ—¶é•¿</span>
    <span class="kt">long</span> <span class="n">mCreateRunningAverageNs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="c1">// è®°å½•è§†å›¾ç»‘å®šçš„å¹³å‡æ—¶é•¿</span>
    <span class="kt">long</span> <span class="n">mBindRunningAverageNs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ ¹æ®åˆ†ç±»ç¼“å­˜ <strong>ScrapData</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">SparseArray</span><span class="o">&lt;</span><span class="nc">ScrapData</span><span class="o">&gt;</span> <span class="n">mScrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SparseArray</span><span class="o">&lt;&gt;();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è°ƒæ•´æŒ‡å®š <strong>viewType</strong> è§†å›¾ç¼“å­˜çš„æœ€å¤§å€¼</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMaxRecycledViews</span><span class="o">(</span><span class="kt">int</span> <span class="n">viewType</span><span class="o">,</span> <span class="kt">int</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ScrapData</span> <span class="n">scrapData</span> <span class="o">=</span> <span class="n">getScrapDataForType</span><span class="o">(</span><span class="n">viewType</span><span class="o">);</span>
    <span class="c1">// ä¿®æ”¹mMaxScrapçš„å€¼</span>
    <span class="n">scrapData</span><span class="o">.</span><span class="na">mMaxScrap</span> <span class="o">=</span> <span class="n">max</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ViewHolder</span><span class="o">&gt;</span> <span class="n">scrapHeap</span> <span class="o">=</span> <span class="n">scrapData</span><span class="o">.</span><span class="na">mScrapHeap</span><span class="o">;</span>
    <span class="c1">// è£å‰ªå¤šä½™ç¼“å­˜å®ä¾‹</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">scrapHeap</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">scrapHeap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">scrapHeap</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¾‹å¦‚ï¼šä¸‹å›¾æ ·å¼çš„ <strong>ViewHolder</strong> ä»…ç¼“å­˜5ä¸ªï¼Œå¤šä½™è§†å›¾ç§»å‡ºå±å¹•åä¼šé”€æ¯ã€‚ä¸‹æ¬¡éœ€è¦è¯¥ <strong>ViewHolder</strong> åˆè¦é‡æ–°æ„å»ºï¼Œæ‰€ä»¥æé«˜ç¼“å­˜æ•°é‡å¯å‡å°‘è¿™ç§æƒ…å†µå‘ç”Ÿæ¬¡æ•°ã€‚</p>

<p><img src="/img/android/RecyclerView/RecyclerView_demo_30.png" alt="RecyclerView_demo" /></p>

<p>æ ¹æ® <strong>viewType</strong> ä»ç¼“å­˜æ± è·å– <strong>ScrapData</strong>ï¼Œå†ä» <strong>ScrapData</strong> å–å‡ºæœ‰æ•ˆ <strong>ViewHolder</strong>ã€‚å¦‚æœç¼“å­˜æ± å†…æ²¡æœ‰ç¼“å­˜è¯¥å®ä¾‹åˆ™è¿”å›nullã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="nd">@Nullable</span>
<span class="kd">public</span> <span class="nc">ViewHolder</span> <span class="nf">getRecycledView</span><span class="o">(</span><span class="kt">int</span> <span class="n">viewType</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">ScrapData</span> <span class="n">scrapData</span> <span class="o">=</span> <span class="n">mScrap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">viewType</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">scrapData</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">scrapData</span><span class="o">.</span><span class="na">mScrapHeap</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ViewHolder</span><span class="o">&gt;</span> <span class="n">scrapHeap</span> <span class="o">=</span> <span class="n">scrapData</span><span class="o">.</span><span class="na">mScrapHeap</span><span class="o">;</span>
        <span class="c1">// ä»åˆ—è¡¨å–å‡ºä¸€ä¸ªViewHolder</span>
        <span class="k">return</span> <span class="n">scrapHeap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">scrapHeap</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯»å– <strong>ViewHolder</strong> çš„ <strong>viewType</strong> å¹¶æ‰¾åˆ°å¯¹åº” <strong>scrapHeap</strong> åˆ—è¡¨ï¼ŒæŠŠ <strong>ViewHolder</strong> ç¼“å­˜åˆ°è¯¥åˆ—è¡¨</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">putRecycledView</span><span class="o">(</span><span class="nc">ViewHolder</span> <span class="n">scrap</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">viewType</span> <span class="o">=</span> <span class="n">scrap</span><span class="o">.</span><span class="na">getItemViewType</span><span class="o">();</span>
    <span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ViewHolder</span><span class="o">&gt;</span> <span class="n">scrapHeap</span> <span class="o">=</span> <span class="n">getScrapDataForType</span><span class="o">(</span><span class="n">viewType</span><span class="o">).</span><span class="na">mScrapHeap</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mScrap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">viewType</span><span class="o">).</span><span class="na">mMaxScrap</span> <span class="o">&lt;=</span> <span class="n">scrapHeap</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">scrap</span><span class="o">.</span><span class="na">resetInternal</span><span class="o">();</span>
    <span class="n">scrapHeap</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">scrap</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ ¹æ® <strong>viewType</strong> è·å– <strong>ScrapData</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">ScrapData</span> <span class="nf">getScrapDataForType</span><span class="o">(</span><span class="kt">int</span> <span class="n">viewType</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ScrapData</span> <span class="n">scrapData</span> <span class="o">=</span> <span class="n">mScrap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">viewType</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">scrapData</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">scrapData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ScrapData</span><span class="o">();</span>
        <span class="n">mScrap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">viewType</span><span class="o">,</span> <span class="n">scrapData</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">scrapData</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸ƒå‚è€ƒé“¾æ¥">ä¸ƒã€å‚è€ƒé“¾æ¥</h2>

<ul>
  <li><a href="https://juejin.im/post/5b79a0b851882542b13d204b">RecyclerViewç¼“å­˜åŸç†ï¼Œæœ‰å›¾æœ‰çœŸç›¸</a></li>
</ul>
:ET