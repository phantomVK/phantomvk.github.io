I"аб<h2 id="дёЂз±»з­ѕеђЌ">дёЂгЂЃз±»з­ѕеђЌ</h2>

<p>д»Ћз±»еђЌеЏЇзџҐпјЊLinkedBlockingQueueжЇеџєдєЋй“ѕиЎЁе®ћзЋ°зљ„й»еЎћйџе€—гЂ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">AbstractQueue</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span>
        <span class="kd">implements</span> <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;,</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>з±»з‰№з‚№пјљ</p>

<ul>
  <li>еџєдєЋй“ѕиЎЁе®ћзЋ°зљ„й»еЎћйџе€—пјЊзєїзЁ‹е®‰е…Ёпј›</li>
  <li>йџе¤ґе…ѓзґ жЇе­жґ»ж—¶й—ґжњЂй•їзљ„е…ѓзґ пјЊйџе°ѕе…ѓзґ жЇе­жґ»ж—¶й—ґжњЂзџ­зљ„е…ѓзґ пј›</li>
  <li>е…ѓзґ д»Ћйџе€—е°ѕиї›йџпјЊд»Ћйџе€—е¤ґе‡єйџпјЊз¬¦еђ€FIFOпј›</li>
  <li>й“ѕиЎЁе®ћзЋ°зљ„йџе€—жЇ”еџєдєЋж•°з»„е®ћзЋ°жњ‰ж›ґй«еђћеђђй‡ЏпјЊдЅ†жЇ”е¤§е¤љж•°е№¶еЏ‘еє”з”Ёзљ„зђ†жѓіжЂ§иѓЅдЅЋпј›</li>
  <li>й»и®¤йџе€—жњЂе¤§й•їеє¦дёєInteger.MAX_VALUEпјЊж–°иЉ‚з‚№еЉЁжЂЃе€›е»єпјЊжЂ»иЉ‚з‚№дёЌдјљи¶…иї‡ж­¤еЂјпј›</li>
  <li>ж­¤з±»е’Ње…¶иї­д»Је™Ёеќ‡е®ћзЋ°дє†<code class="highlighter-rouge">Collection</code>е’Њ<code class="highlighter-rouge">Iterator</code>жЋҐеЏЈзљ„еЏЇйЂ‰ж–№жі•пј›</li>
</ul>

<p>иї™жЇ<code class="highlighter-rouge">two lock queue</code>з®—жі•зљ„еЏдЅ“гЂ‚putLockе®€еЌ«е…ѓзґ зљ„putгЂЃofferж“ЌдЅњпјЊдё”дёЋз­‰еѕ…е­е…Ґзљ„жќЎд»¶е…іиЃ”гЂ‚takeLockеЋџзђ†з±»дјјгЂ‚putLockе’ЊtakeLockйѓЅдѕќиµ–еЋџе­ђеЏй‡Џ<code class="highlighter-rouge">count</code>пјЊйЃїе…Ќе¤љж•°жѓ…е†µдё‹йњЂеђЊж—¶иЇ·ж±‚дё¤дёЄй”ЃгЂ‚</p>

<p>дёєдє†жњЂе°ЏеЊ–putж—¶йњЂиЋ·еЏ–takeLockпјЊдЅїз”Ёдє†е±‚еЏ ејЏйЂљзџҐгЂ‚еЅ“putж“ЌдЅњжіЁж„Џе€°и‡іе°‘дёЂдёЄtakeеЏЇд»ҐеђЇеЉЁпјЊе°±дјљйЂљзџҐtakerгЂ‚е¦‚жћњжњ‰ж›ґе¤љitemењЁдїЎеЏ·еђЋиї›йџпјЊtakerе°†дѕќж¬ЎйЂљзџҐе…¶д»–takerгЂ‚е› ж­¤жњ‰еЇ№з§°зљ„еЏ–ж“ЌдЅњйЂљзџҐе­ж“ЌдЅњгЂ‚жњ‰дє›ж“ЌдЅње¦‚removeе’ЊiteratorsдјљеђЊж—¶иЇ·ж±‚дё¤дёЄй”ЃгЂ‚</p>

<p>иЇ»еЏ–иЂ…е’Ње†™е…ҐиЂ…й—ґеЏЇи§ЃжЂ§е¦‚дё‹жЏђдѕ›пјљ</p>

<p>еЅ“е…ѓзґ е·Іиї›е…Ґйџе€—пјЊputLockе·Іиў«иЋ·еЏ–дё”countеЏй‡Џж›ґж–°гЂ‚йљЏеђЋпјЊиЇ»еЏ–иЂ…йЂљиї‡иЋ·еЏ–putLockж€–иЋ·еЏ–takeLockпјЊеѕ—е€°е…Ґйџе…ѓзґ зљ„еЏЇи§ЃжЂ§пјЊз„¶еђЋиЇ»еЏ–<code class="highlighter-rouge">n = count.get();</code>д»¤е‰ЌnдёЄе…ѓзґ еЏеѕ—еЏЇи§ЃгЂ‚</p>

<p>дёєе®ћзЋ°еј±дёЂи‡ґжЂ§иї­д»Је™ЁпјЊжѕз„¶и¦Ѓд»Ће‰ЌеЇје‡єйџиЉ‚з‚№дёЉдїќжЊЃж‰Ђжњ‰иЉ‚з‚№зљ„GCеЏЇиѕѕжЂ§гЂ‚иї™дјљеј•иµ·дё¤дёЄй—®йўпјљ</p>

<ol>
  <li>е…Ѓи®ёдёЂдёЄеј‚еёёзљ„иї­д»Је™Ёи§¦еЏ‘ж— й™ђе€¶зљ„е†…е­дїќз•™пј›</li>
  <li>е¦‚жћњиЉ‚з‚№ењЁиЂЃе№ґд»Је­жґ»пјЊдјљеј•иµ·иЂЃиЉ‚з‚№е’Њж–°иЉ‚з‚№й—ґзљ„и·Ёд»ЈиїћжЋҐпјЊд»¤е€†д»Јећѓењѕе›ћж”¶йљѕд»Ґиї›иЎЊпјЊеЇји‡ґй‡Ќе¤ЌиЂЃе№ґд»Је›ћж”¶(major collections)пј›</li>
</ol>

<p>з„¶иЂЊпјЊеЏЄжњ‰жњЄе€ й™¤иЉ‚з‚№йњЂи¦Ѓд»Ће·Іе‡єйџиЉ‚з‚№еЏЇиѕѕпјЊGCдёЌйњЂи¦Ѓзђ†и§ЈеЏЇиѕѕжЂ§зљ„з±»ећ‹гЂ‚ж€‘д»¬дЅїз”ЁдёЂдє›е°Џж‰‹ж®µиїћжЋҐдёЂдёЄе€ље€љиў«е‡єйџзљ„иЉ‚з‚№гЂ‚</p>

<p>жєђз ЃжќҐи‡ЄJDK10гЂ‚</p>

<h2 id="дєЊиЉ‚з‚№">дєЊгЂЃиЉ‚з‚№</h2>

<p>еЌ•еђ‘й“ѕиЎЁиЉ‚з‚№з±»пјЊжџҐж‰ѕе…ѓзґ йњЂи¦Ѓд»Ћй“ѕиЎЁе¤ґејЂе§‹дѕќж¬ЎйЃЌеЋ†иЉ‚з‚№</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">class</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="no">E</span> <span class="n">item</span><span class="o">;</span> <span class="c1">// иЉ‚з‚№ж•°жЌ®</span>

    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span> <span class="c1">// дё‹дёЂиЉ‚з‚№</span>

    <span class="nc">Node</span><span class="o">(</span><span class="no">E</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span> <span class="n">item</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span> <span class="o">}</span> <span class="c1">// жћ„йЂ ж–№жі•пјЊе­е…ҐиЉ‚з‚№зљ„е†…е®№</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="дё‰ж•°жЌ®ж€ђе‘">дё‰гЂЃж•°жЌ®ж€ђе‘</h2>

<p>йџе€—е®№й‡ЏпјЊй»и®¤дёєInteger.MAX_VALUE</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">capacity</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>е·Іе­е…ѓзґ жЂ»ж•°</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">count</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>й“ѕиЎЁе¤ґиЉ‚з‚№</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">transient</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">head</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>й“ѕиЎЁе°ѕиЉ‚з‚№</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">transient</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">last</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="е››й”Ѓж€ђе‘">е››гЂЃй”Ѓж€ђе‘</h2>

<p>ж­¤й”Ѓиў«takeпјЊpollз­‰ж“ЌдЅњжЊЃжњ‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">takeLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>takesзљ„з­‰еѕ…йџе€—</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="nc">Condition</span> <span class="n">notEmpty</span> <span class="o">=</span> <span class="n">takeLock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ж­¤й”Ѓиў«putпјЊofferз­‰жЊЃжњ‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">putLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>putsзљ„з­‰еѕ…йџе€—</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="nc">Condition</span> <span class="n">notFull</span> <span class="o">=</span> <span class="n">putLock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="дє”й”Ѓж“ЌдЅњ">дє”гЂЃй”Ѓж“ЌдЅњ</h2>

<p>е”¤й†’notEmptyйџе€—дёЉж­ЈењЁз­‰еѕ…иЋ·еЏ–е…ѓзґ зљ„зєїзЁ‹пјЊж­¤ж–№жі•з”±put/offerи°ѓз”ЁгЂ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">signalNotEmpty</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">takeLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">takeLock</span><span class="o">;</span>
    <span class="n">takeLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">notEmpty</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">takeLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>е”¤й†’notFullйџе€—дёЉж­ЈењЁз­‰еѕ…е­е…Ґе…ѓзґ зљ„зєїзЁ‹пјЊж­¤ж–№жі•з”±take/pollи°ѓз”ЁгЂ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">signalNotFull</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">putLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">putLock</span><span class="o">;</span>
    <span class="n">putLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">notFull</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">putLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="е…­иї›йџе‡єйџ">е…­гЂЃиї›йџе‡єйџ</h2>

<p>е…ѓзґ йџе°ѕиї›йџ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">enqueue</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// assert putLock.isHeldByCurrentThread();</span>
    <span class="c1">// assert last.next == null;</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>йџе¤ґе…ѓзґ е‡єйџ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="no">E</span> <span class="nf">dequeue</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// assert takeLock.isHeldByCurrentThread();</span>
    <span class="c1">// assert head.item == null;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">first</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
    <span class="n">h</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">h</span><span class="o">;</span> <span class="c1">// её®еЉ©GC</span>
    <span class="n">head</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
    <span class="no">E</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
    <span class="n">first</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="дёѓиЇ»е†™й”Ѓж“ЌдЅњ">дёѓгЂЃиЇ»е†™й”Ѓж“ЌдЅњ</h2>

<p>дёЉй”Ѓз¦Ѓж­ўе­еЏ–ж“ЌдЅњ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">fullyLock</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">putLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="n">takeLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>и§Јй”Ѓе…Ѓи®ёе­еЏ–ж“ЌдЅњ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">fullyUnlock</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">takeLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="n">putLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="е…«жћ„йЂ ж–№жі•">е…«гЂЃжћ„йЂ ж–№жі•</h2>

<p>й»и®¤жћ„йЂ ж–№жі•пјЊжњЂе¤§е®№й‡ЏдёєInteger.MAX_VALUE</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nf">LinkedBlockingQueue</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>дЅїз”ЁжЊ‡е®љcapacityе№¶е€ќе§‹еЊ–е¤ґз»“з‚№еј•з”Ёе’Ње°ѕиЉ‚з‚№еј•з”Ё</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nf">LinkedBlockingQueue</span><span class="o">(</span><span class="kt">int</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">capacity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">();</span>
    <span class="c1">// и‡Єе®љд№‰йџе€—capacity</span>
    <span class="k">this</span><span class="o">.</span><span class="na">capacity</span> <span class="o">=</span> <span class="n">capacity</span><span class="o">;</span>
    <span class="c1">// е¤ґжЊ‡й’€е’Ње°ѕжЊ‡й’€жЊ‡еђ‘еђЊдёЂдёЄз©єиЉ‚з‚№</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">head</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;(</span><span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>йЂљиї‡й›†еђ€е®ћдѕ‹е€ќе§‹еЊ–з±»пјЊжњЂе¤§е®№й‡ЏдёєInteger.MAX_VALUE</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nf">LinkedBlockingQueue</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// capacityи®ѕзЅ®дёєInteger.MAX_VALUE</span>
    <span class="k">this</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">putLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">putLock</span><span class="o">;</span>
    <span class="c1">// жІЎжњ‰з«ћдє‰пјЊдЅ†еЇ№еЏЇи§ЃжЂ§жќҐиЇґжњ‰еї…и¦Ѓ</span>
    <span class="n">putLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="c1">// дѕќж¬ЎйЃЌеЋ†й›†еђ€c</span>
        <span class="k">for</span> <span class="o">(</span><span class="no">E</span> <span class="n">e</span> <span class="o">:</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// й›†еђ€е…ѓзґ дёєз©єжЉ›е‡єNullPointerException</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
            
            <span class="c1">// йџе€—е·Іж»Ў</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Queue full"</span><span class="o">);</span>

            <span class="n">enqueue</span><span class="o">(</span><span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;(</span><span class="n">e</span><span class="o">));</span> <span class="c1">// ењЁй›†еђ€cдё­еЏ–е…ѓзґ е€›е»єиЉ‚з‚№е­е…Ґйџе€—</span>
            <span class="o">++</span><span class="n">n</span><span class="o">;</span> <span class="c1">// ж·»еЉ е…ѓзґ йЂ’еўћ</span>
        <span class="o">}</span>
        <span class="c1">// жњЂеђЋжЉЉжЂ»ж·»еЉ е…ѓзґ ж›ґж–°и‡іеЋџе­ђеЂјcount</span>
        <span class="n">count</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">putLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="д№ќж€ђе‘ж–№жі•">д№ќгЂЃж€ђе‘ж–№жі•</h2>

<p>йџе€—е·Іжњ‰е…ѓзґ ж•°й‡Џ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>е‰©дЅ™йџе€—е®№й‡Џ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">int</span> <span class="nf">remainingCapacity</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">capacity</span> <span class="o">-</span> <span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>жЏ’е…Ґе€°йџе€—е°ѕйѓЁпјЊз›ґе€°ж€ђеЉџжЏ’е…Ґж‰Ќиї”е›ћж€ђеЉџ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="c1">// е­е…Ґе…ѓзґ дёЌиѓЅдёєз©є</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
    <span class="c1">// Note: convention in all put/take/etc is to preset local var</span>
    <span class="c1">// holding count negative to indicate failure unless set.</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;(</span><span class="n">e</span><span class="o">);</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">putLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">putLock</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">count</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
    <span class="c1">// ж­¤й”ЃеЏЇд»Ґиў«дё­ж–­</span>
    <span class="n">putLock</span><span class="o">.</span><span class="na">lockInterruptibly</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// йџе€—е·Іж»Ўе€™з­‰еѕ…з›ґе€°е‡єзЋ°з©єдЅ™</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">notFull</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">// е…ѓзґ жЏ’е…Ґе€°йџе€—е°ѕйѓЁ</span>
        <span class="n">enqueue</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
        <span class="c1">// е·Ідїќе­е…ѓзґ ж•°й‡ЏйЂ’еўћ</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
        <span class="c1">// жЈЂжџҐйџе€—жЇеђ¦е·Іж»Ў</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">capacity</span><span class="o">)</span>
            <span class="c1">// йЂљзџҐе…¶д»–зєїзЁ‹з»§з»­жЏ’е…Ґе…ѓзґ </span>
            <span class="n">notFull</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="c1">// и§Јй™¤й”Ѓ</span>
        <span class="n">putLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// йџе€—еЋџжќҐжЇз©єзљ„пјЊж·»еЉ ж–°е…ѓзґ еђЋдёЌдёєз©єпјЊйЂљзџҐзєїзЁ‹еЏ–е‡єе…ѓзґ </span>
    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="n">signalNotEmpty</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ењЁйџе€—е°ѕйѓЁжЏ’е…ҐжЊ‡е®ље…ѓзґ пјЊе¦‚жћњењЁжЊ‡е®љи¶…ж—¶ж—¶й—ґе†…жЏ’е…Ґж€ђеЉџиї”е›ћtrueпјЊеђ¦е€™иї”е›ћfalse</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">offer</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="c1">// eдёєз©єжЉ›е‡єNullPointerException</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
    <span class="c1">// ж №жЌ®и¶…ж—¶еЂје’Њж—¶й—ґеЌ•дЅЌиЅ¬жЌўдёєзєіз§’ж—¶й•ї</span>
    <span class="kt">long</span> <span class="n">nanos</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="c1">// иЋ·еЏ–putLock</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">putLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">putLock</span><span class="o">;</span>
    <span class="c1">// иЋ·еЏ–е·Іжњ‰е…ѓзґ жЂ»ж•°</span>
    <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">count</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
    <span class="c1">// й”ЃputLockи®ѕзЅ®дёєеЏЇдё­ж–­</span>
    <span class="n">putLock</span><span class="o">.</span><span class="na">lockInterruptibly</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// йџе€—е·Іж»Ўе€™еЋџењ°з­‰еѕ…з›ґе€°йџе€—е‡єзЋ°з©єдЅ™</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">nanos</span> <span class="o">&lt;=</span> <span class="mi">0L</span><span class="o">)</span>
                <span class="c1">// е€°иѕѕи¶…ж—¶ж—¶й—ґпјЊйЂЂе‡єж–№жі•е№¶иї”е›ћfalse</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="c1">// ж—¶й—ґеЂ’и®Ўж—¶</span>
            <span class="n">nanos</span> <span class="o">=</span> <span class="n">notFull</span><span class="o">.</span><span class="na">awaitNanos</span><span class="o">(</span><span class="n">nanos</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// е…ѓзґ иї›е…Ґйџе€—</span>
        <span class="n">enqueue</span><span class="o">(</span><span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;(</span><span class="n">e</span><span class="o">));</span>
        <span class="c1">// йџе€—е…ѓзґ жЂ»ж•°йЂ’еўћ</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">capacity</span><span class="o">)</span>
            <span class="c1">// е”¤й†’е…¶д»–е†™е…ҐзєїзЁ‹</span>
            <span class="n">notFull</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">putLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// йџе€—еЋџжќҐжЇз©єзљ„пјЊж·»еЉ ж–°е…ѓзґ еђЋдёЌдёєз©єпјЊйЂљзџҐзєїзЁ‹еЏ–е‡єе…ѓзґ </span>
    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="n">signalNotEmpty</span><span class="o">();</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>жЉЉжЊ‡е®ље…ѓзґ жЏ’е…Ґе€°йџе°ѕпјЊе¦‚жћњжЏ’е…Ґж€ђеЉџиї”е›ћtrueпјЊйџе€—е·Іж»ЎжЏ’е…Ґе¤±иґҐиї”е›ћfalseгЂ‚еЅ“дЅїз”Ёжњ‰е®№й‡Џй™ђе€¶зљ„йџе€—ж—¶пјЊиї™дёЄж–№жі•жЇ”addж–№жі•ж›ґеҐЅпјЊе› дёєaddе…ѓзґ ж·»еЉ е¤±иґҐдјљжЉ›е‡єеј‚еёёгЂ‚е­е…Ґе…ѓзґ eдёєз©єж—¶жЉ›е‡єNullPointerExceptionгЂ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">offer</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// е­е…Ґе…ѓзґ дёЌиѓЅдёєnull</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
    <span class="c1">// иЋ·еЏ–йџе€—е…ѓзґ жЂ»ж•°</span>
    <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">count</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
    <span class="c1">// йџе€—е·Іж»ЎпјЊйЂЂе‡є</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="c1">// е€›е»єж–°иЉ‚з‚№</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;(</span><span class="n">e</span><span class="o">);</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">putLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">putLock</span><span class="o">;</span>
    <span class="c1">// иЋ·еЏ–дёЌеЏЇдё­ж–­й”Ѓ</span>
    <span class="n">putLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// иїжњ‰е‰©дЅ™з©єй—ґ</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// еђ‘йџе€—е­е…Ґе…ѓзґ </span>
            <span class="n">enqueue</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
            <span class="c1">// йџе€—дїќе­е…ѓзґ жЂ»ж•°йЂ’еўћ</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
            <span class="c1">// йџе€—жІЎж»ЎпјЊйЂљзџҐе…¶д»–зєїзЁ‹е†™е…Ґ</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">capacity</span><span class="o">)</span>
                <span class="n">notFull</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="c1">// и§Јй”Ѓ</span>
        <span class="n">putLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// йџе€—еЋџжќҐжЇз©єзљ„пјЊж·»еЉ ж–°е…ѓзґ еђЋдёЌдёєз©єпјЊйЂљзџҐзєїзЁ‹еЏ–е‡єе…ѓзґ </span>
    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="n">signalNotEmpty</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>иЋ·еЏ–е…ѓзґ </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="no">E</span> <span class="nf">take</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="no">E</span> <span class="n">x</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="c1">// иЋ·еЏ–йџе€—е…ѓзґ жЂ»ж•°</span>
    <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">count</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
    <span class="c1">// иЋ·еЏ–takeLock</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">takeLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">takeLock</span><span class="o">;</span>
    <span class="c1">// дёЉй”ЃпјЊи®ѕзЅ®дёєеЏЇдё­ж–­</span>
    <span class="n">takeLock</span><span class="o">.</span><span class="na">lockInterruptibly</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// е¦‚жћњйџе€—дёєз©єпјЊе€™з­‰еѕ…е…¶д»–зєїзЁ‹йЂљзџҐ</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">notEmpty</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">// йџе€—жњ‰еЏЇз”Ёе…ѓзґ пјЊйџе¤ґе…ѓзґ е‡єе€—</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">dequeue</span><span class="o">();</span>
        <span class="c1">// йџе€—е…ѓзґ жЂ»ж•°йЂ’е‡Џ</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="na">getAndDecrement</span><span class="o">();</span>
        <span class="c1">// е¦‚жћњйџе€—иїжњ‰е…ѓзґ пјЊйЂљзџҐе…¶д»–зєїзЁ‹еЏ–ж•°жЌ®</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span>
            <span class="n">notEmpty</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="c1">// и§Јй”Ѓ</span>
        <span class="n">takeLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// йџе€—еЋџжќҐе·Іж»ЎпјЊзЋ°е·Іжњ‰е…ѓзґ иў«еЏ–е‡єпјЊеЏЇд»ҐеЉ е…Ґж–°е…ѓзґ </span>
    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span>
        <span class="n">signalNotFull</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ењЁжЊ‡е®љз­‰еѕ…и¶…ж—¶ж—¶й—ґе†…иЋ·еЏ–е…ѓзґ пјЊе€°иѕѕи¶…ж—¶ж—¶й—ґжІЎжњ‰е€™иї”е›ћnull</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="no">E</span> <span class="nf">poll</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="no">E</span> <span class="n">x</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="c1">// иЅ¬жЌўи¶…ж—¶ж—¶й—ґдёєзєіз§’</span>
    <span class="kt">long</span> <span class="n">nanos</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
    <span class="c1">// иЋ·еЏ–йџе€—е…ѓзґ жЂ»ж•°</span>
    <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">count</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">takeLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">takeLock</span><span class="o">;</span>
    <span class="c1">// дёЉй”ЃtakeLockпјЊи®ѕзЅ®дёєеЏЇдё­ж–­</span>
    <span class="n">takeLock</span><span class="o">.</span><span class="na">lockInterruptibly</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// еЅ“йџе€—дёєз©єпјЊењЁи¶…ж—¶ж—¶й—ґе†…з­‰еѕ…</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">nanos</span> <span class="o">&lt;=</span> <span class="mi">0L</span><span class="o">)</span>
                <span class="c1">// е€°иѕѕи¶…ж—¶ж—¶й—ґпјЊиї”е›ћnull</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="c1">// и¶…ж—¶ж—¶й—ґеЂ’ж•°</span>
            <span class="n">nanos</span> <span class="o">=</span> <span class="n">notEmpty</span><span class="o">.</span><span class="na">awaitNanos</span><span class="o">(</span><span class="n">nanos</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// йџе¤ґе…ѓзґ е‡єе€—</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">dequeue</span><span class="o">();</span>
        <span class="c1">// йџе€—е…ѓзґ жЂ»ж•°йЂ’е‡Џ</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="na">getAndDecrement</span><span class="o">();</span>
        <span class="c1">// йџе€—иїжњ‰еЏЇз”Ёе…ѓзґ пјЊйЂљзџҐе…¶д»–зєїзЁ‹иЋ·еЏ–ж•°жЌ®</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span>
            <span class="n">notEmpty</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="c1">// и§Јй”Ѓ</span>
        <span class="n">takeLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// йџе€—еЋџжќҐе·Іж»ЎпјЊзЋ°е·Іжњ‰е…ѓзґ иў«еЏ–е‡єпјЊеЏЇд»ҐеЉ е…Ґж–°е…ѓзґ </span>
    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span>
        <span class="n">signalNotFull</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>иЋ·еЏ–е…ѓзґ </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="no">E</span> <span class="nf">poll</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// иЋ·еЏ–е…ѓзґ ж•°й‡Џ</span>
    <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">count</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
    <span class="c1">// йџе€—дё­жІЎжњ‰е…ѓзґ е€™иї”е›ћnull</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="c1">// йџе€—дё­жњ‰е…ѓзґ пјЊејЂе§‹д»Ґдё‹йЂ»иѕ‘</span>
    <span class="no">E</span> <span class="n">x</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">takeLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">takeLock</span><span class="o">;</span>
    <span class="n">takeLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// е…ѓзґ д»ЋеЇ№е¤ґе‡єйџ</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">dequeue</span><span class="o">();</span>
            <span class="c1">// йџе€—е…ѓзґ ж•°й‡ЏйЂ’е‡Џ</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="na">getAndDecrement</span><span class="o">();</span>
            <span class="c1">// йџе€—иїжњ‰еЏЇз”Ёе…ѓзґ пјЊйЂљзџҐе…¶д»–зєїзЁ‹иЋ·еЏ–ж•°жЌ®</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span>
                <span class="n">notEmpty</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="c1">// и§Јй”Ѓ</span>
        <span class="n">takeLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// йџе€—еЋџжќҐе·Іж»ЎпјЊзЋ°е·Іжњ‰е…ѓзґ иў«еЏ–е‡єпјЊеЏЇд»ҐеЉ е…Ґж–°е…ѓзґ </span>
    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span>
        <span class="n">signalNotFull</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>иї”е›ћйџе€—е¤ґиЉ‚з‚№еЊ…еђ«зљ„ж•°жЌ®пјЊж­¤ж“ЌдЅњдёЌдјљж”№еЏйџе€—иЉ‚з‚№зљ„ж•°й‡Џж€–йЎєеєЏ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="no">E</span> <span class="nf">peek</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// йџе€—жІЎжњ‰иЉ‚з‚№з›ґжЋҐиї”е›ћnull</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">takeLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">takeLock</span><span class="o">;</span>
    <span class="n">takeLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// иї”е›ћеЇ№е¤ґе…ѓзґ зљ„е†…е®№пјЊеђ¦е€™иї”е›ћnull</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">.</span><span class="na">item</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="c1">// и§Јй”Ѓ</span>
        <span class="n">takeLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>жЉЉиЉ‚з‚№pд»Ће€—иЎЁдё­и§Јй™¤й“ѕжЋҐпјЊpredжЇpзљ„дёЉдёЂдёЄиЉ‚з‚№</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">unlink</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">pred</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// assert putLock.isHeldByCurrentThread();</span>
    <span class="c1">// assert takeLock.isHeldByCurrentThread();</span>
    <span class="c1">// p.next is not changed, to allow iterators that are</span>
    <span class="c1">// traversing p to maintain their weak-consistency guarantee.</span>
    <span class="n">p</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// иЉ‚з‚№pзљ„е†…е®№зЅ®з©є</span>
    <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span> <span class="c1">// ж“ЌдЅњpе‰ЌеђЋиЉ‚з‚№пјЊд»¤pи§Јй™¤й“ѕжЋҐ</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">last</span> <span class="o">==</span> <span class="n">p</span><span class="o">)</span> <span class="c1">// е¦‚жћњpжЇе°ѕиЉ‚з‚№пјЊе€™и°ѓж•ґе°ѕжЊ‡й’€зљ„жЊ‡еђ‘</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">pred</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">count</span><span class="o">.</span><span class="na">getAndDecrement</span><span class="o">()</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span>
        <span class="n">notFull</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>е¦‚жћњйџе€—дё­е­ењЁжЊ‡е®ље…ѓзґ е€™д»Ћйџе€—дё­з§»й™¤гЂ‚и‹Ґйџе€—дё­е­ењЁе¤љдёЄз›ёеђЊе…ѓзґ пјЊж­¤ж–№жі•еЏЄдјљз§»й™¤е…¶дё­дёЂдёЄгЂ‚з§»й™¤ж€ђеЉџиї”е›ћtrueпјЊеђ¦е€™иї”е›ћfalseгЂ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// е…ѓзґ дёєnullз›ґжЋҐиї”е›ћfalse</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="n">fullyLock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">head</span><span class="o">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
             <span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
             <span class="n">pred</span> <span class="o">=</span> <span class="n">p</span><span class="o">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// ењЁй“ѕиЎЁдёЉйЂђдёЄжџҐж‰ѕе…ѓзґ жЇеђ¦еЊ№й…Ќ</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">item</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// ж‰ѕе€°еЊ№й…Ќе…ѓзґ е€™жЉЉиЇҐе…ѓзґ и§Јй™¤й“ѕжЋҐ</span>
                <span class="n">unlink</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">pred</span><span class="o">);</span>
                <span class="c1">// е…ѓзґ иї”е›ћtrue</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// жІЎжњ‰з§»й™¤е…ѓзґ </span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">fullyUnlock</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>жЈЂжџҐжЇеђ¦еЊ…еђ«жЊ‡е®ље…ѓзґ </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// е…ѓзґ дёєnullз›ґжЋҐиї”е›ћfalse</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="n">fullyLock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// йЃЌеЋ†йџе€—йЂђдёЄжџҐж‰ѕе…ѓзґ </span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
            <span class="c1">// ж‰ѕе€°еЊ№й…Ќе…ѓзґ </span>
            <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">item</span><span class="o">))</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="c1">// ж‰ѕдёЌе€°еЊ№й…Ќе…ѓзґ </span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">fullyUnlock</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>иї”е›ћдёЂдёЄж•°з»„пјЊж­¤ж•°з»„еЊ…еђ«йџе€—зљ„ж‰Ђжњ‰е…ѓзґ пјЊдё”ж•°з»„е…ѓзґ зљ„йЎєеєЏе’Њйџе€—зљ„е…ѓзґ зљ„йЎєеєЏдёЂи‡ґгЂ‚жЇЏж¬Ўиї”е›ћзљ„ж•°з»„дёєдёЌеђЊеЇ№и±ЎпјЊдї®ж”№ж•°з»„жЇе®‰е…Ёзљ„гЂ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">fullyLock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// иЋ·еЏ–йџе€—дё­е…ѓзґ дёЄж•°</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="c1">// йЂљиї‡е…ѓзґ ж•°й‡Џжћ„йЂ ж•°з»„</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="c1">// йЃЌеЋ†йџе€—пјЊдѕќж¬Ўж‹·иґќе…ѓзґ еј•з”Ёе€°ж•°з»„еЇ№еє”зґўеј•</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
            <span class="n">a</span><span class="o">[</span><span class="n">k</span><span class="o">++]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
        <span class="c1">// иї”е›ћж•°з»„</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">fullyUnlock</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>иї”е›ћеЊ…еђ«йџе€—ж‰Ђжњ‰е…ѓзґ зљ„ж•°з»„пјЊж•°з»„е…ѓзґ йЎєеєЏе’Њйџе€—е…ѓзґ йЎєеєЏдёЂи‡ґгЂ‚е¦‚жћњдј е…Ґж•°з»„з©єй—ґи¶іе¤џпјЊиї”е›ћзљ„ж•°з»„е°±жЇдј е…Ґзљ„ж•°з»„(иїђиЎЊж—¶з±»ећ‹д№џдёЂи‡ґ)гЂ‚еђ¦е€™ж–№жі•е†…йѓЁе€›е»єз±»ећ‹з›ёеђЊж–°ж•°з»„пјЊж•°з»„й•їеє¦е’Њйџе€—е…ѓзґ ж•°й‡Џз›ёз­‰гЂ‚е¦‚жћњдј е…Ґзљ„ж•°з»„дїќе­йџе€—ж‰Ђжњ‰е…ѓзґ еђЋиїжњ‰з©єдЅ™пјЊиї™дёЄз©єдЅ™дјљиў«зЅ®nullгЂ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">(</span><span class="no">T</span><span class="o">[]</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">fullyLock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// иЋ·еЏ–йџе€—е…ѓзґ жЂ»ж•°</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="c1">// йџе€—е…ѓзґ жЂ»ж•°и¶…иї‡дј е…Ґж•°з»„зљ„й•їеє¦</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">)</span>
            <span class="c1">// е€›е»єж–°зљ„ж•°з»„пјЊй•їеє¦дёєйџе€—е…ѓзґ жЂ»ж•°</span>
            <span class="n">a</span> <span class="o">=</span> <span class="o">(</span><span class="no">T</span><span class="o">[])</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Array</span><span class="o">.</span><span class="na">newInstance</span>
                <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getComponentType</span><span class="o">(),</span> <span class="n">size</span><span class="o">);</span>

        <span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="c1">// дѕќж¬ЎжЉЉйџе€—зљ„е…ѓзґ е­е…Ґж•°з»„дё­</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
            <span class="n">a</span><span class="o">[</span><span class="n">k</span><span class="o">++]</span> <span class="o">=</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span><span class="n">p</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
        <span class="c1">// е¦‚жћњж•°з»„иїжњ‰з©єдЅ™з©єй—ґпјЊе€™иЇҐдЅЌзЅ®и®ѕдёєnull</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">k</span><span class="o">)</span>
            <span class="n">a</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="c1">// иї”е›ћж•°з»„</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">fullyUnlock</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>з§»й™¤йџе€—дё­ж‰Ђжњ‰е…ѓзґ пјЊз§»й™¤е®Њж€ђеђЋйџе€—е…ѓзґ дёєз©є</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// дёЉй”Ѓ</span>
    <span class="n">fullyLock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">h</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">h</span><span class="o">;</span>
            <span class="n">p</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// зЅ®з©єиЉ‚з‚№зљ„ж•°жЌ®</span>
        <span class="o">}</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span> <span class="c1">// з”±дєЋйџе€—е…ѓзґ е…Ёжё…з©єдє†пјЊж‰Ђд»Ґе¤ґжЊ‡й’€е’ЊдёєжЊ‡й’€еј•з”Ёз›ёеђЊ</span>
        <span class="c1">// assert head.item == null &amp;&amp; head.next == null;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">count</span><span class="o">.</span><span class="na">getAndSet</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span>
            <span class="n">notFull</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">fullyUnlock</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>з§»й™¤йџе€—ж‰Ђжњ‰е…ѓзґ пјЊе№¶жЉЉиї™дє›е…ѓзґ ж·»еЉ е€°жЊ‡е®љй›†еђ€cдё­</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">int</span> <span class="nf">drainTo</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">drainTo</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>з§»й™¤йџе€—жњЂе¤љmaxElementsдёЄе…ѓзґ пјЊе№¶жЉЉиї™дє›е…ѓзґ ж·»еЉ е€°жЊ‡е®љй›†еђ€cдё­</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">int</span> <span class="nf">drainTo</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxElements</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
    
    <span class="c1">// дёЌиѓЅжЉЉжњ¬йџе€—зљ„е…ѓзґ ж·»еЉ е€°и‡Єе·±йџе€—дёЉ</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">();</span>
    
    <span class="c1">// maxElementsйЎ»дёєж­Јж•°</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">maxElements</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
    
    <span class="kt">boolean</span> <span class="n">signalNotFull</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">takeLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">takeLock</span><span class="o">;</span>
    <span class="c1">// takeLockдёЉй”Ѓ</span>
    <span class="n">takeLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// и®Ўз®—йњЂи¦ЃиЅ¬з§»е¤ље°‘дёЄйџе€—е…ѓзґ </span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">maxElements</span><span class="o">,</span> <span class="n">count</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="c1">// count.get provides visibility to first n Nodes</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// д»Ће€—иЎЁеЏ–иЉ‚з‚№</span>
                <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                <span class="c1">// иЉ‚з‚№ж•°жЌ®ж·»еЉ е€°ж•°з»„дё­</span>
                <span class="n">c</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">item</span><span class="o">);</span>
                <span class="c1">// зЅ®з©єиЉ‚з‚№зљ„ж•°жЌ®</span>
                <span class="n">p</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="c1">// еј•з”Ёз§»еЉЁе€°дё‹дёЂдёЄиЉ‚з‚№</span>
                <span class="n">h</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">h</span><span class="o">;</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                <span class="c1">// иЅ¬з§»иЉ‚з‚№ж•°йЂ’еўћ</span>
                <span class="o">++</span><span class="n">i</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">n</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// Restore invariants even if c.add() threw</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// assert h.item == null;</span>
                <span class="c1">// е·Із»ЏиЅ¬з§»дє†iдёЄе…ѓзґ пјЊйџе€—зљ„е¤ґеј•з”ЁйњЂи¦Ѓеђ‘еђЋз§»еЉЁiдёЄдЅЌзЅ®</span>
                <span class="n">head</span> <span class="o">=</span> <span class="n">h</span><span class="o">;</span>
                <span class="n">signalNotFull</span> <span class="o">=</span> <span class="o">(</span><span class="n">count</span><span class="o">.</span><span class="na">getAndAdd</span><span class="o">(-</span><span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">takeLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">signalNotFull</span><span class="o">)</span>
            <span class="n">signalNotFull</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ењЁд»»дЅ•е…ѓзґ жІЎжњ‰е®Ње…ЁдёЉй”Ѓзљ„жѓ…е†µдё‹йЃЌеЋ†гЂ‚ж­¤з§ЌйЃЌеЋ†еї…йЎ»е¤„зђ†д»Ґдё‹дё¤з§Ќжѓ…е†µпјљ</p>
<ul>
  <li>е‡єйџиЉ‚з‚№(p.next == p)</li>
  <li>(еЏЇиѓЅе¤љдёЄ)е†…йѓЁе·Із§»й™¤иЉ‚з‚№(p.item == null)</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">succ</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="еЌЃitr">еЌЃгЂЃItr</h2>

<p>иї”е›ћйџе€—еЅ“е‰Ќе…ѓзґ йЎєеєЏзљ„иї­д»Је™ЁпјЊе…ѓзґ йЎєеєЏжЊ‰з…§йџе€—е¤ґе€°йџе€—е°ѕ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">Itr</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>еј±дёЂи‡ґжЂ§иї­д»Је™ЁгЂ‚ж‡’ж›ґж–°зҐ–е…€еџџжЏђдѕ›йў„и®ЎO(1)зљ„remove()пјЊжњЂе·®жѓ…е†µдё‹дёєO(n)пјЊдёЌз®ЎдЅ•ж—¶дїќе­зљ„зҐ–е…€иЉ‚з‚№иў«е№¶еЏ‘е€ й™¤гЂ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">class</span> <span class="nc">Itr</span> <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>           <span class="c1">// Node holding nextItem</span>
    <span class="kd">private</span> <span class="no">E</span> <span class="n">nextItem</span><span class="o">;</span>             <span class="c1">// next item to hand out</span>
    <span class="kd">private</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">lastRet</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">ancestor</span><span class="o">;</span>       <span class="c1">// Helps unlink lastRet on remove()</span>

    <span class="nc">Itr</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">fullyLock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">next</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">nextItem</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">fullyUnlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">next</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="no">E</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
        <span class="n">lastRet</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
        <span class="no">E</span> <span class="n">x</span> <span class="o">=</span> <span class="n">nextItem</span><span class="o">;</span>
        <span class="n">fullyLock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">item</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">succ</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
            <span class="n">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
            <span class="n">nextItem</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">fullyUnlock</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// A variant of forEachFrom</span>
        <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
        <span class="n">lastRet</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
        <span class="n">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">batchSize</span> <span class="o">=</span> <span class="mi">64</span><span class="o">;</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">es</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="k">do</span> <span class="o">{</span>
            <span class="n">fullyLock</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">es</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                    <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span> <span class="n">q</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">succ</span><span class="o">(</span><span class="n">q</span><span class="o">))</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">item</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="n">len</span> <span class="o">==</span> <span class="n">batchSize</span><span class="o">)</span>
                            <span class="k">break</span><span class="o">;</span>
                    <span class="n">es</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">len</span><span class="o">];</span>
                    <span class="n">es</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">nextItem</span><span class="o">;</span>
                    <span class="n">nextItem</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(;</span> <span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">succ</span><span class="o">(</span><span class="n">p</span><span class="o">))</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">es</span><span class="o">[</span><span class="n">n</span><span class="o">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">item</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">lastRet</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                        <span class="n">n</span><span class="o">++;</span>
                    <span class="o">}</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">fullyUnlock</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span> <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">es</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
                <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">lastRet</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
        <span class="n">lastRet</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">fullyLock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">item</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">ancestor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">ancestor</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
                <span class="n">ancestor</span> <span class="o">=</span> <span class="n">findPred</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">ancestor</span><span class="o">);</span>
                <span class="n">unlink</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">ancestor</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">fullyUnlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="еЌЃдёЂlbqspliterator">еЌЃдёЂгЂЃLBQSpliterator</h2>

<p>Spliterators.IteratorSpliteratorзљ„и‡Єе®љд№‰еЏдЅ“</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">LBQSpliterator</span> <span class="kd">implements</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAX_BATCH</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="o">;</span>  <span class="c1">// max batch array size;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">current</span><span class="o">;</span>    <span class="c1">// current node; null until initialized</span>
    <span class="kt">int</span> <span class="n">batch</span><span class="o">;</span>          <span class="c1">// batch size for splits</span>
    <span class="kt">boolean</span> <span class="n">exhausted</span><span class="o">;</span>  <span class="c1">// true when no more nodes</span>
    <span class="kt">long</span> <span class="n">est</span> <span class="o">=</span> <span class="n">size</span><span class="o">();</span>  <span class="c1">// size estimate</span>

    <span class="nc">LBQSpliterator</span><span class="o">()</span> <span class="o">{}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">estimateSize</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">est</span><span class="o">;</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">trySplit</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">h</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">exhausted</span> <span class="o">&amp;&amp;</span>
            <span class="o">((</span><span class="n">h</span> <span class="o">=</span> <span class="n">current</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">.</span><span class="na">next</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">batch</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">batch</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="no">MAX_BATCH</span><span class="o">);</span>
            <span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">n</span><span class="o">];</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">current</span><span class="o">;</span>
            <span class="n">fullyLock</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="k">for</span> <span class="o">(;</span> <span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">succ</span><span class="o">(</span><span class="n">p</span><span class="o">))</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">item</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                            <span class="n">i</span><span class="o">++;</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">fullyUnlock</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">current</span> <span class="o">=</span> <span class="n">p</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">est</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
                <span class="n">exhausted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">est</span> <span class="o">-=</span> <span class="n">i</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0L</span><span class="o">)</span>
                <span class="n">est</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
                <span class="k">return</span> <span class="nc">Spliterators</span><span class="o">.</span><span class="na">spliterator</span>
                    <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="o">(</span><span class="nc">Spliterator</span><span class="o">.</span><span class="na">ORDERED</span> <span class="o">|</span>
                               <span class="nc">Spliterator</span><span class="o">.</span><span class="na">NONNULL</span> <span class="o">|</span>
                               <span class="nc">Spliterator</span><span class="o">.</span><span class="na">CONCURRENT</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryAdvance</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">exhausted</span><span class="o">)</span> <span class="o">{</span>
            <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">fullyLock</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">current</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="k">do</span> <span class="o">{</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">succ</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">current</span> <span class="o">=</span> <span class="n">p</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">exhausted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">fullyUnlock</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">exhausted</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">exhausted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">current</span><span class="o">;</span>
            <span class="n">current</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">forEachFrom</span><span class="o">(</span><span class="n">action</span><span class="o">,</span> <span class="n">p</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">characteristics</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">Spliterator</span><span class="o">.</span><span class="na">ORDERED</span> <span class="o">|</span>
                <span class="nc">Spliterator</span><span class="o">.</span><span class="na">NONNULL</span> <span class="o">|</span>
                <span class="nc">Spliterator</span><span class="o">.</span><span class="na">CONCURRENT</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>иї”е›ћеџєдєЋж­¤йџе€—е…ѓзґ зљ„еЏЇе€†е‰Іиї­д»Је™ЁгЂ‚иї”е›ћзљ„еЏЇе€†е‰Іиї­д»Је™ЁжЇеј±дёЂи‡ґжЂ§зљ„гЂ‚ж­¤иї­д»Је™ЁеЏЇжЉҐе‘ЉSpliterator#CONCURRENTгЂЃSpliterator#ORDEREDгЂЃSpliterator#NONNULLгЂ‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">LBQSpliterator</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="еЌЃдєЊе‰ЌеЇјиЉ‚з‚№">еЌЃдєЊгЂЃе‰ЌеЇјиЉ‚з‚№</h2>

<p>иї”е›ћжґ»иЉ‚з‚№pзљ„е‰ЌеЇјиЉ‚з‚№пјЊд»Ґдѕїи§Јй“ѕжЋҐp</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">findPred</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">ancestor</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// assert p.item != null;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ancestor</span><span class="o">.</span><span class="na">item</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="n">ancestor</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
    <span class="c1">// Fails with NPE if precondition not satisfied</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">q</span><span class="o">;</span> <span class="o">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">ancestor</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="n">p</span><span class="o">;</span> <span class="o">)</span>
        <span class="n">ancestor</span> <span class="o">=</span> <span class="n">q</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">ancestor</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="еЌЃдё‰ж‰№й‡Џж“ЌдЅњ">еЌЃдё‰гЂЃж‰№й‡Џж“ЌдЅњ</h2>

<p>з§»й™¤ж‰Ђжњ‰й›†еђ€cзљ„е…ѓзґ пјЊи‹Ґй›†еђ€cеЇ№и±Ўдёєз©єе€™жЉ›е‡єNullPointerException</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">removeAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
    <span class="k">return</span> <span class="nf">bulkRemove</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">c</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">e</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>д»…дїќз•™ж‰Ђжњ‰й›†еђ€cзљ„е…ѓзґ пјЊи‹Ґй›†еђ€cеЇ№и±Ўдёєз©єе€™жЉ›е‡єNullPointerException</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">retainAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
    <span class="k">return</span> <span class="nf">bulkRemove</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">c</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">e</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>е®ћзЋ°ж‰№й‡Џз§»й™¤ж–№жі•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre><span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">bulkRemove</span><span class="o">(</span><span class="nc">Predicate</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">filter</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">removed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">ancestor</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;[]</span> <span class="n">nodes</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">do</span> <span class="o">{</span>
        <span class="c1">// 1. Extract batch of up to 64 elements while holding the lock.</span>
        <span class="kt">long</span> <span class="n">deathRow</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>          <span class="c1">// "bitset" of size 64</span>
        <span class="n">fullyLock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">nodes</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="n">p</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span> <span class="n">q</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">succ</span><span class="o">(</span><span class="n">q</span><span class="o">))</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">item</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="n">len</span> <span class="o">==</span> <span class="mi">64</span><span class="o">)</span>
                        <span class="k">break</span><span class="o">;</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;[])</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;?&gt;[</span><span class="n">len</span><span class="o">];</span>
            <span class="o">}</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">succ</span><span class="o">(</span><span class="n">p</span><span class="o">))</span>
                <span class="n">nodes</span><span class="o">[</span><span class="n">n</span><span class="o">++]</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">fullyUnlock</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// 2. Run the filter on the elements while lock is free.</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="no">E</span> <span class="n">e</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">item</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">filter</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
                <span class="n">deathRow</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// 3. Remove any filtered elements while holding the lock.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">deathRow</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">fullyLock</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">q</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">deathRow</span> <span class="o">&amp;</span> <span class="o">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="o">))</span> <span class="o">!=</span> <span class="mi">0L</span>
                        <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">[</span><span class="n">i</span><span class="o">]).</span><span class="na">item</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">ancestor</span> <span class="o">=</span> <span class="n">findPred</span><span class="o">(</span><span class="n">q</span><span class="o">,</span> <span class="n">ancestor</span><span class="o">);</span>
                        <span class="n">unlink</span><span class="o">(</span><span class="n">q</span><span class="o">,</span> <span class="n">ancestor</span><span class="o">);</span>
                        <span class="n">removed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">fullyUnlock</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">removed</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
:ET