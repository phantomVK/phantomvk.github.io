I"Í<h1 id="ä¸€ç±»ç­¾å">ä¸€ã€ç±»ç­¾å</h1>

<p><strong>MessageQueue</strong> æ˜¯ä¸ªä½å±‚æ¬¡ç±»ï¼ŒæŒæœ‰éœ€è¦åˆ†å‘çš„æ¶ˆæ¯ã€‚è€Œæ¶ˆæ¯å¹¶ä¸æ˜¯ç›´æ¥å­˜å…¥ <strong>MessageQueue</strong>ï¼Œè€Œæ˜¯é€šè¿‡ <strong>Looper</strong> ç›¸å¯¹åº” <strong>Handler</strong> åŠ å…¥ã€‚é€šè¿‡æ–¹æ³• <strong>Looper.myQueue()</strong> å¯ä»¥è·å–å½“å‰çº¿ç¨‹ <strong>MessageQueue</strong>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MessageQueue</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>MessageQueue</strong>ã€<strong>Looper</strong> å’Œ <strong>Thread</strong> çš„å…³ç³»å›¾è§£ï¼š</p>

<p><img src="/img/android/images/MessageQueue.png" alt="MessageQueue" /></p>

<p>å­¦ä¹  <strong>MessageQueue</strong> æºç å‰ï¼Œå»ºè®®å…ˆå­¦ä¹  <a href="/2016/12/01/Android_Handler/">Androidæºç ç³»åˆ—(4) â€“ Handler</a> å’Œ <a href="/2016/12/03/Android_Looper">Androidæºç ç³»åˆ—(5) â€“ Looper</a>ï¼Œæœ‰åŠ©äºäº†è§£ <strong>Message</strong> å¦‚ä½•åœ¨ <strong>Handler</strong> ã€<strong>Looper</strong>ã€<strong>MessageQueue</strong> ä¸‰è€…é—´æµåŠ¨ã€‚</p>

<p>ç”±äº <strong>MessageQueue</strong> æ˜¯ä¸ªä½å±‚æ¬¡ç±»ï¼Œæœ¬æ¬¡æºç é˜…è¯»åªé’ˆå¯¹Javaæºç è¿›è¡Œåˆ†æï¼Œæ²¡æœ‰æ¶‰åŠ <strong>Android Framework</strong> æºç ï¼Œä»¥åä¼šè¡¥å…¨è¿™éƒ¨åˆ†çŸ¥è¯†ã€‚æºç æ¥è‡ªAndroid 28</p>

<h2 id="äºŒæ•°æ®æˆå‘˜">äºŒã€æ•°æ®æˆå‘˜</h2>

<p>æ¶ˆæ¯é˜Ÿåˆ—å…è®¸é€€å‡ºæ—¶ä¸ºtrue</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">mQuitAllowed</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç”±Cè¯­è¨€ä½¿ç”¨çš„å˜é‡ï¼ˆä¼°è®¡æ˜¯æŒ‡ç¤ºæ¶ˆæ¯é˜Ÿåˆ—åœ¨åº•å±‚çš„IDï¼‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unused"</span><span class="o">)</span>
<span class="kd">private</span> <span class="kt">long</span> <span class="n">mPtr</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¶ˆæ¯é˜Ÿåˆ—å¤´æ¶ˆæ¯ï¼Œé€šè¿‡é“¾è¡¨å½¢æˆé˜Ÿåˆ—</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">Message</span> <span class="n">mMessages</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>IdleHandler</strong> åˆ—è¡¨</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">IdleHandler</span><span class="o">&gt;</span> <span class="n">mIdleHandlers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">IdleHandler</span><span class="o">&gt;();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>FileDescriptorRecord</strong> çš„ç¨€ç–é˜µåˆ—</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">SparseArray</span><span class="o">&lt;</span><span class="nc">FileDescriptorRecord</span><span class="o">&gt;</span> <span class="n">mFileDescriptorRecords</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>IdleHandler</strong> æ•°ç»„</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">IdleHandler</span><span class="o">[]</span> <span class="n">mPendingIdleHandlers</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦æ­£åœ¨é€€å‡º</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">boolean</span> <span class="n">mQuitting</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æŒ‡ç¤ºnext()æ˜¯å¦é˜»å¡åœ¨éé›¶è¶…æ—¶å€¼å‚æ•°çš„pollOnce()è°ƒç”¨ä¸Š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">boolean</span> <span class="n">mBlocked</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¸‹ä¸€ä¸ª <strong>SyncBarrier</strong> çš„tokenã€‚Barrierså°±æ˜¯targetä¸ºç©ºã€arg1å˜é‡å€¼ä¸ºtokençš„æ¶ˆæ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">int</span> <span class="n">mNextBarrierToken</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸‰åŸç”Ÿæ–¹æ³•">ä¸‰ã€åŸç”Ÿæ–¹æ³•</h2>

<p>åŸç”Ÿæ–¹æ³•ç”±Cè¯­è¨€å®ç°ï¼Œæºç åœ¨ <strong>Android Framework</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="c1">// æ¶ˆæ¯é˜Ÿåˆ—åˆå§‹åŒ–</span>
<span class="kd">private</span> <span class="kd">native</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">nativeInit</span><span class="o">();</span>

<span class="c1">// é”€æ¯æ¶ˆæ¯é˜Ÿåˆ—</span>
<span class="kd">private</span> <span class="kd">native</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">nativeDestroy</span><span class="o">(</span><span class="kt">long</span> <span class="n">ptr</span><span class="o">);</span>

<span class="c1">// ä»æ¶ˆæ¯é˜Ÿåˆ—é˜»å¡ç­‰å¾…å¹¶è·å–ä¸€æ¡æ¶ˆæ¯</span>
<span class="kd">private</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">nativePollOnce</span><span class="o">(</span><span class="kt">long</span> <span class="n">ptr</span><span class="o">,</span> <span class="kt">int</span> <span class="n">timeoutMillis</span><span class="o">);</span>

<span class="c1">// å”¤é†’æ¶ˆæ¯é˜Ÿåˆ—</span>
<span class="kd">private</span> <span class="kd">native</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">nativeWake</span><span class="o">(</span><span class="kt">long</span> <span class="n">ptr</span><span class="o">);</span>

<span class="c1">// æ£€æŸ¥æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦åœ¨è½®è¯¢</span>
<span class="kd">private</span> <span class="kd">native</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">nativeIsPolling</span><span class="o">(</span><span class="kt">long</span> <span class="n">ptr</span><span class="o">);</span>

<span class="c1">// æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦äº‹ä»¶</span>
<span class="kd">private</span> <span class="kd">native</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">nativeSetFileDescriptorEvents</span><span class="o">(</span><span class="kt">long</span> <span class="n">ptr</span><span class="o">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="o">,</span> <span class="kt">int</span> <span class="n">events</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å››æ„é€ æ–¹æ³•">å››ã€æ„é€ æ–¹æ³•</h2>

<p><strong>mQuitAllowed</strong> æŒ‡ç¤ºæœ¬æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦å…è®¸é€€å‡ºï¼Œä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—æ­¤å€¼ä¸º <strong>false</strong>ã€‚å…¶ä»–çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸€èˆ¬å¯ä»¥é€€å‡ºã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nc">MessageQueue</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">quitAllowed</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mQuitAllowed</span> <span class="o">=</span> <span class="n">quitAllowed</span><span class="o">;</span>
    <span class="n">mPtr</span> <span class="o">=</span> <span class="n">nativeInit</span><span class="o">();</span> <span class="c1">// åˆå§‹åŒ–</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="äº”æˆå‘˜æ–¹æ³•">äº”ã€æˆå‘˜æ–¹æ³•</h2>

<h4 id="51-finalize">5.1 finalize</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">finalize</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">dispose</span><span class="o">();</span> <span class="c1">// è°ƒç”¨ä¸‹é¢æ–¹æ³•</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">finalize</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é”€æ¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»…èƒ½è¢«looperæ‰€åœ¨çº¿ç¨‹æˆ–æ–¹æ³• <strong>finalizer</strong> è°ƒç”¨ã€‚æ–¹æ³•å†…è°ƒç”¨åŸç”Ÿæ–¹æ³•é”€æ¯æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">dispose</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mPtr</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">nativeDestroy</span><span class="o">(</span><span class="n">mPtr</span><span class="o">);</span>  <span class="c1">// è°ƒç”¨åŸç”Ÿæ–¹æ³•</span>
        <span class="n">mPtr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="52-idle">5.2 idle</h4>

<p>å½“ <strong>Looper</strong> ç©ºé—²æ—¶è¿”å›trueï¼Œæ–¹æ³•å¯åœ¨ä»»ä½•çº¿ç¨‹è°ƒç”¨ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isIdle</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// å½“å‰æ—¶é—´æˆ³</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">mMessages</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">mMessages</span><span class="o">.</span><span class="na">when</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å½“æ–¹æ³• <strong>IdleHandler.queueIdle()</strong> è¢«è°ƒç”¨ä¸”è¿”å› <strong>false</strong> æ—¶ï¼Œ<strong>IdleHandler</strong> ä¼šè¢«è‡ªåŠ¨ç§»é™¤</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">addIdleHandler</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">IdleHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">handler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span><span class="s">"Can't add a null IdleHandler"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mIdleHandlers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç§»é™¤ä¹‹å‰å·²ç»æ·»åŠ çš„ <strong>IdleHandler</strong>ï¼Œè‹¥æŒ‡å®š <strong>IdleHandler</strong> ä¸å­˜åœ¨åˆ™ä¸è¿›è¡Œæ“ä½œã€‚æ–¹æ³•ç”± <strong>synchronized</strong> ä¿æŠ¤ï¼Œå¯åœ¨ä»»æ„çº¿ç¨‹è°ƒç”¨</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeIdleHandler</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">IdleHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mIdleHandlers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="53-polling">5.3 polling</h4>

<p>è¿”å›æ­¤looperçš„çº¿ç¨‹æ˜¯å¦åœ¨ç­‰å¾…è·å¾—æ›´å¤šå·¥ä½œã€‚æ­¤æ–¹æ³•åŒæ—¶è¡¨æ˜loopä¾ç„¶å­˜æ´»ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isPolling</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">isPollingLocked</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨é€€å‡ºçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸€å®šä¸æ˜¯ç©ºé—²çš„ã€‚<strong>mQuitting</strong> ä¸º false æ—¶èƒ½å‡è®¾ mPtr != 0</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isPollingLocked</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="n">mQuitting</span> <span class="o">&amp;&amp;</span> <span class="n">nativeIsPolling</span><span class="o">(</span><span class="n">mPtr</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="54-filedescriptor">5.4 FileDescriptor</h4>

<p>æ·»åŠ æ–‡ä»¶æè¿°ç¬¦ç›‘å¬å™¨ï¼Œå¹¶æ¥å—æ–‡ä»¶æè¿°ç¬¦ç›¸å…³äº‹ä»¶å‘ç”Ÿçš„é€šçŸ¥ã€‚</p>

<p>å¦‚æœè¯¥æ–‡ä»¶æè¿°ç¬¦å·²ç»æ³¨å†Œï¼Œåˆ™æŒ‡å®šçš„äº‹ä»¶å’Œç›‘å¬å™¨ä¼šæŠŠæ—§çš„ç»™æ›¿æ¢æ‰ï¼Œæ‰€ä»¥ä¸å¯èƒ½ç»™æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦æ·»åŠ å¤šä¸ªç›‘å¬å™¨ã€‚æ–‡ä»¶æè¿°ç¬¦ç›‘å¬å™¨ä¸å†ä½¿ç”¨æ—¶ï¼Œéœ€æ³¨é”€è¯¥ç›‘å¬å™¨ã€‚</p>

<p>å‚æ•°eventsæ˜¯ <strong>EVENT_INPUT</strong> ã€<strong>EVENT_OUTPUT</strong>ã€ <strong>EVENT_ERROR</strong> å€¼çš„æ©ç ã€‚å¦‚æœeventsä¸º0ï¼Œåˆ™ä¼ å…¥çš„ç›‘å¬å™¨ç”¨äºæ³¨é”€ï¼Œè€Œä¸æ˜¯æ³¨å†Œã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">addOnFileDescriptorEventListener</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">FileDescriptor</span> <span class="n">fd</span><span class="o">,</span>
        <span class="nd">@OnFileDescriptorEventListener</span><span class="o">.</span><span class="na">Events</span> <span class="kt">int</span> <span class="n">events</span><span class="o">,</span>
        <span class="nd">@NonNull</span> <span class="nc">OnFileDescriptorEventListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// fdå’Œlistenerå‡ä¸èƒ½ä¸ºç©º</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">fd</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"fd must not be null"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">listener</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"listener must not be null"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">updateOnFileDescriptorEventListenerLocked</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="n">events</span><span class="o">,</span> <span class="n">listener</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç§»é™¤æ–‡ä»¶æè¿°ç¬¦ç›‘å¬å™¨ï¼ŒæŒ‡å®šå¯¹è±¡ä¸èƒ½ä¸ºç©º</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeOnFileDescriptorEventListener</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">FileDescriptor</span> <span class="n">fd</span><span class="o">)</span> <span class="o">{</span>
    
    <span class="c1">// fdä¸èƒ½ä¸ºç©º</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">fd</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"fd must not be null"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ä¼ å…¥eventsä¸º0è¡¨ç¤ºç§»é™¤æ­¤äº‹ä»¶ä¸Šç›‘å¬å™¨</span>
        <span class="n">updateOnFileDescriptorEventListenerLocked</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦ç›‘å¬å™¨</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">updateOnFileDescriptorEventListenerLocked</span><span class="o">(</span><span class="nc">FileDescriptor</span> <span class="n">fd</span><span class="o">,</span> <span class="kt">int</span> <span class="n">events</span><span class="o">,</span>
        <span class="nc">OnFileDescriptorEventListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">fdNum</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="na">getInt</span><span class="err">$</span><span class="o">();</span>

    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="nc">FileDescriptorRecord</span> <span class="n">record</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mFileDescriptorRecords</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">mFileDescriptorRecords</span><span class="o">.</span><span class="na">indexOfKey</span><span class="o">(</span><span class="n">fdNum</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">mFileDescriptorRecords</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">record</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">record</span><span class="o">.</span><span class="na">mEvents</span> <span class="o">==</span> <span class="n">events</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">events</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">events</span> <span class="o">|=</span> <span class="nc">OnFileDescriptorEventListener</span><span class="o">.</span><span class="na">EVENT_ERROR</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">record</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mFileDescriptorRecords</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mFileDescriptorRecords</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SparseArray</span><span class="o">&lt;</span><span class="nc">FileDescriptorRecord</span><span class="o">&gt;();</span>
            <span class="o">}</span>
            <span class="n">record</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileDescriptorRecord</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="n">events</span><span class="o">,</span> <span class="n">listener</span><span class="o">);</span>
            <span class="n">mFileDescriptorRecords</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">fdNum</span><span class="o">,</span> <span class="n">record</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">record</span><span class="o">.</span><span class="na">mListener</span> <span class="o">=</span> <span class="n">listener</span><span class="o">;</span>
            <span class="n">record</span><span class="o">.</span><span class="na">mEvents</span> <span class="o">=</span> <span class="n">events</span><span class="o">;</span>
            <span class="n">record</span><span class="o">.</span><span class="na">mSeq</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">nativeSetFileDescriptorEvents</span><span class="o">(</span><span class="n">mPtr</span><span class="o">,</span> <span class="n">fdNum</span><span class="o">,</span> <span class="n">events</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">record</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">record</span><span class="o">.</span><span class="na">mEvents</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">mFileDescriptorRecords</span><span class="o">.</span><span class="na">removeAt</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="n">nativeSetFileDescriptorEvents</span><span class="o">(</span><span class="n">mPtr</span><span class="o">,</span> <span class="n">fdNum</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ­¤æ–¹æ³•ç”±åŸç”Ÿä»£ç ä»£ç è°ƒç”¨</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">int</span> <span class="nf">dispatchEvents</span><span class="o">(</span><span class="kt">int</span> <span class="n">fd</span><span class="o">,</span> <span class="kt">int</span> <span class="n">events</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Get the file descriptor record and any state that might change.</span>
    <span class="kd">final</span> <span class="nc">FileDescriptorRecord</span> <span class="n">record</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldWatchedEvents</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">OnFileDescriptorEventListener</span> <span class="n">listener</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">seq</span><span class="o">;</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">mFileDescriptorRecords</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">fd</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">record</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// spurious, no listener registered</span>
        <span class="o">}</span>

        <span class="n">oldWatchedEvents</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="na">mEvents</span><span class="o">;</span>
        <span class="n">events</span> <span class="o">&amp;=</span> <span class="n">oldWatchedEvents</span><span class="o">;</span> <span class="c1">// filter events based on current watched set</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">events</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">oldWatchedEvents</span><span class="o">;</span> <span class="c1">// spurious, watched events changed</span>
        <span class="o">}</span>

        <span class="n">listener</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="na">mListener</span><span class="o">;</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="na">mSeq</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// åœ¨é”ä¹‹å¤–è°ƒç”¨ç›‘å¬å™¨</span>
    <span class="kt">int</span> <span class="n">newWatchedEvents</span> <span class="o">=</span> <span class="n">listener</span><span class="o">.</span><span class="na">onFileDescriptorEvents</span><span class="o">(</span>
            <span class="n">record</span><span class="o">.</span><span class="na">mDescriptor</span><span class="o">,</span> <span class="n">events</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">newWatchedEvents</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">newWatchedEvents</span> <span class="o">|=</span> <span class="nc">OnFileDescriptorEventListener</span><span class="o">.</span><span class="na">EVENT_ERROR</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Update the file descriptor record if the listener changed the set of</span>
    <span class="c1">// events to watch and the listener itself hasn't been updated since.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">newWatchedEvents</span> <span class="o">!=</span> <span class="n">oldWatchedEvents</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">mFileDescriptorRecords</span><span class="o">.</span><span class="na">indexOfKey</span><span class="o">(</span><span class="n">fd</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mFileDescriptorRecords</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">index</span><span class="o">)</span> <span class="o">==</span> <span class="n">record</span>
                    <span class="o">&amp;&amp;</span> <span class="n">record</span><span class="o">.</span><span class="na">mSeq</span> <span class="o">==</span> <span class="n">seq</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">record</span><span class="o">.</span><span class="na">mEvents</span> <span class="o">=</span> <span class="n">newWatchedEvents</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">newWatchedEvents</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mFileDescriptorRecords</span><span class="o">.</span><span class="na">removeAt</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Return the new set of events to watch for native code to take care of.</span>
    <span class="k">return</span> <span class="n">newWatchedEvents</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="55-next">5.5 next</h4>

<p>æ­¤æ–¹æ³•ä¸ºè½®è¯¢æ¶ˆæ¯é˜Ÿåˆ—ä¸Šçš„æ¶ˆæ¯ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
</pre></td><td class="rouge-code"><pre><span class="nc">Message</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—å·²ç»é€€å‡ºæˆ–é”€æ¯ï¼Œåœ¨æ­¤å¤„è¿”å›è¿”å›null</span>
    <span class="c1">// è¿™å¯èƒ½å‘ç”Ÿåœ¨åº”ç”¨å°è¯•é‡å¯ä¸€ä¸ªå·²ç»é€€å‡ºçš„looper</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">mPtr</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ä¸º0è¡¨ç¤ºé˜Ÿåˆ—å·²å¤±æ•ˆï¼Œlooperæ”¶åˆ°null</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// å¾…å¤„ç†IdleHandlerè®¡æ•°ï¼Œåœ¨é¦–æ¬¡è¿­ä»£ä¸­ä¸º-1</span>
    <span class="kt">int</span> <span class="n">pendingIdleHandlerCount</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    
    <span class="c1">// é˜»å¡æ—¶é—´:</span>
    <span class="c1">// -1ï¼šä¸€ç›´é˜»å¡ç­‰å¾…æ¶ˆæ¯ï¼› </span>
    <span class="c1">// +0ï¼šä¸é˜»å¡ï¼Œç«‹å³è¿”å›ï¼›</span>
    <span class="c1">// &gt;0ï¼šé˜»å¡æ—¶é—´å…·ä½“æ—¶é•¿ï¼Œå¦‚æœæœ‰ç¨‹åºå”¤é†’åˆ™ç«‹å³è¿”å›ï¼›</span>
    <span class="kt">int</span> <span class="n">nextPollTimeoutMillis</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    
    <span class="c1">// å¾ªç¯</span>
    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">nextPollTimeoutMillis</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Binder</span><span class="o">.</span><span class="na">flushPendingCommands</span><span class="o">();</span>
        <span class="o">}</span>
        
        <span class="c1">// æ¶ˆæ¯åœ¨nextPollTimeoutMillisåå°±ç»ªï¼Œåœ¨æ­¤ç­‰å¾…</span>
        <span class="n">nativePollOnce</span><span class="o">(</span><span class="n">ptr</span><span class="o">,</span> <span class="n">nextPollTimeoutMillis</span><span class="o">);</span>

        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// å°è¯•å–ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œå¹¶åœ¨æˆåŠŸåè¿”å›è¯¥æ¶ˆæ¯</span>
            <span class="c1">// è·å–å½“å‰æ—¶é—´æˆ³ï¼Œé•¿åº¦ä¸ºæ‰‹æœºå·²å¯åŠ¨æ—¶é—´</span>
            <span class="kd">final</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
            <span class="nc">Message</span> <span class="n">prevMsg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>  <span class="c1">// ä¸Šä¸€ä¸ªæ¶ˆæ¯</span>
            <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mMessages</span><span class="o">;</span>

            <span class="c1">// æ¶ˆæ¯ä½“ä¸ä¸ºç©ºï¼Œä½†æ˜¯æ¶ˆæ¯çš„Handlerä¸ºç©º</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// è¯¥æ¶ˆæ¯æ˜¯SyncBarrierï¼Œåˆ™æŸ¥æ‰¾ä¸‹ä¸€æ¡é˜Ÿåˆ—ä¸­çš„å¼‚æ­¥æ¶ˆæ¯</span>
                <span class="c1">// æ‰¾åˆ°çš„æ¶ˆæ¯æ˜¯å¼‚æ­¥æ¶ˆæ¯ï¼Œå¹¶æ‰§è¡Œ</span>
                <span class="k">do</span> <span class="o">{</span>
                    <span class="n">prevMsg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">msg</span><span class="o">.</span><span class="na">isAsynchronous</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="c1">// è·å–çš„æ¶ˆæ¯ä¸ä¸ºç©º</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">now</span> <span class="o">&lt;</span> <span class="n">msg</span><span class="o">.</span><span class="na">when</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// ä¸‹ä¸€æ¡æ¶ˆæ¯å°šæœªå°±ç»ªï¼Œè®¾ç½®è¶…æ—¶å¹¶åœ¨æ¶ˆæ¯å°±ç»ªæ—¶å”¤é†’</span>
                    <span class="n">nextPollTimeoutMillis</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="nc">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">when</span> <span class="o">-</span> <span class="n">now</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="c1">// å¯è·å–æ¶ˆæ¯ï¼ŒçŠ¶æ€æ”¹ä¸ºéé˜»å¡</span>
                    <span class="n">mBlocked</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="c1">// msgä»é˜Ÿåˆ—ä¸­è§£é™¤é“¾æ¥å¹¶å‡ºé˜Ÿ</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">prevMsg</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// msgæ˜¯ä¸­é—´èŠ‚ç‚¹</span>
                        <span class="n">prevMsg</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="c1">// msgæ˜¯å¤´èŠ‚ç‚¹ï¼Œmsgä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºé˜Ÿå¤´æ¶ˆæ¯</span>
                        <span class="n">mMessages</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="c1">// è§£é™¤å¯¹ä¸‹ä¸€ä¸ªæ¶ˆæ¯çš„å¼•ç”¨</span>
                    <span class="n">msg</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="c1">// æ¶ˆæ¯æ ‡è®°ä¸ºFLAG_IN_USE</span>
                    <span class="n">msg</span><span class="o">.</span><span class="na">markInUse</span><span class="o">();</span>
                    <span class="c1">// è¿”å›è¯¥æ¶ˆæ¯ï¼Œäº¤ç»™Looper</span>
                    <span class="k">return</span> <span class="n">msg</span><span class="o">;</span>
                    <span class="c1">// è¿›å…¥ä¸‹ä¸€æ¬¡è½®è¯¢</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// æ²¡æœ‰æ›´å¤šæ¶ˆæ¯</span>
                <span class="n">nextPollTimeoutMillis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">// é˜Ÿåˆ—å·²ç»æ ‡è®°ä¸ºé€€å‡ºä¸­ï¼Œåˆ™è°ƒç”¨é˜Ÿåˆ—çš„é”€æ¯æ–¹æ³•</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mQuitting</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">dispose</span><span class="o">();</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">// å¦‚æœæ˜¯é¦–æ¬¡é—²ç½®ï¼Œè·å–é—²ç½®è€…æ•°é‡</span>
            <span class="c1">// IdleHandlersä»…åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–é˜Ÿåˆ—å¤´æ¶ˆæ¯åœ¨å°†æ¥æŸä¸ªæ—¶é—´ç‚¹æ‰å¤„ç†æ—¶è¿è¡Œ</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pendingIdleHandlerCount</span> <span class="o">&lt;</span> <span class="mi">0</span>
                    <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">mMessages</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">mMessages</span><span class="o">.</span><span class="na">when</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// æ›´æ–°IdleHandleræ•°é‡</span>
                <span class="n">pendingIdleHandlerCount</span> <span class="o">=</span> <span class="n">mIdleHandlers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">pendingIdleHandlerCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// æ²¡æœ‰å¯è¿è¡ŒIdleHandlerï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯</span>
                <span class="n">mBlocked</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">// pendingIdleHandlerCount &gt; 0 ä¸” mPendingIdleHandlers == null</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mPendingIdleHandlers</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// æ„å»ºæ•°ç»„ï¼Œé•¿åº¦æœ€å°ä¸º4</span>
                <span class="n">mPendingIdleHandlers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IdleHandler</span><span class="o">[</span><span class="nc">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">pendingIdleHandlerCount</span><span class="o">,</span> <span class="mi">4</span><span class="o">)];</span>
            <span class="o">}</span>

            <span class="c1">// ä»mIdleHandlersè·å–å¯¹è±¡ï¼Œæ”¾å…¥mPendingIdleHandlersæ•°ç»„</span>
            <span class="n">mPendingIdleHandlers</span> <span class="o">=</span> <span class="n">mIdleHandlers</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="n">mPendingIdleHandlers</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// æ‰§è¡ŒIdleHandlerï¼Œåªåœ¨ç¬¬ä¸€æ¬¡è¿­ä»£æœŸé—´åˆ°è¾¾æ­¤ä»£ç å—</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pendingIdleHandlerCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="c1">// è·å–ä¸‹æ ‡å¯¹åº”IdleHandler</span>
            <span class="kd">final</span> <span class="nc">IdleHandler</span> <span class="n">idler</span> <span class="o">=</span> <span class="n">mPendingIdleHandlers</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="c1">// é‡Šæ”¾æ•°ç»„å¯¹handlerçš„å¼•ç”¨</span>
            <span class="n">mPendingIdleHandlers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

            <span class="kt">boolean</span> <span class="n">keep</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// æ‰§è¡ŒIdleHandlerçš„queueIdle()å¾—åˆ°æ‰§è¡Œå€¼keepï¼Œè¯¥å€¼ç”±å­ç±»é‡å†™å¹¶è¿”å›</span>
                <span class="c1">// ç”±äºå­ç±»é‡å†™queueIdle()ï¼Œå¯åœ¨è¯¥æ–¹æ³•å†…è·å¾—ç©ºé—²çŠ¶æ€çš„é€šçŸ¥</span>
                <span class="n">keep</span> <span class="o">=</span> <span class="n">idler</span><span class="o">.</span><span class="na">queueIdle</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// æ•è·IdleHandlerå†…å¼‚å¸¸ï¼Œé¿å…ç»ˆæ­¢MessageQueueè¿è¡Œ</span>
                <span class="nc">Log</span><span class="o">.</span><span class="na">wtf</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"IdleHandler threw exception"</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// æ£€æŸ¥æ˜¯å¦éœ€è¦ç§»é™¤è¯¥IdleHandler</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">keep</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mIdleHandlers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">idler</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// é‡ç½®æ•°é‡ï¼Œä»¥ä¾¿ä¸å†è¿è¡Œå®ƒä»¬</span>
        <span class="n">pendingIdleHandlerCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="c1">// å¤„ç†IdleHandleræ—¶å¯èƒ½æœ‰æ–°æ¶ˆæ¯åˆ†å‘ï¼Œæ‰€ä»¥ä¸‹ä¸€è½®ç›´æ¥è·å–æ¶ˆæ¯ä¸åšé˜»å¡ç­‰å¾…</span>
        <span class="n">nextPollTimeoutMillis</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœ <strong>next()</strong> å·²ç»™ <strong>Looper</strong> è¿”å›æœ‰æ•ˆæ¶ˆæ¯ï¼Œ<strong>Looper</strong> åœ¨æ¶ˆè´¹ <strong>Message</strong> åä¼šé‡æ–°è°ƒç”¨ <strong>next()</strong>ï¼Œå¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">loop</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Looper</span> <span class="n">me</span> <span class="o">=</span> <span class="n">myLooper</span><span class="o">();</span>

    <span class="c1">// Looperæ²¡æœ‰é€šè¿‡prepare()æ–¹æ³•åˆå§‹åŒ–</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">me</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"No Looper; Looper.prepare() wasn't called on this thread."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ä»Looperä¸­è·å–å…¶MessageQueue</span>
    <span class="kd">final</span> <span class="nc">MessageQueue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="na">mQueue</span><span class="o">;</span>
    <span class="nc">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span> <span class="c1">// ç¡®ä¿çº¿ç¨‹å°±æ˜¯æœ¬åœ°çº¿ç¨‹ï¼Œå¹¶å®æ—¶è·Ÿè¸ªçº¿ç¨‹èº«ä»½</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">ident</span> <span class="o">=</span> <span class="nc">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>
    
    <span class="c1">// å¾ªç¯éå†ï¼Œä»æ¶ˆæ¯é˜Ÿåˆ—å–æ¶ˆæ¯</span>
    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
        <span class="c1">// å¦‚æœé˜Ÿåˆ—æ²¡æœ‰æ¶ˆæ¯ï¼Œqueue.next()å†…éƒ¨ä¼šé˜»å¡ç­‰å¾…</span>
        <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>

        <span class="c1">// é˜Ÿåˆ—è¿”å›nullè¡¨æ˜æ¶ˆæ¯é˜Ÿåˆ—å·²ç»å…³é—­ï¼Œé€€å‡ºloop()çš„æ­»å¾ªç¯</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span> <span class="c1">// æ¶ˆæ¯é˜Ÿåˆ—å…³é—­ï¼ŒLooperé€€å‡º</span>
        <span class="o">}</span>

        <span class="c1">// é€šè¿‡å¯¹åº”çš„Handlerè¿›è¡Œå›è°ƒ</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">target</span><span class="o">.</span><span class="na">dispatchMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>

        <span class="c1">// ç¡®ä¿æ¶ˆæ¯åœ¨åˆ†å‘çš„æ—¶å€™çº¿ç¨‹æ²¡æœ‰æ”¹å˜</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">newIdent</span> <span class="o">=</span> <span class="nc">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ident</span> <span class="o">!=</span> <span class="n">newIdent</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Log</span><span class="o">.</span><span class="na">wtf</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Thread identity changed from 0x"</span>
                    <span class="o">+</span> <span class="nc">Long</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">ident</span><span class="o">)</span> <span class="o">+</span> <span class="s">" to 0x"</span>
                    <span class="o">+</span> <span class="nc">Long</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">newIdent</span><span class="o">)</span> <span class="o">+</span> <span class="s">" while dispatching to "</span>
                    <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" "</span>
                    <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">callback</span> <span class="o">+</span> <span class="s">" what="</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// æ¶ˆæ¯ä½“å›æ”¶</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">recycleUnchecked</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è™½ç„¶ <strong>MessageQueue</strong> çš„ <strong>next()</strong> æ–¹æ³•å†… <strong>IdleHandlers</strong> åªè§¦å‘ä¸€æ¬¡ï¼Œä½†æ˜¯ç”±äº <strong>Looper</strong> å¾ªç¯è°ƒç”¨ <strong>MessageQueue.next()</strong>ï¼Œæ‰€ä»¥ <strong>IdleHandlers</strong> åœ¨ç©ºé—²æ—¶é—´èƒ½è¢«æŒç»­é€šçŸ¥ã€‚</p>

<h4 id="56-quit">5.6 quit</h4>

<p>é€€å‡ºæ¶ˆæ¯é˜Ÿåˆ—ã€‚å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—è®¾ç½®ä¸ºä¸å…è®¸é€€å‡ºï¼Œè°ƒç”¨æ­¤æ–¹æ³•ä¼šæŠ›å‡º <strong>IllegalStateException</strong> å¼‚å¸¸ã€‚å…¸å‹å®ç°æ˜¯ä¸»çº¿ç¨‹ä¸å…è®¸é€€å‡ºï¼Œå› ä¸ºé€€å‡ºä¼šå¯¼è‡´æ¶ˆæ¯ä¸èƒ½è¿›å…¥ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p>

<p>è‹¥ <strong>safe</strong> å€¼ä¸ºtrueï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¼šæŠŠæ‰€æœ‰åˆ°è¾¾æ‰§è¡Œæ—¶é—´ç‚¹çš„æ¶ˆæ¯å…¨éƒ¨å¤„ç†å®Œæ¯•å†é€€å‡ºï¼ŒæŠ›å¼ƒæ²¡æœ‰åˆ°è¾¾æ—¶é—´ç‚¹çš„æ¶ˆæ¯ã€‚å¦åˆ™æ‰€æœ‰æ¶ˆæ¯ç›´æ¥æŠ›å¼ƒï¼Œä¸ç®¡æ˜¯å¦éœ€è¦æ‰§è¡Œã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">quit</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">safe</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">mQuitAllowed</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Main thread not allowed to quit."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—æ­£åœ¨é€€å‡ºï¼Œåˆ™æ— éœ€æ‰§è¡Œç¬¬äºŒéé€€å‡º</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mQuitting</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">mQuitting</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">safe</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// å¯èƒ½ä¼šæœ‰æ¶ˆæ¯éœ€è¦ç»§ç»­åˆ†å‘</span>
            <span class="n">removeAllFutureMessagesLocked</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">removeAllMessagesLocked</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// We can assume mPtr != 0 because mQuitting was previously false.</span>
        <span class="n">nativeWake</span><span class="o">(</span><span class="n">mPtr</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="57-syncbarrier">5.7 SyncBarrier</h4>

<p>é€šè¿‡æ­¤æ–¹æ³•å‘æ¶ˆæ¯é˜Ÿåˆ—æäº¤ <strong>SyncBarrier</strong>ã€‚é™¤éé‡åˆ°å·²ç»æäº¤çš„ <strong>SyncBarrier</strong>ï¼Œå¦åˆ™æ¶ˆæ¯åƒå¾€å¸¸ä¸€æ ·æ­£å¸¸å¤„ç†ã€‚é‡åˆ° <strong>SyncBarrier</strong> æ—¶ï¼Œåœ¨ <strong>SyncBarrier</strong> åé¢çš„åŒæ­¥æ¶ˆæ¯ä¼šè¢«é˜»å¡å¹¶æ— æ³•æ‰§è¡Œã€‚ç›´åˆ°è°ƒç”¨æ–¹æ³• <strong>removeSyncBarrier</strong>ï¼Œå³ç”¨ <strong>token</strong> æŠŠåŒ¹é…çš„ <strong>SyncBarrier</strong> ç§»é™¤ï¼Œåˆ™åŒæ­¥æ¶ˆæ¯ç»§ç»­åˆ†å‘ã€‚</p>

<p>æ­¤æ–¹æ³•ç”¨äºç«‹å³é˜»æ­¢åç»­åŒæ­¥æ¶ˆæ¯æ‰§è¡Œï¼Œç›´åˆ°æ¶ˆæ¯é˜Ÿåˆ—æ”¶åˆ°é‡Šæ”¾ <strong>SyncBarrier</strong> çš„æ¡ä»¶ã€‚è€ŒéåŒæ­¥æ¶ˆæ¯(å¼‚æ­¥æ¶ˆæ¯)ä¸ä¼šå—åˆ° <strong>SyncBarrier</strong> å½±å“ï¼Œä¿æŒæ­£å¸¸æ‰§è¡Œã€‚</p>

<p>æ¯æ¬¡ <strong>postSyncBarrier()</strong> ä¼šè¿”å›å¯¹åº”çš„ã€ç‹¬ä¸€æ— äºŒçš„ <strong>token</strong>ï¼Œå¿…è¦æ—¶éœ€ç”¨è¯¥tokenè°ƒç”¨ <strong>removeSyncBarrier</strong> ç§»é™¤å·²æ’å…¥ <strong>SyncBarrier</strong> ä»¥ä¿è¯æ¶ˆæ¯é˜Ÿåˆ—é‡æ–°è¿è½¬ï¼Œä¸ç„¶ä¼šå¯¼è‡´æ¶ˆæ¯é˜Ÿåˆ—æŒç»­æŒ‚èµ·ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">int</span> <span class="nf">postSyncBarrier</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">postSyncBarrier</span><span class="o">(</span><span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">());</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ–° <strong>SyncBarrier</strong> è¿›å…¥é˜Ÿåˆ—ï¼Œä¸”ä¸éœ€å”¤é†’é˜Ÿåˆ—ï¼Œå› ä¸º <strong>SyncBarrier</strong> å°±æ˜¯è®©é˜Ÿåˆ—åœä¸‹ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">int</span> <span class="nf">postSyncBarrier</span><span class="o">(</span><span class="kt">long</span> <span class="n">when</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// è·å–ä¸‹ä¸€ä¸ªSyncBarrierçš„token</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">token</span> <span class="o">=</span> <span class="n">mNextBarrierToken</span><span class="o">++;</span>
        <span class="c1">// ä»ç¼“å­˜æ± è·å–ç©ºMessage</span>
        <span class="kd">final</span> <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="nc">Message</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
        <span class="c1">// åˆå§‹åŒ–å‚æ•°ï¼Œä¸”Message.targetä¸ºç©º</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">markInUse</span><span class="o">();</span>
        <span class="c1">// é˜»å¡whenæ—¶é—´æˆ³ä¹‹åçš„åŒæ­¥äº‹ä»¶ï¼Œå°äºwhençš„åŒæ­¥äº‹ä»¶åœ¨msgä¹‹å‰ä¸å—é˜»å¡</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">when</span> <span class="o">=</span> <span class="n">when</span><span class="o">;</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">arg1</span> <span class="o">=</span> <span class="n">token</span><span class="o">;</span>

        <span class="nc">Message</span> <span class="n">prev</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">Message</span> <span class="n">p</span> <span class="o">=</span> <span class="n">mMessages</span><span class="o">;</span>

        <span class="c1">// æŸ¥æ‰¾æ­£ç¡®é˜Ÿåˆ—ä½ç½®æ’å…¥</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">when</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">when</span> <span class="o">&lt;=</span> <span class="n">when</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// whenä¸ä¸º0ï¼Œä»¤prev != nullï¼Œæ‰€ä»¥æ¶ˆæ¯æ’å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ï¼›</span>
        <span class="c1">// æ’åœ¨SyncBarrierå‰çš„åŒæ­¥Messageä¸å—å½±å“ï¼Œä»…åæ–¹åŒæ­¥Messageå—å½±å“ï¼›</span>
        <span class="c1">// Messageå¼‚æ­¥æ¶ˆæ¯æ°¸è¿œä¸å—SyncBarrierå½±å“ï¼›</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// invariant: p == prev.next</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
            <span class="n">prev</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// whenä¸º0ï¼Œä»¤prev == nullï¼Œæ‰€ä»¥ç›´æ¥æ’å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—å¤´éƒ¨</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
            <span class="n">mMessages</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// è¿”å›æ’å…¥æˆåŠŸSyncBarrierçš„token</span>
        <span class="k">return</span> <span class="n">token</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ ¹æ® <strong>token</strong> ç§»é™¤ <strong>SyncBarrier</strong>ã€‚å½“æ‰¾ä¸åˆ°å¯¹åº” <strong>SyncBarrier</strong> æ—¶æŠ›å‡º <strong>IllegalStateException</strong> å¼‚å¸¸ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeSyncBarrier</span><span class="o">(</span><span class="kt">int</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// å¦‚æœé˜Ÿåˆ—ä¸å—SyncBarrieré˜»å¡ï¼Œå¹¶é‡æ–°å”¤é†’é˜Ÿåˆ—</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Message</span> <span class="n">prev</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">Message</span> <span class="n">p</span> <span class="o">=</span> <span class="n">mMessages</span><span class="o">;</span>

        <span class="c1">// æŸ¥æ‰¾è¯¥ç›®æ ‡SyncBarrier</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">target</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">p</span><span class="o">.</span><span class="na">arg1</span> <span class="o">!=</span> <span class="n">token</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
        <span class="o">}</span>
        
        <span class="c1">// æ‰¾ä¸åˆ°ç›®æ ‡SyncBarrierï¼ŒæŠ›å‡ºIllegalStateExceptionå¼‚å¸¸</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"The specified message queue synchronization "</span>
                    <span class="o">+</span> <span class="s">" barrier token has not been posted or has already been removed."</span><span class="o">);</span>
        <span class="o">}</span>
        
        <span class="c1">// æ‰¾åˆ°ç›®æ ‡SyncBarrierï¼ŒneedWakeå†³å®šæ˜¯å¦éœ€è¦å”¤é†’æ¶ˆæ¯é˜Ÿåˆ—</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">needWake</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// pä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è§£é™¤é“¾æ¥</span>
            <span class="n">prev</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="c1">// SyncBarrierå‰æœ‰æ¶ˆæ¯å¯å–ï¼Œä¸éœ€å”¤é†’é˜Ÿåˆ—</span>
            <span class="n">needWake</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">mMessages</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="c1">// ä¸‹ä¸€ä¸ªæ¶ˆæ¯ä¸ºç©ºï¼Œæˆ–æ¶ˆæ¯çš„targetä¸ä¸ºç©ºï¼Œéœ€è¦å”¤é†’é˜Ÿåˆ—</span>
            <span class="c1">// æ³¨ï¼šæ¶ˆæ¯çš„targetä¸ä¸ºç©ºï¼Œè¡¨ç¤ºä¸‹ä¸€ä¸ªæ¶ˆæ¯ä¸æ˜¯SyncBarrier</span>
            <span class="n">needWake</span> <span class="o">=</span> <span class="n">mMessages</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">mMessages</span><span class="o">.</span><span class="na">target</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// å›æ”¶Message</span>
        <span class="n">p</span><span class="o">.</span><span class="na">recycleUnchecked</span><span class="o">();</span>

        <span class="c1">// å¾ªç¯åœ¨é€€å‡ºæ—¶æ¶ˆæ¯é˜Ÿåˆ—å·²ç»å”¤é†’ï¼Œåˆ™å–æ¶ˆå”¤é†’</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">needWake</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mQuitting</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// mQuitting ä¸º falseï¼Œå¯ä»¥å‡è®¾mPtr != 0</span>
            <span class="n">nativeWake</span><span class="o">(</span><span class="n">mPtr</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="58-messages">5.8 Messages</h4>

<p>æ¶ˆæ¯åœ¨ä» <strong>Looper</strong> é€å…¥æ¶ˆæ¯é˜Ÿåˆ—</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre></td><td class="rouge-code"><pre><span class="kt">boolean</span> <span class="nf">enqueueMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">long</span> <span class="n">when</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Message.targetä¸ºç©ºï¼Œå³Messageçš„Handlerä¸ºç©ºï¼ŒæŠ›å‡ºIllegalArgumentExceptionå¼‚å¸¸</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Message must have a target."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// æ¶ˆæ¯å·²åœ¨ä½¿ç”¨ï¼ŒæŠ›å‡ºIllegalStateExceptionå¼‚å¸¸</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">isInUse</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s">" This message is already in use."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// æ¶ˆæ¯é˜Ÿåˆ—åœ¨é€€å‡ºæ—¶æœ‰æ–°æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—ï¼ŒæŠ›å¼ƒè¯¥æ¶ˆæ¯å¹¶æ‰“å‡ºæ—¥å¿—</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mQuitting</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">IllegalStateException</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IllegalStateException</span><span class="o">(</span>
                    <span class="n">msg</span><span class="o">.</span><span class="na">target</span> <span class="o">+</span> <span class="s">" sending message to a Handler on a dead thread"</span><span class="o">);</span>
            <span class="nc">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="c1">// å›æ”¶è¯¥æ¶ˆæ¯</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// æ¶ˆæ¯æ­£åœ¨ä½¿ç”¨</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">markInUse</span><span class="o">();</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">when</span> <span class="o">=</span> <span class="n">when</span><span class="o">;</span>
        <span class="nc">Message</span> <span class="n">p</span> <span class="o">=</span> <span class="n">mMessages</span><span class="o">;</span>
        <span class="kt">boolean</span> <span class="n">needWake</span><span class="o">;</span>

        <span class="c1">// p == null: æ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©º</span>
        <span class="c1">// when == 0: æ–°æ’å…¥çš„æ¶ˆæ¯éœ€è¦é©¬ä¸Šæ‰§è¡Œ</span>
        <span class="c1">// when &lt; p.when: æ’å…¥æ¶ˆæ¯çš„æ—¶é—´æˆ³å°äºé˜Ÿåˆ—å¤´éƒ¨æ¶ˆæ¯çš„æ—¶é—´æˆ³</span>
        <span class="c1">// ä¸Šè¿°ä¸‰ç§æƒ…å†µï¼Œéƒ½éœ€è¦æŠŠæ–°æ¶ˆæ¯æ’å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„é¦–éƒ¨</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">when</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">when</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">.</span><span class="na">when</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// å¤´æ’æ³•æ’å…¥æ–°æ¶ˆæ¯ï¼Œå¹¶å”¤é†’äº‹ä»¶é˜Ÿåˆ—</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
            <span class="n">mMessages</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
            <span class="c1">// è‹¥é˜Ÿåˆ—å·²é˜»å¡ï¼Œå°è¯•å”¤é†’</span>
            <span class="n">needWake</span> <span class="o">=</span> <span class="n">mBlocked</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// æ¶ˆæ¯æ’å…¥å¯¹é˜Ÿåˆ—ä¸­é—´è€Œä¸æ˜¯å¤´éƒ¨ï¼›</span>
            <span class="c1">// ä¸€èˆ¬æ˜¯ä¸éœ€è¦å”¤é†’æ¶ˆæ¯é˜Ÿåˆ—çš„ï¼›</span>
            <span class="c1">// é™¤éé˜Ÿåˆ—å¤´éƒ¨æœ‰SyncBarrier(å³ p.target == null)</span>
            <span class="c1">// ä¸”msgæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ€æ—©çš„å¼‚æ­¥æ¶ˆæ¯(å³ msg.isAsynchronous())</span>
            <span class="n">needWake</span> <span class="o">=</span> <span class="n">mBlocked</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">.</span><span class="na">isAsynchronous</span><span class="o">();</span>
            <span class="nc">Message</span> <span class="n">prev</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
                <span class="c1">// æŸ¥æ‰¾åˆé€‚çš„æ’å…¥ä½ç½®</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">when</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">.</span><span class="na">when</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">needWake</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">isAsynchronous</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">needWake</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// æ¶ˆæ¯æ’å…¥åˆ°pä¹‹å‰ï¼Œprevä¹‹å</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span> <span class="c1">// invariant: p == prev.next</span>
            <span class="n">prev</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
        <span class="o">}</span>
        
        <span class="c1">// æ‰§è¡Œåˆ°è¿™é‡ŒmQuittingè‚¯å®šä¸ºfalseï¼Œæ‰€ä»¥èƒ½å‡è®¾mPtr != 0</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">needWake</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">nativeWake</span><span class="o">(</span><span class="n">mPtr</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šæ¶ˆæ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kt">boolean</span> <span class="nf">hasMessages</span><span class="o">(</span><span class="nc">Handler</span> <span class="n">h</span><span class="o">,</span> <span class="kt">int</span> <span class="n">what</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Message</span> <span class="n">p</span> <span class="o">=</span> <span class="n">mMessages</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">what</span> <span class="o">==</span> <span class="n">what</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">p</span><span class="o">.</span><span class="na">obj</span> <span class="o">==</span> <span class="n">object</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šæ¶ˆæ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kt">boolean</span> <span class="nf">hasMessages</span><span class="o">(</span><span class="nc">Handler</span> <span class="n">h</span><span class="o">,</span> <span class="nc">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Message</span> <span class="n">p</span> <span class="o">=</span> <span class="n">mMessages</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// åŒ¹é…Message.targetã€Message.callbackã€Message.objä¸‰ä¸ªå˜é‡</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">callback</span> <span class="o">==</span> <span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">p</span><span class="o">.</span><span class="na">obj</span> <span class="o">==</span> <span class="n">object</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// æ£€æŸ¥ä¸‹ä¸€ä¸ªæ¶ˆæ¯</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// æ²¡æœ‰æ‰¾åˆ°åŒ¹é…æ¶ˆæ¯</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æŸ¥æ‰¾æ˜¯å¦æœ‰ç›®æ ‡ä¸ºæŒ‡å®š <strong>Handler</strong> çš„æ¶ˆæ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kt">boolean</span> <span class="nf">hasMessages</span><span class="o">(</span><span class="nc">Handler</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Message</span> <span class="n">p</span> <span class="o">=</span> <span class="n">mMessages</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// åŒ¹é…Message.targetæ˜¯å¦ä¸ºæ‰§è¡ŒHandler</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// æ£€æŸ¥ä¸‹ä¸€ä¸ªæ¶ˆæ¯</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç§»é™¤æŒ‡å®šæ¶ˆæ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">removeMessages</span><span class="o">(</span><span class="nc">Handler</span> <span class="n">h</span><span class="o">,</span> <span class="kt">int</span> <span class="n">what</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Handlerä¸ºç©ºåˆ™ç›´æ¥é€€å‡º</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Message</span> <span class="n">p</span> <span class="o">=</span> <span class="n">mMessages</span><span class="o">;</span>

        <span class="c1">// ä»æ¶ˆæ¯é˜Ÿåˆ—å¤´ç»“ç‚¹å¼€å§‹åŒ¹é…ï¼Œå¦‚æœé˜Ÿåˆ—å¤´è¿ç»­å‡ ä¸ªæ¶ˆæ¯åŒ¹é…å¹¶ç§»é™¤ï¼Œéœ€ä¿®æ”¹mMessagesçš„å¼•ç”¨</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">what</span> <span class="o">==</span> <span class="n">what</span>
               <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">p</span><span class="o">.</span><span class="na">obj</span> <span class="o">==</span> <span class="n">object</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Message</span> <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="n">mMessages</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span> <span class="c1">// è¿™é‡Œå¤„ç†æ¶ˆæ¯å¤´å¼•ç”¨</span>
            <span class="n">p</span><span class="o">.</span><span class="na">recycleUnchecked</span><span class="o">();</span> <span class="c1">// æ¶ˆæ¯ç›´æ¥å›æ”¶åˆ°Messageç¼“å­˜æ± </span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// åŒ¹é…æ¶ˆæ¯é˜Ÿåˆ—åé¢èŠ‚ç‚¹</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Message</span> <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">n</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">.</span><span class="na">what</span> <span class="o">==</span> <span class="n">what</span>
                    <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">n</span><span class="o">.</span><span class="na">obj</span> <span class="o">==</span> <span class="n">object</span><span class="o">))</span> <span class="o">{</span>
                    <span class="nc">Message</span> <span class="n">nn</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                    <span class="n">n</span><span class="o">.</span><span class="na">recycleUnchecked</span><span class="o">();</span>
                    <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">nn</span><span class="o">;</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç§»é™¤æŒ‡å®šæ¶ˆæ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">removeMessages</span><span class="o">(</span><span class="nc">Handler</span> <span class="n">h</span><span class="o">,</span> <span class="nc">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Message</span> <span class="n">p</span> <span class="o">=</span> <span class="n">mMessages</span><span class="o">;</span>

        <span class="c1">// ä»æ¶ˆæ¯é˜Ÿåˆ—å¤´ç»“ç‚¹å¼€å§‹åŒ¹é…ï¼Œå¦‚æœé˜Ÿåˆ—å¤´è¿ç»­å‡ ä¸ªæ¶ˆæ¯åŒ¹é…å¹¶ç§»é™¤ï¼Œéœ€ä¿®æ”¹mMessagesçš„å¼•ç”¨</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">callback</span> <span class="o">==</span> <span class="n">r</span>
               <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">p</span><span class="o">.</span><span class="na">obj</span> <span class="o">==</span> <span class="n">object</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Message</span> <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="n">mMessages</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span> <span class="c1">// è¿™é‡Œå¤„ç†æ¶ˆæ¯å¤´å¼•ç”¨</span>
            <span class="c1">// åŒ¹é…æ¶ˆæ¯pä»é˜Ÿåˆ—ä¸­ç§»é™¤</span>
            <span class="n">p</span><span class="o">.</span><span class="na">recycleUnchecked</span><span class="o">();</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// åŒ¹é…æ¶ˆæ¯é˜Ÿåˆ—åé¢èŠ‚ç‚¹</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Message</span> <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">n</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">.</span><span class="na">callback</span> <span class="o">==</span> <span class="n">r</span>
                    <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">n</span><span class="o">.</span><span class="na">obj</span> <span class="o">==</span> <span class="n">object</span><span class="o">))</span> <span class="o">{</span>
                    <span class="nc">Message</span> <span class="n">nn</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                    <span class="c1">// åŒ¹é…æ¶ˆæ¯nä»é˜Ÿåˆ—ä¸­ç§»é™¤</span>
                    <span class="n">n</span><span class="o">.</span><span class="na">recycleUnchecked</span><span class="o">();</span>
                    <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">nn</span><span class="o">;</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€šè¿‡æ¶ˆæ¯çš„ <strong>Handler</strong> å’Œ <strong>Object</strong> ç§»é™¤æŒ‡å®šæ¶ˆæ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">removeCallbacksAndMessages</span><span class="o">(</span><span class="nc">Handler</span> <span class="n">h</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Message</span> <span class="n">p</span> <span class="o">=</span> <span class="n">mMessages</span><span class="o">;</span>

        <span class="c1">// ä»æ¶ˆæ¯é˜Ÿåˆ—å¤´ç»“ç‚¹å¼€å§‹åŒ¹é…ï¼Œå¦‚æœé˜Ÿåˆ—å¤´è¿ç»­å‡ ä¸ªæ¶ˆæ¯åŒ¹é…å¹¶ç§»é™¤ï¼Œéœ€ä¿®æ”¹mMessagesçš„å¼•ç”¨</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="n">h</span>
                <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">p</span><span class="o">.</span><span class="na">obj</span> <span class="o">==</span> <span class="n">object</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Message</span> <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="n">mMessages</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span> <span class="c1">// è¿™é‡Œå¤„ç†æ¶ˆæ¯å¤´å¼•ç”¨</span>
            <span class="n">p</span><span class="o">.</span><span class="na">recycleUnchecked</span><span class="o">();</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// åŒ¹é…æ¶ˆæ¯é˜Ÿåˆ—åé¢èŠ‚ç‚¹</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Message</span> <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">n</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">n</span><span class="o">.</span><span class="na">obj</span> <span class="o">==</span> <span class="n">object</span><span class="o">))</span> <span class="o">{</span>
                    <span class="nc">Message</span> <span class="n">nn</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                    <span class="n">n</span><span class="o">.</span><span class="na">recycleUnchecked</span><span class="o">();</span>
                    <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">nn</span><span class="o">;</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨æ­¤æ–¹æ³•è°ƒç”¨å‰å·²ç»å¯¹mMessagesä¸Šé”ï¼Œç„¶åæ¸…ç†é˜Ÿåˆ—æ‰€æœ‰æ¶ˆæ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">removeAllMessagesLocked</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Message</span> <span class="n">p</span> <span class="o">=</span> <span class="n">mMessages</span><span class="o">;</span>
    <span class="c1">// å¾ªç¯å¤„ç†å¹¶å›æ”¶Message</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Message</span> <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
        <span class="n">p</span><span class="o">.</span><span class="na">recycleUnchecked</span><span class="o">();</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">mMessages</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç§»é™¤æ‰€æœ‰åˆ°è¾¾æ—¶é—´ç‚¹çš„æ¶ˆæ¯åˆ†å‘æ‰§è¡Œï¼Œå‰©ä½™æ¶ˆæ¯å…¨éƒ¨å›æ”¶</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">removeAllFutureMessagesLocked</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// è·å–å½“å‰æ—¶é—´æˆ³</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>

    <span class="c1">// é˜Ÿåˆ—å¤´æ¶ˆæ¯</span>
    <span class="nc">Message</span> <span class="n">p</span> <span class="o">=</span> <span class="n">mMessages</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// é˜Ÿåˆ—å¤´éƒ¨æ¶ˆæ¯æ²¡åˆ°æ‰§è¡Œæ—¶é—´ç‚¹ï¼Œåˆ™ç§»é™¤æ‰€æœ‰æ¶ˆæ¯</span>
        <span class="c1">// å› ä¸ºé˜Ÿåˆ—åé¢çš„æ¶ˆæ¯ä¸€å®šä¸ä¼šæ¯”å¤´æ¶ˆæ¯æ›´æ—©æ‰§è¡Œ</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">when</span> <span class="o">&gt;</span> <span class="n">now</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">removeAllMessagesLocked</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// é˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯å·²ç»åˆ°è¾¾æ‰§è¡Œæ—¶é—´ç‚¹</span>
            <span class="nc">Message</span> <span class="n">n</span><span class="o">;</span>
            <span class="c1">// éå†æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</span>
            <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                <span class="c1">// nä¸ºç©ºè¡¨ç¤ºé˜Ÿåˆ—æ²¡æœ‰æ›´å¤šæ¶ˆæ¯</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="c1">// åˆ°è¾¾æ‰§è¡Œæ—¶é—´ç‚¹çš„æ¶ˆæ¯ä¸ç§»é™¤é˜Ÿåˆ—</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">n</span><span class="o">.</span><span class="na">when</span> <span class="o">&gt;</span> <span class="n">now</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

            <span class="c1">// ä¸åˆ°å¤„ç†æ—¶é—´ç‚¹çš„æ¶ˆæ¯å…¨éƒ¨å›æ”¶</span>
            <span class="k">do</span> <span class="o">{</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                <span class="n">p</span><span class="o">.</span><span class="na">recycleUnchecked</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">n</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å…­idlehandler">å…­ã€IdleHandler</h2>

<p>ç”¨äºå‘ç°çº¿ç¨‹åœ¨ç­‰å¾…æ¶ˆæ¯è€Œé˜»å¡çš„å›è°ƒæ¥å£ï¼Œå½“æ¶ˆæ¯é˜Ÿåˆ—æ²¡æœ‰æ¶ˆæ¯å¯ä»¥åˆ†å‘æ—¶è°ƒç”¨æœ¬æ¥å£ã€‚</p>

<p>æŠ½è±¡æ–¹æ³• <strong>queueIdle()</strong> è¿”å›trueï¼Œæœ¬ <strong>IdleHandler</strong> æŒç»­æœ‰æ•ˆï¼›è¿”å›falseï¼ŒæŠ½è±¡æ–¹æ³•è°ƒç”¨å <strong>IdleHandler</strong> è¢«ç§»é™¤ã€‚æœ¬æ–¹æ³•å¯èƒ½ä¼šå‘ç”Ÿåœ¨å°šæœ‰æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…çš„æƒ…å†µï¼Œä¸è¿‡è¿™äº›æ¶ˆæ¯éƒ½å®‰æ’åœ¨æœªæ¥æ—¶é—´ç‚¹åˆ†å‘</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">IdleHandler</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="nf">queueIdle</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸ƒonfiledescriptoreventlistener">ä¸ƒã€OnFileDescriptorEventListener</h2>

<p>å½“æ–‡ä»¶æè¿°ç¬¦ç›¸å…³äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œäº‹ä»¶ç›‘å¬å™¨è¢«å›è°ƒ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OnFileDescriptorEventListener</span> <span class="o">{</span>
    <span class="c1">// è¾“å…¥äº‹ä»¶ï¼šè¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦å·²å‡†å¤‡å¥½è¿›è¡Œè¾“å…¥æ“ä½œï¼Œä¾‹å¦‚è¯»å–ï¼›</span>
    <span class="c1">// ç›‘å¬å™¨è¦ä»æ–‡ä»¶æè¿°ç¬¦è¯»å–æ‰€æœ‰æœ‰æ•ˆæ•°æ®ï¼Œå¹¶è¿”å›trueä»¤ç›‘å¬å™¨ä¿æŒå­˜æ´»ï¼Œæˆ–falseç§»é™¤ç›‘å¬å™¨ï¼›</span>
    <span class="c1">// å¯¹Socketæ¥è¯´ï¼Œæ­¤äº‹ä»¶è¡¨ç¤ºç›‘å¬å™¨è‡³å°‘æœ‰ä¸€ä¸ªç­‰å¾…æ¥å…¥çš„è¿æ¥ï¼›</span>
    <span class="c1">// æ­¤äº‹ä»¶åªä¼šåœ¨å·²æ·»åŠ ç›‘å¬å™¨ï¼Œä¸”æŒ‡å®šæ­¤å€¼æƒ…å†µä¸‹äº§ç”Ÿï¼›</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">EVENT_INPUT</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="o">;</span>

    <span class="c1">// è¾“å‡ºäº‹ä»¶ï¼šè¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦åº”å‡†å¤‡å¥½è¾“å…¥æ“ä½œï¼Œä¾‹å¦‚å†™å…¥ï¼›</span>
    <span class="c1">// ç›‘å¬å™¨éœ€å†™å…¥æ‰€æœ‰æœ‰æ•ˆæ•°æ®ã€‚å¦‚æœæ²¡æ³•ä¸€æ¬¡æ€§å®Œæˆå†™å…¥ï¼Œè¿”å›trueä»¤ç›‘å¬å™¨ä¿æŒå­˜æ´»</span>
    <span class="c1">// æˆ–è¿”å›falseç§»é™¤ç›‘å¬å™¨ï¼Œåœ¨éœ€è¦å†™å…¥æ•°æ®æ—¶å†æ¬¡æ³¨å†Œç›‘å¬å™¨ï¼›</span>
    <span class="c1">// æ­¤äº‹ä»¶åªä¼šåœ¨ç›‘å¬å™¨å·²æ·»åŠ ï¼Œä¸”æ­¤å€¼å·²ç»åˆ¶å®šçš„æƒ…å†µä¸‹äº§ç”Ÿ</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">EVENT_OUTPUT</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="o">;</span>

    <span class="c1">// é”™è¯¯æ—¶é—´ï¼šè¡¨æ˜æ–‡ä»¶æè¿°ç¬¦é‡åˆ°è‡´å‘½é”™è¯¯ï¼›</span>
    <span class="c1">// æ–‡ä»¶æè¿°ç¬¦é‡åˆ°é”™è¯¯æœ‰å¾ˆå¤šåŸå› ã€‚ä¸€èˆ¬æ˜¯Socketçš„è¿œç«¯æˆ–ç®¡é“å…³é—­äº†è¿æ¥</span>
    <span class="c1">// å³ä½¿ç›‘å¬å™¨æ²¡æœ‰è®¾ç½®ï¼Œæœ¬é”™è¯¯äº‹ä»¶ä¹Ÿä¼šäº§ç”Ÿ</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">EVENT_ERROR</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="o">;</span>

    <span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">SOURCE</span><span class="o">)</span>
    <span class="nd">@IntDef</span><span class="o">(</span><span class="n">flag</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="o">{</span> <span class="s">"EVENT_"</span> <span class="o">},</span> <span class="n">value</span> <span class="o">=</span> <span class="o">{</span>
            <span class="no">EVENT_INPUT</span><span class="o">,</span>
            <span class="no">EVENT_OUTPUT</span><span class="o">,</span>
            <span class="no">EVENT_ERROR</span>
    <span class="o">})</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">Events</span> <span class="o">{}</span>

    <span class="c1">// å½“æ–‡ä»¶æè¿°ç¬¦æ”¶åˆ°äº‹ä»¶æ—¶è°ƒç”¨</span>
    <span class="c1">// @param fd æ–‡ä»¶æè¿°ç¬¦</span>
    <span class="c1">// @param events å‘ç”Ÿäº‹ä»¶çš„æ©ç </span>
    <span class="c1">// è¿”å›trueè¡¨ç¤ºç»§ç»­è§‚å¯Ÿäº‹ä»¶ï¼Œè¿”å›falseè¡¨ç¤ºæ³¨é”€æ­¤ç›‘å¬å™¨</span>
    <span class="nd">@Events</span> <span class="kt">int</span> <span class="nf">onFileDescriptorEvents</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">FileDescriptor</span> <span class="n">fd</span><span class="o">,</span> <span class="nd">@Events</span> <span class="kt">int</span> <span class="n">events</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å…«filedescriptorrecord">å…«ã€FileDescriptorRecord</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">FileDescriptorRecord</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">FileDescriptor</span> <span class="n">mDescriptor</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">mEvents</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">OnFileDescriptorEventListener</span> <span class="n">mListener</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">mSeq</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">FileDescriptorRecord</span><span class="o">(</span><span class="nc">FileDescriptor</span> <span class="n">descriptor</span><span class="o">,</span>
            <span class="kt">int</span> <span class="n">events</span><span class="o">,</span> <span class="nc">OnFileDescriptorEventListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mDescriptor</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">;</span>
        <span class="n">mEvents</span> <span class="o">=</span> <span class="n">events</span><span class="o">;</span>
        <span class="n">mListener</span> <span class="o">=</span> <span class="n">listener</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
:ET