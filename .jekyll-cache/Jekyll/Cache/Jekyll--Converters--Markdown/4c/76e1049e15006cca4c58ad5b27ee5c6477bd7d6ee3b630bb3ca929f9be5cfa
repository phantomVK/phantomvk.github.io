I"ær<p>æ–‡ç« åˆ—è¡¨ï¼š</p>
<ul>
  <li><a href="/2018/11/15/EventBus_1_Register/">EventBusæºç å‰–æ(1) â€“ è®¢é˜…æ³¨å†Œä¸æ³¨é”€</a></li>
  <li><a href="/2018/12/01/EventBus_2_EventBusBuilder/">EventBusæºç å‰–æ(2) â€“ EventBusBuilder</a></li>
  <li><a href="/2018/12/03/EventBus_3_ThreadMode/">EventBusæºç å‰–æ(3) â€“ çº¿ç¨‹æ¨¡å¼</a></li>
  <li><a href="/2018/12/06/EventBus_4_Subscription/">EventBusæºç å‰–æ(4) â€“ è®¢é˜…è®°å½•</a></li>
  <li><a href="/2018/12/10/EventBus_5_Poster/">EventBusæºç å‰–æ(5) â€“ Poster</a></li>
</ul>

<h2 id="å‰è¨€">å‰è¨€</h2>

<p>ä¸ŠæœŸæ–‡ç«  <a href="/2018/11/14/EventBus_1_Register/">EventBusæºç å‰–æ(1) â€“ æ³¨å†Œä¸æ³¨é”€è®¢é˜…</a> ä»‹ç»äº†è®¢é˜…è€…å‘ <strong>EventBus</strong> è¿›è¡Œæ³¨å†Œå’Œæ³¨é”€çš„æ“ä½œï¼Œå¹¶æ¶‰åŠéƒ¨åˆ† <strong>EventBus</strong> åˆå§‹åŒ–é€»è¾‘ã€‚</p>

<p>åœ¨åˆå§‹åŒ–é€»è¾‘ä¸­ï¼Œå¾ˆå¤šåŠŸèƒ½éƒ½ç”±æœ¬æ–‡å°†ä»‹ç»çš„ <strong>EventBusBuilder</strong> æä¾›ã€‚ä¸€èˆ¬ä½¿ç”¨é»˜è®¤ <strong>EventBusBuilder</strong> å¯¹è±¡ï¼Œä½† <strong>EventBus</strong> è´´å¿ƒåœ°æä¾›äº†å®šåˆ¶çš„èƒ½åŠ›ï¼Œä»¥ä¾¿æ»¡è¶³ä¸åŒéœ€æ±‚ã€‚</p>

<h2 id="ä¸€ç±»ç­¾å">ä¸€ã€ç±»ç­¾å</h2>

<p>é€šè¿‡è‡ªå®šä¹‰å‚æ•°æ„é€  <strong>EventBus</strong> å®ä¾‹ï¼Œå¹¶èƒ½è£…è½½è‡ªå®šä¹‰çš„é»˜è®¤ <strong>EventBus</strong> å®ä¾‹ã€‚å‰æ–‡ <a href="/2018/11/14/EventBus_1_Register/#32-åŸºç¡€æ„é€ ">EventBusæºç å‰–æ(1) â€“ æ³¨å†Œä¸æ³¨é”€è®¢é˜…_3.2 åŸºç¡€æ„é€ </a> ä½¿ç”¨æ­¤å®ä¾‹ï¼Œé€šè¿‡ <strong>EventBus.builder()</strong> åˆ›å»ºæ–° <strong>builder</strong>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EventBusBuilder</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="äºŒæ•°æ®æˆå‘˜">äºŒã€æ•°æ®æˆå‘˜</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="c1">// æ„é€ çº¿ç¨‹æ± ä¸ºnewCachedThreadPoolï¼Œæ‰€æœ‰å®ä¾‹å…±äº«åŒä¸€ä¸ªé™æ€çº¿ç¨‹æ± </span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">ExecutorService</span> <span class="no">DEFAULT_EXECUTOR_SERVICE</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>

<span class="kt">boolean</span> <span class="n">logSubscriberExceptions</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="kt">boolean</span> <span class="n">logNoSubscriberMessages</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="kt">boolean</span> <span class="n">sendSubscriberExceptionEvent</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="kt">boolean</span> <span class="n">sendNoSubscriberEvent</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="kt">boolean</span> <span class="n">throwSubscriberException</span><span class="o">;</span>
<span class="kt">boolean</span> <span class="n">eventInheritance</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="kt">boolean</span> <span class="n">ignoreGeneratedIndex</span><span class="o">;</span>
<span class="kt">boolean</span> <span class="n">strictMethodVerification</span><span class="o">;</span>

<span class="c1">// è·å–é™æ€å®ä¾‹çš„çº¿ç¨‹æ± </span>
<span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="no">DEFAULT_EXECUTOR_SERVICE</span><span class="o">;</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">skipMethodVerificationForClasses</span><span class="o">;</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">SubscriberInfoIndex</span><span class="o">&gt;</span> <span class="n">subscriberInfoIndexes</span><span class="o">;</span>
<span class="nc">Logger</span> <span class="n">logger</span><span class="o">;</span>
<span class="nc">MainThreadSupport</span> <span class="n">mainThreadSupport</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸‰æ„é€ æ–¹æ³•">ä¸‰ã€æ„é€ æ–¹æ³•</h2>

<p>é»˜è®¤æ„é€ æ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nc">EventBusBuilder</span><span class="o">()</span> <span class="o">{</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å››æˆå‘˜æ–¹æ³•">å››ã€æˆå‘˜æ–¹æ³•</h2>

<p>è®¾ç½® <strong>logSubscriberExceptions</strong> çš„å‚æ•°å€¼ï¼Œé»˜è®¤ä¸º trueã€‚è¡¨ç¤ºæ˜¯å¦è®°å½•è®¢é˜…è€…æŠ›å‡ºå¼‚å¸¸çš„æ—¥å¿—ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">EventBusBuilder</span> <span class="nf">logSubscriberExceptions</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">logSubscriberExceptions</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">logSubscriberExceptions</span> <span class="o">=</span> <span class="n">logSubscriberExceptions</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è®¾ç½® <strong>logNoSubscriberMessages</strong> çš„å‚æ•°å€¼ï¼Œé»˜è®¤ä¸ºtrue</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">EventBusBuilder</span> <span class="nf">logNoSubscriberMessages</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">logNoSubscriberMessages</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">logNoSubscriberMessages</span> <span class="o">=</span> <span class="n">logNoSubscriberMessages</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è®¾ç½® <strong>sendSubscriberExceptionEvent</strong> çš„å‚æ•°å€¼ï¼Œé»˜è®¤ä¸ºtrue</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">EventBusBuilder</span> <span class="nf">sendSubscriberExceptionEvent</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">sendSubscriberExceptionEvent</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">sendSubscriberExceptionEvent</span> <span class="o">=</span> <span class="n">sendSubscriberExceptionEvent</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è®¾ç½® <strong>sendNoSubscriberEvent</strong> çš„å‚æ•°å€¼ï¼Œé»˜è®¤ä¸ºtrue</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">EventBusBuilder</span> <span class="nf">sendNoSubscriberEvent</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">sendNoSubscriberEvent</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">sendNoSubscriberEvent</span> <span class="o">=</span> <span class="n">sendNoSubscriberEvent</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è®¾ç½® <strong>throwSubscriberException</strong> çš„å‚æ•°å€¼ï¼Œå½“è®¢é˜…è€…å‡ºç°å¼‚å¸¸æ—¶ä¸ç»§ç»­è¿è¡Œï¼Œé»˜è®¤ä¸ºfalseã€‚å»ºè®®å’Œ <strong>BuildConfig.DEBUG</strong> ä¸€èµ·ä½¿ç”¨ï¼Œå¼€å‘æœŸé—´ä¸ä¼šé”™è¿‡ä»»ä½•æŠ›å‡ºçš„å¼‚å¸¸ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">EventBusBuilder</span> <span class="nf">throwSubscriberException</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">throwSubscriberException</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">throwSubscriberException</span> <span class="o">=</span> <span class="n">throwSubscriberException</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è®¾ç½® <strong>eventInheritance</strong> çš„å‚æ•°å€¼ï¼Œé»˜è®¤ä¸ºtrueã€‚<a href="/2018/11/14/EventBus_1_Register/#42-subscribe">EventBusæºç å‰–æ(1) â€“ æ³¨å†Œä¸æ³¨é”€è®¢é˜…_4.2 subscribe</a> å°èŠ‚ååŠéƒ¨åˆ†ä»£ç æ³¨é‡Šï¼Œé‡Œé¢åŒ…å« <strong>eventInheritance</strong> çš„å…·ä½“ä½œç”¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ<strong>EventBus</strong> è€ƒè™‘äº‹ä»¶ç±»çš„å±‚çº§ç»“æ„(çˆ¶ç±»çš„è®¢é˜…è€…å°†æ”¶åˆ°é€šçŸ¥)ã€‚</p>

<p>å…³é—­æ­¤ç‰¹æ€§èƒ½æå‡äº‹ä»¶æŠ•é€’æ€§èƒ½ï¼Œå¯¹ä¸€ä¸ªç›´æ¥ç»§æ‰¿ <strong>Object</strong> çš„ç®€å•äº‹ä»¶ç±»æ¥è¯´ï¼Œäº‹ä»¶æŠ•é€’æ€§èƒ½æœ‰20%çš„æå‡ã€‚å¯¹æ›´å¤æ‚çš„äº‹ä»¶å±‚çº§ï¼Œæå‡å¹…åº¦è¶…è¿‡20%ã€‚</p>

<p>ä¸è¿‡éœ€è®°ä½çš„æ˜¯ï¼Œäº‹ä»¶æŠ•é€ä¸€èˆ¬åªæ¶ˆè€—åº”ç”¨å¾ˆå°éƒ¨åˆ†çš„å¤„ç†å™¨æ—¶é—´ç‰‡ï¼Œé™¤éå‘é€äº‹ä»¶çš„é¢‘ç‡æ¯ç§’æ•°ä»¥åƒè®¡ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">EventBusBuilder</span> <span class="nf">eventInheritance</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">eventInheritance</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">eventInheritance</span> <span class="o">=</span> <span class="n">eventInheritance</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è‡ªå®šä¹‰çº¿ç¨‹æ± æ›¿æ¢é»˜è®¤çº¿ç¨‹æ± å®ç°ï¼Œä¸ºäº‹ä»¶åˆ†å‘æœåŠ¡æä¾›å¼‚æ­¥åå°çº¿ç¨‹æ± ã€‚ä¸€èˆ¬æ²¡æœ‰å¿…è¦ä¿®æ”¹ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">EventBusBuilder</span> <span class="nf">executorService</span><span class="o">(</span><span class="nc">ExecutorService</span> <span class="n">executorService</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">executorService</span> <span class="o">=</span> <span class="n">executorService</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ–¹æ³•åéªŒè¯ï¼ŒéªŒè¯ä»¥onEventå¼€å¤´çš„æ–¹æ³•é¿å…æ‹¼å†™é”™è¯¯ã€‚ä½¿ç”¨æ­¤æ–¹æ³•èƒ½æ’é™¤æŒ‡å®šè®¢é˜…è€…ç±»çš„æ£€æŸ¥ï¼Œå¹¶å…³é—­å¯¹ä½¿ç”¨ä¿®é¥°ç¬¦ <strong>public</strong>ã€<strong>not static</strong>ã€<strong>not abstract</strong> æ–¹æ³•çš„æ£€æŸ¥ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">EventBusBuilder</span> <span class="nf">skipMethodVerificationFor</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">skipMethodVerificationForClasses</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">skipMethodVerificationForClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="o">}</span>
    <span class="c1">// å­˜å…¥çš„ç±»ä¸ä¼šå—åˆ°æ£€æŸ¥</span>
    <span class="n">skipMethodVerificationForClasses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è®¾ç½® <strong>ignoreGeneratedIndex</strong> çš„å‚æ•°å€¼ï¼Œé»˜è®¤ä¸ºfalseã€‚å³ä½¿å·²ç»å­˜åœ¨å·²ç”Ÿæˆçš„ç´¢å¼•ï¼Œä¹Ÿå¼ºåˆ¶ä½¿ç”¨åå°„ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">EventBusBuilder</span> <span class="nf">ignoreGeneratedIndex</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">ignoreGeneratedIndex</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">ignoreGeneratedIndex</span> <span class="o">=</span> <span class="n">ignoreGeneratedIndex</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è®¾ç½® <strong>strictMethodVerification</strong> çš„å‚æ•°å€¼ï¼Œé»˜è®¤ä¸ºfalseã€‚å¯ç”¨ä¸¥æ ¼çš„æ–¹æ³•éªŒè¯ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">EventBusBuilder</span> <span class="nf">strictMethodVerification</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">strictMethodVerification</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">strictMethodVerification</span> <span class="o">=</span> <span class="n">strictMethodVerification</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ·»åŠ ç”± <strong>EventBus</strong> æ³¨è§£å¤„ç†å™¨å»ºç«‹çš„ç´¢å¼•ï¼Œéœ€è¦æ‰‹åŠ¨æ³¨å…¥</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">EventBusBuilder</span> <span class="nf">addIndex</span><span class="o">(</span><span class="nc">SubscriberInfoIndex</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">subscriberInfoIndexes</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">subscriberInfoIndexes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="o">}</span>
    <span class="n">subscriberInfoIndexes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¸º <strong>EventBus</strong> æ‰€æœ‰æ—¥å¿—äº‹ä»¶æŒ‡å®šæ—¥å¿—å¤„ç†å™¨ï¼Œé»˜è®¤æ‰€æœ‰æ—¥å¿—ç”± <strong>android.util.Log</strong> å¤„ç†ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">EventBusBuilder</span> <span class="nf">logger</span><span class="o">(</span><span class="nc">Logger</span> <span class="n">logger</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è·å– <strong>Logger</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="nc">Logger</span> <span class="nf">getLogger</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">logger</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">logger</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// also check main looper to see if we have "good" Android classes (not Stubs etc.)</span>
        <span class="k">return</span> <span class="nc">Logger</span><span class="o">.</span><span class="na">AndroidLogger</span><span class="o">.</span><span class="na">isAndroidLogAvailable</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">getAndroidMainLooperOrNull</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span>
                <span class="o">?</span> <span class="k">new</span> <span class="nc">Logger</span><span class="o">.</span><span class="na">AndroidLogger</span><span class="o">(</span><span class="s">"EventBus"</span><span class="o">)</span> <span class="o">:</span>
                <span class="k">new</span> <span class="nc">Logger</span><span class="o">.</span><span class="na">SystemOutLogger</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è·å– <strong>MainThreadSupport</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nc">MainThreadSupport</span> <span class="nf">getMainThreadSupport</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mainThreadSupport</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">mainThreadSupport</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="nc">Logger</span><span class="o">.</span><span class="na">AndroidLogger</span><span class="o">.</span><span class="na">isAndroidLogAvailable</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// è·å–Android Looper</span>
        <span class="nc">Object</span> <span class="n">looperOrNull</span> <span class="o">=</span> <span class="n">getAndroidMainLooperOrNull</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">looperOrNull</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span>
                <span class="k">new</span> <span class="nc">MainThreadSupport</span><span class="o">.</span><span class="na">AndroidHandlerMainThreadSupport</span><span class="o">((</span><span class="nc">Looper</span><span class="o">)</span> <span class="n">looperOrNull</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å°è¯•è·å–Androidä¸»çº¿ç¨‹ä¸Šçš„ <strong>Looper</strong>ã€‚<strong>Looperæºç </strong>ï¼š<a href="/2016/12/03/Android_Looper/">Androidæºç ç³»åˆ—(5) â€“ Looper</a></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nc">Object</span> <span class="nf">getAndroidMainLooperOrNull</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Looper</span><span class="o">.</span><span class="na">getMainLooper</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ä¸æ˜¯Androidåº”ç”¨æˆ–åº”ç”¨åŠŸèƒ½ä¸æ­£å¸¸ï¼Œå¯¼è‡´æ‰¾ä¸åˆ°MainLooperï¼Œè¿”å›null</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è£…è½½ç”± <strong>EventBus.getDefault()</strong> è¿”å›çš„é»˜è®¤ <strong>EventBus</strong> å®ä¾‹ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">EventBus</span> <span class="nf">installDefaultEventBus</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">EventBus</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">EventBus</span><span class="o">.</span><span class="na">defaultInstance</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">EventBusException</span><span class="o">(</span><span class="s">"Default instance already exists."</span> <span class="o">+</span>
                    <span class="s">" It may be only set once before it's used the first time to ensure consistent behavior."</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">EventBus</span><span class="o">.</span><span class="na">defaultInstance</span> <span class="o">=</span> <span class="n">build</span><span class="o">();</span>
        <span class="k">return</span> <span class="nc">EventBus</span><span class="o">.</span><span class="na">defaultInstance</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ ¹æ®å½“å‰å®šä¹‰é…ç½®æ„å»º <strong>EventBus</strong> å®ä¾‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">EventBus</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">EventBus</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="äº”mainthreadsupport">äº”ã€MainThreadSupport</h2>

<p>è·å–â€œä¸»â€çº¿ç¨‹çš„æ¥å£ã€‚å¯¹ <strong>Android</strong> æ¥è¯´æ˜¯UIçº¿ç¨‹ï¼Œå…¶ä»–ç±»å‹çš„å·¥ç¨‹åˆ™æ ¹æ®éœ€è¦è®¾å®šã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MainThreadSupport</span> <span class="o">{</span>

    <span class="kt">boolean</span> <span class="nf">isMainThread</span><span class="o">();</span>

    <span class="nc">Poster</span> <span class="nf">createPoster</span><span class="o">(</span><span class="nc">EventBus</span> <span class="n">eventBus</span><span class="o">);</span>

    <span class="c1">// AndroidHandlerMainThreadSupportæ˜¯å†…éƒ¨ç±»ï¼Œå®ç°å¤–éƒ¨æ¥å£MainThreadSupport</span>
    <span class="kd">class</span> <span class="nc">AndroidHandlerMainThreadSupport</span> <span class="kd">implements</span> <span class="nc">MainThreadSupport</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Looper</span> <span class="n">looper</span><span class="o">;</span>
        
        <span class="c1">// æŒ‡å®šLooper</span>
        <span class="kd">public</span> <span class="nf">AndroidHandlerMainThreadSupport</span><span class="o">(</span><span class="nc">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">looper</span> <span class="o">=</span> <span class="n">looper</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isMainThread</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">looper</span> <span class="o">==</span> <span class="nc">Looper</span><span class="o">.</span><span class="na">myLooper</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Poster</span> <span class="nf">createPoster</span><span class="o">(</span><span class="nc">EventBus</span> <span class="n">eventBus</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">HandlerPoster</span><span class="o">(</span><span class="n">eventBus</span><span class="o">,</span> <span class="n">looper</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

:ET