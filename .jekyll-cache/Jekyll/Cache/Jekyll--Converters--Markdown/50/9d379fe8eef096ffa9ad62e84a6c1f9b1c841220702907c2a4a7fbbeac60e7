I"[ù<p>ä¸Šä¸€ç¯‡æ–‡ç«  <a href="/2019/01/07/GlobalScreenshot/">Androidæºç ç³»åˆ—(21) â€“ GlobalScreenshot</a> ä»‹ç»ç³»ç»Ÿæ˜¯å¦‚ä½•è·å–æ¥æ”¶æˆªå›¾æ“ä½œçš„é€šçŸ¥æˆ–æˆªå–å±å¹•ã€‚æœ¬æ–‡ä½œä¸ºåç»­æ–‡ç« ï¼Œç»§ç»­è¡¥å……æˆªå›¾é€šè¿‡ä»€ä¹ˆæ–¹æ³•å†™å…¥åˆ°ç£ç›˜ï¼Œå¹¶é€šçŸ¥åª’ä½“å­˜å‚¨æ›´æ–°è®°å½•ã€‚</p>

<p>æºç ç‰ˆæœ¬ <strong>Android28</strong></p>

<h2 id="ä¸€saveimageinbackgrounddata">ä¸€ã€SaveImageInBackgroundData</h2>

<p>æ­¤ç±»åŒ…å«æˆªå›¾ä¿å­˜åˆ°å­˜å‚¨æ‰€éœ€è¦çš„æ•°æ®ï¼ŒåŒ…æ‹¬æˆªå›¾Bitmapã€ä¿å­˜è·¯å¾„ã€é¢„è§ˆå›¾å®½é«˜ç­‰ä¿¡æ¯ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">SaveImageInBackgroundData</span> <span class="o">{</span>
    <span class="nc">Context</span> <span class="n">context</span><span class="o">;</span>
    <span class="c1">// éœ€è¦ä¿å­˜çš„æˆªå±ä½å›¾</span>
    <span class="nc">Bitmap</span> <span class="n">image</span><span class="o">;</span>
    <span class="c1">// å›¾ç‰‡ä¿å­˜çš„è·¯å¾„</span>
    <span class="nc">Uri</span> <span class="n">imageUri</span><span class="o">;</span>
    <span class="c1">// ä¿å­˜å®Œæˆåè°ƒç”¨finisher</span>
    <span class="nc">Runnable</span> <span class="n">finisher</span><span class="o">;</span>
    <span class="c1">// å›¾æ ‡å°ºå¯¸</span>
    <span class="kt">int</span> <span class="n">iconSize</span><span class="o">;</span>
    <span class="c1">// é¢„è§ˆå›¾å®½åº¦</span>
    <span class="kt">int</span> <span class="n">previewWidth</span><span class="o">;</span>
    <span class="c1">// é¢„è§ˆå›¾é«˜åº¦</span>
    <span class="kt">int</span> <span class="n">previewheight</span><span class="o">;</span>
    <span class="c1">// é”™è¯¯ä¿¡æ¯id</span>
    <span class="kt">int</span> <span class="n">errorMsgResId</span><span class="o">;</span>

    <span class="c1">// æ¸…ç©ºå¯¹è±¡æ•°æ®</span>
    <span class="kt">void</span> <span class="nf">clearImage</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">image</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">imageUri</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">iconSize</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="c1">// ç§»é™¤ä¿å­˜çš„Context</span>
    <span class="kt">void</span> <span class="nf">clearContext</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">context</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="äºŒsaveimageinbackgroundtask">äºŒã€SaveImageInBackgroundTask</h2>

<p>ä¿å­˜æˆªå›¾çš„ <a href="/2018/10/21/AsyncTask/">AsyncTask</a> ä»»åŠ¡ï¼Œåœ¨åå°æŠŠæˆªå–çš„å›¾ç‰‡ä¿å­˜åˆ°åª’ä½“å­˜å‚¨ã€‚è°ƒç”¨ <strong>AsyncTask.execute()</strong> çš„ä»»åŠ¡åœ¨åå°ä»¥ä¸²è¡Œçš„æ–¹å¼å¤„ç†ã€‚å¦‚æœæœ‰è‡ªå®šä¹‰ä»»åŠ¡é˜»å¡æ•´ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œåˆ™æˆªå›¾å°†æ— æ³•å†™å…¥å­˜å‚¨ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">SaveImageInBackgroundTask</span> <span class="kd">extends</span> <span class="nc">AsyncTask</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">,</span> <span class="nc">Void</span><span class="o">,</span> <span class="nc">Void</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="21-é™æ€å˜é‡">2.1 é™æ€å˜é‡</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TAG</span> <span class="o">=</span> <span class="s">"SaveImageInBackgroundTask"</span><span class="o">;</span>

<span class="c1">// æˆªå›¾ä¿å­˜çš„æ–‡ä»¶å¤¹åç§°</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SCREENSHOTS_DIR_NAME</span> <span class="o">=</span> <span class="s">"Screenshots"</span><span class="o">;</span>

<span class="c1">// æˆªå›¾æ–‡ä»¶åæ¨¡æ¿</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SCREENSHOT_FILE_NAME_TEMPLATE</span> <span class="o">=</span> <span class="s">"Screenshot_%s.png"</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SCREENSHOT_SHARE_SUBJECT_TEMPLATE</span> <span class="o">=</span> <span class="s">"Screenshot (%s)"</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="22-æ•°æ®æˆå‘˜">2.2 æ•°æ®æˆå‘˜</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="nc">SaveImageInBackgroundData</span> <span class="n">mParams</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">NotificationManager</span> <span class="n">mNotificationManager</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Notification</span><span class="o">.</span><span class="na">Builder</span> <span class="n">mNotificationBuilder</span><span class="o">,</span> <span class="n">mPublicNotificationBuilder</span><span class="o">;</span>

<span class="c1">// ä¿å­˜æˆªå›¾çš„è·¯å¾„</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">File</span> <span class="n">mScreenshotDir</span><span class="o">;</span>

<span class="c1">// æˆªå›¾æ–‡ä»¶å</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">mImageFileName</span><span class="o">;</span>

<span class="c1">// æˆªå›¾æ–‡ä»¶è·¯å¾„</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">mImageFilePath</span><span class="o">;</span>

<span class="c1">// æˆªå›¾æ—¶é—´</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">mImageTime</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">BigPictureStyle</span> <span class="n">mNotificationStyle</span><span class="o">;</span>

<span class="c1">// æˆªå›¾å®½åº¦</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">mImageWidth</span><span class="o">;</span>

<span class="c1">// æˆªå›¾é«˜åº¦</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">mImageHeight</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="23-æ„é€ æ–¹æ³•">2.3 æ„é€ æ–¹æ³•</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
</pre></td><td class="rouge-code"><pre><span class="nc">SaveImageInBackgroundTask</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">SaveImageInBackgroundData</span> <span class="n">data</span><span class="o">,</span>
        <span class="nc">NotificationManager</span> <span class="n">nManager</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Resources</span> <span class="n">r</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">();</span>

    <span class="c1">// Prepare all the output metadata</span>
    <span class="n">mParams</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
    <span class="c1">// è·å–ç³»ç»Ÿæ—¶é—´æˆ³</span>
    <span class="n">mImageTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="c1">// æ„é€ æˆªå›¾çš„æ—¶é—´</span>
    <span class="nc">String</span> <span class="n">imageDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyyMMdd-HHmmss"</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="n">mImageTime</span><span class="o">));</span>
    <span class="c1">// æ„é€ æˆªå›¾åç§°ï¼Œå½¢å¦‚ï¼šScreenshot_20181201-235132</span>
    <span class="n">mImageFileName</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="no">SCREENSHOT_FILE_NAME_TEMPLATE</span><span class="o">,</span> <span class="n">imageDate</span><span class="o">);</span>

    <span class="c1">// å¹¶è·å–å¤–éƒ¨å­˜å‚¨ä¿å­˜å›¾ç‰‡æ–‡ä»¶å¤¹çš„è·¯å¾„</span>
    <span class="n">mScreenshotDir</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="nc">Environment</span><span class="o">.</span><span class="na">getExternalStoragePublicDirectory</span><span class="o">(</span>
            <span class="nc">Environment</span><span class="o">.</span><span class="na">DIRECTORY_PICTURES</span><span class="o">),</span> <span class="no">SCREENSHOTS_DIR_NAME</span><span class="o">);</span>
    <span class="c1">// æ„é€ æˆªå›¾è·¯å¾„</span>
    <span class="n">mImageFilePath</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">mScreenshotDir</span><span class="o">,</span> <span class="n">mImageFileName</span><span class="o">).</span><span class="na">getAbsolutePath</span><span class="o">();</span>

    <span class="c1">// æ„å»ºå¤§çš„é€šçŸ¥å›¾æ ‡</span>
    <span class="n">mImageWidth</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">image</span><span class="o">.</span><span class="na">getWidth</span><span class="o">();</span>
    <span class="n">mImageHeight</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">image</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">iconSize</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">iconSize</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">previewWidth</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">previewWidth</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">previewHeight</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">previewheight</span><span class="o">;</span>

    <span class="nc">Paint</span> <span class="n">paint</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Paint</span><span class="o">();</span>
    <span class="nc">ColorMatrix</span> <span class="n">desat</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ColorMatrix</span><span class="o">();</span>
    <span class="n">desat</span><span class="o">.</span><span class="na">setSaturation</span><span class="o">(</span><span class="mf">0.25f</span><span class="o">);</span>
    <span class="n">paint</span><span class="o">.</span><span class="na">setColorFilter</span><span class="o">(</span><span class="k">new</span> <span class="nc">ColorMatrixColorFilter</span><span class="o">(</span><span class="n">desat</span><span class="o">));</span>
    <span class="nc">Matrix</span> <span class="n">matrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Matrix</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">overlayColor</span> <span class="o">=</span> <span class="mh">0x40FFFFFF</span><span class="o">;</span>

    <span class="n">matrix</span><span class="o">.</span><span class="na">setTranslate</span><span class="o">((</span><span class="n">previewWidth</span> <span class="o">-</span> <span class="n">mImageWidth</span><span class="o">)</span> <span class="o">/</span> <span class="mi">2</span><span class="o">,</span> <span class="o">(</span><span class="n">previewHeight</span> <span class="o">-</span> <span class="n">mImageHeight</span><span class="o">)</span> <span class="o">/</span> <span class="mi">2</span><span class="o">);</span>
    <span class="nc">Bitmap</span> <span class="n">picture</span> <span class="o">=</span> <span class="n">generateAdjustedHwBitmap</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">image</span><span class="o">,</span> <span class="n">previewWidth</span><span class="o">,</span> <span class="n">previewHeight</span><span class="o">,</span> <span class="n">matrix</span><span class="o">,</span>
            <span class="n">paint</span><span class="o">,</span> <span class="n">overlayColor</span><span class="o">);</span>

    <span class="c1">// æ²¡æ³•ä½¿ç”¨å°å›¾æ ‡çš„é¢„è§ˆï¼Œå› ä¸ºå›¾æ ‡ä¸æ˜¯æ­£æ–¹å½¢çš„</span>
    <span class="kt">float</span> <span class="n">scale</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">iconSize</span> <span class="o">/</span> <span class="nc">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">mImageWidth</span><span class="o">,</span> <span class="n">mImageHeight</span><span class="o">);</span>
    <span class="n">matrix</span><span class="o">.</span><span class="na">setScale</span><span class="o">(</span><span class="n">scale</span><span class="o">,</span> <span class="n">scale</span><span class="o">);</span>
    <span class="n">matrix</span><span class="o">.</span><span class="na">postTranslate</span><span class="o">((</span><span class="n">iconSize</span> <span class="o">-</span> <span class="o">(</span><span class="n">scale</span> <span class="o">*</span> <span class="n">mImageWidth</span><span class="o">))</span> <span class="o">/</span> <span class="mi">2</span><span class="o">,</span>
            <span class="o">(</span><span class="n">iconSize</span> <span class="o">-</span> <span class="o">(</span><span class="n">scale</span> <span class="o">*</span> <span class="n">mImageHeight</span><span class="o">))</span> <span class="o">/</span> <span class="mi">2</span><span class="o">);</span>
    <span class="nc">Bitmap</span> <span class="n">icon</span> <span class="o">=</span> <span class="n">generateAdjustedHwBitmap</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">image</span><span class="o">,</span> <span class="n">iconSize</span><span class="o">,</span> <span class="n">iconSize</span><span class="o">,</span> <span class="n">matrix</span><span class="o">,</span> <span class="n">paint</span><span class="o">,</span>
            <span class="n">overlayColor</span><span class="o">);</span>

    <span class="n">mNotificationManager</span> <span class="o">=</span> <span class="n">nManager</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>

    <span class="c1">// æ„å»ºé€šçŸ¥</span>
    <span class="n">mNotificationStyle</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Notification</span><span class="o">.</span><span class="na">BigPictureStyle</span><span class="o">()</span>
            <span class="o">.</span><span class="na">bigPicture</span><span class="o">(</span><span class="n">picture</span><span class="o">.</span><span class="na">createAshmemBitmap</span><span class="o">());</span>

    <span class="c1">// å±•ç¤ºå…¬å…±é€šçŸ¥</span>
    <span class="n">mPublicNotificationBuilder</span> <span class="o">=</span>
            <span class="k">new</span> <span class="nc">Notification</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="nc">NotificationChannels</span><span class="o">.</span><span class="na">SCREENSHOTS_HEADSUP</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">setContentTitle</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">screenshot_saving_title</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">setSmallIcon</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">stat_notify_image</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">setCategory</span><span class="o">(</span><span class="nc">Notification</span><span class="o">.</span><span class="na">CATEGORY_PROGRESS</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">setWhen</span><span class="o">(</span><span class="n">now</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">setShowWhen</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getColor</span><span class="o">(</span>
                            <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">system_notification_accent_color</span><span class="o">));</span>
    <span class="nc">SystemUI</span><span class="o">.</span><span class="na">overrideNotificationAppName</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">mPublicNotificationBuilder</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

    <span class="n">mNotificationBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Notification</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">context</span><span class="o">,</span>
            <span class="nc">NotificationChannels</span><span class="o">.</span><span class="na">SCREENSHOTS_HEADSUP</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setContentTitle</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">screenshot_saving_title</span><span class="o">))</span>
        <span class="o">.</span><span class="na">setSmallIcon</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">stat_notify_image</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setWhen</span><span class="o">(</span><span class="n">now</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setShowWhen</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getColor</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">system_notification_accent_color</span><span class="o">))</span>
        <span class="o">.</span><span class="na">setStyle</span><span class="o">(</span><span class="n">mNotificationStyle</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setPublicVersion</span><span class="o">(</span><span class="n">mPublicNotificationBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
    <span class="n">mNotificationBuilder</span><span class="o">.</span><span class="na">setFlag</span><span class="o">(</span><span class="nc">Notification</span><span class="o">.</span><span class="na">FLAG_NO_CLEAR</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="nc">SystemUI</span><span class="o">.</span><span class="na">overrideNotificationAppName</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">mNotificationBuilder</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

    <span class="n">mNotificationManager</span><span class="o">.</span><span class="na">notify</span><span class="o">(</span><span class="nc">SystemMessage</span><span class="o">.</span><span class="na">NOTE_GLOBAL_SCREENSHOT</span><span class="o">,</span>
            <span class="n">mNotificationBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>

    <span class="c1">// ä»¥ä¸‹ä»£ç ç”¨äºæ›´æ–°å›¾ç‰‡å·²ç»å†™å…¥ç£ç›˜çš„é€šçŸ¥ä¿¡æ¯</span>

    <span class="c1">// On the tablet, the large icon makes the notification appear as if it is clickable (and</span>
    <span class="c1">// on small devices, the large icon is not shown) so defer showing the large icon until</span>
    <span class="c1">// we compose the final post-save notification below.</span>
    <span class="n">mNotificationBuilder</span><span class="o">.</span><span class="na">setLargeIcon</span><span class="o">(</span><span class="n">icon</span><span class="o">.</span><span class="na">createAshmemBitmap</span><span class="o">());</span>
    <span class="c1">// But we still don't set it for the expanded view, allowing the smallIcon to show here.</span>
    <span class="n">mNotificationStyle</span><span class="o">.</span><span class="na">bigLargeIcon</span><span class="o">((</span><span class="nc">Bitmap</span><span class="o">)</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="24-generateadjustedhwbitmap">2.4 generateAdjustedHwBitmap</h4>

<p>ç”¨æŒ‡å®šåˆ†è¾¨ç‡ç”Ÿæˆè°ƒæ•´åçš„Bitmap</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">Bitmap</span> <span class="nf">generateAdjustedHwBitmap</span><span class="o">(</span><span class="nc">Bitmap</span> <span class="n">bitmap</span><span class="o">,</span> <span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">,</span> <span class="nc">Matrix</span> <span class="n">matrix</span><span class="o">,</span>
        <span class="nc">Paint</span> <span class="n">paint</span><span class="o">,</span> <span class="kt">int</span> <span class="n">color</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Picture</span> <span class="n">picture</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Picture</span><span class="o">();</span>
    <span class="nc">Canvas</span> <span class="n">canvas</span> <span class="o">=</span> <span class="n">picture</span><span class="o">.</span><span class="na">beginRecording</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">);</span>
    <span class="n">canvas</span><span class="o">.</span><span class="na">drawColor</span><span class="o">(</span><span class="n">color</span><span class="o">);</span>
    <span class="n">canvas</span><span class="o">.</span><span class="na">drawBitmap</span><span class="o">(</span><span class="n">bitmap</span><span class="o">,</span> <span class="n">matrix</span><span class="o">,</span> <span class="n">paint</span><span class="o">);</span>
    <span class="n">picture</span><span class="o">.</span><span class="na">endRecording</span><span class="o">();</span>
    <span class="k">return</span> <span class="nc">Bitmap</span><span class="o">.</span><span class="na">createBitmap</span><span class="o">(</span><span class="n">picture</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="25-åå°ä¿å­˜">2.5 åå°ä¿å­˜</h4>

<p>å½“æ‰§è¡Œåˆ° <strong>doInBackground</strong> æ—¶ï¼Œæˆªå±å·²ä¿å­˜åœ¨å†…å­˜ä¸­ç­‰å¾…å†™å…¥ç£ç›˜ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="nc">Void</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="nc">Void</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isCancelled</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// é»˜è®¤æƒ…å†µä¸‹ï¼ŒAsyncTaskå°†å·¥ä½œçº¿ç¨‹è®¾ç½®ä¸ºå…·æœ‰åå°çº¿ç¨‹ä¼˜å…ˆçº§ï¼Œå› æ­¤å°†å…¶æ¢å¤ä»¥ä¾¿æ›´å¿«åœ°ä¿å­˜æˆªå›¾</span>
    <span class="nc">Process</span><span class="o">.</span><span class="na">setThreadPriority</span><span class="o">(</span><span class="nc">Process</span><span class="o">.</span><span class="na">THREAD_PRIORITY_FOREGROUND</span><span class="o">);</span>

    <span class="nc">Context</span> <span class="n">context</span> <span class="o">=</span> <span class="n">mParams</span><span class="o">.</span><span class="na">context</span><span class="o">;</span>
    <span class="c1">// ä»Paramå–å‡ºæˆªå±å›¾ç‰‡</span>
    <span class="nc">Bitmap</span> <span class="n">image</span> <span class="o">=</span> <span class="n">mParams</span><span class="o">.</span><span class="na">image</span><span class="o">;</span>
    <span class="nc">Resources</span> <span class="n">r</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// åˆ›å»ºæˆªå±æ–‡ä»¶å¤¹çš„ç›®å½•</span>
        <span class="n">mScreenshotDir</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">();</span>

        <span class="c1">// DATE_TAKENçš„æ—¶é—´æˆ³å•ä½æ˜¯æ¯«ç§’ï¼Œä½†DATE_MODIFIEDå’ŒDATE_ADDEDå•ä½æ˜¯ç§’ï¼Œè¿™é‡Œè¿›è¡Œè½¬æ¢</span>
        <span class="kt">long</span> <span class="n">dateSeconds</span> <span class="o">=</span> <span class="n">mImageTime</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>

        <span class="c1">// æˆªå›¾ä½å›¾å†™å…¥æ–‡ä»¶æµ</span>
        <span class="nc">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">mImageFilePath</span><span class="o">);</span>
        <span class="c1">// æ ¼å¼PNGï¼Œè´¨é‡100è¡¨ç¤ºæœ€ä½å‹ç¼©</span>
        <span class="n">image</span><span class="o">.</span><span class="na">compress</span><span class="o">(</span><span class="nc">Bitmap</span><span class="o">.</span><span class="na">CompressFormat</span><span class="o">.</span><span class="na">PNG</span><span class="o">,</span> <span class="mi">100</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="c1">// é…ç½®ContentValuesï¼Œå‡†å¤‡é€šçŸ¥è®¾å¤‡æ›´æ–°åª’ä½“è®°å½•</span>
        <span class="c1">// ä¸‹é¢å°†å†™å…¥æˆªå›¾çš„ä¿¡æ¯ï¼šæ—¶é—´ã€æ ‡é¢˜ã€åç§°ã€ç±»å‹å’Œå¤§å°ç­‰ä¿¡æ¯</span>
        <span class="nc">ContentValues</span> <span class="n">values</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ContentValues</span><span class="o">();</span>
        <span class="nc">ContentResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">();</span>
        <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">MediaStore</span><span class="o">.</span><span class="na">Images</span><span class="o">.</span><span class="na">ImageColumns</span><span class="o">.</span><span class="na">DATA</span><span class="o">,</span> <span class="n">mImageFilePath</span><span class="o">);</span>
        <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">MediaStore</span><span class="o">.</span><span class="na">Images</span><span class="o">.</span><span class="na">ImageColumns</span><span class="o">.</span><span class="na">TITLE</span><span class="o">,</span> <span class="n">mImageFileName</span><span class="o">);</span>
        <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">MediaStore</span><span class="o">.</span><span class="na">Images</span><span class="o">.</span><span class="na">ImageColumns</span><span class="o">.</span><span class="na">DISPLAY_NAME</span><span class="o">,</span> <span class="n">mImageFileName</span><span class="o">);</span>
        <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">MediaStore</span><span class="o">.</span><span class="na">Images</span><span class="o">.</span><span class="na">ImageColumns</span><span class="o">.</span><span class="na">DATE_TAKEN</span><span class="o">,</span> <span class="n">mImageTime</span><span class="o">);</span>
        <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">MediaStore</span><span class="o">.</span><span class="na">Images</span><span class="o">.</span><span class="na">ImageColumns</span><span class="o">.</span><span class="na">DATE_ADDED</span><span class="o">,</span> <span class="n">dateSeconds</span><span class="o">);</span>
        <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">MediaStore</span><span class="o">.</span><span class="na">Images</span><span class="o">.</span><span class="na">ImageColumns</span><span class="o">.</span><span class="na">DATE_MODIFIED</span><span class="o">,</span> <span class="n">dateSeconds</span><span class="o">);</span>
        <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">MediaStore</span><span class="o">.</span><span class="na">Images</span><span class="o">.</span><span class="na">ImageColumns</span><span class="o">.</span><span class="na">MIME_TYPE</span><span class="o">,</span> <span class="s">"image/png"</span><span class="o">);</span>
        <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">MediaStore</span><span class="o">.</span><span class="na">Images</span><span class="o">.</span><span class="na">ImageColumns</span><span class="o">.</span><span class="na">WIDTH</span><span class="o">,</span> <span class="n">mImageWidth</span><span class="o">);</span>
        <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">MediaStore</span><span class="o">.</span><span class="na">Images</span><span class="o">.</span><span class="na">ImageColumns</span><span class="o">.</span><span class="na">HEIGHT</span><span class="o">,</span> <span class="n">mImageHeight</span><span class="o">);</span>
        <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">MediaStore</span><span class="o">.</span><span class="na">Images</span><span class="o">.</span><span class="na">ImageColumns</span><span class="o">.</span><span class="na">SIZE</span><span class="o">,</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">mImageFilePath</span><span class="o">).</span><span class="na">length</span><span class="o">());</span>
        <span class="c1">// æŠŠæˆªå±è®°å½•æ’å…¥åˆ°MediaStore</span>
        <span class="nc">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="nc">MediaStore</span><span class="o">.</span><span class="na">Images</span><span class="o">.</span><span class="na">Media</span><span class="o">.</span><span class="na">EXTERNAL_CONTENT_URI</span><span class="o">,</span> <span class="n">values</span><span class="o">);</span>

        <span class="c1">// åˆ›å»ºåˆ†äº«çš„Intent</span>
        <span class="nc">String</span> <span class="n">subjectDate</span> <span class="o">=</span> <span class="nc">DateFormat</span><span class="o">.</span><span class="na">getDateTimeInstance</span><span class="o">().</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="n">mImageTime</span><span class="o">));</span>
        <span class="nc">String</span> <span class="n">subject</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="no">SCREENSHOT_SHARE_SUBJECT_TEMPLATE</span><span class="o">,</span> <span class="n">subjectDate</span><span class="o">);</span>
        <span class="nc">Intent</span> <span class="n">sharingIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">ACTION_SEND</span><span class="o">);</span>
        <span class="n">sharingIntent</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="s">"image/png"</span><span class="o">);</span>
        <span class="n">sharingIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">EXTRA_STREAM</span><span class="o">,</span> <span class="n">uri</span><span class="o">);</span>
        <span class="n">sharingIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">EXTRA_SUBJECT</span><span class="o">,</span> <span class="n">subject</span><span class="o">);</span>
        <span class="n">sharingIntent</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">FLAG_GRANT_READ_URI_PERMISSION</span><span class="o">);</span>

        <span class="c1">// Create a share action for the notification. Note, we proxy the call to</span>
        <span class="c1">// ScreenshotActionReceiver because RemoteViews currently forces an activity options</span>
        <span class="c1">// on the PendingIntent being launched, and since we don't want to trigger the share</span>
        <span class="c1">// sheet in this case, we start the chooser activity directly in</span>
        <span class="c1">// ScreenshotActionReceiver.</span>
        <span class="c1">// æ„é€ åˆ†äº«çš„PendingIntent</span>
        <span class="nc">PendingIntent</span> <span class="n">shareAction</span> <span class="o">=</span> <span class="nc">PendingIntent</span><span class="o">.</span><span class="na">getBroadcast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
                <span class="k">new</span> <span class="nf">Intent</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="nc">GlobalScreenshot</span><span class="o">.</span><span class="na">ScreenshotActionReceiver</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="no">SHARING_INTENT</span><span class="o">,</span> <span class="n">sharingIntent</span><span class="o">),</span>
                <span class="nc">PendingIntent</span><span class="o">.</span><span class="na">FLAG_CANCEL_CURRENT</span><span class="o">);</span>
        <span class="nc">Notification</span><span class="o">.</span><span class="na">Action</span><span class="o">.</span><span class="na">Builder</span> <span class="n">shareActionBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Notification</span><span class="o">.</span><span class="na">Action</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span>
                <span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">ic_screenshot_share</span><span class="o">,</span>
                <span class="n">r</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">share</span><span class="o">),</span> <span class="n">shareAction</span><span class="o">);</span>
        <span class="n">mNotificationBuilder</span><span class="o">.</span><span class="na">addAction</span><span class="o">(</span><span class="n">shareActionBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>

        <span class="c1">// æ„é€ ç¼–è¾‘æˆªå›¾çš„Intent</span>
        <span class="nc">Intent</span> <span class="n">editIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">ACTION_EDIT</span><span class="o">);</span>
        <span class="n">editIntent</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="s">"image/png"</span><span class="o">);</span>
        <span class="n">editIntent</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
        <span class="n">editIntent</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">FLAG_GRANT_READ_URI_PERMISSION</span><span class="o">);</span>
        <span class="n">editIntent</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">FLAG_GRANT_WRITE_URI_PERMISSION</span><span class="o">);</span>

        <span class="c1">// Create a edit action for the notification the same way.</span>
        <span class="nc">PendingIntent</span> <span class="n">editAction</span> <span class="o">=</span> <span class="nc">PendingIntent</span><span class="o">.</span><span class="na">getBroadcast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span>
                <span class="k">new</span> <span class="nf">Intent</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="nc">GlobalScreenshot</span><span class="o">.</span><span class="na">ScreenshotActionReceiver</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="no">SHARING_INTENT</span><span class="o">,</span> <span class="n">editIntent</span><span class="o">),</span>
                <span class="nc">PendingIntent</span><span class="o">.</span><span class="na">FLAG_CANCEL_CURRENT</span><span class="o">);</span>
        <span class="nc">Notification</span><span class="o">.</span><span class="na">Action</span><span class="o">.</span><span class="na">Builder</span> <span class="n">editActionBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Notification</span><span class="o">.</span><span class="na">Action</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span>
                <span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">ic_screenshot_edit</span><span class="o">,</span>
                <span class="n">r</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">screenshot_edit</span><span class="o">),</span> <span class="n">editAction</span><span class="o">);</span>
        <span class="n">mNotificationBuilder</span><span class="o">.</span><span class="na">addAction</span><span class="o">(</span><span class="n">editActionBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>

        <span class="c1">// ç»™é€šçŸ¥åˆ›å»ºåˆ é™¤æˆªå±çš„æ“ä½œ</span>
        <span class="nc">PendingIntent</span> <span class="n">deleteAction</span> <span class="o">=</span> <span class="nc">PendingIntent</span><span class="o">.</span><span class="na">getBroadcast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
                <span class="k">new</span> <span class="nf">Intent</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="nc">GlobalScreenshot</span><span class="o">.</span><span class="na">DeleteScreenshotReceiver</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="nc">GlobalScreenshot</span><span class="o">.</span><span class="na">SCREENSHOT_URI_ID</span><span class="o">,</span> <span class="n">uri</span><span class="o">.</span><span class="na">toString</span><span class="o">()),</span>
                <span class="nc">PendingIntent</span><span class="o">.</span><span class="na">FLAG_CANCEL_CURRENT</span> <span class="o">|</span> <span class="nc">PendingIntent</span><span class="o">.</span><span class="na">FLAG_ONE_SHOT</span><span class="o">);</span>
        <span class="nc">Notification</span><span class="o">.</span><span class="na">Action</span><span class="o">.</span><span class="na">Builder</span> <span class="n">deleteActionBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Notification</span><span class="o">.</span><span class="na">Action</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span>
                <span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">ic_screenshot_delete</span><span class="o">,</span>
                <span class="n">r</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">delete</span><span class="o">),</span> <span class="n">deleteAction</span><span class="o">);</span>
        <span class="n">mNotificationBuilder</span><span class="o">.</span><span class="na">addAction</span><span class="o">(</span><span class="n">deleteActionBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>

        <span class="n">mParams</span><span class="o">.</span><span class="na">imageUri</span> <span class="o">=</span> <span class="n">uri</span><span class="o">;</span>
        <span class="n">mParams</span><span class="o">.</span><span class="na">image</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">mParams</span><span class="o">.</span><span class="na">errorMsgResId</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// å¤–éƒ¨å­˜å‚¨æ²¡æœ‰æŒ‚è½½ä¼šæŠ›å‡ºIOException/UnsupportedOperationException</span>
        <span class="nc">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"unable to save screenshot"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="n">mParams</span><span class="o">.</span><span class="na">clearImage</span><span class="o">();</span>
        <span class="n">mParams</span><span class="o">.</span><span class="na">errorMsgResId</span> <span class="o">=</span> <span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">screenshot_failed_to_save_text</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// å›æ”¶ä½å›¾</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">image</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">image</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="26-onpostexecute">2.6 onPostExecute</h4>

<p>æˆªå›¾å·²ç»ä¿å­˜åˆ°ç£ç›˜ä¸­ï¼Œç»™ç”¨æˆ·å¼¹å‡ºæˆåŠŸæˆ–å¤±è´¥çš„æç¤ºã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="nc">Void</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mParams</span><span class="o">.</span><span class="na">errorMsgResId</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// å›¾ç‰‡ä¿å­˜åˆ°å­˜å‚¨å¤±è´¥ï¼Œå¼¹å‡ºä¸€ä¸ªé€šçŸ¥å‘ŠçŸ¥ç”¨æˆ·</span>
        <span class="nc">GlobalScreenshot</span><span class="o">.</span><span class="na">notifyScreenshotError</span><span class="o">(</span><span class="n">mParams</span><span class="o">.</span><span class="na">context</span><span class="o">,</span> <span class="n">mNotificationManager</span><span class="o">,</span>
                <span class="n">mParams</span><span class="o">.</span><span class="na">errorMsgResId</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// å›¾ç‰‡ä¿å­˜åˆ°å­˜å‚¨æˆåŠŸï¼Œå¼¹å‡ºé€šçŸ¥æŒ‡æ˜å·²ä¿å­˜çš„æˆªå±</span>
        <span class="nc">Context</span> <span class="n">context</span> <span class="o">=</span> <span class="n">mParams</span><span class="o">.</span><span class="na">context</span><span class="o">;</span>
        <span class="nc">Resources</span> <span class="n">r</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">();</span>

        <span class="c1">// æ„é€ intentï¼Œå¼•å¯¼ç”¨æˆ·è·³åˆ°ç›¸å†Œæµè§ˆæˆªå›¾</span>
        <span class="nc">Intent</span> <span class="n">launchIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">ACTION_VIEW</span><span class="o">);</span>
        <span class="c1">// å¸¦ä¸Šå›¾ç‰‡çš„ç±»å‹å’Œèµ„æºåœ°å€</span>
        <span class="n">launchIntent</span><span class="o">.</span><span class="na">setDataAndType</span><span class="o">(</span><span class="n">mParams</span><span class="o">.</span><span class="na">imageUri</span><span class="o">,</span> <span class="s">"image/png"</span><span class="o">);</span>
        <span class="n">launchIntent</span><span class="o">.</span><span class="na">setFlags</span><span class="o">(</span>
                <span class="nc">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_NEW_TASK</span> <span class="o">|</span> <span class="nc">Intent</span><span class="o">.</span><span class="na">FLAG_GRANT_READ_URI_PERMISSION</span><span class="o">);</span>

        <span class="kd">final</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>

        <span class="c1">// æ›´æ–°å·²æœ‰é€šçŸ¥çš„æ–‡æœ¬å’Œicon</span>
        <span class="n">mPublicNotificationBuilder</span>
                <span class="o">.</span><span class="na">setContentTitle</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">screenshot_saved_title</span><span class="o">))</span>
                <span class="o">.</span><span class="na">setContentText</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">screenshot_saved_text</span><span class="o">))</span>
                <span class="o">.</span><span class="na">setContentIntent</span><span class="o">(</span><span class="nc">PendingIntent</span><span class="o">.</span><span class="na">getActivity</span><span class="o">(</span><span class="n">mParams</span><span class="o">.</span><span class="na">context</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">launchIntent</span><span class="o">,</span> <span class="mi">0</span><span class="o">))</span>
                <span class="o">.</span><span class="na">setWhen</span><span class="o">(</span><span class="n">now</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setAutoCancel</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getColor</span><span class="o">(</span>
                        <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">system_notification_accent_color</span><span class="o">));</span>
        <span class="n">mNotificationBuilder</span>
            <span class="o">.</span><span class="na">setContentTitle</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">screenshot_saved_title</span><span class="o">))</span>
            <span class="o">.</span><span class="na">setContentText</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">screenshot_saved_text</span><span class="o">))</span>
            <span class="o">.</span><span class="na">setContentIntent</span><span class="o">(</span><span class="nc">PendingIntent</span><span class="o">.</span><span class="na">getActivity</span><span class="o">(</span><span class="n">mParams</span><span class="o">.</span><span class="na">context</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">launchIntent</span><span class="o">,</span> <span class="mi">0</span><span class="o">))</span>
            <span class="o">.</span><span class="na">setWhen</span><span class="o">(</span><span class="n">now</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setAutoCancel</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getColor</span><span class="o">(</span>
                    <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">color</span><span class="o">.</span><span class="na">system_notification_accent_color</span><span class="o">))</span>
            <span class="o">.</span><span class="na">setPublicVersion</span><span class="o">(</span><span class="n">mPublicNotificationBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">())</span>
            <span class="o">.</span><span class="na">setFlag</span><span class="o">(</span><span class="nc">Notification</span><span class="o">.</span><span class="na">FLAG_NO_CLEAR</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

        <span class="n">mNotificationManager</span><span class="o">.</span><span class="na">notify</span><span class="o">(</span><span class="nc">SystemMessage</span><span class="o">.</span><span class="na">NOTE_GLOBAL_SCREENSHOT</span><span class="o">,</span>
                <span class="n">mNotificationBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="c1">// è°ƒèµ·finish</span>
    <span class="n">mParams</span><span class="o">.</span><span class="na">finisher</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
    <span class="n">mParams</span><span class="o">.</span><span class="na">clearContext</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="27-oncancelled">2.7 onCancelled</h4>

<p>ä¿å­˜æˆªå›¾çš„æ“ä½œè¢«å–æ¶ˆã€‚å¦‚æœæˆªå›¾æ­£åœ¨åå°ä¿å­˜çš„æ—¶å€™ä»»åŠ¡è¢«å–æ¶ˆï¼Œ<strong>onCancelled</strong> å€¼ä¸º <strong>null</strong>ã€‚åŒæ—¶ï¼Œ<strong>finisher</strong> çš„é¢„æœŸæ˜¯ä¸€å®šä¼šè¢«å›è°ƒçš„ï¼Œæ‰€ä»¥è¢«å–æ¶ˆçš„ä»»åŠ¡éœ€è¦åœ¨è¿™é‡Œå›è°ƒ <strong>finisher</strong>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCancelled</span><span class="o">(</span><span class="nc">Void</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mParams</span><span class="o">.</span><span class="na">finisher</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
    <span class="n">mParams</span><span class="o">.</span><span class="na">clearImage</span><span class="o">();</span>
    <span class="n">mParams</span><span class="o">.</span><span class="na">clearContext</span><span class="o">();</span>

    <span class="c1">// å–æ¶ˆå·²ç»å¼¹å‡ºçš„é€šçŸ¥</span>
    <span class="n">mNotificationManager</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="nc">SystemMessage</span><span class="o">.</span><span class="na">NOTE_GLOBAL_SCREENSHOT</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸‰deleteimageinbackgroundtask">ä¸‰ã€DeleteImageInBackgroundTask</h2>

<p>åœ¨åå°åˆ é™¤åª’ä½“å­˜å‚¨çš„å›¾ç‰‡ï¼Œæ­¤ç±»ç»§æ‰¿ <strong>AsyncTask</strong>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">DeleteImageInBackgroundTask</span> <span class="kd">extends</span> <span class="nc">AsyncTask</span><span class="o">&lt;</span><span class="nc">Uri</span><span class="o">,</span> <span class="nc">Void</span><span class="o">,</span> <span class="nc">Void</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Context</span> <span class="n">mContext</span><span class="o">;</span>

    <span class="nc">DeleteImageInBackgroundTask</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">Void</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="nc">Uri</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">params</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>

        <span class="c1">// ä»å‚æ•°è·å–æˆªå›¾çš„èµ„æºè·¯å¾„Uri</span>
        <span class="nc">Uri</span> <span class="n">screenshotUri</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
        <span class="c1">// è·å–ContentResolver</span>
        <span class="nc">ContentResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="n">mContext</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">();</span>
        <span class="c1">//  ä»ContentResolverç§»é™¤æŒ‡å®šå›¾ç‰‡</span>
        <span class="n">resolver</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">screenshotUri</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="c1">// ç»™æ–¹æ³•è¿”å›å€¼ç±»å‹Voidè¿”å›null</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

:ET