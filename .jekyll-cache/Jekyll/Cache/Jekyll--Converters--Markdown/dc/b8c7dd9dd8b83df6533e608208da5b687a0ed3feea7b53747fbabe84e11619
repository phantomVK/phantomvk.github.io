I"ßÎ<h2 id="ä¸€ç±»ç­¾å">ä¸€ã€ç±»ç­¾å</h2>

<p>è¿™æ˜¯ä¸ªå†…éƒ¨å·¥å…·ç±»ï¼Œç”¨äºè·Ÿè¸ªé‚£äº›æœªå®Œæˆçš„æˆ–å°šæœªç»“æŸçš„å…¨å±€ä»»åŠ¡ï¼Œæ–°ä»»åŠ¡é€šè¿‡æ–¹æ³• <strong>queue</strong> åŠ å…¥ã€‚æ·»åŠ  <strong>finisher</strong> çš„runnablesï¼Œç”± <strong>waitToFinish</strong> æ–¹æ³•ä¿è¯æ‰§è¡Œï¼Œç”¨äºä¿è¯ä»»åŠ¡å·²è¢«å¤„ç†å®Œæˆã€‚</p>

<p>è¿™ä¸ªç±»ç”¨äº <strong>SharedPreference</strong> ç¼–è¾‘åä¿®æ”¹å¼‚æ­¥å†™å…¥åˆ°ç£ç›˜ï¼Œæ‰€ä»¥è®¾è®¡ä¸€ä¸ªåœ¨ <strong>Activity.onPause</strong> æˆ–ç±»ä¼¼åœ°æ–¹ç­‰å¾…å†™å…¥æ“ä½œæœºåˆ¶ï¼Œè€Œè¿™ä¸ªæœºåˆ¶ä¹Ÿèƒ½ç”¨äºå…¶ä»–åŠŸèƒ½ã€‚æ‰€æœ‰æ’é˜Ÿçš„å¼‚æ­¥ä»»åŠ¡éƒ½åœ¨ä¸€ä¸ªç‹¬ç«‹ã€ä¸“ç”¨çš„çº¿ç¨‹ä¸Šå¤„ç†ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">QueuedWork</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="äºŒå¸¸é‡">äºŒã€å¸¸é‡</h2>

<p>å¯å»¶è¿Ÿ <strong>Runnable</strong> çš„å»¶è¿Ÿå€¼ã€‚è¯¥å€¼è®¾ç½®å¾—å°½å¯èƒ½å¤§ï¼Œä½†ä¹Ÿéœ€è¦è¶³å¤Ÿå°ï¼Œä»¤å»¶è¿Ÿéš¾ä»¥å¯Ÿè§‰ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">DELAY</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å½“ <strong>waitToFinish()</strong> è¿è¡Œè¶…è¿‡ <strong>MAX_WAIT_TIME_MILLIS</strong> æ¯«ç§’ï¼Œå‘å‡ºè­¦å‘Š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">MAX_WAIT_TIME_MILLIS</span> <span class="o">=</span> <span class="mi">512</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ¬ç±»ä½¿ç”¨çš„é”å¯¹è±¡</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="n">sLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸‰é™æ€å˜é‡">ä¸‰ã€é™æ€å˜é‡</h2>

<p>ç”¨æ­¤é”çº¦æŸä»»ä½•æ—¶å€™éƒ½åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å¤„ç†ä¸€ä¸ªä»»åŠ¡ï¼Œæ„å‘³ç€æ‰§è¡Œé¡ºåºå°±æ˜¯ä»»åŠ¡æ·»åŠ çš„é¡ºåºã€‚</p>

<p>å› ä¸ºä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šä¸€ç›´æŒæœ‰ <strong>sProcessingWork</strong> é”ï¼Œæ‰€ä»¥ <strong>sProcessingWork</strong> ç‹¬ç«‹äº <strong>sLock</strong> é¿å…é˜»å¡æ•´ä¸ªç±»çš„è¿è½¬</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="nc">Object</span> <span class="n">sProcessingWork</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å­˜æ”¾ <strong>Finisher</strong> çš„é“¾è¡¨ã€‚é€šè¿‡ <strong>added</strong> æ–¹æ³•æ·»åŠ ï¼Œæˆ– <strong>removed</strong> æ–¹æ³•ç§»é™¤</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">"sLock"</span><span class="o">)</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;</span> <span class="n">sFinishers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>QueuedWork</strong> å†…éƒ¨çš„é™æ€ <strong>HandlerThread</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">"sLock"</span><span class="o">)</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="nc">Handler</span> <span class="n">sHandler</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å­˜æ”¾é€šè¿‡ <strong>queue</strong> æ–¹æ³•æ·»åŠ ä»»åŠ¡çš„é˜Ÿåˆ—</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">"sLock"</span><span class="o">)</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;</span> <span class="n">sWork</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æŒ‡ç¤ºæ–°ä»»åŠ¡æ˜¯å¦èƒ½è¢«å»¶è¿Ÿï¼Œé»˜è®¤ä¸º <strong>true</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">"sLock"</span><span class="o">)</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">sCanDelay</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»»åŠ¡æ‰§è¡Œå‰ç­‰å¾…çš„æ—¶é—´</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">"sLock"</span><span class="o">)</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">ExponentiallyBucketedHistogram</span>
        <span class="n">mWaitTimes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExponentiallyBucketedHistogram</span><span class="o">(</span>
        <span class="mi">16</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ­£åœ¨ç­‰å¾…å¤„ç†çš„ä»»åŠ¡æ•°</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">mNumWaits</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å››é™æ€æ–¹æ³•">å››ã€é™æ€æ–¹æ³•</h2>

<h4 id="41-gethandler">4.1 getHandler()</h4>

<p><strong>HandlerThread</strong> å®ç°ç»†èŠ‚è¯·å‚è€ƒ <a href="/2018/06/13/HandlerThread/">Androidæºç ç³»åˆ—(11) â€“ HandlerThread</a>ã€‚è¯¥æ–‡ç« å·²ç»æåˆ° <strong>HandlerThread</strong> æœ¬è´¨æ˜¯çº¿ç¨‹ï¼Œå¯åŠ¨ <strong>HandlerThread</strong> å³å¯åŠ¨å­çº¿ç¨‹ï¼Œå¹¶è®©ä»»åŠ¡åœ¨è¯¥çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="nc">Handler</span> <span class="nf">getHandler</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">sLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sHandler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">HandlerThread</span> <span class="n">handlerThread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HandlerThread</span><span class="o">(</span><span class="s">"queued-work-looper"</span><span class="o">,</span>
                    <span class="nc">Process</span><span class="o">.</span><span class="na">THREAD_PRIORITY_FOREGROUND</span><span class="o">);</span>
            <span class="n">handlerThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

            <span class="n">sHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">QueuedWorkHandler</span><span class="o">(</span><span class="n">handlerThread</span><span class="o">.</span><span class="na">getLooper</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">sHandler</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="42-addfinisherrunnable-finisher">4.2 addFinisher(Runnable finisher)</h4>

<p>æ·»åŠ  <strong>finisher-runnable</strong> ç­‰å¾… <strong>queue()</strong> å¼‚æ­¥å¤„ç†ä»»åŠ¡ï¼Œç”± <strong>SharedPreferences$Editor.startCommit()</strong> ä½¿ç”¨</p>

<p>åº”æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•ä¸ä¼šå¼•èµ· <strong>finisher</strong> çš„æ‰§è¡Œã€‚è¿™åªæ˜¯è°ƒç”¨è€…çš„é›†åˆï¼Œè®©è°ƒç”¨è€…å¼‚æ­¥è·Ÿè¸ªä»»åŠ¡çš„æœ€æ–°çŠ¶æ€ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè°ƒç”¨è€…(å¦‚ï¼šSharedPreferences) ä¼šåœ¨ <strong>add()</strong> åå¾ˆå¿«åˆè°ƒç”¨ <strong>remove()</strong>ã€‚è¿™äº›ä»»åŠ¡å®é™…åœ¨ <strong>waitToFinish()</strong> æ‰§è¡Œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addFinisher</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">finisher</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">sLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sFinishers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">finisher</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="43-removefinisherrunnable-finisher">4.3 removeFinisher(Runnable finisher)</h4>

<p>ç§»é™¤ä¸€ä¸ªå·²ç»æ·»åŠ çš„ <strong>finisher-runnable</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">removeFinisher</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">finisher</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">sLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sFinishers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">finisher</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="44-waittofinish">4.4 waitToFinish()</h4>

<p>è§¦å‘æ’é˜Ÿä»»åŠ¡é©¬ä¸Šæ‰§è¡Œã€‚æ’é˜Ÿä»»åŠ¡åœ¨ç‹¬ç«‹çš„çº¿ç¨‹å¼‚æ­¥æ‰§è¡Œã€‚ä»»åŠ¡å’Œ <strong>finishers</strong> éƒ½åœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šè¿è¡Œï¼Œ<strong>finishers</strong> é€šè¿‡è¿™ç§æ–¹å¼å®ç°æ£€æŸ¥æ’é˜Ÿä»»åŠ¡æ˜¯å¦å®Œæˆã€‚</p>

<p><strong>Activity.onPause()</strong>ã€<strong>BroadcastReceiver.onReceive()ä¹‹å</strong>ã€<strong>å¤„ç†Service.commandä¹‹å</strong> éƒ½ä¼šè°ƒç”¨æ­¤æ–¹æ³•ï¼Œæ‰€ä»¥å¼‚æ­¥ä»»åŠ¡æ°¸è¿œä¸ä¼šä¸¢å¤±</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">waitToFinish</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="n">hadMessages</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="nc">Handler</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">getHandler</span><span class="o">();</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">sLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">handler</span><span class="o">.</span><span class="na">hasMessages</span><span class="o">(</span><span class="nc">QueuedWorkHandler</span><span class="o">.</span><span class="na">MSG_RUN</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// å»¶è¿Ÿä»»åŠ¡ä¼šåœ¨processPendingWork()ä¸­å¤„ç†</span>
            <span class="n">handler</span><span class="o">.</span><span class="na">removeMessages</span><span class="o">(</span><span class="nc">QueuedWorkHandler</span><span class="o">.</span><span class="na">MSG_RUN</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// ä¸è¦å»¶è¿Ÿä»»ä½•ä»»åŠ¡ï¼Œå› ä¸ºè¿™æ ·å¯èƒ½ä¼šæ¨è¿Ÿfinishersçš„æ‰§è¡Œ</span>
        <span class="n">sCanDelay</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nc">StrictMode</span><span class="o">.</span><span class="na">ThreadPolicy</span> <span class="n">oldPolicy</span> <span class="o">=</span> <span class="nc">StrictMode</span><span class="o">.</span><span class="na">allowThreadDiskWrites</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// æ‰€æœ‰ç­‰å¾…ä»»åŠ¡è¿è¡Œå®Œæ¯•</span>
        <span class="n">processPendingWork</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="nc">StrictMode</span><span class="o">.</span><span class="na">setThreadPolicy</span><span class="o">(</span><span class="n">oldPolicy</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Runnable</span> <span class="n">finisher</span><span class="o">;</span>
            
            <span class="c1">// ä»sFinishersè·å–ä¸€ä¸ªFinisher</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">sLock</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">finisher</span> <span class="o">=</span> <span class="n">sFinishers</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">finisher</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            
            <span class="c1">// æ‰§è¡ŒFinisher</span>
            <span class="n">finisher</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="c1">// æ‰€æœ‰finisherè¿è¡Œå®Œæ¯•</span>
        <span class="n">sCanDelay</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// ç»Ÿè®¡ä»»åŠ¡æ‰§è¡Œçš„æ€»æ—¶é—´å’Œé€’å¢çš„ç­‰å¾…æ¬¡æ•°</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">sLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">waitTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">waitTime</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hadMessages</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mWaitTimes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">waitTime</span><span class="o">).</span><span class="na">intValue</span><span class="o">());</span>
            <span class="n">mNumWaits</span><span class="o">++;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨ <strong>ActivityThread</strong> ç±»å†…å…±æœ‰äº”æ®µæºç è°ƒç”¨ <strong>QueuedWork.waitToFinish();</strong></p>

<p>ä½ç½®ä¸€ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleServiceArgs</span><span class="o">(</span><span class="nc">ServiceArgsData</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Service</span> <span class="n">s</span> <span class="o">=</span> <span class="n">mServices</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">token</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">args</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">data</span><span class="o">.</span><span class="na">args</span><span class="o">.</span><span class="na">setExtrasClassLoader</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>
                <span class="n">data</span><span class="o">.</span><span class="na">args</span><span class="o">.</span><span class="na">prepareToEnterProcess</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="kt">int</span> <span class="n">res</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">data</span><span class="o">.</span><span class="na">taskRemoved</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">onStartCommand</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">args</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">flags</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">startId</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">s</span><span class="o">.</span><span class="na">onTaskRemoved</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">args</span><span class="o">);</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nc">Service</span><span class="o">.</span><span class="na">START_TASK_REMOVED_COMPLETE</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nc">QueuedWork</span><span class="o">.</span><span class="na">waitToFinish</span><span class="o">();</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">ActivityManager</span><span class="o">.</span><span class="na">getService</span><span class="o">().</span><span class="na">serviceDoneExecuting</span><span class="o">(</span>
                        <span class="n">data</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="no">SERVICE_DONE_EXECUTING_START</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">startId</span><span class="o">,</span> <span class="n">res</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">ensureJitEnabled</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mInstrumentation</span><span class="o">.</span><span class="na">onException</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">e</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                        <span class="s">"Unable to start service "</span> <span class="o">+</span> <span class="n">s</span>
                        <span class="o">+</span> <span class="s">" with "</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="na">args</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½ç½®äºŒï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleStopService</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Service</span> <span class="n">s</span> <span class="o">=</span> <span class="n">mServices</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">localLOGV</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Destroying service "</span> <span class="o">+</span> <span class="n">s</span><span class="o">);</span>
            <span class="n">s</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
            <span class="n">s</span><span class="o">.</span><span class="na">detachAndCleanUp</span><span class="o">();</span>
            <span class="nc">Context</span> <span class="n">context</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getBaseContext</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="k">instanceof</span> <span class="nc">ContextImpl</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="nc">String</span> <span class="n">who</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getClassName</span><span class="o">();</span>
                <span class="o">((</span><span class="nc">ContextImpl</span><span class="o">)</span> <span class="n">context</span><span class="o">).</span><span class="na">scheduleFinalCleanup</span><span class="o">(</span><span class="n">who</span><span class="o">,</span> <span class="s">"Service"</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nc">QueuedWork</span><span class="o">.</span><span class="na">waitToFinish</span><span class="o">();</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">ActivityManager</span><span class="o">.</span><span class="na">getService</span><span class="o">().</span><span class="na">serviceDoneExecuting</span><span class="o">(</span>
                        <span class="n">token</span><span class="o">,</span> <span class="no">SERVICE_DONE_EXECUTING_STOP</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mInstrumentation</span><span class="o">.</span><span class="na">onException</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">e</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                        <span class="s">"Unable to stop service "</span> <span class="o">+</span> <span class="n">s</span>
                        <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="nc">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"handleStopService: exception for "</span> <span class="o">+</span> <span class="n">token</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="nc">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"handleStopService: token="</span> <span class="o">+</span> <span class="n">token</span> <span class="o">+</span> <span class="s">" not found."</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//Slog.i(TAG, "Running services: " + mServices);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½ç½®ä¸‰ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handlePauseActivity</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">finished</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">userLeaving</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">configChanges</span><span class="o">,</span> <span class="nc">PendingTransactionActions</span> <span class="n">pendingActions</span><span class="o">,</span> <span class="nc">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ActivityClientRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="n">mActivities</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">userLeaving</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">performUserLeavingActivity</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">r</span><span class="o">.</span><span class="na">activity</span><span class="o">.</span><span class="na">mConfigChangeFlags</span> <span class="o">|=</span> <span class="n">configChanges</span><span class="o">;</span>
        <span class="n">performPauseActivity</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">finished</span><span class="o">,</span> <span class="n">reason</span><span class="o">,</span> <span class="n">pendingActions</span><span class="o">);</span>

        <span class="c1">// Make sure any pending writes are now committed.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">isPreHoneycomb</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">QueuedWork</span><span class="o">.</span><span class="na">waitToFinish</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">mSomeActivitiesChanged</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½ç½®å››ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleStopActivity</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">show</span><span class="o">,</span> <span class="kt">int</span> <span class="n">configChanges</span><span class="o">,</span>
        <span class="nc">PendingTransactionActions</span> <span class="n">pendingActions</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">finalStateRequest</span><span class="o">,</span> <span class="nc">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">ActivityClientRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="n">mActivities</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="n">r</span><span class="o">.</span><span class="na">activity</span><span class="o">.</span><span class="na">mConfigChangeFlags</span> <span class="o">|=</span> <span class="n">configChanges</span><span class="o">;</span>

    <span class="kd">final</span> <span class="nc">StopInfo</span> <span class="n">stopInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StopInfo</span><span class="o">();</span>
    <span class="n">performStopActivityInner</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">stopInfo</span><span class="o">,</span> <span class="n">show</span><span class="o">,</span> <span class="kc">true</span> <span class="cm">/* saveState */</span><span class="o">,</span> <span class="n">finalStateRequest</span><span class="o">,</span>
            <span class="n">reason</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">localLOGV</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span>
        <span class="no">TAG</span><span class="o">,</span> <span class="s">"Finishing stop of "</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="s">": show="</span> <span class="o">+</span> <span class="n">show</span>
        <span class="o">+</span> <span class="s">" win="</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">window</span><span class="o">);</span>

    <span class="n">updateVisibility</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">show</span><span class="o">);</span>

    <span class="c1">// Make sure any pending writes are now committed.</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">r</span><span class="o">.</span><span class="na">isPreHoneycomb</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">QueuedWork</span><span class="o">.</span><span class="na">waitToFinish</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">stopInfo</span><span class="o">.</span><span class="na">setActivity</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
    <span class="n">stopInfo</span><span class="o">.</span><span class="na">setState</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">state</span><span class="o">);</span>
    <span class="n">stopInfo</span><span class="o">.</span><span class="na">setPersistentState</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">persistentState</span><span class="o">);</span>
    <span class="n">pendingActions</span><span class="o">.</span><span class="na">setStopInfo</span><span class="o">(</span><span class="n">stopInfo</span><span class="o">);</span>
    <span class="n">mSomeActivitiesChanged</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½ç½®äº”ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="c1">// TODO: This method should be changed to use {@link #performStopActivityInner} to perform to</span>
<span class="c1">// stop operation on the activity to reduce code duplication and the chance of fixing a bug in</span>
<span class="c1">// one place and missing the other.</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleSleeping</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">sleeping</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ActivityClientRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="n">mActivities</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"handleSleeping: no activity for token "</span> <span class="o">+</span> <span class="n">token</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">sleeping</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">r</span><span class="o">.</span><span class="na">stopped</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">r</span><span class="o">.</span><span class="na">isPreHoneycomb</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">callActivityOnStop</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="kc">true</span> <span class="cm">/* saveState */</span><span class="o">,</span> <span class="s">"sleeping"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// Make sure any pending writes are now committed.</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">r</span><span class="o">.</span><span class="na">isPreHoneycomb</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">QueuedWork</span><span class="o">.</span><span class="na">waitToFinish</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// Tell activity manager we slept.</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">ActivityManager</span><span class="o">.</span><span class="na">getService</span><span class="o">().</span><span class="na">activitySlept</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">token</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">stopped</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">.</span><span class="na">activity</span><span class="o">.</span><span class="na">mVisibleFromServer</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">r</span><span class="o">.</span><span class="na">activity</span><span class="o">.</span><span class="na">performRestart</span><span class="o">(</span><span class="kc">true</span> <span class="cm">/* start */</span><span class="o">,</span> <span class="s">"handleSleeping"</span><span class="o">);</span>
            <span class="n">r</span><span class="o">.</span><span class="na">setState</span><span class="o">(</span><span class="no">ON_START</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="45-queuerunnable-work-boolean-shoulddelay">4.5 queue(Runnable work, boolean shouldDelay)</h4>

<p>å®‰æ’ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œã€‚<strong>work</strong> æ˜¯æ–°åŠ å…¥çš„ä»»åŠ¡ï¼Œ<strong>shouldDelay</strong> æŒ‡æ˜æœ¬ä»»åŠ¡æ˜¯å¦èƒ½å»¶è¿Ÿå¤„ç†ã€‚</p>

<p><strong>SharedPreferences.Editor.appy()</strong> æºç é—´æ¥è°ƒç”¨æ­¤æ–¹æ³•ï¼Œè°ƒç”¨æ—¶ <strong>shouldDelay</strong> ä¸º <strong>true</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">queue</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">work</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">shouldDelay</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Handler</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">getHandler</span><span class="o">();</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">sLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ä»»åŠ¡æ”¾å…¥sWorkåˆ—è¡¨ä¸­</span>
        <span class="n">sWork</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">work</span><span class="o">);</span>

        <span class="c1">// ç„¶åæ”¾å…¥ä¸€ä¸ªMessageä½œä¸ºé€šçŸ¥</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">shouldDelay</span> <span class="o">&amp;&amp;</span> <span class="n">sCanDelay</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// sCanDelayé»˜è®¤ä¸ºtrueï¼Œæ”¯æŒå»¶è¿Ÿ100ms</span>
            <span class="n">handler</span><span class="o">.</span><span class="na">sendEmptyMessageDelayed</span><span class="o">(</span><span class="nc">QueuedWorkHandler</span><span class="o">.</span><span class="na">MSG_RUN</span><span class="o">,</span> <span class="no">DELAY</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// æ”¾å…¥ä¸€ä¸ªé©¬ä¸Šè§¦å‘è¿è¡Œçš„æ¶ˆæ¯</span>
            <span class="n">handler</span><span class="o">.</span><span class="na">sendEmptyMessage</span><span class="o">(</span><span class="nc">QueuedWorkHandler</span><span class="o">.</span><span class="na">MSG_RUN</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="46-haspendingwork">4.6 hasPendingWork()</h4>

<p>å½“é˜Ÿåˆ—å­˜åœ¨ç­‰å¾…çš„å¼‚æ­¥ä»»åŠ¡æ—¶è¿”å› <strong>true</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">hasPendingWork</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">sLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="n">sWork</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="47-processpendingwork">4.7 processPendingWork()</h4>

<p>ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–ä»»åŠ¡æ‰§è¡Œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">processPendingWork</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// æ­¤å¤„ä½¿ç”¨sProcessingWorké”ï¼Œä¿è¯sWork</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">sProcessingWork</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;</span> <span class="n">work</span><span class="o">;</span>

        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">sLock</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// å…‹éš†sWorkä¸ºworkå®ä¾‹</span>
            <span class="n">work</span> <span class="o">=</span> <span class="o">(</span><span class="nc">LinkedList</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;)</span> <span class="n">sWork</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
            <span class="c1">// æ¸…é™¤sWork</span>
            <span class="n">sWork</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

            <span class="c1">// åˆ©ç”¨QueuedWorkHandler.MSG_RUNç§»é™¤ç›¸å…³Messages</span>
            <span class="c1">// é¿å…ä»¥åæ”¶åˆ°ç±»ä¼¼é€šçŸ¥ï¼Œè€Œä»»åŠ¡å´å·²ç»å®Œæˆæ‰§è¡Œ</span>
            <span class="n">getHandler</span><span class="o">().</span><span class="na">removeMessages</span><span class="o">(</span><span class="nc">QueuedWorkHandler</span><span class="o">.</span><span class="na">MSG_RUN</span><span class="o">);</span>
        <span class="o">}</span>
        
        <span class="c1">// æ ¹æ®workä»»åŠ¡æ’åˆ—é¡ºåºä¾æ¬¡æ‰§è¡Œ</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">work</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Runnable</span> <span class="n">w</span> <span class="o">:</span> <span class="n">work</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">w</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="äº”queuedworkhandler">äº”ã€QueuedWorkHandler</h2>

<p>æ”¶åˆ° <strong>msg.what == MSG_RUN</strong> æ¶ˆæ¯é€šçŸ¥å°±å»è°ƒç”¨<a href="/2018/11/05/QueuedWork/#47-processpendingwork">processPendingWork()</a>æ–¹æ³•ã€‚è¯¥ <strong>Handler</strong> ç”± <strong>Looper</strong> è°ƒç”¨ï¼Œ <strong>Looper</strong> åˆåœ¨å­çº¿ç¨‹ï¼Œæ‰€ä»¥ <strong>Handler</strong> åœ¨å­çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">QueuedWorkHandler</span> <span class="kd">extends</span> <span class="nc">Handler</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MSG_RUN</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>

    <span class="nc">QueuedWorkHandler</span><span class="o">(</span><span class="nc">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">looper</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// æ”¶åˆ°Message</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span> <span class="o">==</span> <span class="no">MSG_RUN</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// è§¦å‘æ–¹æ³•è°ƒç”¨ï¼ŒæŠŠsWorkå†…æ‰€æœ‰ä»»åŠ¡æ‰¹é‡é€å»æ‰§è¡Œ</span>
            <span class="n">processPendingWork</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
:ET