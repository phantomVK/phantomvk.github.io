I"nÀ<h2 id="ä¸€å‰è¨€">ä¸€ã€å‰è¨€</h2>

<p><strong>SharedPreferences</strong> é€šè¿‡è¯»å†™ç£ç›˜xmlæ–‡ä»¶çš„æ–¹å¼ï¼Œä¸ºå®¢æˆ·ç«¯æä¾›ä¾¿æ·çš„é”®å€¼å¯¹æŒä¹…åŒ–æœåŠ¡ã€‚åŒæ—¶æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ•°æ®æäº¤æ–¹å¼ï¼Œå‡å°‘å¯¹ä¸»çº¿ç¨‹è¿è¡Œçš„å½±å“ã€‚</p>

<p>è™½ç„¶æ­¤å·¥å…·ç±»å› ä½¿ç”¨æ–¹ä¾¿æ·±å¾—å¼€å‘è€…çš„é’çï¼Œä½†å…¶å¤šçº¿ç¨‹æ“ä½œã€å¤šè¿›ç¨‹æ“ä½œæ˜¯å¦å®‰å…¨çš„é—®é¢˜ï¼Œå´é²œæœ‰äººæ¢ç©¶ã€‚å¯¹ <strong>SharedPreferences</strong> å­˜å–æ“ä½œæ„Ÿå…´è¶£çš„è¯»è€…ï¼Œè¿™é‡Œå…ˆä¸ºæ‚¨å‘ˆä¸Šæ–‡ç«  <a href="/2018/09/14/SharedPreferences/">SharedPreferences</a>ã€‚</p>

<p>æ¥ä¸‹æ¥é€è¿‡è¿›ç¨‹å¯åŠ¨æµç¨‹ï¼Œå¾—å‡ºä¸»é¢˜ç»“è®ºã€‚å› ä¸ºæ¶‰åŠ <strong>ActivityThread</strong>ã€<strong>ApplicationThread</strong>ã€<strong>ActivityManagerService</strong>ã€Android IPCç­‰çŸ¥è¯†ï¼Œè¯·è‡ªè¡ŒæŸ¥é˜…ï¼Œæœ¬æ–‡ä¸å†èµ˜è¿°ã€‚</p>

<p>æœ¬æ–‡æºç æ¥è‡ª <strong>Android 23</strong>ã€‚</p>

<h2 id="äºŒactivitythread">äºŒã€ActivityThread</h2>

<p>çœç•¥å‰é¢æºActivityæ£€æŸ¥å’Œåˆ›å»ºæ“ä½œï¼Œç›´åˆ°æ–°åº”ç”¨çš„ <strong>ActivityThread</strong> æŠŠ <strong>ApplicationThread</strong> æ³¨å†Œåˆ° <strong>ActivityManagerService</strong>ã€‚æ³¨å†Œå®Œæˆå <strong>ActivityManagerService</strong> é€šè¿‡IPCè°ƒç”¨ <strong>IApplicationThread.bindApplication(â€¦)</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">attachApplicationLocked</span><span class="o">(</span><span class="nc">IApplicationThread</span> <span class="n">thread</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pid</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">.....</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="o">.....</span>
        <span class="c1">// ç»è¿‡ä¸Šè¿°å¤„ç†åï¼Œé€šè¿‡IPCè°ƒç”¨ApplicationThread.bindApplication()</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">bindApplication</span><span class="o">(</span><span class="n">processName</span><span class="o">,</span> <span class="n">appInfo</span><span class="o">,</span> <span class="n">providers</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">instrumentationClass</span><span class="o">,</span>
                <span class="n">profilerInfo</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">instrumentationArguments</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">instrumentationWatcher</span><span class="o">,</span>
                <span class="n">app</span><span class="o">.</span><span class="na">instrumentationUiAutomationConnection</span><span class="o">,</span> <span class="n">testMode</span><span class="o">,</span> <span class="n">enableOpenGlTrace</span><span class="o">,</span>
                <span class="n">isRestrictedBackupMode</span> <span class="o">||</span> <span class="o">!</span><span class="n">normalMode</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">persistent</span><span class="o">,</span>
                <span class="k">new</span> <span class="nf">Configuration</span><span class="o">(</span><span class="n">mConfiguration</span><span class="o">),</span> <span class="n">app</span><span class="o">.</span><span class="na">compat</span><span class="o">,</span>
                <span class="n">getCommonServicesLocked</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">isolated</span><span class="o">),</span>
                <span class="n">mCoreSettingsObserver</span><span class="o">.</span><span class="na">getCoreSettingsLocked</span><span class="o">());</span>
        <span class="n">updateLruProcessLocked</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">lastRequestedGc</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="na">lastLowMemory</span> <span class="o">=</span> <span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// todo: Yikes!  What should we do?  For now we will try to</span>
        <span class="c1">// start another process, but that could easily get us in</span>
        <span class="c1">// an infinite loop of restarting processes...</span>
        <span class="nc">Slog</span><span class="o">.</span><span class="na">wtf</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Exception thrown during bind of "</span> <span class="o">+</span> <span class="n">app</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>

        <span class="n">app</span><span class="o">.</span><span class="na">resetPackageList</span><span class="o">(</span><span class="n">mProcessStats</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">unlinkDeathRecipient</span><span class="o">();</span>
        <span class="n">startProcessLocked</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="s">"bind fail"</span><span class="o">,</span> <span class="n">processName</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="o">.....</span>

    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®ç°æ–¹æ³•æ˜¯ <strong>ActivityThread.ApplicationThread.bindApplication()</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">bindApplication</span><span class="o">(</span><span class="nc">String</span> <span class="n">processName</span><span class="o">,</span> <span class="nc">ApplicationInfo</span> <span class="n">appInfo</span><span class="o">,</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ProviderInfo</span><span class="o">&gt;</span> <span class="n">providers</span><span class="o">,</span> <span class="nc">ComponentName</span> <span class="n">instrumentationName</span><span class="o">,</span>
        <span class="nc">ProfilerInfo</span> <span class="n">profilerInfo</span><span class="o">,</span> <span class="nc">Bundle</span> <span class="n">instrumentationArgs</span><span class="o">,</span>
        <span class="nc">IInstrumentationWatcher</span> <span class="n">instrumentationWatcher</span><span class="o">,</span>
        <span class="nc">IUiAutomationConnection</span> <span class="n">instrumentationUiConnection</span><span class="o">,</span> <span class="kt">int</span> <span class="n">debugMode</span><span class="o">,</span>
        <span class="kt">boolean</span> <span class="n">enableOpenGlTrace</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isRestrictedBackupMode</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">persistent</span><span class="o">,</span>
        <span class="nc">Configuration</span> <span class="n">config</span><span class="o">,</span> <span class="nc">CompatibilityInfo</span> <span class="n">compatInfo</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">IBinder</span><span class="o">&gt;</span> <span class="n">services</span><span class="o">,</span>
        <span class="nc">Bundle</span> <span class="n">coreSettings</span><span class="o">)</span> <span class="o">{</span>

    <span class="o">.....</span>

    <span class="nc">IPackageManager</span> <span class="n">pm</span> <span class="o">=</span> <span class="n">getPackageManager</span><span class="o">();</span>
    <span class="n">android</span><span class="o">.</span><span class="na">content</span><span class="o">.</span><span class="na">pm</span><span class="o">.</span><span class="na">PackageInfo</span> <span class="n">pi</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">pi</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="na">getPackageInfo</span><span class="o">(</span><span class="n">appInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nc">UserHandle</span><span class="o">.</span><span class="na">myUserId</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">pi</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">sharedUserIdSet</span> <span class="o">=</span> <span class="o">(</span><span class="n">pi</span><span class="o">.</span><span class="na">sharedUserId</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
        <span class="kt">boolean</span> <span class="n">processNameNotDefault</span> <span class="o">=</span>
        <span class="o">(</span><span class="n">pi</span><span class="o">.</span><span class="na">applicationInfo</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
         <span class="o">!</span><span class="n">appInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pi</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">processName</span><span class="o">));</span>
        <span class="kt">boolean</span> <span class="n">sharable</span> <span class="o">=</span> <span class="o">(</span><span class="n">sharedUserIdSet</span> <span class="o">||</span> <span class="n">processNameNotDefault</span><span class="o">);</span>

        <span class="c1">// é™¤éåº”ç”¨æ˜¯ä¸ªå…±äº«è¿›ç¨‹ï¼Œå¦åˆ™æŠŠåº”ç”¨ä¿¡æ¯å‘Šè¯‰VMRuntime</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">sharable</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">VMRuntime</span><span class="o">.</span><span class="na">registerAppInfo</span><span class="o">(</span><span class="n">appInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">appInfo</span><span class="o">.</span><span class="na">dataDir</span><span class="o">,</span>
                                    <span class="n">appInfo</span><span class="o">.</span><span class="na">processName</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// æ„å»ºAppBindData</span>
    <span class="nc">AppBindData</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AppBindData</span><span class="o">();</span>
    <span class="n">data</span><span class="o">.</span><span class="na">processName</span> <span class="o">=</span> <span class="n">processName</span><span class="o">;</span>
    <span class="n">data</span><span class="o">.</span><span class="na">appInfo</span> <span class="o">=</span> <span class="n">appInfo</span><span class="o">;</span>
    <span class="n">data</span><span class="o">.</span><span class="na">providers</span> <span class="o">=</span> <span class="n">providers</span><span class="o">;</span>
    <span class="n">data</span><span class="o">.</span><span class="na">instrumentationName</span> <span class="o">=</span> <span class="n">instrumentationName</span><span class="o">;</span>
    <span class="n">data</span><span class="o">.</span><span class="na">instrumentationArgs</span> <span class="o">=</span> <span class="n">instrumentationArgs</span><span class="o">;</span>
    <span class="n">data</span><span class="o">.</span><span class="na">instrumentationWatcher</span> <span class="o">=</span> <span class="n">instrumentationWatcher</span><span class="o">;</span>
    <span class="n">data</span><span class="o">.</span><span class="na">instrumentationUiAutomationConnection</span> <span class="o">=</span> <span class="n">instrumentationUiConnection</span><span class="o">;</span>
    <span class="n">data</span><span class="o">.</span><span class="na">debugMode</span> <span class="o">=</span> <span class="n">debugMode</span><span class="o">;</span>
    <span class="n">data</span><span class="o">.</span><span class="na">enableOpenGlTrace</span> <span class="o">=</span> <span class="n">enableOpenGlTrace</span><span class="o">;</span>
    <span class="n">data</span><span class="o">.</span><span class="na">restrictedBackupMode</span> <span class="o">=</span> <span class="n">isRestrictedBackupMode</span><span class="o">;</span>
    <span class="n">data</span><span class="o">.</span><span class="na">persistent</span> <span class="o">=</span> <span class="n">persistent</span><span class="o">;</span>
    <span class="n">data</span><span class="o">.</span><span class="na">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">;</span>
    <span class="n">data</span><span class="o">.</span><span class="na">compatInfo</span> <span class="o">=</span> <span class="n">compatInfo</span><span class="o">;</span>
    <span class="n">data</span><span class="o">.</span><span class="na">initProfilerInfo</span> <span class="o">=</span> <span class="n">profilerInfo</span><span class="o">;</span>
    <span class="c1">// ApplicationThreadå†…é€šè¿‡Handlerå‘é€æ¶ˆæ¯åˆ°ActivityThread</span>
    <span class="n">sendMessage</span><span class="o">(</span><span class="no">H</span><span class="o">.</span><span class="na">BIND_APPLICATION</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>ActivityThread</strong> çš„ <strong>Handler</strong> å®ç°ç±» <strong>H</strong> æ¥æ”¶ <strong>BIND_APPLICATION</strong> æŒ‡ä»¤å¹¶æ‰§è¡Œé€»è¾‘ï¼Œè¿™ä¸ª <strong>Handler</strong> å’Œå¯¹åº”çš„ <strong>Looper</strong> ç»„ä»¶å°±æ˜¯å¸¸è¯´çš„ä¸»çº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸Šã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">class</span> <span class="nc">H</span> <span class="kd">extends</span> <span class="nc">Handler</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å›è°ƒ <strong>H</strong> çš„æ–¹æ³• <strong>handleMessage(Message msg</strong>)</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">.....</span>

        <span class="k">case</span> <span class="nl">BIND_APPLICATION:</span>
            <span class="c1">// ä»Messageå–å‡ºä¼ é€çš„å¯¹è±¡</span>
            <span class="nc">AppBindData</span> <span class="n">data</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AppBindData</span><span class="o">)</span><span class="n">msg</span><span class="o">.</span><span class="na">obj</span><span class="o">;</span>
            <span class="c1">// è°ƒç”¨æ–¹æ³•</span>
            <span class="n">handleBindApplication</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
        
        <span class="o">.....</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»ä¸Šé¢çš„é€»è¾‘å¼€å§‹è°ƒç”¨ <strong>ActivityThread</strong> çš„ <strong>handleBindApplication(data)</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
</pre></td><td class="rouge-code"><pre><span class="c1">// ActivityThreadçš„æˆå‘˜å˜é‡mInstrumentation</span>
<span class="nc">Instrumentation</span> <span class="n">mInstrumentation</span><span class="o">;</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleBindApplication</span><span class="o">(</span><span class="nc">AppBindData</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mBoundApplication</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
    <span class="n">mConfiguration</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Configuration</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">config</span><span class="o">);</span>
    <span class="n">mCompatConfiguration</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Configuration</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">config</span><span class="o">);</span>

    <span class="n">mProfiler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Profiler</span><span class="o">();</span>
    <span class="o">.....</span>

    <span class="c1">// åˆ›å»ºContextImplå®ä¾‹</span>
    <span class="kd">final</span> <span class="nc">ContextImpl</span> <span class="n">appContext</span> <span class="o">=</span> <span class="nc">ContextImpl</span><span class="o">.</span><span class="na">createAppContext</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="nc">Process</span><span class="o">.</span><span class="na">isIsolated</span><span class="o">())</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">File</span> <span class="n">cacheDir</span> <span class="o">=</span> <span class="n">appContext</span><span class="o">.</span><span class="na">getCacheDir</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">cacheDir</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Provide a usable directory for temporary files</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"java.io.tmpdir"</span><span class="o">,</span> <span class="n">cacheDir</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Unable to initialize \"java.io.tmpdir\" property due to missing cache directory"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// Use codeCacheDir to store generated/compiled graphics code</span>
        <span class="kd">final</span> <span class="nc">File</span> <span class="n">codeCacheDir</span> <span class="o">=</span> <span class="n">appContext</span><span class="o">.</span><span class="na">getCodeCacheDir</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">codeCacheDir</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">setupGraphicsSupport</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">,</span> <span class="n">codeCacheDir</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Unable to setupGraphicsSupport due to missing code-cache directory"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="o">.....</span>
        
    <span class="k">if</span> <span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">instrumentationName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">InstrumentationInfo</span> <span class="n">ii</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// è·å–InstrumentationInfo</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">appContext</span><span class="o">.</span><span class="na">getPackageManager</span><span class="o">().</span>
                <span class="n">getInstrumentationInfo</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">instrumentationName</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">PackageManager</span><span class="o">.</span><span class="na">NameNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ii</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                <span class="s">"Unable to find instrumentation info for: "</span>
                <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="na">instrumentationName</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">mInstrumentationPackageName</span> <span class="o">=</span> <span class="n">ii</span><span class="o">.</span><span class="na">packageName</span><span class="o">;</span>
        <span class="n">mInstrumentationAppDir</span> <span class="o">=</span> <span class="n">ii</span><span class="o">.</span><span class="na">sourceDir</span><span class="o">;</span>
        <span class="n">mInstrumentationSplitAppDirs</span> <span class="o">=</span> <span class="n">ii</span><span class="o">.</span><span class="na">splitSourceDirs</span><span class="o">;</span>
        <span class="n">mInstrumentationLibDir</span> <span class="o">=</span> <span class="n">ii</span><span class="o">.</span><span class="na">nativeLibraryDir</span><span class="o">;</span>
        <span class="n">mInstrumentedAppDir</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">getAppDir</span><span class="o">();</span>
        <span class="n">mInstrumentedSplitAppDirs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">getSplitAppDirs</span><span class="o">();</span>
        <span class="n">mInstrumentedLibDir</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">getLibDir</span><span class="o">();</span>

        <span class="nc">ApplicationInfo</span> <span class="n">instrApp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ApplicationInfo</span><span class="o">();</span>
        <span class="n">instrApp</span><span class="o">.</span><span class="na">packageName</span> <span class="o">=</span> <span class="n">ii</span><span class="o">.</span><span class="na">packageName</span><span class="o">;</span>
        <span class="n">instrApp</span><span class="o">.</span><span class="na">sourceDir</span> <span class="o">=</span> <span class="n">ii</span><span class="o">.</span><span class="na">sourceDir</span><span class="o">;</span>
        <span class="n">instrApp</span><span class="o">.</span><span class="na">publicSourceDir</span> <span class="o">=</span> <span class="n">ii</span><span class="o">.</span><span class="na">publicSourceDir</span><span class="o">;</span>
        <span class="n">instrApp</span><span class="o">.</span><span class="na">splitSourceDirs</span> <span class="o">=</span> <span class="n">ii</span><span class="o">.</span><span class="na">splitSourceDirs</span><span class="o">;</span>
        <span class="n">instrApp</span><span class="o">.</span><span class="na">splitPublicSourceDirs</span> <span class="o">=</span> <span class="n">ii</span><span class="o">.</span><span class="na">splitPublicSourceDirs</span><span class="o">;</span>
        <span class="n">instrApp</span><span class="o">.</span><span class="na">dataDir</span> <span class="o">=</span> <span class="n">ii</span><span class="o">.</span><span class="na">dataDir</span><span class="o">;</span>
        <span class="n">instrApp</span><span class="o">.</span><span class="na">nativeLibraryDir</span> <span class="o">=</span> <span class="n">ii</span><span class="o">.</span><span class="na">nativeLibraryDir</span><span class="o">;</span>
        <span class="nc">LoadedApk</span> <span class="n">pi</span> <span class="o">=</span> <span class="n">getPackageInfo</span><span class="o">(</span><span class="n">instrApp</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">compatInfo</span><span class="o">,</span>
                <span class="n">appContext</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="nc">ContextImpl</span> <span class="n">instrContext</span> <span class="o">=</span> <span class="nc">ContextImpl</span><span class="o">.</span><span class="na">createAppContext</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">pi</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// è·å–ç±»åŠ è½½å™¨</span>
            <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">instrContext</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span>
            <span class="c1">// é€šè¿‡åå°„åˆ›å»ºInstrumentationå®ä¾‹</span>
            <span class="c1">// ç±»åç”±data.instrumentationName.getClassName()æŒ‡å®š</span>
            <span class="n">mInstrumentation</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Instrumentation</span><span class="o">)</span>
                <span class="n">cl</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">instrumentationName</span><span class="o">.</span><span class="na">getClassName</span><span class="o">()).</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                <span class="s">"Unable to instantiate instrumentation "</span>
                <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="na">instrumentationName</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// ä¸Šé¢åˆ›å»ºçš„ContextImplå®ä¾‹å¼•ç”¨ä¿å­˜åœ¨Instrumentation</span>
        <span class="c1">// æ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªActivityThreadï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ªInstrumentationå®ä¾‹</span>
        <span class="c1">// å¯çŸ¥ContextImplåœ¨ä¸€ä¸ªè¿›ç¨‹é‡Œåªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œæ‰€ä»¥è¿›ç¨‹èƒ½æ§åˆ¶å…¶çº¿ç¨‹å®‰å…¨</span>
        <span class="n">mInstrumentation</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">instrContext</span><span class="o">,</span> <span class="n">appContext</span><span class="o">,</span>
               <span class="k">new</span> <span class="nf">ComponentName</span><span class="o">(</span><span class="n">ii</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">ii</span><span class="o">.</span><span class="na">name</span><span class="o">),</span><span class="n">data</span><span class="o">.</span><span class="na">instrumentationWatcher</span><span class="o">,</span>
               <span class="n">data</span><span class="o">.</span><span class="na">instrumentationUiAutomationConnection</span><span class="o">);</span>
        
        <span class="o">.....</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">mInstrumentation</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Instrumentation</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="o">.....</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸‰instrumentation">ä¸‰ã€Instrumentation</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Instrumentation</span> <span class="o">{</span>
    <span class="c1">// ç”¨äºçº¿ç¨‹åŒæ­¥çš„å®ä¾‹</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="n">mSync</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
    <span class="c1">// æŒæœ‰ActivityThread</span>
    <span class="kd">private</span> <span class="nc">ActivityThread</span> <span class="n">mThread</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="c1">// ä»ActivityThreadçš„çº¿ç¨‹Looperè·å¾—MessageQueue</span>
    <span class="kd">private</span> <span class="nc">MessageQueue</span> <span class="n">mMessageQueue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Context</span> <span class="n">mInstrContext</span><span class="o">;</span>
    <span class="c1">// ApplicationContextï¼Œå°±æ˜¯ContextImplçš„å®ä¾‹</span>
    <span class="kd">private</span> <span class="nc">Context</span> <span class="n">mAppContext</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">ComponentName</span> <span class="n">mComponent</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Thread</span> <span class="n">mRunner</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ActivityWaiter</span><span class="o">&gt;</span> <span class="n">mWaitingActivities</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ActivityMonitor</span><span class="o">&gt;</span> <span class="n">mActivityMonitors</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">IInstrumentationWatcher</span> <span class="n">mWatcher</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">IUiAutomationConnection</span> <span class="n">mUiAutomationConnection</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">mAutomaticPerformanceSnapshots</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">PerformanceCollector</span> <span class="n">mPerformanceCollector</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Bundle</span> <span class="n">mPerfMetrics</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bundle</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nc">UiAutomation</span> <span class="n">mUiAutomation</span><span class="o">;</span>
    
    <span class="o">.....</span>
        
    <span class="c1">// å®ä¾‹åˆ›å»ºåé€šè¿‡ç»™æˆå‘˜å˜é‡èµ‹å€¼</span>
    <span class="kd">final</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="nc">ActivityThread</span> <span class="n">thread</span><span class="o">,</span>
            <span class="nc">Context</span> <span class="n">instrContext</span><span class="o">,</span> <span class="nc">Context</span> <span class="n">appContext</span><span class="o">,</span> <span class="nc">ComponentName</span> <span class="n">component</span><span class="o">,</span> 
            <span class="nc">IInstrumentationWatcher</span> <span class="n">watcher</span><span class="o">,</span> <span class="nc">IUiAutomationConnection</span> <span class="n">uiAutomationConnection</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mThread</span> <span class="o">=</span> <span class="n">thread</span><span class="o">;</span>
        <span class="n">mMessageQueue</span> <span class="o">=</span> <span class="n">mThread</span><span class="o">.</span><span class="na">getLooper</span><span class="o">().</span><span class="na">myQueue</span><span class="o">();</span>
        <span class="n">mInstrContext</span> <span class="o">=</span> <span class="n">instrContext</span><span class="o">;</span>
        <span class="n">mAppContext</span> <span class="o">=</span> <span class="n">appContext</span><span class="o">;</span>
        <span class="n">mComponent</span> <span class="o">=</span> <span class="n">component</span><span class="o">;</span>
        <span class="n">mWatcher</span> <span class="o">=</span> <span class="n">watcher</span><span class="o">;</span>
        <span class="n">mUiAutomationConnection</span> <span class="o">=</span> <span class="n">uiAutomationConnection</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å››contextimpl">å››ã€ContextImpl</h2>

<p>æŒæœ‰ä¸€ä¸ªé™æ€å“ˆå¸Œè¡¨ï¼Œé”®ä¸ºåº”ç”¨å…¨è·¯å¾„åï¼Œå€¼ä¸ºå…¨è·¯å¾„åå¯¹åº”çš„ <strong>SharedPreferences</strong> å®ä¾‹ã€‚è¯¥åŒ…è·¯å¾„å®ä¾‹ä¸å­˜åœ¨å°±åˆå§‹åŒ–æ–°å®ä¾‹ï¼Œå¦åˆ™ä»å“ˆå¸Œè¡¨ä¸­è·å–å®ä¾‹ã€‚</p>

<p>ç”±äº <strong>getSharedPreferences</strong> å†…éƒ¨æŠŠ <strong>ContextImpl.class</strong> ç±»å®ä¾‹ä½œä¸ºé”å¯¹è±¡ï¼Œæ‰€ä»¥æ¯æ¬¡è·å–æŒ‡å®šåŒ…è·¯å¾„å¯¹åº”å®ä¾‹éƒ½æ˜¯çº¿ç¨‹å®‰å…¨ã€‚</p>

<p>æ ¹æ®ç±»ç­¾åå¯çŸ¥ <strong>ContextImpl</strong> æ˜¯ <strong>Context</strong> çš„å…·ä½“å®ç°ç±»ï¼Œä¸º <strong>Activity</strong> å’Œå…¶ä»–åº”ç”¨ç»„ä»¶æä¾›åŸºç¡€ä¸Šä¸‹æ–‡ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">ContextImpl</span> <span class="kd">extends</span> <span class="nc">Context</span> <span class="o">{</span>
    <span class="o">.....</span>
    
    <span class="c1">// åŒ…åå’Œå¯¹åº”å·²ç¼“å­˜çš„SharedPreferencesImplå®ä¾‹</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">SharedPreferencesImpl</span><span class="o">&gt;&gt;</span> <span class="n">sSharedPrefs</span><span class="o">;</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">SharedPreferences</span> <span class="nf">getSharedPreferences</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SharedPreferencesImpl</span> <span class="n">sp</span><span class="o">;</span>
        <span class="c1">// æŠŠContextImplçš„ç±»ä½œä¸ºé”å¯¹è±¡</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">ContextImpl</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// ç¼“å­˜ç”¨çš„å“ˆå¸Œè¡¨ä¸ºç©ºåˆ™åˆ›å»ºè¯¥å¯¹è±¡</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">sSharedPrefs</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sSharedPrefs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">SharedPreferencesImpl</span><span class="o">&gt;&gt;();</span>
            <span class="o">}</span>

            <span class="c1">// è·å–åº”ç”¨çš„åŒ…å</span>
            <span class="kd">final</span> <span class="nc">String</span> <span class="n">packageName</span> <span class="o">=</span> <span class="n">getPackageName</span><span class="o">();</span>
            <span class="c1">// æ£€æŸ¥åº”ç”¨çš„åŒ…åæ˜¯å¦å·²ç»ç¼“å­˜å¯¹åº”å®ä¾‹</span>
            <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">SharedPreferencesImpl</span><span class="o">&gt;</span> <span class="n">packagePrefs</span> <span class="o">=</span> <span class="n">sSharedPrefs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">packageName</span><span class="o">);</span>
            <span class="c1">// ä¸ºç©ºåˆ™éœ€è¦ä¸ºè¯¥åº”ç”¨åŒ…ååˆ›å»ºæ–°å®ä¾‹</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">packagePrefs</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">packagePrefs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">SharedPreferencesImpl</span><span class="o">&gt;();</span>
                <span class="n">sSharedPrefs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">packageName</span><span class="o">,</span> <span class="n">packagePrefs</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">mPackageInfo</span><span class="o">.</span><span class="na">getApplicationInfo</span><span class="o">().</span><span class="na">targetSdkVersion</span> <span class="o">&lt;</span>
                    <span class="nc">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">KITKAT</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// è‹¥ä¼ å…¥çš„æ–‡ä»¶åä¸ºç©ºåˆ™è®¾ç½®ä¸º"null"ï¼Œä»…å¯¹KITKATä»¥ä¸‹ç‰ˆæœ¬åº”ç”¨æœ‰æ•ˆ</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s">"null"</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            
            <span class="c1">// æ ¹æ®Prefsåç§°è·å–åŒ…è·¯å¾„ä¸‹å¯¹åº”æ–‡ä»¶</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">packagePrefs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">sp</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// åˆ›å»ºSharedPreferencesçš„å­˜å‚¨æ–‡ä»¶</span>
                <span class="nc">File</span> <span class="n">prefsFile</span> <span class="o">=</span> <span class="n">getSharedPrefsFile</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
                <span class="c1">// ç”¨è¯¥æ–‡ä»¶åˆ›å»ºSharedPreferenceså®ä¾‹</span>
                <span class="n">sp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SharedPreferencesImpl</span><span class="o">(</span><span class="n">prefsFile</span><span class="o">,</span> <span class="n">mode</span><span class="o">);</span>
                <span class="c1">// æ”¾å…¥ç¼“å­˜</span>
                <span class="n">packagePrefs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">sp</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">sp</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="nc">Context</span><span class="o">.</span><span class="na">MODE_MULTI_PROCESS</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
            <span class="n">getApplicationInfo</span><span class="o">().</span><span class="na">targetSdkVersion</span> <span class="o">&lt;</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">HONEYCOMB</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// è‹¥æ–‡ä»¶è¢«å…¶ä»–è¿›ç¨‹ä¿®æ”¹ï¼Œå°±é‡æ–°åŠ è½½è¯¥æ–‡ä»¶ï¼Œä»…å¯¹HONEYCOMBä»¥ä¸‹ç‰ˆæœ¬åº”ç”¨æœ‰æ•ˆ</span>
            <span class="n">sp</span><span class="o">.</span><span class="na">startReloadIfChangedUnexpectedly</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">sp</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="äº”æ€»ç»“">äº”ã€æ€»ç»“</h2>

<p>æ€»ç»“æµç¨‹å¦‚ä¸‹ï¼š</p>

<ul>
  <li><strong>ApplicationThread</strong> æ˜¯ <strong>ActivityThread</strong> çš„å†…éƒ¨ç±»ï¼Œä¹Ÿæ˜¯æˆå‘˜å˜é‡ä¹‹ä¸€ï¼›</li>
  <li><strong>ActivityThread</strong> åˆ›å»ºåæŠŠè‡ªå·±çš„ <strong>ApplicationThread</strong> å®ä¾‹ <strong>IPC</strong> æ³¨å†Œåˆ° <strong>ActivityManagerService</strong>ï¼›</li>
  <li><strong>ActivityManagerService</strong> ç™»è®° <strong>ApplicationThread</strong> å <strong>IPC</strong> è°ƒç”¨åè€… <strong>bindApplication()</strong> è¡¨ç¤ºæ³¨å†Œå·¥ä½œå·²å®Œæˆï¼Œç”¨ <strong>ApplicationThread</strong> å‘ŠçŸ¥ <strong>ActivityThread</strong> ç»§ç»­è¿›è¡Œ <strong>Application</strong> åˆå§‹åŒ–ï¼›</li>
  <li><strong>ApplicationThread.bindApplication()</strong> é€šè¿‡å‘é€æ ‡å¿—ä¸º <strong>BIND_APPLICATION</strong> çš„ <strong>Message</strong> å‘ŠçŸ¥ <strong>ActivityThread</strong> è¿›è¡Œ <strong>Applicatoin</strong> åˆå§‹åŒ–ï¼›</li>
  <li><strong>ActivityThread</strong> æ‰§è¡Œ <strong>handleBindApplication()</strong>ï¼Œæ–¹æ³•å†…éƒ¨åˆ›å»º <strong>Instrumentation</strong> åä¿å­˜åœ¨æˆå‘˜å˜é‡ <strong>mInstrumentation</strong>ï¼›</li>
  <li>éšååˆ›å»º <strong>ContextImpl</strong> å®ä¾‹ï¼ŒæŠŠè¯¥å®ä¾‹ä¿å­˜åœ¨ <strong>mInstrumentation</strong> å®ä¾‹ä¸­ï¼›</li>
  <li>è€Œ <strong>ContextImpl</strong> è·å– <strong>SharedPreferences</strong> çº¿ç¨‹å®‰å…¨ä¸” <strong>SharedPreferences</strong> å†…éƒ¨æ“ä½œçº¿ç¨‹å®‰å…¨ï¼›</li>
</ul>

<p>å»¶ä¼¸é—®é¢˜ï¼Œæ ¹æ®ä¸Šé¢åˆ†æå·²çŸ¥ <strong>SharedPreferences</strong> çº¿ç¨‹å®‰å…¨ã€‚è€Œ <strong>SharedPreferences</strong> è¡¨é¢æ”¯æŒè¿›ç¨‹å®‰å…¨ï¼Œå³å¤šä¸ªè¿›ç¨‹å¯åŒæ—¶å†™å…¥æ–‡ä»¶ã€‚</p>

<p>ä½†å®é™… <strong>Google</strong> å¹¶ä¸è®¤å¯è¿™ç§æ“ä½œï¼Œå› ä¸ºå¤šä¸ªè¿›ç¨‹åŒæ—¶å†™å…¥æ–‡ä»¶çš„æ“ä½œæ²¡æ³•åœ¨ç³»ç»Ÿå±‚è¿›è¡Œåè°ƒï¼Œä¸èƒ½ä¿è¯å…¶å®‰å…¨ï¼Œæ‰€ä»¥å¯èƒ½ä¼šé€ æˆæ•°æ®çš„ä¸¢å¤±ã€‚</p>

<h2 id="å…­å‚è€ƒé“¾æ¥">å…­ã€å‚è€ƒé“¾æ¥</h2>

<ul>
  <li><a href="https://stackoverflow.com/questions/4693387/sharedpreferences-and-thread-safety">SharedPreferences and Thread Safety - StackOverflow</a></li>
  <li><a href="https://developer.android.com/reference/android/content/SharedPreferences.Editor.html#apply()">SharedPreferences.Editor.apply()</a></li>
  <li><a href="https://developer.android.com/reference/android/content/SharedPreferences.Editor.html#commit()">SharedPreferences.Editor.commit()</a></li>
</ul>
:ET