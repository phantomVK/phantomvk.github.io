I"¯5<h3 id="é›¶å¯¼è¯»">é›¶ã€å¯¼è¯»</h3>

<p>ç¬”è€…è´Ÿè´£çš„å·¥ç¨‹é•¿å¹´è¿›è¡ŒåŠŸèƒ½è¿­ä»£ï¼Œæ²¡æœ‰å¤„ç†æ€§èƒ½é—®é¢˜ï¼Œæœ€è¿‘ç»ˆäºæœ‰ç©ºè¿›è¡Œå†…å­˜é—®é¢˜ä¿®å¤ã€‚æœ¬æ–‡è®°å½•æ­¤æ¬¡å†…å­˜é—®é¢˜å®šä½è¿‡ç¨‹åŠä¿®å¤æ–¹æ³•ï¼Œå¹¶æ€»ç»“å¼€å‘å¿ƒå¾—å’Œç»éªŒã€‚</p>

<p>åº”ç”¨é¢‘ç¹ç”³è¯·å°å¯¹è±¡ï¼Œå ç”¨å¤„ç†å™¨æ—¶é—´ç‰‡(<strong>è™šæ‹ŸæœºTLABåˆ’åˆ†</strong>ã€<strong>å¯¹è±¡åˆå§‹åŒ–</strong>)ï¼Œæ ·æœ¬è¶…é™ä»¤æŠ½æ ·å·¥å…·å¡é¡¿å´©æºƒã€‚<strong>å·¨å‹å¯¹è±¡</strong>ã€<strong>é•¿å‘¨æœŸå¯¹è±¡</strong> å¢åŠ åƒåœ¾å›æ”¶çš„æ—¶é—´ï¼Œç»™è°ƒè¯•å¤„ç†å™¨å ç”¨ç‡ã€ä¸»çº¿ç¨‹é˜»å¡å¢åŠ æœªçŸ¥é£é™©ã€‚</p>

<h3 id="ä¸€ç›®æ ‡">ä¸€ã€ç›®æ ‡</h3>

<p>æ¯æ¬¡æ€§èƒ½ä¼˜åŒ–è¦æ˜ç¡®é˜¶æ®µæ€§ç›®æ ‡ï¼Œæ˜ç¡®ç›®æ ‡ä¸ºâ€å¯åŠ¨é€Ÿåº¦ä¼˜åŒ–â€œï¼Œè¿˜æ˜¯â€ä¿®å¤å†…å­˜å ç”¨é«˜â€œã€‚ç¡®å®šç›®æ ‡å¯ä»¥å¯¹ç‰¹å®šæ€§èƒ½ç‚¹åšå‡ºé«˜åº¦ä¼˜åŒ–ï¼Œé™ä½ä¼˜åŒ–é‡åŒ–çš„éš¾åº¦ã€‚</p>

<p>å—äº§å“å½¢æ€æ‰€é™ï¼Œæœ¬äº§å“éœ€é›†æˆåˆ°å®¿ä¸»åº”ç”¨ä½œä¸ºè¿è¡Œéƒ¨åˆ†ã€‚å¯åŠ¨è¿‡ç¨‹é«˜å†…å­˜å ç”¨ï¼ŒåŠ ä¸Šå®¿ä¸»å·²ç»ç”³è¯·ç©ºé—´ï¼Œå®¹æ˜“é€ æˆ <strong>OutOfMemoryError</strong>ã€‚å¯ä»¥æ˜ç¡®ï¼Œæœ¬æ¬¡é¦–è¦ç›®æ ‡ä¸ºå‰Šå¯åŠ¨å†…å­˜çš„å³°å€¼ï¼Œå…¶æ¬¡æŸ¥æ‰¾å¯åŠ¨åå†…å­˜æ³„æ¼ã€‚</p>

<h3 id="äºŒå·¥å…·">äºŒã€å·¥å…·</h3>

<h4 id="21-android-profiler">2.1 Android Profiler</h4>

<p>æŒ‰ç…§Googleæœ€æ–°å¼€å‘æŒ‡å¼•ï¼Œ<strong>Android Profiler</strong> æ˜¯é¦–è¦æ¨èæ€§èƒ½æ£€æµ‹å·¥å…·ï¼Œç”¨äºåˆ†æè¿è¡Œè¿‡ç¨‹äº§ç”Ÿå¯¹è±¡çš„æ•°é‡å’Œæ€»å¤§å°ï¼Œä¸‹æ–‡åŸºäº <strong>Android Studio 3.5.1</strong> ç‰ˆæœ¬çš„å·¥å…·ã€‚</p>

<p><img src="/img/android/performance/android_profiler.png" alt="android_profiler" /></p>

<p>ä¸»è¦æœ‰ä»¥ä¸‹å‚æ•°ï¼š</p>

<ul>
  <li>
    <p><strong>Java</strong>ï¼šä» Java æˆ– Kotlin ä»£ç åˆ†é…çš„å¯¹è±¡çš„å†…å­˜</p>
  </li>
  <li>
    <p><strong>Native</strong>ï¼šä» C æˆ– C++ ä»£ç åˆ†é…çš„å¯¹è±¡çš„å†…å­˜</p>

    <p>å³ä½¿æ‚¨çš„åº”ç”¨ä¸­ä¸ä½¿ç”¨ C++ï¼Œæ‚¨ä¹Ÿå¯èƒ½ä¼šçœ‹åˆ°æ­¤å¤„ä½¿ç”¨çš„ä¸€äº›åŸç”Ÿå†…å­˜ï¼Œå› ä¸º Android æ¡†æ¶ä½¿ç”¨åŸç”Ÿå†…å­˜ä»£è¡¨æ‚¨å¤„ç†å„ç§ä»»åŠ¡ï¼Œå¦‚å¤„ç†å›¾åƒèµ„æºå’Œå…¶ä»–å›¾å½¢æ—¶ï¼Œå³ä½¿æ‚¨ç¼–å†™çš„ä»£ç é‡‡ç”¨ Java æˆ– Kotlin è¯­è¨€</p>
  </li>
  <li>
    <p><strong>Graphics</strong>ï¼šå›¾å½¢ç¼“å†²åŒºé˜Ÿåˆ—å‘å±å¹•æ˜¾ç¤ºåƒç´ ï¼ˆåŒ…æ‹¬ GL è¡¨é¢ã€GL çº¹ç†ç­‰ç­‰ï¼‰æ‰€ä½¿ç”¨çš„å†…å­˜ã€‚ï¼ˆè¯·æ³¨æ„ï¼Œè¿™æ˜¯ä¸ CPU å…±äº«çš„å†…å­˜ï¼Œä¸æ˜¯ GPU ä¸“ç”¨å†…å­˜ã€‚ï¼‰</p>
  </li>
  <li>
    <p><strong>Stack</strong>ï¼šæ‚¨çš„åº”ç”¨ä¸­çš„åŸç”Ÿå †æ ˆå’Œ Java å †æ ˆä½¿ç”¨çš„å†…å­˜ã€‚è¿™é€šå¸¸ä¸æ‚¨çš„åº”ç”¨è¿è¡Œå¤šå°‘çº¿ç¨‹æœ‰å…³</p>
  </li>
  <li>
    <p><strong>Code</strong>ï¼šæ‚¨çš„åº”ç”¨ç”¨äºå¤„ç†ä»£ç å’Œèµ„æºï¼ˆå¦‚ dex å­—èŠ‚ç ã€ç»è¿‡ä¼˜åŒ–æˆ–ç¼–è¯‘çš„ dex ä»£ç ã€.so åº“å’Œå­—ä½“ï¼‰çš„å†…å­˜</p>
  </li>
  <li>
    <p><strong>Others</strong>ï¼šæ‚¨çš„åº”ç”¨ä½¿ç”¨çš„ç³»ç»Ÿä¸ç¡®å®šå¦‚ä½•åˆ†ç±»çš„å†…å­˜</p>
  </li>
  <li>
    <p><strong>Allocated</strong>ï¼šæ‚¨çš„åº”ç”¨åˆ†é…çš„ Java/Kotlin å¯¹è±¡æ•°ã€‚æ­¤æ•°å­—æ²¡æœ‰è®¡å…¥ C æˆ– C++ ä¸­åˆ†é…çš„å¯¹è±¡</p>
  </li>
</ul>

<p>è¾ƒæ–°çš„ç³»ç»Ÿç‰ˆæœ¬æ‰èƒ½å®Œå…¨æä¾›ä»¥ä¸Šå‚æ•°ï¼Œæ—§ç‰ˆæœ¬åˆ™æ ¹æ®ç‰ˆæœ¬ä¸åŒæœ‰å·®åˆ«ã€‚ä¸€èˆ¬æ¥è¯´ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºå°±æ˜¯ä¼˜åŒ–éš¾åº¦ï¼Œå³ä» <strong>Javaå †å†…å­˜</strong> å¼€å§‹éš¾åº¦é€æ¸æå‡ï¼Œåˆ° <strong>Other</strong> å†…å­˜æœ€éš¾å¤„ç†ã€‚</p>

<p>ä¸åŒåº”ç”¨åœºæ™¯å†…å­˜å ç”¨æ¯”ä¾‹ä¹Ÿä¸ä¸€æ ·ï¼Œä¼˜åŒ–æ•ˆæœè¦åœ¨åŒä¸€åœºæ™¯åå¤æµ‹é‡åç¡®å®šã€‚</p>

<h4 id="22-eclipse-mat">2.2 Eclipse MAT</h4>

<p>è€ç‰Œå†…å­˜åˆ†æå·¥å…·ç”¨äºæ£€æŸ¥å†…å­˜æ³„æ¼é—®é¢˜ï¼Œä¸è¿‡è¿™ä¸ªå·¥å…·å¯¹ <strong>Android</strong> å†…å­˜æ³„æ¼è‡ªåŠ¨æ¨æ–­ä¸å‡†ç¡®ã€‚</p>

<p>ä» <strong>Android Profiler</strong> å¯¼å‡ºå†…å­˜å¿«ç…§åï¼Œç”¨ <strong>platform-tools</strong> çš„ <strong>hprof-conv</strong> å·¥å…·è½¬æ¢åçš„é•œåƒæ‰èƒ½å¯¼å…¥ <strong>MAT</strong>ã€‚è€Œ <strong>-z</strong> å‚æ•°è½¬æ¢ç»“æœåªåŒ…å«åº”ç”¨è‡ªèº«å†…å­˜ï¼Œæ˜“äºæŸ¥çœ‹ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cd</span> /Users/phantomvk/Library/Android/sdk/platform-tools <span class="c"># MacOS</span>
<span class="nv">$ </span>hprof-conv <span class="nt">-z</span> dump_from.hprof dump_to.hprof
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯¼å…¥ <strong>dump_to.hprof</strong> åˆ° <strong>MAT</strong> åå¯è§å†…å­˜åˆ†ç±»ï¼Œé€‰æ‹©å·¦ä¸‹è§’ <strong>Histogram</strong> è§†å›¾ï¼š</p>

<p><img src="/img/android/performance/histogram.png" alt="histogram" /></p>

<p>å¦‚å›¾å³é”®ç»“æœï¼Œå…ˆæ’é™¤è½¯ã€å¼±ã€è™šå¼•ç”¨å¯¹è¯¥å®ä¾‹å¹²æ‰°ï¼š</p>

<p><img src="/img/android/performance/exclude_references.png" alt="exclude_references" /></p>

<p>å‰©ä¸‹çš„å…¨éƒ½æ˜¯å¼ºå¼•ç”¨ï¼Œé€‰æ‹©å…¶ä¸­ä¸€é¡¹å±•å¼€ï¼š</p>

<p><img src="/img/android/performance/ScreenShotListenManager.png" alt="ScreenShotListenManager" /></p>

<p>å³é”®ç‚¹å‡» <strong>List objects</strong> é€‰æ‹© <strong>with incoming references</strong> å¯çœ‹è§æ³„æ¼å¯¹è±¡è¢«å¼•ç”¨çš„è·¯å¾„ï¼š</p>

<p><img src="/img/android/performance/leak_MediaContentObserver.png" alt="leak_MediaContentObserver" /></p>

<p>é™¤äº†æ˜¾ç¤ºå†…å­˜æ³„æ¼çš„å¼•ç”¨ï¼Œ<strong>MAT</strong> å…¶ä»–å¯è§ç»“æœä¸»è¦æ˜¯ç±»åŠ è½½å™¨æŒæœ‰çš„é™æ€å˜é‡ã€å¸¸é‡ã€‚ä¸‹å›¾æ˜¯æšä¸¾ç±»å‹ <strong>FuncType</strong> è¢«ç±»åŠ è½½å™¨æŒæœ‰çš„ç¤ºæ„å›¾ï¼Œå†…éƒ¨28ä¸ªæ•°å€¼å…±ä½¿ç”¨448Bå†…å­˜ï¼š</p>

<p><img src="/img/android/performance/no_memory_leak.png" alt="no_memory_leak" /></p>

<p><strong>Android</strong> æšä¸¾ç±»å‹åœ¨æ··æ·†çš„ä¼˜åŒ–é˜¶æ®µå†…è”åˆ°è°ƒç”¨ç‚¹ï¼Œä¸å†å‡ºç°ä¸Šè¿°448Bå†…å­˜å ç”¨ã€‚ä½†åˆ«å¿˜è®°ç°åœ¨å¤„äºæ²¡æœ‰å¼€å¯æ··æ·†çš„ <strong>debug</strong> æ¨¡å¼ï¼Œæ‰€ä»¥èƒ½çœ‹è§æšä¸¾ç±»åœ¨å†…å­˜çš„å½¢æ€ã€‚</p>

<h3 id="ä¸‰è¯¦æƒ…">ä¸‰ã€è¯¦æƒ…</h3>

<h4 id="31-ä½¿ç”¨arouter">3.1 ä½¿ç”¨ARouter</h4>

<p><strong>ARouter</strong> åœ¨æœ¬å·¥ç¨‹è´Ÿè´£é¡µé¢è·¯ç”±è·³è½¬å’ŒæœåŠ¡æä¾›ï¼Œå®Œæˆç»„ä»¶åŒ–å¤§éƒ¨åˆ†å·¥ä½œï¼Œæ­£å¸¸ä¸ä¼šæœ‰æ€§èƒ½é—®é¢˜ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">RoomSummaryComparator</span> <span class="o">:</span> <span class="nc">Comparator</span><span class="o">&lt;</span><span class="nc">RoomSummary</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="n">override</span> <span class="n">fun</span> <span class="nf">compare</span><span class="o">(</span><span class="nl">lSummary:</span> <span class="nc">RoomSummary</span><span class="o">?,</span> <span class="nl">rSummary:</span> <span class="nc">RoomSummary</span><span class="o">?):</span> <span class="nc">Int</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">when</span> <span class="o">{</span>
            <span class="k">else</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="c1">// ä»ARouterè·å–å¯¹è±¡SessionManager</span>
                <span class="n">val</span> <span class="n">lTs</span> <span class="o">=</span> <span class="nc">ServiceFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">sessionManager</span>
                        <span class="o">.</span><span class="na">defaultLatestChatMessageCache</span>
                        <span class="o">.</span><span class="na">getLatestTextTs</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">,</span> <span class="n">lSummary</span><span class="o">.</span><span class="na">roomId</span><span class="o">)</span>
                        <span class="o">?:</span> <span class="n">lEvent</span><span class="o">.</span><span class="na">getOriginServerTs</span><span class="o">()</span>

                <span class="c1">// ä»ARouterè·å–å¯¹è±¡SessionManager</span>
                <span class="n">val</span> <span class="n">rTs</span> <span class="o">=</span> <span class="nc">ServiceFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">sessionManager</span>
                        <span class="o">.</span><span class="na">defaultLatestChatMessageCache</span>
                        <span class="o">.</span><span class="na">getLatestTextTs</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">,</span> <span class="n">rSummary</span><span class="o">.</span><span class="na">roomId</span><span class="o">)</span>
                        <span class="o">?:</span> <span class="n">rEvent</span><span class="o">.</span><span class="na">getOriginServerTs</span><span class="o">()</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™é‡Œè°ƒç”¨åµŒå¥—åœ¨ <strong>Comparator</strong>ï¼Œæˆ¿é—´åˆ—è¡¨æ’åºç´¯è®¡è°ƒç”¨ <strong>ARouter</strong> å¤šè¾¾3.6ä¸‡æ¬¡ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»º <strong>PostCard</strong> å®ä¾‹ï¼Œç´¯è®¡æµ…å†…å­˜ä½¿ç”¨2MBã€‚</p>

<p><img src="/img/android/performance/arouter_postcard_larger.png" alt="arouter_postcard" /></p>

<p>éœ€è¦æ•´åˆè°ƒç”¨ç‚¹é¿å…é‡å¤è°ƒç”¨ <strong>ARouter</strong>ï¼Œä¼˜åŒ–åç›¸åŒåœºæ™¯åªæœ‰1000æ¬¡è°ƒç”¨ã€‚</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">RoomSummaryComparator</span> <span class="p">:</span> <span class="nc">Comparator</span><span class="p">&lt;</span><span class="nc">RoomSummary</span><span class="p">&gt;</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">messageCache</span> <span class="p">=</span> <span class="nc">ServiceFactory</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">()</span>
            <span class="p">.</span><span class="n">sessionManager</span>
            <span class="p">.</span><span class="n">defaultLatestChatMessageCache</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">compare</span><span class="p">(</span><span class="n">lSummary</span><span class="p">:</span> <span class="nc">RoomSummary</span><span class="p">?,</span> <span class="n">rSummary</span><span class="p">:</span> <span class="nc">RoomSummary</span><span class="p">?):</span> <span class="nc">Int</span> <span class="p">{</span>
        <span class="o">....</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="32-å †æ ˆè·Ÿè¸ªå¼€é”€">3.2 å †æ ˆè·Ÿè¸ªå¼€é”€</h4>

<p>ä¸‹é¢ä»£ç ä» <strong>JsonObject</strong> è·å–åä¸º <strong>flag</strong> çš„æ•´å½¢å€¼ï¼Œå¦åˆ™æ•è·å¼‚å¸¸å¹¶è¿”å›nullã€‚</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">val</span> <span class="py">flag</span> <span class="p">=</span> <span class="k">try</span> <span class="p">{</span>
    <span class="n">event</span><span class="p">.</span><span class="nf">getContent</span><span class="p">().</span><span class="n">asJsonObject</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="s">"flag"</span><span class="p">).</span><span class="n">asInt</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">null</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¯¥æ•´å‹å€¼å­˜åœ¨æ˜¯å°‘æ•°æƒ…å†µï¼Œæ‰€ä»¥é¢‘ç¹æŠ›å‡ºå¼‚å¸¸å¹¶ä½¿ç”¨ <strong>StackTraceElement</strong> è®°å½•å †æ ˆä¿¡æ¯ã€‚</p>

<p>ä¸Šè¿°ä»£ç å¤šæ¬¡ç”Ÿæˆè¯¥å®ä¾‹ï¼Œæ¯ä¸ªå¤§å°32Bå…±æŠ›å‡º1041æ¬¡ï¼Œ<strong>ShallowSize</strong> æ€»è®¡33,312Bã€‚è€ƒè™‘åˆ° <strong>StackTraceElement</strong> åŒ…å«ä¿å­˜å †æ ˆä¿¡æ¯çš„å­—ç¬¦ä¸²ï¼Œå®é™…å ç”¨å°†å¤§äº 33,312Bã€‚</p>

<p>å¤„ç†æ–¹æ³•æ¯”è¾ƒç®€å•ï¼šä» <strong>JsonObject</strong> è·å–æ•´å½¢å€¼å‰æ£€æŸ¥è¯¥å€¼æ˜¯å¦å­˜åœ¨ã€‚</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kd">val</span> <span class="py">jsObj</span> <span class="p">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">getContent</span><span class="p">().</span><span class="n">asJsonObject</span>
<span class="k">if</span> <span class="p">(</span><span class="n">jsObj</span><span class="p">.</span><span class="nf">has</span><span class="p">(</span><span class="s">"flag"</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">jsObj</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="s">"flag"</span><span class="p">).</span><span class="n">asInt</span> <span class="c1">// è¯¥å€¼çº¦å®šä¸ºintï¼Œä¸è€ƒè™‘å…¶ä»–ç±»å‹</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">null</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="33-é‡ç”¨å¯¹è±¡">3.3 é‡ç”¨å¯¹è±¡</h4>

<p>å¾ˆå¤šæ–‡ç« æåˆ°åœ¨ <strong>onDraw()</strong> ä¸åº”è¯¥åˆ›å»ºå¯¹è±¡ï¼Œä½†åŒäº‹çš„ <strong>onDraw()</strong> å’Œ <strong>onResize()</strong> å›¾çœäº‹é¢‘ç¹åˆ›å»º <strong>RectF</strong>ã€‚æŒ‰ç…§æ¯ä¸ªæ–¹æ³•æ‰§è¡Œä¸€æ¬¡çš„æƒ…å†µç®—ï¼Œå…±è®¡åˆ›å»º9ä¸ª <strong>RectF</strong> å¯¹è±¡ã€‚</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">BubbleShape</span> <span class="nd">@JvmOverloads</span> <span class="k">constructor</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="nc">Context</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Shape</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">draw</span><span class="p">(</span><span class="n">canvas</span><span class="p">:</span> <span class="nc">Canvas</span><span class="p">,</span> <span class="n">paint</span><span class="p">:</span> <span class="nc">Paint</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawPath</span><span class="p">(</span><span class="n">mTop</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawRect</span><span class="p">(</span><span class="nc">RectF</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">arrowMarginTop</span> <span class="p">+</span> <span class="n">arrowHeight</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawPath</span><span class="p">(</span><span class="n">mBottom</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>

        <span class="n">paint</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">strokeColor</span>
        <span class="n">paint</span><span class="p">.</span><span class="n">style</span> <span class="p">=</span> <span class="nc">Paint</span><span class="p">.</span><span class="nc">Style</span><span class="p">.</span><span class="nc">STROKE</span>
        <span class="n">paint</span><span class="p">.</span><span class="n">strokeCap</span> <span class="p">=</span> <span class="nc">Paint</span><span class="p">.</span><span class="nc">Cap</span><span class="p">.</span><span class="nc">ROUND</span>
        <span class="n">paint</span><span class="p">.</span><span class="n">strokeJoin</span> <span class="p">=</span> <span class="nc">Paint</span><span class="p">.</span><span class="nc">Join</span><span class="p">.</span><span class="nc">ROUND</span>
        <span class="n">paint</span><span class="p">.</span><span class="n">strokeWidth</span> <span class="p">=</span> <span class="n">strokeWidth</span><span class="p">.</span><span class="nf">toFloat</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">offset</span> <span class="p">=</span> <span class="n">strokeWidth</span> <span class="p">/</span> <span class="m">2f</span>
        <span class="kd">val</span> <span class="py">ext</span> <span class="p">=</span> <span class="n">cornerRadius</span> <span class="p">*</span> <span class="m">0.5f</span>

        <span class="c1">// ä½¿ç”¨æ—¶ç›´æ¥åˆ›å»ºRectFå®ä¾‹ï¼Œä¸‹åˆ—ä»£ç ä¸­æ­¤é—®é¢˜å¤šæ¬¡å‡ºç°</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawArc</span><span class="p">(</span><span class="nc">RectF</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="n">arrowWidth</span> <span class="p">+</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="n">cornerRadius</span> <span class="p">+</span> <span class="n">offset</span><span class="p">),</span>
                <span class="m">180f</span><span class="p">,</span> <span class="m">90f</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawLine</span><span class="p">(</span><span class="n">arrowWidth</span> <span class="p">+</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">ext</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                <span class="n">width</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawArc</span><span class="p">(</span><span class="nc">RectF</span><span class="p">((</span><span class="n">width</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">offset</span><span class="p">),</span> <span class="n">offset</span><span class="p">,</span> <span class="n">width</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">cornerRadius</span> <span class="p">+</span> <span class="n">offset</span><span class="p">),</span> <span class="m">270f</span><span class="p">,</span>
                <span class="m">90f</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawLine</span><span class="p">(</span><span class="n">width</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">ext</span><span class="p">,</span> <span class="n">width</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawArc</span><span class="p">(</span><span class="nc">RectF</span><span class="p">(</span><span class="n">width</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">width</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">offset</span><span class="p">),</span>
                <span class="m">0f</span><span class="p">,</span> <span class="m">90f</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawLine</span><span class="p">(</span><span class="n">width</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span>
                <span class="n">arrowWidth</span> <span class="p">+</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">ext</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawArc</span><span class="p">(</span><span class="nc">RectF</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">offset</span><span class="p">),</span> <span class="p">(</span><span class="n">arrowWidth</span> <span class="p">+</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="n">height</span> <span class="p">-</span> <span class="n">offset</span><span class="p">),</span>
                <span class="m">90f</span><span class="p">,</span> <span class="m">90f</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawLine</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">arrowWidth</span><span class="p">,</span> <span class="n">arrowMarginTop</span> <span class="p">+</span> <span class="n">arrowHeight</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawLine</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">arrowMarginTop</span> <span class="p">+</span> <span class="n">arrowHeight</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="n">arrowMarginTop</span> <span class="p">+</span> <span class="n">arrowHeight</span> <span class="p">/</span> <span class="m">2</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawLine</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="n">arrowMarginTop</span> <span class="p">+</span> <span class="n">arrowHeight</span> <span class="p">/</span> <span class="m">2</span><span class="p">,</span> <span class="n">arrowWidth</span><span class="p">,</span> <span class="n">arrowMarginTop</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawLine</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">arrowMarginTop</span><span class="p">,</span> <span class="n">arrowWidth</span><span class="p">,</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">ext</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">restore</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onResize</span><span class="p">(</span><span class="n">width</span><span class="p">:</span> <span class="nc">Float</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nc">Float</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">reset</span><span class="p">()</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">moveTo</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="p">(</span><span class="n">arrowMarginTop</span> <span class="p">+</span> <span class="n">arrowHeight</span><span class="p">))</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">lineTo</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="p">(</span><span class="n">arrowMarginTop</span> <span class="p">+</span> <span class="n">arrowHeight</span> <span class="p">/</span> <span class="m">2</span><span class="p">))</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">lineTo</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">arrowMarginTop</span><span class="p">)</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">lineTo</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">cornerRadius</span><span class="p">)</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">arcTo</span><span class="p">(</span><span class="nc">RectF</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="p">(</span><span class="n">arrowWidth</span> <span class="p">+</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="n">cornerRadius</span><span class="p">),</span>
                <span class="m">180f</span><span class="p">,</span> <span class="m">90f</span><span class="p">)</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">lineTo</span><span class="p">((</span><span class="n">width</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="m">0f</span><span class="p">)</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">arcTo</span><span class="p">(</span><span class="nc">RectF</span><span class="p">((</span><span class="n">width</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="m">0f</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="m">270f</span><span class="p">,</span> <span class="m">90f</span><span class="p">)</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">lineTo</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="n">arrowHeight</span> <span class="p">+</span> <span class="n">arrowMarginTop</span><span class="p">))</span>

        <span class="n">mBottom</span><span class="p">.</span><span class="nf">reset</span><span class="p">()</span>
        <span class="n">mBottom</span><span class="p">.</span><span class="nf">moveTo</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">))</span>
        <span class="n">mBottom</span><span class="p">.</span><span class="nf">arcTo</span><span class="p">(</span><span class="nc">RectF</span><span class="p">((</span><span class="n">width</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="p">(</span><span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="m">0f</span><span class="p">,</span> <span class="m">90f</span><span class="p">)</span>
        <span class="n">mBottom</span><span class="p">.</span><span class="nf">lineTo</span><span class="p">((</span><span class="n">arrowWidth</span> <span class="p">+</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">mBottom</span><span class="p">.</span><span class="nf">arcTo</span><span class="p">(</span><span class="nc">RectF</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="p">(</span><span class="n">arrowWidth</span> <span class="p">+</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="n">height</span><span class="p">),</span>
                <span class="m">90f</span><span class="p">,</span> <span class="m">90f</span><span class="p">)</span>
        <span class="n">mBottom</span><span class="p">.</span><span class="nf">lineTo</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">)</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¿®æ”¹ä¸ºå¤ç”¨ <strong>RectF</strong> çš„å˜é‡ï¼Œä½¿ç”¨æ—¶å…ˆè°ƒç”¨ <strong>RectF.set(left, top, right, button)</strong> ä¼ å…¥æ›´æ–°å€¼ï¼Œå†æŠŠ <strong>RectF</strong> æä¾›ç»™ç»˜åˆ¶æ–¹æ³•ã€‚</p>

<p>è‹¥ç¡®ä¿ <strong>BubbleShape</strong> åªåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œåˆ™èƒ½æŠŠ <strong>RectF</strong> è®¾ç½®ä¸ºå¸¸é‡ã€‚æ— è®ºå¤šå°‘ä¸ª <strong>BubbleShape</strong> å®ä¾‹éƒ½åªä¼šå¤ç”¨å•ä¸ª <strong>RectF</strong> å¸¸é‡ã€‚</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">BubbleShape</span> <span class="nd">@JvmOverloads</span> <span class="k">constructor</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="nc">Context</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Shape</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">rect</span> <span class="p">=</span> <span class="nc">RectF</span><span class="p">()</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">draw</span><span class="p">(</span><span class="n">canvas</span><span class="p">:</span> <span class="nc">Canvas</span><span class="p">,</span> <span class="n">paint</span><span class="p">:</span> <span class="nc">Paint</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawPath</span><span class="p">(</span><span class="n">mTop</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="c1">// æ›´æ–°rectFå®ä¾‹çš„æ•°æ®</span>
        <span class="n">rect</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">arrowMarginTop</span> <span class="p">+</span> <span class="n">arrowHeight</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawRect</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawPath</span><span class="p">(</span><span class="n">mBottom</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>

        <span class="n">paint</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">strokeColor</span>
        <span class="n">paint</span><span class="p">.</span><span class="n">style</span> <span class="p">=</span> <span class="nc">Paint</span><span class="p">.</span><span class="nc">Style</span><span class="p">.</span><span class="nc">STROKE</span>
        <span class="n">paint</span><span class="p">.</span><span class="n">strokeCap</span> <span class="p">=</span> <span class="nc">Paint</span><span class="p">.</span><span class="nc">Cap</span><span class="p">.</span><span class="nc">ROUND</span>
        <span class="n">paint</span><span class="p">.</span><span class="n">strokeJoin</span> <span class="p">=</span> <span class="nc">Paint</span><span class="p">.</span><span class="nc">Join</span><span class="p">.</span><span class="nc">ROUND</span>
        <span class="n">paint</span><span class="p">.</span><span class="n">strokeWidth</span> <span class="p">=</span> <span class="n">strokeWidth</span><span class="p">.</span><span class="nf">toFloat</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">offset</span> <span class="p">=</span> <span class="n">strokeWidth</span> <span class="p">/</span> <span class="m">2f</span>
        <span class="kd">val</span> <span class="py">ext</span> <span class="p">=</span> <span class="n">cornerRadius</span> <span class="p">*</span> <span class="m">0.5f</span>

        <span class="n">rect</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="n">arrowWidth</span> <span class="p">+</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="n">cornerRadius</span> <span class="p">+</span> <span class="n">offset</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawArc</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="m">180f</span><span class="p">,</span> <span class="m">90f</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawLine</span><span class="p">(</span><span class="n">arrowWidth</span> <span class="p">+</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">ext</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                <span class="n">width</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">rect</span><span class="p">.</span><span class="k">set</span><span class="p">((</span><span class="n">width</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">offset</span><span class="p">),</span> <span class="n">offset</span><span class="p">,</span> <span class="n">width</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">cornerRadius</span> <span class="p">+</span> <span class="n">offset</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawArc</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="m">270f</span><span class="p">,</span> <span class="m">90f</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawLine</span><span class="p">(</span><span class="n">width</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">ext</span><span class="p">,</span> <span class="n">width</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>

        <span class="n">rect</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">width</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">width</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">offset</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawArc</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="m">90f</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawLine</span><span class="p">(</span><span class="n">width</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span>
                <span class="n">arrowWidth</span> <span class="p">+</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">ext</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">rect</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">offset</span><span class="p">),</span> <span class="p">(</span><span class="n">arrowWidth</span> <span class="p">+</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="n">height</span> <span class="p">-</span> <span class="n">offset</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawArc</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="m">90f</span><span class="p">,</span> <span class="m">90f</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawLine</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span> <span class="p">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">arrowWidth</span><span class="p">,</span> <span class="n">arrowMarginTop</span> <span class="p">+</span> <span class="n">arrowHeight</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawLine</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">arrowMarginTop</span> <span class="p">+</span> <span class="n">arrowHeight</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="n">arrowMarginTop</span> <span class="p">+</span> <span class="n">arrowHeight</span> <span class="p">/</span> <span class="m">2</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawLine</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="n">arrowMarginTop</span> <span class="p">+</span> <span class="n">arrowHeight</span> <span class="p">/</span> <span class="m">2</span><span class="p">,</span> <span class="n">arrowWidth</span><span class="p">,</span> <span class="n">arrowMarginTop</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">drawLine</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">arrowMarginTop</span><span class="p">,</span> <span class="n">arrowWidth</span><span class="p">,</span> <span class="n">cornerRadius</span> <span class="p">-</span> <span class="n">ext</span><span class="p">,</span> <span class="n">paint</span><span class="p">)</span>
        <span class="n">canvas</span><span class="p">.</span><span class="nf">restore</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onResize</span><span class="p">(</span><span class="n">width</span><span class="p">:</span> <span class="nc">Float</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nc">Float</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">reset</span><span class="p">()</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">moveTo</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="p">(</span><span class="n">arrowMarginTop</span> <span class="p">+</span> <span class="n">arrowHeight</span><span class="p">))</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">lineTo</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="p">(</span><span class="n">arrowMarginTop</span> <span class="p">+</span> <span class="n">arrowHeight</span> <span class="p">/</span> <span class="m">2</span><span class="p">))</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">lineTo</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">arrowMarginTop</span><span class="p">)</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">lineTo</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">cornerRadius</span><span class="p">)</span>

        <span class="n">rect</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="p">(</span><span class="n">arrowWidth</span> <span class="p">+</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="n">cornerRadius</span><span class="p">)</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">arcTo</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="m">180f</span><span class="p">,</span> <span class="m">90f</span><span class="p">)</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">lineTo</span><span class="p">((</span><span class="n">width</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="m">0f</span><span class="p">)</span>

        <span class="n">rect</span><span class="p">.</span><span class="k">set</span><span class="p">((</span><span class="n">width</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="m">0f</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">cornerRadius</span><span class="p">)</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">arcTo</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="m">270f</span><span class="p">,</span> <span class="m">90f</span><span class="p">)</span>
        <span class="n">mTop</span><span class="p">.</span><span class="nf">lineTo</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="n">arrowHeight</span> <span class="p">+</span> <span class="n">arrowMarginTop</span><span class="p">))</span>

        <span class="n">mBottom</span><span class="p">.</span><span class="nf">reset</span><span class="p">()</span>
        <span class="n">mBottom</span><span class="p">.</span><span class="nf">moveTo</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">))</span>

        <span class="n">rect</span><span class="p">.</span><span class="k">set</span><span class="p">((</span><span class="n">width</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="p">(</span><span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">mBottom</span><span class="p">.</span><span class="nf">arcTo</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="m">90f</span><span class="p">)</span>
        <span class="n">mBottom</span><span class="p">.</span><span class="nf">lineTo</span><span class="p">((</span><span class="n">arrowWidth</span> <span class="p">+</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="n">height</span><span class="p">)</span>

        <span class="n">rect</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="p">(</span><span class="n">arrowWidth</span> <span class="p">+</span> <span class="n">cornerRadius</span><span class="p">),</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">mBottom</span><span class="p">.</span><span class="nf">arcTo</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="m">90f</span><span class="p">,</span> <span class="m">90f</span><span class="p">)</span>
        <span class="n">mBottom</span><span class="p">.</span><span class="nf">lineTo</span><span class="p">(</span><span class="n">arrowWidth</span><span class="p">,</span> <span class="n">height</span> <span class="p">-</span> <span class="n">cornerRadius</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ­¤å¤„ä¼˜åŒ–çš„æ•ˆæœä¸å¥½ç»Ÿè®¡ï¼Œä¸è¿‡å¯çŸ¥æœ‰æ•ˆé™ä½åƒåœ¾å›æ”¶å¯¹ä¸»çº¿ç¨‹ç»˜åˆ¶é€ æˆçš„å½±å“ã€‚</p>

<h4 id="34-é‡å¤åˆ›å»º">3.4 é‡å¤åˆ›å»º</h4>

<p>åœ¨ <strong>RecyclerView.Adapter</strong> çš„ <strong>onBindViewHolder()</strong> ä» <strong>allRows()</strong> è·å–åˆ—è¡¨ï¼Œå‘ç° <strong>allRows()</strong> æ¯æ¬¡éƒ½ç”Ÿæˆæ–° <strong>ArrayList</strong>ã€‚</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">MessagesListAdapter</span><span class="p">(</span><span class="n">mContext</span><span class="p">:</span> <span class="nc">Context</span><span class="p">,</span>
                          <span class="k">private</span> <span class="kd">val</span> <span class="py">mSession</span><span class="p">:</span> <span class="nc">Session</span><span class="p">,</span>
                          <span class="k">private</span> <span class="kd">val</span> <span class="py">mRoom</span><span class="p">:</span> <span class="nc">Room</span><span class="p">,</span>
                          <span class="k">private</span> <span class="kd">val</span> <span class="py">mMediasCache</span><span class="p">:</span> <span class="nc">MediasCache</span><span class="p">)</span> <span class="p">:</span> <span class="nc">RecyclerView</span><span class="p">.</span><span class="nc">Adapter</span><span class="p">&lt;</span><span class="nc">ViewHolder</span><span class="p">&gt;()</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">messageRows</span> <span class="p">=</span> <span class="nc">ArrayList</span><span class="p">&lt;</span><span class="nc">MessageRow</span><span class="p">&gt;()</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">headerMessageRows</span> <span class="p">=</span> <span class="nc">ArrayList</span><span class="p">&lt;</span><span class="nc">MessageRow</span><span class="p">&gt;()</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">footerMessageRows</span> <span class="p">=</span> <span class="nc">ArrayList</span><span class="p">&lt;</span><span class="nc">MessageRow</span><span class="p">&gt;()</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onBindViewHolder</span><span class="p">(</span><span class="n">holder</span><span class="p">:</span> <span class="nc">ViewHolder</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ä»allRows()è·å–åˆ—è¡¨</span>
        <span class="n">holders</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">holder</span><span class="p">,</span> <span class="nf">allRows</span><span class="p">()[</span><span class="n">position</span><span class="p">])</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getPosition</span><span class="p">(</span><span class="n">messageRow</span><span class="p">:</span> <span class="nc">MessageRow</span><span class="p">?):</span> <span class="nc">Int</span> <span class="p">{</span>
        <span class="c1">// ä»allRows()è·å–åˆ—è¡¨</span>
        <span class="k">return</span> <span class="nf">allRows</span><span class="p">().</span><span class="nf">indexOf</span><span class="p">(</span><span class="n">messageRow</span><span class="p">)</span>
    <span class="p">}</span>
  
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">allRows</span><span class="p">():</span> <span class="nc">ArrayList</span><span class="p">&lt;</span><span class="nc">MessageRow</span><span class="p">&gt;</span> <span class="p">{</span>
      <span class="c1">// æ¯æ¬¡è°ƒç”¨éƒ½ä¼šç”Ÿæˆæ–°çš„ArrayListå®ä¾‹</span>
      <span class="kd">val</span> <span class="py">rows</span> <span class="p">=</span> <span class="nc">ArrayList</span><span class="p">&lt;</span><span class="nc">MessageRow</span><span class="p">&gt;()</span>
      <span class="n">rows</span><span class="p">.</span><span class="nf">addAll</span><span class="p">(</span><span class="n">headerMessageRows</span><span class="p">)</span>
      <span class="n">rows</span><span class="p">.</span><span class="nf">addAll</span><span class="p">(</span><span class="n">messageRows</span><span class="p">)</span>
      <span class="n">rows</span><span class="p">.</span><span class="nf">addAll</span><span class="p">(</span><span class="n">footerMessageRows</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">rows</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¿®æ”¹ä¸º <strong>headerMessageRows</strong>ã€<strong>messageRows</strong>ã€<strong>footerMessageRows</strong> æ²¡æ”¹å˜æ—¶ï¼Œå¤ç”¨ä¸Šæ¬¡ç”Ÿæˆçš„ <strong>ArrayList</strong> ç»“æœã€‚</p>

<h4 id="35-å¤šæ¬¡jsonè§£æ">3.5 å¤šæ¬¡Jsonè§£æ</h4>

<p>é‡å¤åœ¨ä¸»çº¿ç¨‹è§£æ <strong>Json</strong> ä¸ä»…å ç”¨æ—¶é—´ç‰‡å¯¼è‡´å¡é¡¿ï¼Œè¿˜äº§ç”Ÿå¾ˆå¤šå°å¯¹è±¡ï¼Œæ‰€ä»¥ç›´æ¥ç¼“å­˜ç»“æœå³å¯ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nf">RoomTopic</span><span class="o">(</span><span class="kd">private</span> <span class="n">val</span> <span class="nl">topicString:</span> <span class="nc">String</span><span class="o">?)</span> <span class="o">{</span>

    <span class="c1">// è½¬æ¢å­—ç¬¦ä¸²å˜é‡topicStringä¸ºJsonObject</span>
    <span class="kd">private</span> <span class="kt">var</span> <span class="n">topicJson</span> <span class="o">=</span> <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// å°å¯¹è±¡å¼€é”€</span>
        <span class="n">val</span> <span class="n">element</span> <span class="o">=</span> <span class="nc">JsonParser</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">topicString</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">element</span><span class="o">.</span><span class="na">isJsonObject</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">element</span><span class="o">.</span><span class="na">asJsonObject</span><span class="o">!!</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">JsonObject</span><span class="o">().</span><span class="na">apply</span> <span class="o">{</span>
                <span class="n">addProperty</span><span class="o">(</span><span class="no">JSON_KEY_TOPIC</span><span class="o">,</span> <span class="n">topicString</span><span class="o">)</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nl">e:</span> <span class="nc">Exception</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">JsonObject</span><span class="o">().</span><span class="na">apply</span> <span class="o">{</span>
            <span class="n">addProperty</span><span class="o">(</span><span class="no">JSON_KEY_TOPIC</span><span class="o">,</span> <span class="n">topicString</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// æˆ¿é—´å±æ€§</span>
    <span class="kt">var</span> <span class="n">topic</span> <span class="n">by</span> <span class="n">jsonProperty</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;(</span><span class="no">JSON_KEY_TOPIC</span><span class="o">)</span>

    <span class="c1">// æ˜¯å¦å•èŠ</span>
    <span class="kt">var</span> <span class="n">isDirect</span> <span class="n">by</span> <span class="n">jsonProperty</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;(</span><span class="no">JSON_KEY_IS_DIRECT</span><span class="o">)</span>

    <span class="o">....</span>

    <span class="n">operator</span> <span class="n">fun</span> <span class="o">&lt;</span><span class="n">reified</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="nl">key:</span> <span class="nc">String</span><span class="o">):</span> <span class="no">T</span><span class="o">?</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">gson</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">getElement</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">object</span> <span class="o">:</span> <span class="nc">TypeToken</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;()</span> <span class="o">{}.</span><span class="na">type</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">inline</span> <span class="n">fun</span> <span class="o">&lt;</span><span class="n">reified</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nf">jsonProperty</span><span class="o">(</span><span class="nl">key:</span> <span class="nc">String</span><span class="o">):</span> <span class="nc">ReadWriteProperty</span><span class="o">&lt;</span><span class="nc">Any</span><span class="o">,</span> <span class="no">T</span><span class="o">?&gt;</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">object</span> <span class="o">:</span> <span class="nc">ReadWriteProperty</span><span class="o">&lt;</span><span class="nc">Any</span><span class="o">,</span> <span class="no">T</span><span class="o">?&gt;</span> <span class="o">{</span>
            <span class="n">override</span> <span class="n">fun</span> <span class="nf">getValue</span><span class="o">(</span><span class="nl">thisRef:</span> <span class="nc">Any</span><span class="o">,</span> <span class="nl">property:</span> <span class="nc">KProperty</span><span class="o">&lt;*&gt;):</span> <span class="no">T</span><span class="o">?</span> <span class="o">=</span> <span class="n">get</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;(</span><span class="n">key</span><span class="o">)</span>
            <span class="n">override</span> <span class="n">fun</span> <span class="nf">setValue</span><span class="o">(</span><span class="nl">thisRef:</span> <span class="nc">Any</span><span class="o">,</span> <span class="nl">property:</span> <span class="nc">KProperty</span><span class="o">&lt;*&gt;,</span> <span class="nl">value:</span> <span class="no">T</span><span class="o">?)</span> <span class="o">=</span>
                    <span class="n">set</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="36-å†—ä½™å®ä¾‹">3.6 å†—ä½™å®ä¾‹</h4>

<p>æ¯ä¸ª <strong>Room</strong> å¯¹è±¡åŒ…å«ä¸€ä¸ª <strong>Gson</strong> å®ä¾‹ï¼Œç”¨äºå¤„ç† <strong>Json</strong> åºåˆ—åŒ–æ“ä½œã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Room</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GsonBuilder</span><span class="o">().</span><span class="na">create</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½†æ ¹æ® <a href="https://javadoc.io/doc/com.google.code.gson/gson/2.8.0/com/google/gson/Gson.html">APIæ–‡æ¡£</a> å¯çŸ¥ <strong>Gson</strong> æœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨ï¼Œæ²¡å¿…è¦æ¯ä¸ª <strong>Room</strong> å¯¹è±¡æŒæœ‰å„è‡ª <strong>Gson</strong> å®ä¾‹ã€‚</p>

<blockquote>
  <p>Gson instances are Thread-safe so you can reuse them freely across multiple threads.</p>
</blockquote>

<p>è®©æ‰€æœ‰ <strong>Room</strong> å…±äº«å¸¸é‡å®ä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Room</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Gson</span> <span class="no">GSON_INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GsonBuilder</span><span class="o">().</span><span class="na">create</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æŒ‰ç…§æµ‹è¯•è´¦å·æœ‰307ä¸ª <strong>Room</strong> å®ä¾‹ï¼Œæ¯ä¸ª <strong>Gson</strong> å¼•ç”¨å ç”¨4B(32ä½4Bï¼Œ64ä½8B)ï¼Œå®ä¾‹ä½“ç§¯654Bï¼Œæ­¤ä¼˜åŒ–æ€»è®¡èŠ‚çœå†…å­˜197KBã€‚</p>

<p><img src="/img/android/performance/gson_instance_retained_size.png" alt="gson_instance_retained_size" /></p>

<h4 id="37-å…³é—­èµ„æº">3.7 å…³é—­èµ„æº</h4>

<p>å†…å­˜å–æ ·è¿‡ç¨‹è¿˜å‘ç° <strong>InputStream</strong> å®ä¾‹æ»ç•™åœ¨å†…å­˜æ²¡æœ‰æ­£ç¡®å…³é—­ï¼Œä»å†…å­˜ç”³è¯·ç‚¹å‘ç°ä»¥ä¸‹ä»£ç ï¼š</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">try</span> <span class="p">{</span>
    <span class="nc">BitmapFactory</span><span class="p">.</span><span class="nf">decodeStream</span><span class="p">(</span><span class="nc">FileInputStream</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="k">null</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">OutOfMemoryError</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">e</span><span class="p">.</span><span class="nf">printStackTrace</span><span class="p">()</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½¿ç”¨ <strong>Kotlin</strong> çš„ <strong>try-resources</strong> å…³é—­ï¼š</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">try</span> <span class="p">{</span>
    <span class="nc">FileInputStream</span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="nf">use</span> <span class="p">{</span>
        <span class="nc">BitmapFactory</span><span class="p">.</span><span class="nf">decodeStream</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">OutOfMemoryError</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">e</span><span class="p">.</span><span class="nf">printStackTrace</span><span class="p">()</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="38-ç›‘å¬å™¨æ³„æ¼">3.8 ç›‘å¬å™¨æ³„æ¼</h4>

<p>æœ€ååœ¨ <strong>MAT</strong> æ£€æŸ¥å‘ç°å°çš„å†…å­˜æ³„æ¼ï¼Œä¼šå¯¼è‡´ <strong>ScreenShotListenManager</strong> è¢«ç³»ç»Ÿå¼•ç”¨ã€‚ä¸è¿‡å¹¸å¥½ <strong>ScreenShotListenManager</strong> ä¸å¼•ç”¨ <strong>Activity</strong>ï¼Œæ‰€ä»¥è¯¥æ³„æ¼æ²¡æœ‰é€ æˆä¸¥é‡åæœã€‚</p>

<p><img src="/img/android/performance/leak_MediaContentObserver.png" alt="leak_MediaContentObserver" /></p>

<p>æ³„æ¼åŸå› ï¼šåœ¨ <strong>onResume()</strong> ç”Ÿå‘½å‘¨æœŸå¤šæ¬¡æ³¨å†Œä¸åŒå®ä¾‹ï¼Œä½†åœ¨ <strong>onDestroy()</strong> ä»…æ³¨é”€äº†æœ€åä¸€æ¬¡æ³¨å†Œçš„ç›‘å¬å™¨ï¼Œå¯¼è‡´æ­¤å‰åˆ›å»ºçš„ç›‘å¬å™¨è¢«ç³»ç»ŸæŒæœ‰é€ æˆæ³„æ¼ã€‚</p>

<p><img src="/img/android/performance/activity_lifecycle_listener_leaks.jpg" alt="activity_lifecycle_listener_leaks" /></p>

<p>æºç å®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ScreenShotListenManager</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">MediaContentObserver</span> <span class="n">mInternalObserver</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">MediaContentObserver</span> <span class="n">mExternalObserver</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Handler</span> <span class="n">mUiHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Handler</span><span class="o">(</span><span class="nc">Looper</span><span class="o">.</span><span class="na">getMainLooper</span><span class="o">());</span>

    <span class="c1">// å‘ç³»ç»Ÿæ³¨å†Œç›‘å¬å™¨ï¼Œåœ¨onResume()è°ƒç”¨</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">startListen</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">mInternalObserver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MediaContentObserver</span><span class="o">(</span><span class="nc">MediaStore</span><span class="o">.</span><span class="na">Images</span><span class="o">.</span><span class="na">Media</span><span class="o">.</span><span class="na">INTERNAL_CONTENT_URI</span><span class="o">,</span> <span class="n">mUiHandler</span><span class="o">);</span>
        <span class="n">mExternalObserver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MediaContentObserver</span><span class="o">(</span><span class="nc">MediaStore</span><span class="o">.</span><span class="na">Images</span><span class="o">.</span><span class="na">Media</span><span class="o">.</span><span class="na">EXTERNAL_CONTENT_URI</span><span class="o">,</span> <span class="n">mUiHandler</span><span class="o">);</span>

        <span class="n">mContext</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">()</span>
                <span class="o">.</span><span class="na">getContentResolver</span><span class="o">()</span>
                <span class="o">.</span><span class="na">registerContentObserver</span><span class="o">(</span>
                        <span class="nc">MediaStore</span><span class="o">.</span><span class="na">Images</span><span class="o">.</span><span class="na">Media</span><span class="o">.</span><span class="na">INTERNAL_CONTENT_URI</span><span class="o">,</span>
                        <span class="kc">false</span><span class="o">,</span>
                        <span class="n">mInternalObserver</span><span class="o">);</span>

        <span class="n">mContext</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">()</span>
                <span class="o">.</span><span class="na">getContentResolver</span><span class="o">()</span>
                <span class="o">.</span><span class="na">registerContentObserver</span><span class="o">(</span>
                        <span class="nc">MediaStore</span><span class="o">.</span><span class="na">Images</span><span class="o">.</span><span class="na">Media</span><span class="o">.</span><span class="na">EXTERNAL_CONTENT_URI</span><span class="o">,</span>
                        <span class="kc">false</span><span class="o">,</span>
                        <span class="n">mExternalObserver</span><span class="o">);</span>
    <span class="o">}</span>
  
    <span class="c1">// ä»ç³»ç»Ÿæ³¨é”€ç›‘å¬å™¨ï¼Œåœ¨onDestroy()è°ƒç”¨</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stopListen</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mInternalObserver</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">mContext</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">getContentResolver</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">unregisterContentObserver</span><span class="o">(</span><span class="n">mInternalObserver</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">mInternalObserver</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">mExternalObserver</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">mContext</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">getContentResolver</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">unregisterContentObserver</span><span class="o">(</span><span class="n">mExternalObserver</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">mExternalObserver</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æŠŠåŸæ¥åœ¨ <strong>onDestroy</strong> çš„æ³¨é”€æ“ä½œï¼Œç§»åŠ¨åˆ° <strong>onResume</strong> é…å¯¹çš„ <strong>onPause</strong> ä¸Šå³å¯ä¿®å¤ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onResume</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onResume</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mManager</span><span class="o">.</span><span class="na">startListen</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// é”™è¯¯çš„æ¡ˆä¾‹ï¼šåœ¨é”™è¯¯çš„ç”Ÿå‘½å‘¨æœŸé‡Šæ”¾ç›‘å¬å™¨</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>   
    <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mManager</span><span class="o">.</span><span class="na">stopListen</span><span class="o">();</span>
        <span class="n">mManager</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="å››æ•ˆæœ">å››ã€æ•ˆæœ</h3>

<p>æ²¡æœ‰ä¼˜åŒ–å†…å­˜å‰ï¼Œå¯åŠ¨å25ç§’å¤§å¹…è¶…è¿‡32MBå†…å­˜åˆ†é…ï¼Œä¸”25ç§’åˆ°45ç§’æœŸé—´å¤šæ¬¡å‡ºç°å†…å­˜æ¯›åˆºå’Œåƒåœ¾å›æ”¶è¡Œä¸ºã€‚45ç§’æ—¶ç•Œé¢å·²ç»åŠ è½½å®Œæˆï¼Œä½†æ˜¯åå°æœåŠ¡è¿˜åœ¨é¢‘ç¹ç”³è¯·å’Œé‡Šæ”¾å†…å­˜ã€‚</p>

<p><img src="/img/android/performance/dump_size_compare.png" alt="dump_size_compare" /></p>

<p>å¯¹æ¯”ä¼˜åŒ–åï¼Œæ•´ä¸ªå¯åŠ¨åªæœ‰ä¸¤æ¬¡è½»å¾®è¶Šè¿‡32MBå †å†…å­˜ï¼Œæ•´ä½“å†…å­˜ç”³è¯·æ›²çº¿ç›¸å¯¹æŸ”å’Œï¼Œå¯åŠ¨å®Œæˆæ—¶é—´ä»45ç§’æå‰åˆ°28ç§’ã€‚éšåä¹Ÿä¸å†è§¦å‘åƒåœ¾å›æ”¶æ“ä½œï¼Œå†…å­˜å ç”¨ç»´æŒ32MBã€‚</p>

<p>æ—¶é—´åˆ°1åˆ†é’Ÿæ•´ï¼Œåº”ç”¨é€€åˆ°åå°å¹¶æ‰‹åŠ¨è§¦å‘GCï¼Œä¸¤è€…å †å†…å­˜å‡å‡ä½åˆ°25MBï¼Œå¯è§åº”ç”¨å¤„äºåå°æ—¶å ç”¨å†…å­˜ä¸å¤šã€‚</p>

<h3 id="äº”æ€»ç»“">äº”ã€æ€»ç»“</h3>

<p>æ­¤æ¬¡ä¼˜åŒ–æ‰€ç”¨æŠ€æœ¯æ–¹æ¡ˆï¼Œå¯å‡å°‘å¯åŠ¨è¿‡ç¨‹å¯¹è±¡äº§ç”Ÿæ•°é‡ï¼Œç¼©å‡æœ€å¤§å†…å­˜å ç”¨é‡ã€‚ç„¶è€Œè¯»è€…å¯èƒ½ä¼šç–‘æƒ‘ï¼Œä¸€èˆ¬æŠ€æœ¯ä¼˜åŒ–æ•ˆæœå¦‚æ­¤æ˜æ˜¾ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚</p>

<p>é™¤äº†ä¸Šè¿°æŠ€æœ¯ä¼˜åŒ–ï¼Œåœ¨è·Ÿè¸ªæºç è¿‡ç¨‹å‘ç°ä¸šåŠ¡ä»£ç ï¼Œå­˜åœ¨æ‰§è¡Œä½æ•ˆã€ç”šè‡³æ˜¯å†—ä½™çš„é—®é¢˜ã€‚è¿™ç§æŸ¥æ‰¾ä¸å…·æœ‰ä¸€èˆ¬æ€§ï¼Œä¸èƒ½åœ¨æ­¤ä¸€ä¸€åˆ—å‡ºï¼Œåªèƒ½æŒ‰ç…§â€œèƒ½çœåˆ™çœâ€çš„åŸºæœ¬æ³•åˆ™ï¼Œåœ¨æŠ€æœ¯ä¼˜åŒ–çš„è¿‡ç¨‹å®Œå–„ã€‚</p>

<p>è‹¥è€ƒè™‘ç”¨æˆ·åŠ¨æ€ä½¿ç”¨åœºæ™¯ã€éšå«æœªçŸ¥çš„å†…å­˜æ³„æ¼ã€å›¾ä¸­å°šå­˜åœ¨çš„å°–å³°ï¼Œåç»­è¿˜æœ‰è¿›ä¸€æ­¥ä¼˜åŒ–ç©ºé—´ã€‚</p>

<p>ç»éªŒæ€»ç»“ï¼š</p>

<ul>
  <li>è‹¥é¢‘ç¹è¾“å‡ºæ—¥å¿—ï¼Œä½¿ç”¨mmapè€Œä¸æ˜¯åŸºäºJavaçš„æ—¥å¿—æ¡†æ¶ï¼Œé¿å…Stringå†…å­˜å¼€é”€ï¼›</li>
  <li>çº¿ç¨‹å®‰å…¨å·¥å…·ç±»å¯å£°æ˜ä¸ºå¸¸é‡å¯¹è±¡ï¼Œä¸ºæ‰€æœ‰è°ƒç”¨ç‚¹æä¾›æœåŠ¡è€Œå‡å°‘å†—ä½™å®ä¾‹ï¼›</li>
  <li>é€‰ç”¨çŸ¥åå›¾ç‰‡åŠ è½½æ¡†æ¶ä¸ä»…èŠ‚çº¦å¼€å‘æ—¶é—´ï¼Œè¿˜èƒ½é¿å…å›¾ç‰‡åŠ è½½å¼•èµ·çš„å†…å­˜é—®é¢˜ï¼›</li>
  <li>éå—æ£€å¼‚å¸¸å¦‚ <strong>NullPointerException</strong>ã€<strong>ClassCastException</strong> éƒ½èƒ½é¢„é˜²ï¼Œå¤„ç†åå¯é¿å…å †æ ˆæ‰“å°å¿«ç…§å¼•èµ·çš„åœé¡¿åŠ <strong>StackTraceElement</strong> å¼€é”€ï¼›</li>
  <li>å‰Šå‡ç©ºé—²çº¿ç¨‹ä¹Ÿæ˜¯ä¼˜åŒ–å†…å­˜å ç”¨æ–¹æ³•ä¹‹ä¸€ï¼Œé…Œæƒ…æ“ä½œï¼›</li>
  <li>è°¨æ…å¯¹å¾…æ¯ä¸ªå†…å­˜å¼€é”€ï¼Œåœ¨ <strong>Comparator</strong> æˆ– åŒé‡ <strong>for</strong> å¾ªç¯åŠ©åŠ›ä¸‹ï¼Œå¼€é”€èƒ½ä»¥ <strong>n</strong> ç”šè‡³ <strong>n*n</strong> æ–¹å¼å¢åŠ ï¼›</li>
</ul>

<h3 id="å…­å‚è€ƒé“¾æ¥">å…­ã€å‚è€ƒé“¾æ¥</h3>

<ul>
  <li><a href="https://developer.android.com/studio/profile/memory-profiler?hl=zh-cn">ä½¿ç”¨ Memory Profiler æŸ¥çœ‹ Java å †å’Œå†…å­˜åˆ†é…</a></li>
  <li><a href="https://wetest.qq.com/lab/view/359.html">æˆ‘è¿™æ ·å‡å°‘äº†26.5M Javaå†…å­˜ï¼</a></li>
  <li><a href="https://wetest.qq.com/lab/view/362.html">Android å†…å­˜æš´å‡çš„ç§˜å¯†ï¼Ÿï¼</a></li>
</ul>
:ET