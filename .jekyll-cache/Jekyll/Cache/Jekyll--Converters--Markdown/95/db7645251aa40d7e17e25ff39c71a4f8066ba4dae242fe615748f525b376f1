I"…<<p>æ–‡ç« åˆ—è¡¨ï¼š</p>
<ul>
  <li><a href="/2018/11/15/EventBus_1_Register/">EventBusæºç å‰–æ(1) â€“ è®¢é˜…æ³¨å†Œä¸æ³¨é”€</a></li>
  <li><a href="/2018/12/01/EventBus_2_EventBusBuilder/">EventBusæºç å‰–æ(2) â€“ EventBusBuilder</a></li>
  <li><a href="/2018/12/03/EventBus_3_ThreadMode/">EventBusæºç å‰–æ(3) â€“ çº¿ç¨‹æ¨¡å¼</a></li>
  <li><a href="/2018/12/06/EventBus_4_Subscription/">EventBusæºç å‰–æ(4) â€“ è®¢é˜…è®°å½•</a></li>
  <li><a href="/2018/12/10/EventBus_5_Poster/">EventBusæºç å‰–æ(5) â€“ Poster</a></li>
</ul>

<h2 id="ä¸€subscription">ä¸€ã€Subscription</h2>

<p>è®¢é˜…è€…è¿›è¡Œæ³¨å†Œæ—¶ï¼Œ<strong>EventBus</strong> ä¼šæ‰«ææ•´ä¸ªè®¢é˜…è€…ç±»ï¼Œè·å–æ¥æ”¶äº‹ä»¶çš„å…·ä½“æ–¹æ³•ï¼Œå¹¶æ„é€ å‡º <strong>Subscription</strong> å®ä¾‹ã€‚æ¯ä¸ªè®¢é˜…è€…å¯æœ‰å¤šä¸ªæ–¹æ³•æ¥æ”¶è®¢é˜…äº‹ä»¶ï¼Œæ¯ä¸ªæ–¹æ³•ç”Ÿæˆå„è‡ªçš„ <strong>Subscription</strong> ä½œä¸ºäº‹ä»¶æ¥æ”¶å‡­è¯ã€‚</p>

<p>è®¢é˜…è®°å½•å†…ä¸»è¦åŒ…æ‹¬3ä¸ªæˆå‘˜å˜é‡ï¼š</p>

<ul>
  <li><code class="highlighter-rouge">subscriber</code>è¡¨ç¤ºè®¢é˜…ç±»çš„å®ä¾‹ï¼›</li>
  <li><code class="highlighter-rouge">subscriberMethod</code>è¡¨ç¤ºè®¢é˜…è€…å†…æ¥å—äº‹ä»¶çš„æ–¹æ³•ï¼›</li>
  <li>è¿˜æœ‰è¡¨ç¤ºè®¢é˜…è®°å½•æ˜¯å¦æœ‰æ•ˆçš„<code class="highlighter-rouge">active</code>ï¼›</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="nc">Subscription</span> <span class="o">{</span>
    <span class="c1">// è®¢é˜…è€…ç±»çš„å®ä¾‹</span>
    <span class="kd">final</span> <span class="nc">Object</span> <span class="n">subscriber</span><span class="o">;</span>
    
    <span class="c1">// è®¢é˜…äº‹ä»¶çš„æ–¹æ³•</span>
    <span class="kd">final</span> <span class="nc">SubscriberMethod</span> <span class="n">subscriberMethod</span><span class="o">;</span>

    <span class="c1">// è®¢é˜…è®°å½•æ˜¯å¦ä¾ç„¶ç”Ÿæ•ˆæ ‡å¿—ä½ï¼Œvolatileä¿®é¥°æ§åˆ¶å¤šçº¿ç¨‹å¯è§æ€§</span>
    <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">active</span><span class="o">;</span>

    <span class="c1">// æ„é€ æ–¹æ³•ï¼Œæ„é€ ä¹‹åé»˜è®¤æ¥å—äº‹ä»¶</span>
    <span class="nc">Subscription</span><span class="o">(</span><span class="nc">Object</span> <span class="n">subscriber</span><span class="o">,</span> <span class="nc">SubscriberMethod</span> <span class="n">subscriberMethod</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">subscriber</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">subscriberMethod</span> <span class="o">=</span> <span class="n">subscriberMethod</span><span class="o">;</span>
        <span class="n">active</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="nc">Subscription</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Subscription</span> <span class="n">otherSubscription</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Subscription</span><span class="o">)</span> <span class="n">other</span><span class="o">;</span>
            <span class="c1">// å¯¹æ¯”æ˜¯å¦ä¸ºé‡å¤å®ä¾‹</span>
            <span class="k">return</span> <span class="n">subscriber</span> <span class="o">==</span> <span class="n">otherSubscription</span><span class="o">.</span><span class="na">subscriber</span>
                    <span class="o">&amp;&amp;</span> <span class="n">subscriberMethod</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">otherSubscription</span><span class="o">.</span><span class="na">subscriberMethod</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">subscriber</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span> <span class="o">+</span> <span class="n">subscriberMethod</span><span class="o">.</span><span class="na">methodString</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è°ƒç”¨ <strong>EventBus#unregister(Object)</strong> æ³¨é”€è®¢é˜…è€…åï¼Œ<code class="highlighter-rouge">active</code>æ”¹ä¸º <strong>false</strong>ï¼Œè¯¥å€¼ç”±è´Ÿè´£é˜Ÿåˆ—äº‹ä»¶æŠ•é€’çš„ <strong>EventBus#invokeSubscriber(PendingPost)</strong> æ£€æŸ¥ä»¥é¿å… <strong>race conditions</strong>ã€‚</p>

<h2 id="äºŒsubscribermethod">äºŒã€SubscriberMethod</h2>

<p>å…·ä½“åˆ° <strong>Subscription</strong> å†…éƒ¨å®ç°ï¼Œé‡Œé¢è¿˜åŒ…å«äº† <strong>SubscriberMethod</strong>ã€‚æ¯ä¸ª <strong>SubscriberMethod</strong> è¡¨ç¤ºä¸€ä¸ªè®¢é˜…è€…ç±»çš„è®¢é˜…æ–¹æ³•ã€‚</p>

<p>å‰æ–‡å·²ç»æåˆ°ï¼Œè®¢é˜…è€…ç±»é€šè¿‡ <strong>EventBus</strong> çš„æ³¨è§£ä¿®é¥°å¹¶å› æ­¤èƒ½è¢« <strong>EventBus</strong> å‘ç°ã€‚<strong>EventBus</strong> é€šè¿‡æ³¨è§£å¤„ç†å™¨åˆ†ææ³¨è§£ï¼Œå’Œè·å–çš„è®¢é˜…è€…æ–¹æ³•ä¿¡æ¯æ„é€ ä¸º <strong>SubscriberMethod</strong> å®ä¾‹ï¼Œæˆä¸ºè®¢é˜…è€…ä¿¡æ¯çš„ç´¢å¼•ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SubscriberMethod</span> <span class="o">{</span>
    <span class="c1">// æ¥æ”¶äº‹ä»¶çš„æ–¹æ³•å®ä¾‹</span>
    <span class="kd">final</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">;</span>
    
    <span class="c1">// çº¿ç¨‹æ¨¡å¼</span>
    <span class="kd">final</span> <span class="nc">ThreadMode</span> <span class="n">threadMode</span><span class="o">;</span>
    
    <span class="c1">// äº‹ä»¶ç±»å‹</span>
    <span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventType</span><span class="o">;</span>
    
    <span class="c1">// äº‹ä»¶ä¼˜å…ˆçº§</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">priority</span><span class="o">;</span>
    
    <span class="c1">// æ˜¯å¦ç²˜æ€§äº‹ä»¶</span>
    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">sticky</span><span class="o">;</span>
    
    <span class="c1">// æ­¤å­—ç¬¦ä¸²ç”¨äºæé«˜æ¯”è¾ƒæ•ˆç‡</span>
    <span class="nc">String</span> <span class="n">methodString</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SubscriberMethod</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventType</span><span class="o">,</span> <span class="nc">ThreadMode</span> <span class="n">threadMode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">sticky</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">threadMode</span> <span class="o">=</span> <span class="n">threadMode</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">eventType</span> <span class="o">=</span> <span class="n">eventType</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">priority</span> <span class="o">=</span> <span class="n">priority</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sticky</span> <span class="o">=</span> <span class="n">sticky</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="c1">// æ¯”è¾ƒä¸¤ä¸ªè®¢é˜…è€…æ–¹æ³•</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="nc">SubscriberMethod</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">checkMethodString</span><span class="o">();</span>
            <span class="nc">SubscriberMethod</span> <span class="n">otherSubscriberMethod</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SubscriberMethod</span><span class="o">)</span><span class="n">other</span><span class="o">;</span>
            <span class="n">otherSubscriberMethod</span><span class="o">.</span><span class="na">checkMethodString</span><span class="o">();</span>
            <span class="c1">// Don't use method.equals because of https://issuetracker.google.com/issues/36916580#c6</span>
            <span class="k">return</span> <span class="n">methodString</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">otherSubscriberMethod</span><span class="o">.</span><span class="na">methodString</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">checkMethodString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">methodString</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Method.toStringå¼€é”€è¾ƒå¤§ï¼Œåªéœ€è¦å–æ–¹æ³•å</span>
            <span class="nc">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="mi">64</span><span class="o">);</span>
            <span class="c1">// ä¸‰å…ƒç»„ï¼šè®¢é˜…è€…ç±»ã€è®¢é˜…æ–¹æ³•ã€è®¢é˜…æ¶ˆæ¯ç±»å‹</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'#'</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'('</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">eventType</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="n">methodString</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸‰subscribeæ³¨è§£">ä¸‰ã€Subscribeæ³¨è§£</h2>

<p>è¿™ä¸ªå°±æ˜¯ <strong>EventBus</strong> æ³¨è§£ã€‚ä»æ³¨è§£ç±»çœ‹åˆ° <strong>threadMode</strong>ã€<strong>sticky</strong>ã€<strong>priority</strong> éƒ½èƒ½å’Œ <strong>SubscriberMethod</strong> ç±»çš„æ•°æ®æˆå‘˜åŒ¹é…ä¸Šã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="nd">@Documented</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">})</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">Subscribe</span> <span class="o">{</span>
    <span class="c1">// é€šè¿‡æŒ‡å®šçº¿ç¨‹æ¨¡å¼è°ƒèµ·è®¢é˜…è€…æ–¹æ³•</span>
    <span class="nc">ThreadMode</span> <span class="nf">threadMode</span><span class="o">()</span> <span class="k">default</span> <span class="nc">ThreadMode</span><span class="o">.</span><span class="na">POSTING</span><span class="o">;</span>

    <span class="c1">// è‹¥æ˜¯ç²˜æ€§äº‹ä»¶ï¼ŒæŠŠç²˜æ€§äº‹ä»¶å‘é€ç»™è®¢é˜…è€…</span>
    <span class="kt">boolean</span> <span class="nf">sticky</span><span class="o">()</span> <span class="k">default</span> <span class="kc">false</span><span class="o">;</span>

    <span class="c1">// æ–¹æ³•æ¥æ”¶äº‹ä»¶çš„ä¼˜å…ˆçº§ï¼Œé»˜è®¤ä¼˜å…ˆçº§æ˜¯0</span>
    <span class="c1">// åœ¨ç›¸åŒçº¿ç¨‹å†…ï¼Œé«˜ä¼˜å…ˆçº§è®¢é˜…è€…æ–¹æ³•æ¯”ä½ä¼˜å…ˆçº§æ–¹æ³•æ›´æ—©æ¥æ”¶äº‹ä»¶</span>
    <span class="c1">// æ­¤ä¼˜å…ˆçº§ä¸ä¼šå½±å“ä¸åŒçº¿ç¨‹æ¨¡å¼ä¸­ä¸åŒè®¢é˜…è€…äº‹ä»¶çš„æ´¾å‘</span>
    <span class="kt">int</span> <span class="nf">priority</span><span class="o">()</span> <span class="k">default</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è‹¥æ³¨è§£æ–¹æ³•æ— éœ€ä¿®æ”¹é»˜è®¤æ¡ä»¶ï¼Œåˆ™ä½¿ç”¨ <strong>@Subscribe</strong> æ—¶ä¸æŒ‡å®šå‚æ•°å³å¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1">// ä¸‰ä¸ªå‚æ•°çš„è®¾ç½®</span>
<span class="nd">@Subscribe</span><span class="o">(</span><span class="n">threadMode</span> <span class="o">=</span> <span class="nc">ThreadMode</span><span class="o">.</span><span class="na">MAIN</span><span class="o">,</span> <span class="n">sticky</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="o">)</span>
<span class="n">fun</span> <span class="nf">onEventReceived</span><span class="o">(</span><span class="nl">event:</span> <span class="nc">UserEvent</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">val</span> <span class="n">name</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">name</span>
    <span class="n">val</span> <span class="n">age</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">age</span>
    <span class="nc">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Event received, Name: $name, Age: $age."</span><span class="o">)</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœå®ä¾‹æ²¡æœ‰å¯æ‰§è¡Œæ–¹æ³•ï¼Œæ³¨å†Œåˆ° <strong>EventBus</strong> è¿‡ç¨‹çš„ç±»æ‰«æä¼šæŠ›å‡ºå¼‚å¸¸ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>java.lang.RuntimeException: Unable to start activity ComponentInfo{com.phantomvk.playground/com.phantomvk.playground.MainActivity}: org.greenrobot.eventbus.EventBusException: Subscriber class com.phantomvk.playground.MainActivity and its super classes have no public methods with the @Subscribe annotation
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å››subscribermethodfinder">å››ã€SubscriberMethodFinder</h2>

<h4 id="41-ç±»ç­¾å">4.1 ç±»ç­¾å</h4>

<p>å‰æ–‡é“ºå« <strong>Subscription</strong>ã€<strong>SubscriberMethod</strong>ã€<strong>Subscribe</strong> æ³¨è§£ï¼Œæ˜¯ä¸ºäº†é™ä½ç†è§£ <strong>SubscriberMethodFinder</strong> çš„éš¾åº¦ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">SubscriberMethodFinder</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€šè¿‡æ‰«æè®¢é˜…è€…æ–¹æ³•çš„ <strong>Subscribe</strong> æ³¨è§£ï¼Œä¸ºå¯¹åº”è®¢é˜…æ–¹æ³•ç”Ÿæˆ <strong>SubscriberMethod</strong> å®ä¾‹ï¼Œå†æ„é€ å‡ºè®¢é˜…è®°å½• <strong>Subscription</strong>ã€‚</p>

<h4 id="42-å¸¸é‡">4.2 å¸¸é‡</h4>

<p>è¾ƒæ–°çš„ç±»æ–‡ä»¶ä¸­ç¼–è¯‘å™¨å¯èƒ½ä¼šæ·»åŠ é¢å¤–æ–¹æ³•ï¼Œ è¿™äº›æ–¹æ³•è¢«ç§°ä¸ºæ¡¥æ¢æˆ–åˆæˆæ–¹æ³•ã€‚<strong>EventBus</strong> åŒæ—¶å¿½ç•¥è¿™ä¸¤ç§æ–¹æ³•ã€‚</p>

<p>è¿™äº›ä¿®é¥°ç¬¦éƒ½ä¸å’Œ <strong>public</strong> ä½¿ç”¨ï¼Œè€Œæ˜¯ä»¥Javaç±»æ–‡ä»¶æ ¼å¼å®šä¹‰ï¼Œè¯¦æƒ…è¯·çœ‹ï¼š<a href="http://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html#jvms-4.6-200-A.1">jvms-4.html#jvms-4.6-200-A.1</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">BRIDGE</span> <span class="o">=</span> <span class="mh">0x40</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">SYNTHETIC</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¿½ç•¥æŠ½è±¡æ–¹æ³•ã€é™æ€æ–¹æ³•ã€æ¡¥æ¥æ–¹æ³•ã€åˆæˆæ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MODIFIERS_IGNORE</span> <span class="o">=</span> <span class="nc">Modifier</span><span class="o">.</span><span class="na">ABSTRACT</span> <span class="o">|</span> <span class="nc">Modifier</span><span class="o">.</span><span class="na">STATIC</span> <span class="o">|</span> <span class="no">BRIDGE</span> <span class="o">|</span> <span class="no">SYNTHETIC</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ‰«æè®¢é˜…è€…å’Œè®¢é˜…æ–¹æ³•åç”Ÿæˆç¼“å­˜</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SubscriberMethod</span><span class="o">&gt;&gt;</span> <span class="no">METHOD_CACHE</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>FindState</strong> å¯¹è±¡ç¼“å­˜æ± å¤§å°</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">POOL_SIZE</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>FindState</strong> å¯¹è±¡ç¼“å­˜æ± </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">FindState</span><span class="o">[]</span> <span class="no">FIND_STATE_POOL</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FindState</span><span class="o">[</span><span class="no">POOL_SIZE</span><span class="o">];</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="43-æ•°æ®æˆå‘˜">4.3 æ•°æ®æˆå‘˜</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SubscriberInfoIndex</span><span class="o">&gt;</span> <span class="n">subscriberInfoIndexes</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">strictMethodVerification</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">ignoreGeneratedIndex</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="44-æ„é€ æ–¹æ³•">4.4 æ„é€ æ–¹æ³•</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nc">SubscriberMethodFinder</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">SubscriberInfoIndex</span><span class="o">&gt;</span> <span class="n">subscriberInfoIndexes</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">strictMethodVerification</span><span class="o">,</span>
                       <span class="kt">boolean</span> <span class="n">ignoreGeneratedIndex</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">subscriberInfoIndexes</span> <span class="o">=</span> <span class="n">subscriberInfoIndexes</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">strictMethodVerification</span> <span class="o">=</span> <span class="n">strictMethodVerification</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">ignoreGeneratedIndex</span> <span class="o">=</span> <span class="n">ignoreGeneratedIndex</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="45-findsubscribermethods">4.5 findSubscriberMethods</h4>

<p>åœ¨è®¢é˜…è€…ç±»å†…æ‰«æè®¢é˜…è€…æ–¹æ³•ï¼Œå¦‚æœè®¢é˜…è€…ç±»æ²¡æœ‰ç›®æ ‡æ–¹æ³•ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚ä»ç¼“å­˜åˆ—è¡¨ä¸­æŸ¥æ‰¾ç¼“å­˜å‡å°‘æ‰«ææ—¶é—´ï¼Œç¼“å­˜å‘½ä¸­å°±ä¸éœ€è¦ä»è®¢é˜…è€…ç±»ä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="nc">List</span><span class="o">&lt;</span><span class="nc">SubscriberMethod</span><span class="o">&gt;</span> <span class="nf">findSubscriberMethods</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">subscriberClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// æ ¹æ®è®¢é˜…è€…ç±»ä»ç¼“å­˜ä¸­è·å–è®¢é˜…è€…æ–¹æ³•</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SubscriberMethod</span><span class="o">&gt;</span> <span class="n">subscriberMethods</span> <span class="o">=</span> <span class="no">METHOD_CACHE</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">subscriberClass</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">subscriberMethods</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">subscriberMethods</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// ignoreGeneratedIndexåœ¨EventBusBuilder.ignoreGeneratedIndexä¸ºfalse</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ignoreGeneratedIndex</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// é€šè¿‡åå°„çš„æ–¹å¼æŸ¥æ‰¾è®¢é˜…è€…æ–¹æ³•</span>
        <span class="n">subscriberMethods</span> <span class="o">=</span> <span class="n">findUsingReflection</span><span class="o">(</span><span class="n">subscriberClass</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// æŸ¥æ‰¾è®¢é˜…è€…æ–¹æ³•</span>
        <span class="n">subscriberMethods</span> <span class="o">=</span> <span class="n">findUsingInfo</span><span class="o">(</span><span class="n">subscriberClass</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">// åœ¨è®¢é˜…è€…ä¸­æ²¡æœ‰æ‰¾åˆ°ä½¿ç”¨æ³¨è§£æ ‡æ³¨çš„å…¬å¼€æ–¹æ³•</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">subscriberMethods</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">EventBusException</span><span class="o">(</span><span class="s">"Subscriber "</span> <span class="o">+</span> <span class="n">subscriberClass</span>
                <span class="o">+</span> <span class="s">" and its super classes have no public methods with the @Subscribe annotation"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// ç»“æœæ”¾å…¥ç¼“å­˜ä¸­</span>
        <span class="no">METHOD_CACHE</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">subscriberClass</span><span class="o">,</span> <span class="n">subscriberMethods</span><span class="o">);</span>
        <span class="c1">// è¿”å›è®¢é˜…è€…æ–¹æ³•</span>
        <span class="k">return</span> <span class="n">subscriberMethods</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="46-findusingreflection">4.6 findUsingReflection</h4>

<p>é€šè¿‡åå°„æŸ¥æ‰¾è®¢é˜…è€…çš„è®¢é˜…æ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SubscriberMethod</span><span class="o">&gt;</span> <span class="nf">findUsingReflection</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">subscriberClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ä»ç¼“å­˜æ± è·å–findState</span>
    <span class="nc">FindState</span> <span class="n">findState</span> <span class="o">=</span> <span class="n">prepareFindState</span><span class="o">();</span>
    <span class="c1">// ç”¨è®¢é˜…è€…ç±»åˆå§‹åŒ–findState</span>
    <span class="n">findState</span><span class="o">.</span><span class="na">initForSubscriber</span><span class="o">(</span><span class="n">subscriberClass</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">findState</span><span class="o">.</span><span class="na">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">findUsingReflectionInSingleClass</span><span class="o">(</span><span class="n">findState</span><span class="o">);</span>
        <span class="n">findState</span><span class="o">.</span><span class="na">moveToSuperclass</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="nf">getMethodsAndRelease</span><span class="o">(</span><span class="n">findState</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="47-findusinginfo">4.7 findUsingInfo</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SubscriberMethod</span><span class="o">&gt;</span> <span class="nf">findUsingInfo</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">subscriberClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ä»ç¼“å­˜æ± è·å–findState</span>
    <span class="nc">FindState</span> <span class="n">findState</span> <span class="o">=</span> <span class="n">prepareFindState</span><span class="o">();</span>
    <span class="c1">// ç”¨è®¢é˜…è€…ç±»åˆå§‹åŒ–findState</span>
    <span class="n">findState</span><span class="o">.</span><span class="na">initForSubscriber</span><span class="o">(</span><span class="n">subscriberClass</span><span class="o">);</span>
    <span class="c1">// é‡åˆ°ï¼š"java."ã€"javax."ã€"android."çš„ç±»åclazzä¼šç½®ç©ºï¼Œå¹¶ç»ˆæ­¢è¿™ä¸ªå¾ªç¯</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">findState</span><span class="o">.</span><span class="na">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// å¦‚æœè®¢é˜…è€…ä¹‹å‰æ²¡æœ‰æ³¨å†Œè¿‡ï¼Œåˆ™ä»¥ä¸‹è¿”å›å€¼ä¸ºnullï¼Œéœ€é€šè¿‡åå°„çš„æ–¹å¼æŸ¥æ‰¾</span>
        <span class="n">findState</span><span class="o">.</span><span class="na">subscriberInfo</span> <span class="o">=</span> <span class="n">getSubscriberInfo</span><span class="o">(</span><span class="n">findState</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">findState</span><span class="o">.</span><span class="na">subscriberInfo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">SubscriberMethod</span><span class="o">[]</span> <span class="n">array</span> <span class="o">=</span> <span class="n">findState</span><span class="o">.</span><span class="na">subscriberInfo</span><span class="o">.</span><span class="na">getSubscriberMethods</span><span class="o">();</span>
            <span class="c1">// ä¸Šé¢æ— å·®åˆ«è®¢é˜…ç±»ä¸­æ‰€æœ‰æ–¹æ³•ï¼Œä¸‹é¢éœ€è¦éå†ç­›é€‰å‡ºæœ‰æ•ˆçš„è®¢é˜…æ–¹æ³•</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">SubscriberMethod</span> <span class="n">subscriberMethod</span> <span class="o">:</span> <span class="n">array</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">findState</span><span class="o">.</span><span class="na">checkAdd</span><span class="o">(</span><span class="n">subscriberMethod</span><span class="o">.</span><span class="na">method</span><span class="o">,</span> <span class="n">subscriberMethod</span><span class="o">.</span><span class="na">eventType</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">findState</span><span class="o">.</span><span class="na">subscriberMethods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">subscriberMethod</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">findUsingReflectionInSingleClass</span><span class="o">(</span><span class="n">findState</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// æ‰«æç›®æ ‡ç±»è½¬ç§»åˆ°çˆ¶ç±»ä¸Š</span>
        <span class="n">findState</span><span class="o">.</span><span class="na">moveToSuperclass</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// è¿”å›List&lt;SubscriberMethod&gt;ï¼Œé‡Šæ”¾FindStateå®ä¾‹</span>
    <span class="k">return</span> <span class="nf">getMethodsAndRelease</span><span class="o">(</span><span class="n">findState</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="48-getmethodsandrelease">4.8 getMethodsAndRelease</h4>

<p>ä» <strong>findState</strong> è·å–è®¢é˜…è€…çš„è®¢é˜…æ–¹æ³•ï¼Œ <strong>findState</strong> é‡ç½®åæ”¾å…¥ç¼“å­˜ï¼Œæœ€åè¿”å›è®¢é˜…è€…æ–¹æ³•åˆ—è¡¨</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SubscriberMethod</span><span class="o">&gt;</span> <span class="nf">getMethodsAndRelease</span><span class="o">(</span><span class="nc">FindState</span> <span class="n">findState</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ä»findStateè·å–æ‰€æœ‰è®¢é˜…æ–¹æ³•</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SubscriberMethod</span><span class="o">&gt;</span> <span class="n">subscriberMethods</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">findState</span><span class="o">.</span><span class="na">subscriberMethods</span><span class="o">);</span>
    <span class="c1">// é‡ç½®findState</span>
    <span class="n">findState</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
    <span class="c1">// æŠŠfindStateæ”¾å…¥ç¼“å­˜æ± ä¸­</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="no">FIND_STATE_POOL</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">POOL_SIZE</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="c1">// æ‰¾ä¸€ä¸ªéç©ºä½ç½®å­˜æ”¾å¯ç¼“å­˜å®ä¾‹</span>
            <span class="k">if</span> <span class="o">(</span><span class="no">FIND_STATE_POOL</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="no">FIND_STATE_POOL</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">findState</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// è¿”å›findStateä¸­ä¿å­˜çš„subscriberMethods</span>
    <span class="k">return</span> <span class="n">subscriberMethods</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="49-preparefindstate">4.9 prepareFindState</h4>

<p>ä»ç¼“å­˜æ± ä¸­è·å– <strong>FindState</strong> å®ä¾‹ï¼Œå¦‚æœç¼“å­˜æ± æ²¡æœ‰ç¼“å­˜çš„å®ä¾‹åˆ™åˆ›å»ºæ–°å®ä¾‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">FindState</span> <span class="nf">prepareFindState</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="no">FIND_STATE_POOL</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">POOL_SIZE</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">FindState</span> <span class="n">state</span> <span class="o">=</span> <span class="no">FIND_STATE_POOL</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="c1">// ä»ç¼“å­˜æ± å–ä¸€ä¸ªå¯ç”¨çš„å®ä¾‹</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">state</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="no">FIND_STATE_POOL</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">return</span> <span class="n">state</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// ç¼“å­˜æ± ä¸ºç©ºï¼Œåˆ›å»ºå¹¶è¿”å›æ–°å®ä¾‹</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">FindState</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="410-getsubscriberinfo">4.10 getSubscriberInfo</h4>

<p>è·å–è®¢é˜…è€…çš„ä¿¡æ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">SubscriberInfo</span> <span class="nf">getSubscriberInfo</span><span class="o">(</span><span class="nc">FindState</span> <span class="n">findState</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// é¦–æ¬¡æ³¨å†Œçš„è®¢é˜…è€…ï¼Œä»¥ä¸‹æ¡ä»¶åˆ¤æ–­ä¸ºç©º</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">findState</span><span class="o">.</span><span class="na">subscriberInfo</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">findState</span><span class="o">.</span><span class="na">subscriberInfo</span><span class="o">.</span><span class="na">getSuperSubscriberInfo</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SubscriberInfo</span> <span class="n">superclassInfo</span> <span class="o">=</span> <span class="n">findState</span><span class="o">.</span><span class="na">subscriberInfo</span><span class="o">.</span><span class="na">getSuperSubscriberInfo</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">findState</span><span class="o">.</span><span class="na">clazz</span> <span class="o">==</span> <span class="n">superclassInfo</span><span class="o">.</span><span class="na">getSubscriberClass</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">superclassInfo</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// é¦–æ¬¡æ³¨å†Œçš„è®¢é˜…è€…ï¼Œä»¥ä¸‹æ¡ä»¶åˆ¤æ–­ä¸ºç©º</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">subscriberInfoIndexes</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">SubscriberInfoIndex</span> <span class="n">index</span> <span class="o">:</span> <span class="n">subscriberInfoIndexes</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">SubscriberInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="na">getSubscriberInfo</span><span class="o">(</span><span class="n">findState</span><span class="o">.</span><span class="na">clazz</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">info</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">info</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// é¦–æ¬¡æ³¨å†Œçš„è®¢é˜…è€…è¿”å›å€¼ä¸ºnull</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="411-findusingreflectioninsingleclass">4.11 findUsingReflectionInSingleClass</h4>

<p><strong>FindState.clazz</strong> å°±æ˜¯è®¢é˜…è€…ç±»ã€‚å…ˆæŠŠè®¢é˜…è€…çš„æ–¹æ³•æ”¶é›†æˆä¸ºåˆ—è¡¨ï¼Œåé€ä¸ªåˆ†ææ–¹æ³•çš„æ³¨è§£ã€‚æ ¹æ®çº¦æŸæ¡ä»¶é€æ¸ç­›é€‰å‡ºç¬¦åˆæ¡ä»¶çš„æ–¹æ³•ï¼Œæ”¾å…¥åˆ° <strong>FindState.subscriberMethods</strong>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">findUsingReflectionInSingleClass</span><span class="o">(</span><span class="nc">FindState</span> <span class="n">findState</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Method</span><span class="o">[]</span> <span class="n">methods</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// æ­¤æ–¹æ³•æ¯”getMethodsé€Ÿåº¦æ›´å¿«ï¼Œå°¤å…¶æ˜¯è®¢é˜…è€…åƒActivitiesè¿™ç§å·¨å‹ç±»çš„æ—¶å€™</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="n">findState</span><span class="o">.</span><span class="na">clazz</span><span class="o">.</span><span class="na">getDeclaredMethods</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">th</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="n">findState</span><span class="o">.</span><span class="na">clazz</span><span class="o">.</span><span class="na">getMethods</span><span class="o">();</span>
        <span class="n">findState</span><span class="o">.</span><span class="na">skipSuperClasses</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="c1">// éå†è®¢é˜…è€…ç±»å†…æ‰€æœ‰æ–¹æ³•</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Method</span> <span class="n">method</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">modifiers</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">();</span>
        <span class="c1">// æ–¹æ³•ä½¿ç”¨å¯è§æ€§ä¸ºpublicï¼Œä¸”æ²¡æœ‰ä½¿ç”¨MODIFIERS_IGNOREä¿®é¥°</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">modifiers</span> <span class="o">&amp;</span> <span class="nc">Modifier</span><span class="o">.</span><span class="na">PUBLIC</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">modifiers</span> <span class="o">&amp;</span> <span class="no">MODIFIERS_IGNORE</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// ä»æ–¹æ³•è·å–å˜é‡ç±»å‹</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
            <span class="c1">// å˜é‡çš„æ•°é‡å¿…é¡»ä¸º1ä¸ªï¼Œå¦åˆ™ä¸å¤„ç†</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// æ£€æŸ¥æ–¹æ³•æ˜¯å¦æœ‰Subscribeæ³¨è§£ä¿®é¥°</span>
                <span class="nc">Subscribe</span> <span class="n">subscribeAnnotation</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">Subscribe</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">subscribeAnnotation</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// ä»æ–¹æ³•å˜é‡ä¸­ç¡®è®¤è®¢é˜…äº‹ä»¶çš„ç±»å‹</span>
                    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventType</span> <span class="o">=</span> <span class="n">parameterTypes</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">findState</span><span class="o">.</span><span class="na">checkAdd</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">eventType</span><span class="o">))</span> <span class="o">{</span>
                        <span class="c1">// ä»æ³¨è§£è·å–threadModeä¿¡æ¯</span>
                        <span class="nc">ThreadMode</span> <span class="n">threadMode</span> <span class="o">=</span> <span class="n">subscribeAnnotation</span><span class="o">.</span><span class="na">threadMode</span><span class="o">();</span>
                        <span class="c1">// å‘findStateå¢åŠ æ–°SubscriberMethod</span>
                        <span class="n">findState</span><span class="o">.</span><span class="na">subscriberMethods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">SubscriberMethod</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">eventType</span><span class="o">,</span> <span class="n">threadMode</span><span class="o">,</span>
                                <span class="n">subscribeAnnotation</span><span class="o">.</span><span class="na">priority</span><span class="o">(),</span> <span class="n">subscribeAnnotation</span><span class="o">.</span><span class="na">sticky</span><span class="o">()));</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">strictMethodVerification</span> <span class="o">&amp;&amp;</span> <span class="n">method</span><span class="o">.</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="nc">Subscribe</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// è®¢é˜…è€…æ–¹æ³•çš„å½¢å‚æ•°é‡ä¸ä¸º1ï¼Œä½†åˆä½¿ç”¨Subscribeæ³¨è§£ä¿®é¥°æ–¹æ³•ï¼Œéœ€æŠ›å‡ºå¼‚å¸¸</span>
                <span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">EventBusException</span><span class="o">(</span><span class="s">"@Subscribe method "</span> <span class="o">+</span> <span class="n">methodName</span> <span class="o">+</span>
                        <span class="s">"must have exactly 1 parameter but has "</span> <span class="o">+</span> <span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">strictMethodVerification</span> <span class="o">&amp;&amp;</span> <span class="n">method</span><span class="o">.</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="nc">Subscribe</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// æ–¹å¼åŒ…å«Subscribeæ³¨è§£ï¼Œä½†æ–¹æ³•ä¸èƒ½åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼šå…¬å¼€å¯è§æ€§ã€éé™æ€ã€éæŠ½è±¡</span>
            <span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">EventBusException</span><span class="o">(</span><span class="n">methodName</span> <span class="o">+</span>
                    <span class="s">" is a illegal @Subscribe method: must be public, non-static, and non-abstract"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="412-clearcaches">4.12 clearCaches</h4>

<p>æ¸…é™¤ç¼“å­˜</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="kt">void</span> <span class="nf">clearCaches</span><span class="o">()</span> <span class="o">{</span>
    <span class="no">METHOD_CACHE</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="äº”findstate">äº”ã€FindState</h2>

<h4 id="51-ç±»ä¿¡æ¯">5.1 ç±»ä¿¡æ¯</h4>

<p><strong>EventBus</strong> åˆ›å»ºå¤šä¸ªç¼“å­˜çš„ <strong>FindState</strong> å®ä¾‹ï¼Œå½“æœ‰è®¢é˜…è€…éœ€è¦æ‰«æè®¢é˜…æ–¹æ³•æ—¶ï¼Œä»ç¼“å­˜æ± ä¸­å–å‡ºä¸€ä¸ª <strong>FindState</strong> ï¼Œå‘æ­¤å®ä¾‹ä¸­æ”¾å…¥éœ€è¢«æ‰«æçš„è®¢é˜…è€…ç±»ã€‚ä¹‹åï¼ŒåŒ…å«è®¢é˜…è€…çš„  <strong>FindState</strong> ä¼ é€’ç»™è´Ÿè´£å¤„ç†å·¥ä½œçš„æ–¹æ³•ï¼Œå¤„ç†å®Œæ¯•åçš„è®¢é˜…è€…æ–¹æ³•ç»“æœä¹Ÿä¼šå­˜å›åˆ°  <strong>FindState</strong> ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">class</span> <span class="nc">FindState</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å› æ­¤å¤„ç†å®Œæ¯•åçš„ <strong>FindState</strong> æ—¢åŒ…å«è®¢é˜…è€…ç±»çš„ä¿¡æ¯ï¼Œä¹Ÿä¿å­˜ç€è®¢é˜…è€…æ–¹æ³•çš„åˆ—è¡¨ã€‚<strong>EventBus</strong> ä» <strong>FindState</strong> è·å–æ‰€æœ‰è®¢é˜…è€…æ–¹æ³•åï¼Œè¯¥ <strong>FindState</strong> ä¼šé‡ç½®å¹¶é‡æ–°æ”¾å…¥ç¼“å­˜æ± ä¸­ã€‚</p>

<p>æ ¹æ®  <strong>FindState</strong> å†…éƒ¨ç»“æ„å¯çŸ¥ï¼Œ<strong>FindState</strong> å®ä¾‹åŒ…å« <strong>ArrayList</strong>ã€<strong>HashMap</strong>ã€åˆå§‹é•¿åº¦ä¸º128çš„ <strong>StringBuilder</strong>ï¼Œæ‰€ä»¥ <strong>FindState</strong> å®ä¾‹æœ¬èº«å°±æœ‰ä¸€å®šåˆ†é‡ã€‚å¦‚æœå®ä¾‹ä¸æ–­åˆ›å»ºå¹¶é”€æ¯ï¼Œä¼šåŠ é‡è™šæ‹Ÿæœºåƒåœ¾å›æ”¶çš„è´Ÿæ‹…ã€‚ç›¸åï¼ŒæŠŠç”¨è¿‡çš„   <strong>FindState</strong> æ”¾å…¥ç¼“å­˜æ± é‡ç”¨åº”è¯¥æ˜¯æ›´åˆç†çš„è¡Œä¸ºã€‚</p>

<p>ä» <strong>SubscriberMethodFinder</strong> çš„ <strong>POOL_SIZE</strong> å¸¸é‡å¯çŸ¥ç¼“å­˜æ± å¤§å°ä¸º4ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">POOL_SIZE</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="52-ä¸å¯å˜æˆå‘˜">5.2 ä¸å¯å˜æˆå‘˜</h4>

<p>è¿™ä¸ªæ•°æ®æˆå‘˜ç”¨äºä¿å­˜è®¢é˜…è€…ç±»æ‰«ææ‰«ææ–¹æ³•çš„ç»“æœï¼Œä½¿ç”¨å®Œæ¯•åä¼šç®€å•æ¸…ç©ºä¸ºä¸‹æ¬¡é‡ç”¨ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SubscriberMethod</span><span class="o">&gt;</span> <span class="n">subscriberMethods</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">anyMethodByEventType</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&gt;</span> <span class="n">subscriberClassByMethodKey</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="kd">final</span> <span class="nc">StringBuilder</span> <span class="n">methodKeyBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="mi">128</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="53-å¯å˜æˆå‘˜">5.3 å¯å˜æˆå‘˜</h4>

<p>è¿™äº›æˆå‘˜ç”¨äºå­˜å‚¨è®¢é˜…è€…ç±»çš„ä¿¡æ¯ã€‚æ¯æ¬¡ <strong>EventBus</strong> ä»ç¼“å­˜æ± è·å– <strong>FindState</strong> ç¼“å­˜å®ä¾‹åï¼Œéƒ½ä¼šæŠŠè®¢é˜…è€…ç±»çš„åŸºæœ¬ä¿¡æ¯å­˜å…¥ä»¥ä¸‹å˜é‡ï¼Œä½œä¸ºåç»­æ“ä½œçš„å‚è€ƒå†…å®¹ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c1">// ä¿å­˜è®¢é˜…è€…çš„ç±»å‹</span>
<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">subscriberClass</span><span class="o">;</span>
<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">;</span>
<span class="kt">boolean</span> <span class="n">skipSuperClasses</span><span class="o">;</span>
<span class="c1">// è®¢é˜…è€…çš„ä¿¡æ¯ï¼ŒåŒ…å«è®¢é˜…è€…ç±»çš„æ–¹æ³•æ•°ç»„ã€ç»™æŒ‡å‘çˆ¶ç±»SubscriberInfoçš„å¼•ç”¨</span>
<span class="nc">SubscriberInfo</span> <span class="n">subscriberInfo</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="54-initforsubscriber">5.4 initForSubscriber</h4>

<p>è®¢é˜…è€…ç±»æ•°æ®é€šè¿‡æ­¤æ–¹æ³•è®¾ç½®åˆ° <strong>FindState</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">initForSubscriber</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">subscriberClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">subscriberClass</span> <span class="o">=</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">subscriberClass</span><span class="o">;</span>
    <span class="n">skipSuperClasses</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="n">subscriberInfo</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="55-recycle">5.5 recycle</h4>

<p><strong>FindState</strong> ä½¿ç”¨å®Œæ¯•åéœ€è°ƒç”¨ <strong>recycle()</strong> æ¸…ç©ºåå½’è¿˜ç»™ç¼“å­˜æ± ã€‚è¿™ä¸ªæ–¹æ³•çš„å¤„ç†æ–¹å¼æœ‰ç‚¹åƒ <strong>Message</strong> ç±»çš„ <a href="/2016/11/13/Android_Message/#ä¸‰æ¶ˆæ¯å›æ”¶">recycleUnchecked()</a> æ–¹æ³•ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">recycle</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">subscriberMethods</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="n">anyMethodByEventType</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="n">subscriberClassByMethodKey</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="n">methodKeyBuilder</span><span class="o">.</span><span class="na">setLength</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="n">subscriberClass</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">skipSuperClasses</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="n">subscriberInfo</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="56-checkadd">5.6 checkAdd</h4>

<p>ä¸¤é‡æ£€éªŒï¼šç¬¬ä¸€å±‚ï¼Œé€šè¿‡äº‹ä»¶ç±»å‹å¿«é€Ÿæ£€éªŒï¼›ç¬¬äºŒå±‚ï¼Œåœ¨éœ€è¦æ—¶é€šè¿‡å®Œæ•´çš„ç­¾åæ£€æŸ¥ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè®¢é˜…è€…ç±»ä¸ä¼šæœ‰æ–¹æ³•è®¢é˜…åŒä¸€ä¸ªäº‹ä»¶ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kt">boolean</span> <span class="nf">checkAdd</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventType</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// æ£€æŸ¥è®¢é˜…è€…ç±»å†…æ˜¯å¦æœ‰å¤šä¸ªæ–¹æ³•è®¢é˜…ç›¸åŒäº‹ä»¶</span>
    <span class="nc">Object</span> <span class="n">existing</span> <span class="o">=</span> <span class="n">anyMethodByEventType</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">eventType</span><span class="o">,</span> <span class="n">method</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">existing</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// æœ‰å¤šä¸ªæ–¹æ³•è®¢é˜…ç›¸åŒäº‹ä»¶</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">existing</span> <span class="k">instanceof</span> <span class="nc">Method</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">checkAddWithMethodSignature</span><span class="o">((</span><span class="nc">Method</span><span class="o">)</span> <span class="n">existing</span><span class="o">,</span> <span class="n">eventType</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="c1">// Put any non-Method object to "consume" the existing Method</span>
            <span class="n">anyMethodByEventType</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">eventType</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">checkAddWithMethodSignature</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">eventType</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="57-checkaddwithmethodsignature">5.7 checkAddWithMethodSignature</h4>

<p>é€šè¿‡æ–¹æ³•ç­¾åæ£€æŸ¥æ–¹æ³•æ˜¯å¦é‡å¤æ³¨å†Œï¼Œæ£€æŸ¥é€šè¿‡å°±èƒ½åŠ å…¥åˆ°åˆ—è¡¨ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">checkAddWithMethodSignature</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventType</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">methodKeyBuilder</span><span class="o">.</span><span class="na">setLength</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="n">methodKeyBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="n">methodKeyBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'&gt;'</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">eventType</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

    <span class="c1">// ä¾‹å¦‚ï¼šonEventReceived&gt;UserEvent</span>
    <span class="nc">String</span> <span class="n">methodKey</span> <span class="o">=</span> <span class="n">methodKeyBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">methodClass</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">();</span>
    <span class="c1">// é€šè¿‡æ’å…¥æ–°(methodKey, methodClass)ï¼Œå¹¶è·å–æ—§value</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">methodClassOld</span> <span class="o">=</span> <span class="n">subscriberClassByMethodKey</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">methodKey</span><span class="o">,</span> <span class="n">methodClass</span><span class="o">);</span>
    <span class="c1">// æ—§valueä¸ºç©ºï¼Œæˆ–methodClassOldæ˜¯methodClassçš„çˆ¶ç±»æˆ–åŒç±»</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">methodClassOld</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">methodClassOld</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">methodClass</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// æ–¹æ³•å¯ä»¥æ·»åŠ è®¢é˜…</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// æ’¤é”€æ­¤æ¬¡æ’å…¥ï¼Œä¿ç•™ç¼“å­˜ä¸­çš„æ—§å€¼</span>
        <span class="n">subscriberClassByMethodKey</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">methodKey</span><span class="o">,</span> <span class="n">methodClassOld</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="58-movetosuperclass">5.8 moveToSuperclass</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">moveToSuperclass</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">skipSuperClasses</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">clazz</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">();</span>
        <span class="c1">// è·å–ç±»å</span>
        <span class="nc">String</span> <span class="n">clazzName</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>

        <span class="c1">// è·³è¿‡ç³»ç»Ÿç±»ï¼Œè¿™åªä¼šé™ä½æ€§èƒ½ã€‚</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">clazzName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"java."</span><span class="o">)</span> <span class="o">||</span> <span class="n">clazzName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"javax."</span><span class="o">)</span> <span class="o">||</span> <span class="n">clazzName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"android."</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å…­äº‹ä»¶å‘é€ç»™è®¢é˜…è€…">å…­ã€äº‹ä»¶å‘é€ç»™è®¢é˜…è€…</h2>

<h4 id="61-invokesubscriber">6.1 invokeSubscriber</h4>

<p>æ ¹æ® <strong>event</strong> å’Œ è®¢é˜…è®°å½• <strong>Subscription</strong>ï¼Œå°±èƒ½æŠŠäº‹ä»¶å‘é€ç»™è®¢é˜…æ–¹æ³•ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">invokeSubscriber</span><span class="o">(</span><span class="nc">Subscription</span> <span class="n">subscription</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// ç”¨è®¢é˜…è€…çš„å®ä¾‹å’Œè®¢é˜…çš„äº‹ä»¶è°ƒèµ·è®¢é˜…æ–¹æ³•</span>
        <span class="n">subscription</span><span class="o">.</span><span class="na">subscriberMethod</span><span class="o">.</span><span class="na">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">subscription</span><span class="o">.</span><span class="na">subscriber</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// è®¢é˜…è€…æ–¹æ³•æ¥æ”¶äº‹ä»¶æ˜¯å‡ºç°å¼‚å¸¸</span>
        <span class="n">handleSubscriberException</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// å‡ºç°æœªçŸ¥å¼‚å¸¸</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Unexpected exception"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="62-handlesubscriberexception">6.2 handleSubscriberException</h4>

<p>æ£€æŸ¥æ ‡å¿—ä½å†³å®šæ˜¯å¦å¤„ç†äº‹ä»¶è®¢é˜…æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleSubscriberException</span><span class="o">(</span><span class="nc">Subscription</span> <span class="n">subscription</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">event</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">event</span> <span class="k">instanceof</span> <span class="nc">SubscriberExceptionEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">logSubscriberExceptions</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Don't send another SubscriberExceptionEvent to avoid infinite event recursion, just log</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="nc">Level</span><span class="o">.</span><span class="na">SEVERE</span><span class="o">,</span> <span class="s">"SubscriberExceptionEvent subscriber "</span> <span class="o">+</span> <span class="n">subscription</span><span class="o">.</span><span class="na">subscriber</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span>
                    <span class="o">+</span> <span class="s">" threw an exception"</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
            <span class="nc">SubscriberExceptionEvent</span> <span class="n">exEvent</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SubscriberExceptionEvent</span><span class="o">)</span> <span class="n">event</span><span class="o">;</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="nc">Level</span><span class="o">.</span><span class="na">SEVERE</span><span class="o">,</span> <span class="s">"Initial event "</span> <span class="o">+</span> <span class="n">exEvent</span><span class="o">.</span><span class="na">causingEvent</span> <span class="o">+</span> <span class="s">" caused exception in "</span>
                    <span class="o">+</span> <span class="n">exEvent</span><span class="o">.</span><span class="na">causingSubscriber</span><span class="o">,</span> <span class="n">exEvent</span><span class="o">.</span><span class="na">throwable</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">throwSubscriberException</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">EventBusException</span><span class="o">(</span><span class="s">"Invoking subscriber failed"</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">logSubscriberExceptions</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="nc">Level</span><span class="o">.</span><span class="na">SEVERE</span><span class="o">,</span> <span class="s">"Could not dispatch event: "</span> <span class="o">+</span> <span class="n">event</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">+</span> <span class="s">" to subscribing class "</span>
                    <span class="o">+</span> <span class="n">subscription</span><span class="o">.</span><span class="na">subscriber</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">cause</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sendSubscriberExceptionEvent</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">SubscriberExceptionEvent</span> <span class="n">exEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SubscriberExceptionEvent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">cause</span><span class="o">,</span> <span class="n">event</span><span class="o">,</span>
                    <span class="n">subscription</span><span class="o">.</span><span class="na">subscriber</span><span class="o">);</span>
            <span class="n">post</span><span class="o">(</span><span class="n">exEvent</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
:ET