I"‡d<h2 id="å‰è¨€">å‰è¨€</h2>

<p>è¿™ç¯‡æ–‡ç« å°†æ·±å…¥ä»‹ç»<code class="highlighter-rouge">CAS</code>åœ¨<code class="highlighter-rouge">JDK</code>å…·ä½“çš„å®ç°æ–¹å¼ï¼Œå¡«è¡¥<a href="/2018/01/17/AtomicInteger/">Javaæºç ç³»åˆ—(7) â€“ AtomicInteger</a>ä¸­ç›¸å…³å†…å®¹çš„ç©ºç¼ºï¼Œä¸»è¦ä»é«˜å±‚è°ƒç”¨å¼€å§‹ï¼Œç»å†JDKã€JNIå’Œasmæ±‡ç¼–ï¼Œæœ€ç»ˆè°ƒç”¨å¤„ç†å™¨CASæŒ‡ä»¤é›†ï¼Œå¸¦ä½ æµè§ˆæ•´ä¸ªå®ç°è¿‡ç¨‹ã€‚</p>

<p>é˜…è¯»éœ€æ‰å®JavaåŸºæœ¬åŠŸï¼Œäº†è§£æˆ–èƒ½çœ‹æ‡‚JNIå’ŒCè¯­è¨€ã€‚æ±‡ç¼–æ²¡çœ‹è¿‡ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œæ–‡ç« å‚è€ƒé“¾æ¥é™„å¸¦æœ¬æ–‡æ¶‰åŠæ‰€æœ‰æ±‡ç¼–çŸ¥è¯†ç‚¹ä»¥ä¾›æŸ¥é˜…ã€‚</p>

<h2 id="ä¸€ä»€ä¹ˆæ˜¯cas">ä¸€ã€ä»€ä¹ˆæ˜¯CAS</h2>

<p>å¤šçº¿ç¨‹ä¸å¯é¿å…å¸¦æ¥äº†æ›´å¤šçš„å…ƒç´ åŒæ­¥å¤„ç†ã€‚è¦åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­æ„æˆåŒæ­¥åŸè¯­ï¼ˆå¦‚ä¿¡å·é‡å’Œäº’æ–¥ï¼‰ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šæåˆ°è¢«ç§°ä¸ºæ¯”è¾ƒå’Œäº¤æ¢ (CAS) çš„åŸå­æ“ä½œã€‚</p>

<p>CASçš„ä¼ªä»£ç ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>compare_and_swap (*p, oldval, newval):
      if (*p == oldval)
          *p = newval;
          success;
      else
          fail;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é¦–å…ˆæ¯”è¾ƒå†…å­˜ä½ç½® p (*p) çš„å†…å®¹ä¸å·²çŸ¥å€¼ oldvalï¼ˆè¿™åº”è¯¥æ˜¯å½“å‰çº¿ç¨‹ä¸­ *p çš„å€¼ï¼‰ã€‚åªæœ‰å½“å®ƒä»¬æ˜¯ç›¸åŒå€¼æ—¶ï¼Œæ‰ä¼šå°† newval å†™å…¥ *pã€‚è‹¥å…¶ä»–çº¿ç¨‹ä¹‹å‰å·²ç»ä¿®æ”¹è¯¥å†…å­˜ä½ç½®ï¼Œé‚£ä¹ˆæ¯”è¾ƒæ“ä½œä¼šå¤±è´¥ã€‚</p>

<blockquote>
  <p>å‚è€ƒè‡ª<a href="https://www.ibm.com/developerworks/cn/aix/library/au-inline_assembly/index.html">å†…è”æ±‡ç¼– - ä»å¤´å¼€å§‹</a>ï¼Œæœ‰åˆ æ”¹</p>
</blockquote>

<h2 id="äºŒunsafe">äºŒã€Unsafe</h2>

<p>JDK8è¯¥æ–¹æ³•ååœ¨Unsafeç±»ä¸º<code class="highlighter-rouge">compareAndSwapInt</code>ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">native</span> <span class="kt">boolean</span> <span class="nf">compareAndSwapInt</span><span class="o">(</span><span class="nc">Object</span> <span class="n">var1</span><span class="o">,</span> <span class="kt">long</span> <span class="n">var2</span><span class="o">,</span> <span class="kt">int</span> <span class="n">var4</span><span class="o">,</span> <span class="kt">int</span> <span class="n">var5</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>JDK9å‘½ååœ¨Unsafeç±»ä¸º<code class="highlighter-rouge">compareAndSetInt</code>ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">native</span> <span class="kt">boolean</span> <span class="nf">compareAndSetInt</span><span class="o">(</span><span class="nc">Object</span> <span class="n">var1</span><span class="o">,</span> <span class="kt">long</span> <span class="n">var2</span><span class="o">,</span> <span class="kt">int</span> <span class="n">var4</span><span class="o">,</span> <span class="kt">int</span> <span class="n">var5</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ¬æ–‡ç”¨JDK9ä»‹ç»ï¼Œé¦–å…ˆçœ‹è¯¥æ–¹æ³•çš„åŸç”Ÿå®ç°ï¼Œå¯¹åº”unsafe.cppæ–‡ä»¶çš„1198è¡Œï¼Œæ–‡ä»¶è·¯å¾„<code class="highlighter-rouge">jdk9/hotspot/src/share/vm/prims/</code>ã€‚</p>

<p>ä¸‹é¢ <strong>unsafe.cpp</strong> å°¾æ®µæœ‰ä¸ªä¿å­˜æ–¹æ³•å¯¹åº”å…³ç³»çš„é™æ€æ•°ç»„ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="n">JNINativeMethod</span> <span class="n">jdk_internal_misc_Unsafe_methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">......</span>
    
    <span class="p">{</span><span class="n">CC</span> <span class="s">"compareAndSetInt"</span><span class="p">,</span>   <span class="n">CC</span> <span class="s">"("</span> <span class="n">OBJ</span> <span class="s">"J""I""I"")Z"</span><span class="p">,</span>  <span class="n">FN_PTR</span><span class="p">(</span><span class="n">Unsafe_CompareAndSetInt</span><span class="p">)},</span>
    <span class="p">{</span><span class="n">CC</span> <span class="s">"compareAndSetLong"</span><span class="p">,</span>  <span class="n">CC</span> <span class="s">"("</span> <span class="n">OBJ</span> <span class="s">"J""J""J"")Z"</span><span class="p">,</span>  <span class="n">FN_PTR</span><span class="p">(</span><span class="n">Unsafe_CompareAndSetLong</span><span class="p">)},</span>
    <span class="p">{</span><span class="n">CC</span> <span class="s">"compareAndExchangeObject"</span><span class="p">,</span> <span class="n">CC</span> <span class="s">"("</span> <span class="n">OBJ</span> <span class="s">"J"</span> <span class="n">OBJ</span> <span class="s">""</span> <span class="n">OBJ</span> <span class="s">")"</span> <span class="n">OBJ</span><span class="p">,</span> <span class="n">FN_PTR</span><span class="p">(</span><span class="n">Unsafe_CompareAndExchangeObject</span><span class="p">)},</span>
    <span class="p">{</span><span class="n">CC</span> <span class="s">"compareAndExchangeInt"</span><span class="p">,</span>  <span class="n">CC</span> <span class="s">"("</span> <span class="n">OBJ</span> <span class="s">"J""I""I"")I"</span><span class="p">,</span> <span class="n">FN_PTR</span><span class="p">(</span><span class="n">Unsafe_CompareAndExchangeInt</span><span class="p">)},</span>
    <span class="p">{</span><span class="n">CC</span> <span class="s">"compareAndExchangeLong"</span><span class="p">,</span> <span class="n">CC</span> <span class="s">"("</span> <span class="n">OBJ</span> <span class="s">"J""J""J"")J"</span><span class="p">,</span> <span class="n">FN_PTR</span><span class="p">(</span><span class="n">Unsafe_CompareAndExchangeLong</span><span class="p">)},</span>
    <span class="p">......</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»æŸ¥æ‰¾å¯¹åº”å…³ç³»çŸ¥é“<code class="highlighter-rouge">compareAndSetInt</code>æ˜¯<code class="highlighter-rouge">Unsafe_CompareAndSetInt</code>ï¼Œä½äºç›¸åŒæ–‡ä»¶1031è¡Œã€‚</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">UNSAFE_ENTRY</span><span class="p">(</span><span class="n">jboolean</span><span class="p">,</span> <span class="n">Unsafe_CompareAndSetInt</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">unsafe</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">offset</span><span class="p">,</span> <span class="n">jint</span> <span class="n">e</span><span class="p">,</span> <span class="n">jint</span> <span class="n">x</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">oop</span> <span class="n">p</span> <span class="o">=</span> <span class="n">JNIHandles</span><span class="o">::</span><span class="n">resolve</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
  <span class="n">jint</span><span class="o">*</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">jint</span> <span class="o">*</span><span class="p">)</span><span class="n">index_oop_from_field_offset_long</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">jint</span><span class="p">)(</span><span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span> <span class="o">==</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span> <span class="n">UNSAFE_END</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯¹æ¯”Javaçš„æ–¹æ³•ç­¾åï¼š</p>

<blockquote>
  <p>boolean compareAndSetInt(Object var1, long var2, int var4, int var5);</p>
</blockquote>

<p>Cå‡½æ•°å‚æ•°ä¸ºï¼š</p>

<blockquote>
  <p>Unsafe_CompareAndSetInt(JNIEnv *env, jobject unsafe, jobject obj, jlong offset, jint e, jint x)</p>
</blockquote>

<p>å¿½ç•¥ <strong>JNIEnv *env, jobject unsafe</strong>ï¼Œå‰©ä¸‹å‚æ•° <strong>Object, long, int, int</strong> é¡ºåºå¯ä¸€ä¸€å¯¹åº”ã€‚</p>

<p>é€»è¾‘æ‰§è¡Œæµç¨‹ï¼š</p>

<ul>
  <li><code class="highlighter-rouge">obj</code>æ˜¯<code class="highlighter-rouge">AtomicInteger</code>å¯¹è±¡ï¼Œé€šè¿‡ JNIHandles::resolve() è·å–<code class="highlighter-rouge">obj</code>åœ¨å†…å­˜ä¸­OOPå®ä¾‹<code class="highlighter-rouge">p</code>;</li>
  <li>æ ¹æ®<code class="highlighter-rouge">value</code>çš„å†…å­˜åç§»å€¼<code class="highlighter-rouge">offset</code>å»å†…å­˜ä¸­å–æŒ‡é’ˆ<code class="highlighter-rouge">addr</code>;</li>
  <li>è·å¾—æ›´æ–°å€¼<code class="highlighter-rouge">x</code>ã€æŒ‡é’ˆ<code class="highlighter-rouge">addr</code>ã€æœŸå¾…å€¼<code class="highlighter-rouge">e</code>å‚æ•°åè°ƒç”¨<code class="highlighter-rouge">Atomic::cmpxchg(x, addr, e)</code>;</li>
  <li>é€šè¿‡<code class="highlighter-rouge">Atomic::cmpxchg(x, addr, e)</code>å®ç°CAS;</li>
</ul>

<h2 id="ä¸‰casæœ¬ä½“">ä¸‰ã€CASæœ¬ä½“</h2>

<h3 id="31-atomiccmpxchg">3.1 Atomic::cmpxchg</h3>

<p><code class="highlighter-rouge">jdk9/hotspot/src/os_cpu/linux_x86/vm/atomic_linux_x86</code>ç¬¬100è¡Œè°ƒç”¨asmæ±‡ç¼–ã€‚</p>

<p><strong>æ³¨æ„ï¼šå½¢å‚orderæ˜¯JDK9ä¸­æ–°åŠ çš„ï¼ŒJDK8uæ²¡æœ‰è¯¥å½¢å‚</strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kr">inline</span> <span class="n">jint</span> <span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg</span><span class="p">(</span><span class="n">jint</span> <span class="n">exchange_value</span><span class="p">,</span>
                            <span class="k">volatile</span> <span class="n">jint</span><span class="o">*</span> <span class="n">dest</span><span class="p">,</span>
                            <span class="n">jint</span> <span class="n">compare_value</span><span class="p">,</span>
                            <span class="n">cmpxchg_memory_order</span> <span class="n">order</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">mp</span> <span class="o">=</span> <span class="n">os</span><span class="o">::</span><span class="n">is_MP</span><span class="p">();</span>
  <span class="n">__asm__</span> <span class="k">volatile</span> <span class="p">(</span><span class="n">LOCK_IF_MP</span><span class="p">(</span><span class="o">%</span><span class="mi">4</span><span class="p">)</span> <span class="s">"cmpxchgl %1,(%3)"</span>
                    <span class="o">:</span> <span class="s">"=a"</span> <span class="p">(</span><span class="n">exchange_value</span><span class="p">)</span>
                    <span class="o">:</span> <span class="s">"r"</span> <span class="p">(</span><span class="n">exchange_value</span><span class="p">),</span> <span class="s">"a"</span> <span class="p">(</span><span class="n">compare_value</span><span class="p">),</span> <span class="s">"r"</span> <span class="p">(</span><span class="n">dest</span><span class="p">),</span> <span class="s">"r"</span> <span class="p">(</span><span class="n">mp</span><span class="p">)</span>
                    <span class="o">:</span> <span class="s">"cc"</span><span class="p">,</span> <span class="s">"memory"</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">exchange_value</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æŒ‰é¡ºåºå°±æ˜¯<code class="highlighter-rouge">%1</code>åˆ°<code class="highlighter-rouge">%4</code>ï¼Œexchange_valueæ˜¯<code class="highlighter-rouge">%1</code>ï¼Œdestæ˜¯<code class="highlighter-rouge">%3</code>ã€‚<code class="highlighter-rouge">r</code>ä»£è¡¨ä»»æ„ä¸€ä¸ªå¯„å­˜å™¨ï¼Œ<code class="highlighter-rouge">a</code>ä»£è¡¨eaxå¯„å­˜å™¨ã€‚</p>

<blockquote>
  <p>: â€œrâ€ (exchange_value), â€œaâ€ (compare_value), â€œrâ€ (dest), â€œrâ€ (mp)</p>
</blockquote>

<p>ç»è¿‡åˆæ­¥äº†è§£ï¼Œcmpxchglå°±å®¹æ˜“ç†è§£å¤šäº†:</p>

<blockquote>
  <p>cmpxchgl %1,(%3)</p>
</blockquote>

<p>å¥‡æ€ªçš„æ˜¯<code class="highlighter-rouge">%2</code>æ²¡æœ‰ç”¨ä¸Šï¼Œéœ€è¦æŸ¥è¯cmpxchglçš„ç”¨æ³•ï¼Œå®ƒç”¨åˆ°äº†ä¸€ä¸ªéšå«çš„æ“ä½œæ•°ï¼Œå³eaxã€‚åœ¨å‰é¢çš„è¾“å…¥æ“ä½œæ•°ä¸­ï¼Œå¯¹åº”çš„%2æ²¡æœ‰åœ¨æ±‡ç¼–æ¨¡æ¿é‡Œå‡ºç°ï¼Œä½†é€šè¿‡ä¿®é¥°ç¬¦aæŠŠå®ƒå­˜æ”¾åˆ°äº†eaxå¯„å­˜å™¨ï¼Œå› æ­¤è¿™é‡Œè¢«cmpxchgæŒ‡ä»¤éšå«ä½¿ç”¨ã€‚</p>

<p>æŒ‡ä»¤cmpxchgæ¯”è¾ƒeax(ä¹Ÿå°±æ˜¯compare_value)ä¸destçš„å€¼ã€‚å¦‚æœç›¸ç­‰ï¼Œé‚£ä¹ˆå°†exchange_valueçš„å€¼èµ‹å€¼ç»™destï¼›å¦åˆ™ï¼Œå°†destçš„å€¼èµ‹å€¼ç»™eaxã€‚</p>

<blockquote>
  <p>: â€œ=aâ€ (exchange_value)</p>
</blockquote>

<h3 id="32-osis_mp">3.2 os::is_MP</h3>

<p>æ–¹æ³•<code class="highlighter-rouge">is_MP()</code>å®ç°åœ¨<code class="highlighter-rouge">jdk9/hotspot/src/share/vm/runtime/os.hpp</code>206è¡Œï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">mp</span> <span class="o">=</span> <span class="n">os</span><span class="o">::</span><span class="n">is_MP</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç”¨äºè·å–å½“å‰ç³»ç»Ÿå¤„ç†å™¨æ ¸å¿ƒæ•°ï¼Œå¦‚æœ<code class="highlighter-rouge">_processor_count</code>åœ¨å¼•å¯¼è¿‡ç¨‹å°šæœªåˆå§‹åŒ–ï¼Œå°±é»˜è®¤å‡è®¾å…¶æ˜¯å¤šå¤„ç†å™¨ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="n">_processor_count</span><span class="p">;</span>                <span class="c1">// number of processors</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">_initial_active_processor_count</span><span class="p">;</span> <span class="c1">// number of active processors during initialization.</span>

<span class="c1">// Interface for detecting multiprocessor system</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">is_MP</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// During bootstrap if _processor_count is not yet initialized</span>
  <span class="c1">// we claim to be MP as that is safest. If any platform has a</span>
  <span class="c1">// stub generator that might be triggered in this phase and for</span>
  <span class="c1">// which being declared MP when in fact not, is a problem - then</span>
  <span class="c1">// the bootstrap routine for the stub generator needs to check</span>
  <span class="c1">// the processor count directly and leave the bootstrap routine</span>
  <span class="c1">// in place until called after initialization has ocurred.</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">_processor_count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">AssumeMP</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="33-lock_if_mpmp">3.3 LOCK_IF_MP(mp)</h3>

<p>è·å–æˆåŠŸåæŠŠæ ¸å¿ƒæ•°ä¿å­˜åœ¨æ•´å½¢å€¼<code class="highlighter-rouge">mp</code>ä¸­ï¼Œå®é™…èµ·åˆ°å¸ƒå°”å€¼çš„ä½œç”¨ã€‚ä¸º0æ„å‘³ç³»ç»Ÿæ˜¯å•å¤„ç†å™¨ç³»ç»Ÿï¼Œå¤§äº0æ˜¯å¤šå¤„ç†å™¨ç³»ç»Ÿï¼Œå¹¶ä½œä¸ºå®å‚è°ƒèµ·å®å®šä¹‰<code class="highlighter-rouge">LOCK_IF_MP(mp)</code>ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1">// Adding a lock prefix to an instruction on MP machine</span>
<span class="cp">#define LOCK_IF_MP(mp) "cmp $0, " #mp "; je 1f; lock; 1: "
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>å®å®šä¹‰ç”¨<code class="highlighter-rouge">"cmp $0, " #mp "</code>æ£€æŸ¥æ ¸å¿ƒæ˜¯å¦ä¸ºå•æ ¸ï¼š</p>

<ul>
  <li>æ˜¯ï¼šè·³åˆ°<code class="highlighter-rouge">1f</code>ï¼Œæ‰§è¡ŒCPUæŒ‡ä»¤<code class="highlighter-rouge">cmpxchgl %1,(%3)</code>ã€‚<code class="highlighter-rouge">1f</code>çš„æ„æ€æ˜¯<code class="highlighter-rouge">1after</code>ï¼Œå‚çœ‹<a href="https://stackoverflow.com/questions/27353096/1b-and-1f-in-gnu-assembly">å‚è€ƒé“¾æ¥-6</a>;</li>
  <li>ä¸æ˜¯ï¼šåˆ™è·³åˆ°<code class="highlighter-rouge">1f</code>å‰å…ˆé€šè¿‡<code class="highlighter-rouge">lock</code>ç»™æ€»çº¿ä¸Šé”ï¼Œä»¤ç‰©ç†å¤„ç†å™¨çš„å…¶ä»–æ ¸å¿ƒä¸èƒ½é€šè¿‡æ€»çº¿è®¿å­˜ï¼Œä¿è¯æŒ‡ä»¤æ“ä½œçš„åŸå­æ€§ã€‚</li>
</ul>

<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å¯¹ä¸€ä¸ªå˜é‡ä½¿ç”¨<code class="highlighter-rouge">volatile</code>ä¿®é¥°ç¬¦ï¼Œæ±‡ç¼–ä¸­ä¹Ÿä¼šå¢åŠ <code class="highlighter-rouge">lock</code>æŒ‡ä»¤å‰ç¼€ä»¥ä¿è¯è¯¥å˜é‡çº¿ç¨‹å¯è§æ€§å’ŒæŒ‡ä»¤æ‰§è¡Œæœ‰åºæ€§ã€‚</p>

<h3 id="34-__asm__-volatile---memory">3.4 __asm__ volatile (â€œâ€: : :â€memoryâ€)</h3>

<p>è¿˜æœ‰ä¸€ä¸ªç»“æ„ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">__asm__</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">""</span><span class="o">:</span> <span class="o">:</span> <span class="o">:</span><span class="s">"memory"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ­¤ç»“æ„å‘Šè¯‰ç¼–è¯‘å™¨æ·»åŠ ä¸€ä¸ªå†…å­˜å±éšœç¦æ­¢ç›¸å…³åŒºåŸŸå†…çš„æ“ä½œæŒ‡ä»¤é‡æ’åºï¼Œä½†å¦‚ä½•æ‰§è¡Œè¿˜ä¼šå—åˆ°å…·ä½“å¤„ç†å™¨çš„å½±å“ã€‚è¯¦è§<a href="https://stackoverflow.com/questions/14950614/working-of-asm-volatile-memory">å‚è€ƒé“¾æ¥-3</a>ï¼š</p>

<blockquote>
  <p>Creates a compiler level memory barrier forcing optimizer to not re-order memory accesses across the barrier.</p>
</blockquote>

<h3 id="35-ä¼ªä»£ç ">3.5 ä¼ªä»£ç </h3>

<p>è¯´äº†è¿™ä¹ˆå¤šè¿˜æ˜¯ä¸æ˜“ç†è§£ï¼Œæ¯•ç«Ÿä¸Šè¿°ä»£ç æ˜¯Cè¯­è¨€æ··ç¼–<code class="highlighter-rouge">asm</code>ï¼Œç¿»è¯‘ä¸º<code class="highlighter-rouge">Java-like</code>ä¼ªä»£ç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="c1">// @param _processor_count processor count</span>
<span class="c1">// @param assumeMP         assume is multiprocessor when is not yet initialized</span>
<span class="c1">// @param compare_value    be comparing</span>
<span class="c1">// @param dest             set as new value if true</span>
<span class="nd">@AsmVolatileMemory</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">isMultiProcessCAS</span><span class="o">(</span><span class="kt">int</span> <span class="n">_processor_count</span><span class="o">,</span>
                               <span class="kt">boolean</span> <span class="n">assumeMP</span><span class="o">,</span>
                               <span class="kt">int</span> <span class="n">compare_value</span><span class="o">,</span>
                               <span class="kt">int</span> <span class="n">dest</span><span class="o">)</span> <span class="o">{</span>              
    <span class="k">if</span> <span class="o">(</span><span class="n">_processor_count</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">assumeMP</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">cmpxchgl</span><span class="o">(</span><span class="n">compare_value</span><span class="o">,</span> <span class="n">dest</span><span class="o">);</span>
    <span class="c1">// Should unlock after cmpxchgl(int, int)???</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ‰äººæè®®<a href="https://bugs.java.com/view_bug.do?bug_id=8185062">å‚è€ƒé“¾æ¥-12</a>æŠŠ<code class="highlighter-rouge">os::is_MP()</code>çš„<code class="highlighter-rouge">AssumeMP</code>æ”¹ä¸º<code class="highlighter-rouge">true</code>æå‡æ€§èƒ½ã€‚ä¸”åœ¨2017-10-03çš„JDK10b13å®ç°äº†è¯¥æè®®ï¼Œæ‰€ä»¥ä¸Šè¿°ä¼ªä»£ç å¯ä»¥è¿›ä¸€æ­¥æ¼”è¿›ä¸ºï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1">// @param _processor_count processor count</span>
<span class="c1">// @param compare_value    be comparing</span>
<span class="c1">// @param dest             set as new value if true</span>
<span class="nd">@AsmVolatileMemory</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">isMultiProcessCAS</span><span class="o">(</span><span class="kt">int</span> <span class="n">_processor_count</span><span class="o">,</span>
                               <span class="kt">int</span> <span class="n">compare_value</span><span class="o">,</span>
                               <span class="kt">int</span> <span class="n">dest</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">_processor_count</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">cmpxchgl</span><span class="o">(</span><span class="n">compare_value</span><span class="o">,</span> <span class="n">dest</span><span class="o">);</span>
    <span class="c1">// Should unlock after cmpxchgl(int, int)???</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆ°è¿™é‡ŒJava CASåº•å±‚å®ç°å…¨éƒ¨è®²è§£å®Œæ¯•ã€‚å¦‚æœè¿˜æœ‰ç–‘é—®ï¼Œå‚è€ƒé“¾æ¥åº”è¯¥èƒ½ç»™ä½ æ‰€æœ‰éœ€è¦çš„è§£ç­”ã€‚</p>

<h2 id="å››å‚è€ƒé“¾æ¥">å››ã€å‚è€ƒé“¾æ¥</h2>

<ul>
  <li>
    <p><a href="https://juejin.im/post/5a73cbbff265da4e807783f5">Java CAS åŸç†å‰–æ - å¡å·´æ‹‰çš„æ ‘ - æ˜é‡‘</a></p>
  </li>
  <li>
    <p><a href="https://stackoverflow.com/questions/1582960/assembly-language-je-jump-function">Assembly language je jump function - Stackoverflow</a></p>
  </li>
  <li>
    <p><a href="https://stackoverflow.com/questions/14950614/working-of-asm-volatile-memory">Working of <strong>asm</strong> <strong>volatile</strong> (â€œâ€ : : : â€œmemoryâ€) - Stackoverflow</a></p>
  </li>
  <li>
    <p><a href="https://stackoverflow.com/questions/8012450/jni-converting-unsigned-int-to-jint">JNI: converting unsigned int to jint - Stackoverflow</a></p>
  </li>
  <li>
    <p><a href="http://faydoc.tripod.com/cpu/cmpxchg.htm">CMPXCHG - Compare and Exchange</a></p>
  </li>
  <li>
    <p><a href="https://stackoverflow.com/questions/27353096/1b-and-1f-in-gnu-assembly">1b and 1f in GNU assembly - Stackoverflow</a></p>
  </li>
  <li>
    <p><a href="https://stackoverflow.com/questions/12665289/cmp-je-jg-how-they-work-in-assembly">cmp je/jg how they work in assembly - Stackoverflow</a></p>
  </li>
  <li>
    <p><a href="http://www.unixwiz.net/techtips/x86-jumps.html">Intel x86 JUMP quick reference</a></p>
  </li>
  <li>
    <p><a href="https://github.com/1184893257/simplelinux/blob/master/inlineasm.md">æœ´ç´ linux: å†…è”æ±‡ç¼–  - Github</a></p>
  </li>
  <li>
    <p><a href="https://www.ibm.com/developerworks/cn/aix/library/au-inline_assembly/index.html">å†…è”æ±‡ç¼– - ä»å¤´å¼€å§‹ - IBM</a></p>
  </li>
  <li>
    <p><a href="https://www.zhihu.com/question/24844900">ä»€ä¹ˆæ˜¯æ¡©ä»£ç ï¼ˆStubï¼‰- çŸ¥ä¹</a></p>
  </li>
  <li>
    <p><a href="https://bugs.java.com/view_bug.do?bug_id=8185062">JDK-8185062 : Set AssumeMP to true and deprecate the flag</a></p>
  </li>
  <li>
    <p><a href="https://stackoverflow.com/questions/27837731/is-x86-cmpxchg-atomic">Is x86 CMPXCHG atomic? - Stackoverflow</a></p>
  </li>
</ul>

:ET