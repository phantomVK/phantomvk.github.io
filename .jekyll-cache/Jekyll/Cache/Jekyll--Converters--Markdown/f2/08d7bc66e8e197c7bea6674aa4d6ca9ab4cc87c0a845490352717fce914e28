I"	ä<h2 id="ä¸€ç±»ç­¾å">ä¸€ã€ç±»ç­¾å</h2>

<h4 id="11-ç‰¹æ€§">1.1 ç‰¹æ€§</h4>

<p>è¿™æ˜¯åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„ <strong>LRU(Least Recently Used)</strong> ç¼“å­˜ç±»ï¼Œå¹¶æ”¯æŒæ§åˆ¶ç©ºé—´ä½¿ç”¨é‡ã€‚</p>

<p>æ¯ä¸ªç¼“å­˜æ¡ç›®éƒ½æœ‰ä¸€ä¸ªå­—ç¬¦ä¸²é”®å’Œå›ºå®šæ•°é‡çš„å€¼ã€‚æ¯ä¸ªé”®å¿…é¡»æ»¡è¶³æ­£åˆ™è¡¨è¾¾å¼ï¼š<strong>[a-z0-9_-]{1,120}</strong>ã€‚å€¼éƒ½æ˜¯å­—èŠ‚åºåˆ—ï¼Œå¯é€šè¿‡æµæˆ–æ–‡ä»¶çš„æ–¹å¼è®¿é—®ï¼Œé•¿åº¦åœ¨0åˆ° <strong>Integer.MAX_VALUE</strong> ä¹‹é—´ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">DiskLruCache</span> <span class="kd">implements</span> <span class="nc">Closeable</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ•°æ®ä¿å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿçš„åŒä¸€ä¸ªç›®å½•ä¸­ã€‚æ­¤æ–‡ä»¶å¿…é¡»æ’é™¤åœ¨ç¼“å­˜ä¹‹å¤–ï¼Œç¼“å­˜åªèƒ½åˆ é™¤æˆ–å¤å†™ç›®å½•é‡Œçš„æ–‡ä»¶ã€‚ä¸æ”¯æŒå¤šè¿›ç¨‹åŒæ—¶æ“ä½œåŒä¸€ä¸ªç¼“å­˜ç›®å½•ã€‚</p>

<p>æ­¤ç¼“å­˜å¯é™åˆ¶ä¿å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿå­—èŠ‚çš„é•¿åº¦ã€‚å½“å·²ä¿å­˜å­—èŠ‚é•¿åº¦è¶…è¿‡é™åˆ¶ï¼Œä¼šåœ¨åå°çº¿ç¨‹é€ä¸ªç§»é™¤æ¡ç›®ï¼Œç›´åˆ°æ»¡è¶³é•¿åº¦é™åˆ¶ä¸ºæ­¢ã€‚ä½†é™åˆ¶ä¹Ÿä¸æ˜¯ä¸¥æ ¼æ‰§è¡Œï¼šéœ€åˆ é™¤æ–‡ä»¶çš„æ—¶å€™ï¼Œç¼“å­˜å¤§å°ä¼šæš‚æ—¶è¶…è¿‡é™åˆ¶ã€‚å®¹é‡é™åˆ¶ä¸åŒ…å«æ–‡ä»¶ç³»ç»Ÿçš„å¼€é”€å’Œç¼“å­˜æ—¥å¿—æ–‡ä»¶çš„å¤§å°ï¼Œæ‰€ä»¥å¯¹ç©ºé—´å¤§å°æ•æ„Ÿçš„åº”ç”¨æœ€å¥½è®¾ç½®ä¸€ä¸ªç›¸å¯¹ä¿å®ˆçš„é˜ˆå€¼ã€‚</p>

<p>å®¢æˆ·ç«¯è°ƒç”¨ <strong>edit()</strong> æ–¹æ³•æ‰èƒ½åˆ›å»ºæˆ–æ›´æ–°æ¡ç›®çš„å€¼ï¼Œæ¯æ¬¡åªè¢«ä¸€ä¸ªç¼–è¾‘å™¨æŒæœ‰ã€‚å¦‚æœä¸èƒ½ç¼–è¾‘åˆ™ <strong>edit()</strong> æ–¹æ³•è¿”å› <strong>null</strong>ã€‚</p>

<p>æ¡ç›®åˆ›å»ºæ—¶éœ€æä¾›æ‰€æœ‰å€¼ï¼Œæˆ–åœ¨å¿…è¦æ—¶ç”¨ <strong>null</strong> ä½œä¸ºå ä½ç¬¦ã€‚æ¡ç›®ç¼–è¾‘æ—¶ä¸éœ€è¦ä¸ºæ¯ä¸ªå€¼æä¾›æ•°æ®ï¼Œå€¼çš„å†…å®¹ä¸ºä¹‹å‰çš„å†…å®¹ã€‚</p>

<p>æ¯æ¬¡è°ƒç”¨ <strong>edit</strong> æ–¹æ³•åå¿…é¡»é…å¯¹ä½¿ç”¨ <strong>Editor.commit()</strong> æˆ– <strong>Editor.abort()</strong>ã€‚æäº¤æ“ä½œæ˜¯åŸå­æ€§çš„ï¼šæ¯æ¬¡è¯»å–è·å¾— <strong>æäº¤ä¹‹å‰</strong> æˆ– <strong>æäº¤ä¹‹å</strong> å®Œæ•´çš„å€¼é›†åˆï¼Œè€Œä¸æ˜¯ä¸¤ä¸ªçŠ¶æ€çš„æ··åˆå€¼ã€‚</p>

<p>å®¢æˆ·ç«¯è°ƒç”¨ <strong>get()</strong> è¯»å–æ¡ç›®çš„å¿«ç…§ã€‚è¯»æ“ä½œä¼šåœ¨ <strong>get</strong> æ–¹æ³•è°ƒç”¨çš„æ—¶å€™è§‚å¯Ÿå€¼ã€‚æ›´æ–°æˆ–ç§»é™¤æ“ä½œä¸ä¼šå½±å“æ­£åœ¨è¿›è¡Œçš„è¯»å–æ“ä½œã€‚</p>

<p>æœ¬ç±»å¯å®¹å¿å°‘é‡ I/O é”™è¯¯ã€‚å¦‚æœæ–‡ä»¶ç³»ç»Ÿä¸¢å¤±æ–‡ä»¶ï¼Œå¯¹åº”çš„æ¡ç›®ä¼šä»ç¼“å­˜ä¸­åˆ é™¤ã€‚å‡å¦‚è¿™ä¸ªé”™è¯¯å‘ç”Ÿåœ¨ç¼“å­˜å†™å…¥å€¼çš„æ—¶å€™ï¼Œç¼–è¾‘æ‰§è¡Œæ“ä½œä¼šé™é»˜å¤±è´¥ã€‚æ³¨æ„ï¼Œè°ƒç”¨è€…éœ€è¦è‡ªè¡Œå¤„ç†å›  <strong>IOException</strong> å¼•èµ·çš„é—®é¢˜ã€‚</p>

<p>ä»¥ä¸‹æºç æ¥è‡ª <strong>Glide 4.4.0</strong> ï¼Œä¸åŒæ¥æºå¯èƒ½ä¼šæœ‰ç»†å¾®å·®åˆ«ï¼Œä½†æ˜¯æ€»ä½“é€»è¾‘å’Œè®¾è®¡æ€è·¯æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿéƒ½æ˜¯å‚è€ƒ <a href="https://github.com/JakeWharton/DiskLruCache">Jake Wharton</a> å†™çš„ç‰ˆæœ¬ã€‚</p>

<h4 id="12-æ—¥å¿—æ ¼å¼">1.2 æ—¥å¿—æ ¼å¼</h4>

<p>æ—¥å¿—æ–‡ä»¶å‘½åä¸º â€œjournalâ€ï¼Œå…¸å‹çš„æ–‡ä»¶æ ¼å¼å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="n">libcore</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">DiskLruCache</span>
<span class="mi">1</span>
<span class="mi">100</span>
<span class="mi">2</span>

<span class="no">CLEAN</span> <span class="mi">3400330</span><span class="n">d1dfc7f3f7f4b8d4d803dfcf6</span> <span class="mi">832</span> <span class="mi">21054</span>
<span class="no">DIRTY</span> <span class="mi">335</span><span class="n">c4c6028171cfddfbaae1a9c313c52</span>
<span class="no">CLEAN</span> <span class="mi">335</span><span class="n">c4c6028171cfddfbaae1a9c313c52</span> <span class="mi">3934</span> <span class="mi">2342</span>
<span class="no">REMOVE</span> <span class="mi">335</span><span class="n">c4c6028171cfddfbaae1a9c313c52</span>
<span class="no">DIRTY</span> <span class="mi">1</span><span class="n">ab96a171faeeee38496d8b330771a7a</span>
<span class="no">CLEAN</span> <span class="mi">1</span><span class="n">ab96a171faeeee38496d8b330771a7a</span> <span class="mi">1600</span> <span class="mi">234</span>
<span class="no">READ</span> <span class="mi">335</span><span class="n">c4c6028171cfddfbaae1a9c313c52</span>
<span class="no">READ</span> <span class="mi">3400330</span><span class="n">d1dfc7f3f7f4b8d4d803dfcf6</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å‰äº”è¡Œå†…å®¹æ˜¯æ—¥å¿—æ–‡ä»¶çš„å¤´éƒ¨ã€‚åˆ†åˆ«æ˜¯ <strong>â€œlibcore.io.DiskLruCacheâ€</strong>ã€<strong>ç£ç›˜ç¼“å­˜ç‰ˆæœ¬</strong>ã€<strong>åº”ç”¨ç¨‹åºç‰ˆæœ¬</strong>ã€<strong>å€¼æ€»è®¡æ•°é‡</strong> å’Œä¸€ä¸ªç©ºè¡Œã€‚</p>

<p>æ–‡ä»¶éšåæ¯ä¸€è¡Œï¼Œä»£è¡¨è®°å½•ä¸€ä¸ªç¼“å­˜æ¡ç›®çš„çŠ¶æ€ã€‚å†…å®¹ä¸ºï¼šçŠ¶æ€å€¼ã€keyã€å¯é€‰çš„æè¿°çŠ¶æ€çš„å€¼ï¼Œå„è‡ªç”¨ç©ºæ ¼åˆ†å‰²ã€‚</p>

<ul>
  <li><strong>DIRTY</strong> æ„å‘³å¯¹åº”æ¡ç›®æ˜¯æ–°åˆ›å»ºæˆ–å·²è¢«ä¿®æ”¹ã€‚æ¯ä¸ªæ­£ç¡®çš„ <strong>DIRTY</strong> æ“ä½œå¿…é¡»è·Ÿç€ <strong>CLEAN</strong> æˆ– <strong>REMOVE</strong> æ“ä½œã€‚å¦‚æœæ²¡æ»¡è¶³è¯¥æ¡ä»¶ï¼Œåˆ™éœ€è¦åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼›</li>
  <li><strong>CLEAN</strong> è¡¨ç¤ºç¼“å­˜æ¡ç›®å·²æˆåŠŸå‘å¸ƒå¹¶å¯è®¿é—®ã€‚æ¯ä¸ªå‘å¸ƒè¡Œåé¢è·Ÿç€è‹¥å¹²ä¸ªå†™å…¥å€¼çš„é•¿åº¦ï¼›</li>
  <li><strong>READ</strong> æ˜¯è®¿é—®æ“ä½œ (è®¿é—®ä¸ä¼šé€ æˆå‰¯ä½œç”¨)ï¼›</li>
  <li><strong>REMOVE</strong> è¡¨ç¤ºè¯¥æ¡ç›®å†…å®¹å·²è¢«åˆ é™¤ã€‚</li>
</ul>

<p>å½“å‘ç”Ÿç¼“å­˜æ“ä½œæ—¶ï¼Œå†…å®¹ä¼šè¿½åŠ åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ã€‚ç¼“å­˜ç±»å¶å°”ä¼šåˆ é™¤æ—¥å¿—æ–‡ä»¶å¤šä½™çš„è¡Œï¼Œç¼©å°å†…å®¹ä½“ç§¯ã€‚ä¸´æ—¶æ–‡ä»¶åä¸º <strong>â€œjournal.tmpâ€</strong>ï¼Œåœ¨æ—¥å¿—å‹ç¼©è¿‡ç¨‹ä¸­ä½¿ç”¨ï¼Œä¸”ä¼šåœ¨ç¼“å­˜å¯åŠ¨æ—¶åˆ é™¤è¯¥æ–‡ä»¶ã€‚</p>

<h2 id="äºŒå¸¸é‡">äºŒã€å¸¸é‡</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="c1">// åŸæ–‡ä»¶çš„æ–‡ä»¶å</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">JOURNAL_FILE</span> <span class="o">=</span> <span class="s">"journal"</span><span class="o">;</span>

<span class="c1">// ä¸´æ—¶æ–‡ä»¶çš„æ–‡ä»¶å</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">JOURNAL_FILE_TEMP</span> <span class="o">=</span> <span class="s">"journal.tmp"</span><span class="o">;</span>

<span class="c1">// å¤‡ä»½æ–‡ä»¶çš„æ–‡ä»¶å</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">JOURNAL_FILE_BACKUP</span> <span class="o">=</span> <span class="s">"journal.bkp"</span><span class="o">;</span>

<span class="c1">// é­”æ•°å­—ç¬¦ä¸²æ ‡è¯†æ–‡ä»¶çš„èº«ä»½</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MAGIC</span> <span class="o">=</span> <span class="s">"libcore.io.DiskLruCache"</span><span class="o">;</span>

<span class="c1">// å½“å‰DiskLruCacheçš„ç‰ˆæœ¬</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">VERSION_1</span> <span class="o">=</span> <span class="s">"1"</span><span class="o">;</span>

<span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">ANY_SEQUENCE_NUMBER</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>

<span class="c1">// å·²æ¸…é™¤</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">CLEAN</span> <span class="o">=</span> <span class="s">"CLEAN"</span><span class="o">;</span>

<span class="c1">// è„æ•°æ®</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DIRTY</span> <span class="o">=</span> <span class="s">"DIRTY"</span><span class="o">;</span>

<span class="c1">// å·²ç§»é™¤</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">REMOVE</span> <span class="o">=</span> <span class="s">"REMOVE"</span><span class="o">;</span>

<span class="c1">// å·²è¯»å–</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">READ</span> <span class="o">=</span> <span class="s">"READ"</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸‰æ•°æ®æˆå‘˜">ä¸‰ã€æ•°æ®æˆå‘˜</h2>

<p>æ•°æ®æˆå‘˜é€šè¿‡ <strong>LinkedHashMap</strong> ç±»å®ç°LRUç‰¹æ€§ï¼Œå…·ä½“æºç è¯·çœ‹<a href="/2018/07/09/LinkedHashMap/">Javaæºç ç³»åˆ—(11) â€“ LinkedHashMap</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="c1">// ç¼“å­˜ä¿å­˜çš„æ–‡ä»¶å¤¹</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">File</span> <span class="n">directory</span><span class="o">;</span>

<span class="c1">// æ—¥å¿—æ–‡ä»¶</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">File</span> <span class="n">journalFile</span><span class="o">;</span>

<span class="c1">// ä¸´æ—¶æ—¥å¿—æ–‡ä»¶</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">File</span> <span class="n">journalFileTmp</span><span class="o">;</span>

<span class="c1">// å¤‡ä»½çš„æ—¥å¿—æ–‡ä»¶</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">File</span> <span class="n">journalFileBackup</span><span class="o">;</span>

<span class="c1">// ä½¿ç”¨æ­¤åº“æ—¶Appçš„ç‰ˆæœ¬å·ï¼Œç‰ˆæœ¬å·æ”¹å˜åç¼“å­˜å°†å¤±æ•ˆ</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">appVersion</span><span class="o">;</span>

<span class="c1">// ç”¨äºå­˜å‚¨çš„æœ€å¤§å­—èŠ‚æ•°</span>
<span class="kd">private</span> <span class="kt">long</span> <span class="n">maxSize</span><span class="o">;</span>

<span class="c1">// æ¯ä¸ªæ¡ç›®å¯ä¿å­˜å€¼çš„æœ€å¤§æ•°é‡</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">valueCount</span><span class="o">;</span>

<span class="c1">// å·²ä¿å­˜å†…å®¹çš„å¤§å°</span>
<span class="kd">private</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="kd">private</span> <span class="nc">Writer</span> <span class="n">journalWriter</span><span class="o">;</span>

<span class="c1">// å®ç°LRUçš„LinkedHashMap</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Entry</span><span class="o">&gt;</span> <span class="n">lruEntries</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Entry</span><span class="o">&gt;(</span><span class="mi">0</span><span class="o">,</span> <span class="mf">0.75f</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

<span class="c1">// å¤šä½™æ“ä½œæ¬¡æ•°çš„ç»Ÿè®¡</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">redundantOpCount</span><span class="o">;</span>

<span class="c1">// ç”¨äºåŒºåˆ†å½“å‰å¿«ç…§å’Œæ—§å¿«ç…§çš„åºåˆ—å·ï¼Œæ¡ç›®æ¯æ¬¡æäº¤ç¼–è¾‘æ—¶éƒ½è¢«æˆäºˆä¸€ä¸ªåºåˆ—å·</span>
<span class="c1">// å¦‚æœå¿«ç…§çš„åºåˆ—å·ä¸ç­‰äºæ¡ç›®çš„åºåˆ—å·ï¼Œåˆ™å¿«ç…§æ˜¯æ—§çš„</span>
<span class="kd">private</span> <span class="kt">long</span> <span class="n">nextSequenceNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

<span class="c1">// ç¼“å­˜ä½¿ç”¨åå°å•çº¿ç¨‹æ¸…é™¤æ¡ç›®</span>
<span class="kd">final</span> <span class="nc">ThreadPoolExecutor</span> <span class="n">executorService</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">60L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¸…é™¤æ—¥å¿—æ–‡ä»¶çš„ä»»åŠ¡ï¼Œåœ¨éœ€è¦çš„æ—¶å€™åŠ åˆ°çº¿ç¨‹æ± ç­‰å¾…æ‰§è¡Œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">cleanupCallable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;()</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nc">Void</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// æ“ä½œçš„æ—¶å€™é”ç±»å¯¹è±¡</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">DiskLruCache</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// æ—¥å¿—æ–‡ä»¶æ— æ³•æ“ä½œ</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">journalWriter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// Closed.</span>
      <span class="o">}</span>
      <span class="n">trimToSize</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">journalRebuildRequired</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// é‡å»ºæ—¥å¿—æ–‡ä»¶</span>
        <span class="n">rebuildJournal</span><span class="o">();</span>
        <span class="c1">// æ—¥å¿—æ–‡ä»¶å·²é‡å»ºï¼Œæ­¤ç»Ÿè®¡å€¼ç½®0</span>
        <span class="n">redundantOpCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å››æ„é€ æ–¹æ³•">å››ã€æ„é€ æ–¹æ³•</h2>

<p>å¯è§æ€§ä¿®é¥°æ˜¯ <strong>private</strong>ï¼Œæ„é€ æ–¹æ³•æ— æ³•ä»å¤–éƒ¨è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡å†…éƒ¨é™æ€æ–¹æ³• <strong>open</strong> åˆ›å»ºå®ä¾‹ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nf">DiskLruCache</span><span class="o">(</span><span class="nc">File</span> <span class="n">directory</span><span class="o">,</span> <span class="kt">int</span> <span class="n">appVersion</span><span class="o">,</span> <span class="kt">int</span> <span class="n">valueCount</span><span class="o">,</span> <span class="kt">long</span> <span class="n">maxSize</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">directory</span> <span class="o">=</span> <span class="n">directory</span><span class="o">;</span>
  <span class="k">this</span><span class="o">.</span><span class="na">appVersion</span> <span class="o">=</span> <span class="n">appVersion</span><span class="o">;</span>
  <span class="k">this</span><span class="o">.</span><span class="na">journalFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="no">JOURNAL_FILE</span><span class="o">);</span>
  <span class="k">this</span><span class="o">.</span><span class="na">journalFileTmp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="no">JOURNAL_FILE_TEMP</span><span class="o">);</span>
  <span class="k">this</span><span class="o">.</span><span class="na">journalFileBackup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="no">JOURNAL_FILE_BACKUP</span><span class="o">);</span>
  <span class="k">this</span><span class="o">.</span><span class="na">valueCount</span> <span class="o">=</span> <span class="n">valueCount</span><span class="o">;</span>
  <span class="k">this</span><span class="o">.</span><span class="na">maxSize</span> <span class="o">=</span> <span class="n">maxSize</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="äº”æˆå‘˜æ–¹æ³•">äº”ã€æˆå‘˜æ–¹æ³•</h2>

<h4 id="51-open">5.1 open</h4>

<p>æ‰“å¼€åœ¨ç›®å½• <strong>directory</strong> ä¸­çš„ç¼“å­˜ï¼Œæ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°ç¼“å­˜ã€‚å‚æ•°è§£æï¼š</p>

<ul>
  <li><strong>directory</strong>ï¼šå­˜æ”¾æ–‡ä»¶çš„å¯å†™ç›®å½•</li>
  <li><strong>appVersion</strong>ï¼šåº”ç”¨ç‰ˆæœ¬å·ï¼Œå½“ç‰ˆæœ¬å·æ”¹å˜åç¼“å­˜ä¼šå…¨éƒ¨é‡ç½®</li>
  <li><strong>valueCount</strong>ï¼šæ¯ä¸ªç¼“å­˜æ¡ç›®ä¿å­˜å€¼çš„æ•°é‡ï¼Œå¿…é¡»ä¸ºæ­£æ•°</li>
  <li><strong>maxSize</strong>ï¼šæ­¤ç¼“å­˜å¯ç”¨äºå­˜å‚¨çš„æœ€å¤§å­—èŠ‚æ•°</li>
</ul>

<p>è¿˜æœ‰ï¼Œè¯»å†™æ–‡ä»¶ç¼“å­˜ç›®å½•å¤±è´¥æ—¶ä¼šæŠ›å‡º <strong>IOException</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="nc">DiskLruCache</span> <span class="nf">open</span><span class="o">(</span><span class="nc">File</span> <span class="n">directory</span><span class="o">,</span> <span class="kt">int</span> <span class="n">appVersion</span><span class="o">,</span> <span class="kt">int</span> <span class="n">valueCount</span><span class="o">,</span> <span class="kt">long</span> <span class="n">maxSize</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    
  <span class="c1">// ç¼“å­˜å¯ç”¨çš„æœ€å¤§å­—èŠ‚æ•°å°äºç­‰äº0</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">maxSize</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"maxSize &lt;= 0"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">valueCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"valueCount &lt;= 0"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// è·å–å¤‡ä»½æ–‡ä»¶ï¼Œæ–‡ä»¶æ˜¯é‡å»ºæ—¥å¿—æ—¶ç”Ÿæˆçš„</span>
  <span class="nc">File</span> <span class="n">backupFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="no">JOURNAL_FILE_BACKUP</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">backupFile</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">File</span> <span class="n">journalFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="no">JOURNAL_FILE</span><span class="o">);</span>
    <span class="c1">// å¤‡ä»½æ–‡ä»¶å­˜åœ¨ï¼ŒåŸjournalæ–‡ä»¶ä¹Ÿå­˜åœ¨</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">journalFile</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
      <span class="c1">// åŸæ–‡ä»¶å­˜åœ¨ï¼Œè¡¨ç¤ºé‡å»ºè¿‡ç¨‹æ­£å¸¸å®Œæˆï¼Œå·²ä¸éœ€è¦å¤‡ä»½æ–‡ä»¶</span>
      <span class="c1">// åˆ™åˆ é™¤å¤‡ä»½æ–‡ä»¶JOURNAL_FILE_BACKUPï¼Œå³journal.bkp</span>
      <span class="n">backupFile</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// åŸjournalæ–‡ä»¶ä¸å­˜åœ¨ï¼ŒæŠŠJOURNAL_FILE_BACKUPä½œä¸ºJOURNAL_FILE</span>
      <span class="n">renameTo</span><span class="o">(</span><span class="n">backupFile</span><span class="o">,</span> <span class="n">journalFile</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// Prefer to pick up where we left off.</span>
  <span class="nc">DiskLruCache</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DiskLruCache</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="n">appVersion</span><span class="o">,</span> <span class="n">valueCount</span><span class="o">,</span> <span class="n">maxSize</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">cache</span><span class="o">.</span><span class="na">journalFile</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">cache</span><span class="o">.</span><span class="na">readJournal</span><span class="o">();</span>
      <span class="n">cache</span><span class="o">.</span><span class="na">processJournal</span><span class="o">();</span>
      <span class="c1">// ç¼“å­˜è¯»å–æˆåŠŸï¼Œè¿”å›cacheå¥æŸ„</span>
      <span class="k">return</span> <span class="n">cache</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">journalIsCorrupt</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span>
          <span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"DiskLruCache "</span>
              <span class="o">+</span> <span class="n">directory</span>
              <span class="o">+</span> <span class="s">" is corrupt: "</span>
              <span class="o">+</span> <span class="n">journalIsCorrupt</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()</span>
              <span class="o">+</span> <span class="s">", removing"</span><span class="o">);</span>
      <span class="n">cache</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// æ²¡æ‰¾åˆ°æ–‡ä»¶æˆ–è¯»å–å‡ºé”™ï¼Œåˆ™åˆ›å»ºå…¨æ–°ç©ºçš„ç¼“å­˜</span>
  <span class="n">directory</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">();</span>
  <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DiskLruCache</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="n">appVersion</span><span class="o">,</span> <span class="n">valueCount</span><span class="o">,</span> <span class="n">maxSize</span><span class="o">);</span>
  <span class="n">cache</span><span class="o">.</span><span class="na">rebuildJournal</span><span class="o">();</span>
  <span class="k">return</span> <span class="n">cache</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="52-readjournal">5.2 readJournal</h4>

<p>è¯»å–æ—¥å¿—ï¼Œä¸»è¦ç›®çš„æ˜¯æ ¡éªŒæ—¥å¿—æ–‡ä»¶å¤´å†…å®¹æ˜¯å¦åˆæ³•ï¼Œå¹¶é€šè¿‡æ•è·è‡ªè¡ŒæŠ›å‡ºå¼‚å¸¸çš„æ–¹æ³•å¤„ç†å¼‚å¸¸æƒ…å†µã€‚å¸¸è§çš„åº”ç”¨åœºæ™¯æ˜¯ï¼šAppç‰ˆæœ¬å·æ›´æ–°åï¼Œæ–°ç‰ˆæœ¬å·å’Œæ—¥å¿—å†…Appç‰ˆæœ¬å·ä¸åŒ¹é…æŠ›å‡ºå¼‚å¸¸ã€‚ç„¶åï¼Œè¯¥å¼‚å¸¸è¢«æ•è·åï¼Œæ­¤ç¼“å­˜ä¼šè¢«ä¸¢å¼ƒå¹¶åˆ›å»ºæ–°ç¼“å­˜æ–‡ä»¶ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">readJournal</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="nc">StrictLineReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StrictLineReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">journalFile</span><span class="o">),</span> <span class="nc">Util</span><span class="o">.</span><span class="na">US_ASCII</span><span class="o">);</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">magic</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">version</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">appVersionString</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">valueCountString</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">blank</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
    <span class="c1">// æ£€éªŒå¤´éƒ¨5è¡Œå†…å®¹æ˜¯å¦åˆæ³•</span>
    <span class="k">if</span> <span class="o">(!</span><span class="no">MAGIC</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">magic</span><span class="o">)</span>
        <span class="o">||</span> <span class="o">!</span><span class="no">VERSION_1</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">version</span><span class="o">)</span>
        <span class="o">||</span> <span class="o">!</span><span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">appVersion</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="n">appVersionString</span><span class="o">)</span>
        <span class="o">||</span> <span class="o">!</span><span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">valueCount</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="n">valueCountString</span><span class="o">)</span>
        <span class="o">||</span> <span class="o">!</span><span class="s">""</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">blank</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// å¤–éƒ¨æ•è·å¼‚å¸¸ï¼Œç”¨æ–°å»ºæ—¥å¿—æ–‡ä»¶æ›¿æ¢é—®é¢˜æ—¥å¿—</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"unexpected journal header: ["</span> <span class="o">+</span> <span class="n">magic</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">version</span> <span class="o">+</span> <span class="s">", "</span>
          <span class="o">+</span> <span class="n">valueCountString</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">blank</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// æ—¥å¿—æ–‡ä»¶å¤´éƒ¨å†…å®¹æ ¡éªŒå·²é€šè¿‡</span>
    <span class="kt">int</span> <span class="n">lineCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="c1">// é€è¡Œè¯»å–æ—¥å¿—ï¼Œå¹¶æŒ‰ç…§å›ºå®šæ ¼å¼è§£æè¡Œå†…å®¹</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">readJournalLine</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">());</span>
        <span class="c1">// è®¡ç®—è¯»å–çš„æ€»è¡Œæ•°ï¼Œè¡Œæ•°ä¸åŒ…æ‹¬æ—¥å¿—å¤´éƒ¨å†…å®¹</span>
        <span class="n">lineCount</span><span class="o">++;</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">EOFException</span> <span class="n">endOfJournal</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// è¯»å–çš„å†…å®¹å¼‚å¸¸ï¼Œä¾‹å¦‚ï¼šè®¾å¤‡çªç„¶æ–­ç”µå¯¼è‡´æ—¥å¿—æ²¡å†™å…¨</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// å†—ä½™æ“ä½œè®¡æ•° = æ—¥å¿—è¡Œæ•° - ç¼“å­˜å®ä½“æ•°é‡</span>
    <span class="c1">// è‹¥å†—ä½™æ“ä½œè®¡æ•°å¾ˆå¤§ï¼Œè¡¨ç¤ºæ—¥å¿—å¯èƒ½å«æœ‰å¾ˆå¤šå†—ä½™çš„ä¿¡æ¯ï¼Œéœ€è¦è¿›è¡Œæ—¥å¿—æ¸…ç†</span>
    <span class="n">redundantOpCount</span> <span class="o">=</span> <span class="n">lineCount</span> <span class="o">-</span> <span class="n">lruEntries</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">hasUnterminatedLine</span><span class="o">())</span> <span class="o">{</span>
      <span class="c1">// ä¸Šé¢æŒ‰ç…§è¡Œè¯»å–æ˜¯å‡ºç°æˆªæ–­ï¼Œåˆ™è§¦å‘æ—¥å¿—é‡å»º</span>
      <span class="n">rebuildJournal</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// æ—¥å¿—éªŒè¯æ²¡æœ‰é—®é¢˜ï¼Œå»ºç«‹æ–‡ä»¶å†™å…¥å¥æŸ„</span>
      <span class="n">journalWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">OutputStreamWriter</span><span class="o">(</span>
          <span class="k">new</span> <span class="nf">FileOutputStream</span><span class="o">(</span><span class="n">journalFile</span><span class="o">,</span> <span class="kc">true</span><span class="o">),</span> <span class="nc">Util</span><span class="o">.</span><span class="na">US_ASCII</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="nc">Util</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">reader</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="53-readjournalline">5.3 readJournalLine</h4>

<p>æ—¥å¿—æ–‡ä»¶å¤´éƒ¨å†…å®¹æ ¡éªŒé€šè¿‡åï¼Œé€è¡Œè¯»å–æ—¥å¿—å†…å®¹å¹¶ç”±æ­¤æ–¹æ³•å¤„ç†ã€‚å‡è®¾æ­£åœ¨å¤„ç†çš„è¡Œå†…å®¹æ˜¯ <code class="highlighter-rouge">REMOVE 335c4c6028171cfddfbaae1a9c313c52</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">readJournalLine</span><span class="o">(</span><span class="nc">String</span> <span class="n">line</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="c1">// æ¯è¡Œå¿…é¡»åŒ…å«ä¸€ä¸ªè‡³å°‘ç©ºæ ¼ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸IOException</span>
  <span class="kt">int</span> <span class="n">firstSpace</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="sc">' '</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">firstSpace</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"unexpected journal line: "</span> <span class="o">+</span> <span class="n">line</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// firstSpaceç´¢å¼•å€¼ä¸º6</span>
  <span class="kt">int</span> <span class="n">keyBegin</span> <span class="o">=</span> <span class="n">firstSpace</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">secondSpace</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="sc">' '</span><span class="o">,</span> <span class="n">keyBegin</span><span class="o">);</span>
  <span class="kd">final</span> <span class="nc">String</span> <span class="n">key</span><span class="o">;</span>
  <span class="c1">// æ­¤æ—¶ä¸å­˜åœ¨secondSpaceï¼Œæ‰€ä»¥secondSpaceä¸º-1ï¼Œæ¡ä»¶å‘½ä¸­</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">secondSpace</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ä»è¡Œå†…å®¹è£å‡ºkey: 335c4c6028171cfddfbaae1a9c313c52</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">keyBegin</span><span class="o">);</span>
    <span class="c1">// æ‰€æœ‰æ“ä½œçš„å­—ç¬¦ä¸²åªæœ‰REMOVEçš„é•¿åº¦ä¸º6</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">firstSpace</span> <span class="o">==</span> <span class="no">REMOVE</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="no">REMOVE</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// åŒ¹é…ç§»é™¤æ“ä½œï¼Œåˆ™æŠŠè¯¥æ¡ç›®ä»LinkedHashMapä¸­ç§»é™¤</span>
      <span class="n">lruEntries</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
      <span class="c1">// REMOVEæ“ä½œç»“æŸï¼Œé€€å‡ºæ–¹æ³•</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="c1">// CLEANæ“ä½œè¿›å…¥æ­¤åˆ†æ”¯çš„ï¼Œå› ä¸ºåªæœ‰CLEANçš„secondSpaceä¸ä¸º-1</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">keyBegin</span><span class="o">,</span> <span class="n">secondSpace</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// DIRTYã€READã€CLEANæ“ä½œåˆ°è¿™é‡Œ</span>
  <span class="nc">Entry</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">lruEntries</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">entry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// æ—¥å¿—åŒ…å«çš„è®°å½•åœ¨è¿™é‡Œåˆå§‹åŒ–å¹¶æ”¾å…¥å†…å­˜ä¸­</span>
    <span class="n">entry</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Entry</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
    <span class="n">lruEntries</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">entry</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">secondSpace</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">firstSpace</span> <span class="o">==</span> <span class="no">CLEAN</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="no">CLEAN</span><span class="o">))</span> <span class="o">{</span>
    <span class="c1">// å¤„ç†CLEANæ“ä½œï¼Œè£å‰ªå‡ºkeyåé¢çš„å¤šä¸ªå€¼</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">secondSpace</span> <span class="o">+</span> <span class="mi">1</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
    <span class="n">entry</span><span class="o">.</span><span class="na">readable</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="n">entry</span><span class="o">.</span><span class="na">currentEditor</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">entry</span><span class="o">.</span><span class="na">setLengths</span><span class="o">(</span><span class="n">parts</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">secondSpace</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">firstSpace</span> <span class="o">==</span> <span class="no">DIRTY</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="no">DIRTY</span><span class="o">))</span> <span class="o">{</span>
    <span class="c1">// å¤„ç†DIRTYæ“ä½œ</span>
    <span class="n">entry</span><span class="o">.</span><span class="na">currentEditor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Editor</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">secondSpace</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">firstSpace</span> <span class="o">==</span> <span class="no">READ</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="no">READ</span><span class="o">))</span> <span class="o">{</span>
    <span class="c1">// READæ“ä½œä¸éœ€å¤„ç†ï¼Œå› ä¸ºREADæ“ä½œæ²¡æœ‰ä»»ä½•å‰¯ä½œç”¨</span>
    <span class="c1">// This work was already done by calling lruEntries.get().</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="c1">// å‡ºç°æœªçŸ¥æ“ä½œç±»å‹ï¼Œæ­£å¸¸æ¥è¯´ä¸ä¼šé‡åˆ°</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"unexpected journal line: "</span> <span class="o">+</span> <span class="n">line</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ€»ç»“æ“ä½œæŒ‡ä»¤ï¼š</p>

<ul>
  <li><strong>REMOVE</strong>ï¼šä» <strong>LinkedHashMap</strong> åˆ é™¤æ¡ç›®ï¼›</li>
  <li><strong>CLEAN</strong>ï¼šåˆå§‹åŒ–æ¡ç›®ï¼Œè®¾ç½® <strong>readable=true</strong>ã€<strong>currentEditor=null</strong>ï¼Œåˆå§‹åŒ–å†…å®¹é•¿åº¦ï¼›</li>
  <li><strong>DIRTY</strong>ï¼šè®¾ç½® <strong>currentEditor</strong> å¯¹è±¡ï¼›</li>
  <li><strong>READ</strong>ï¼šä»€ä¹ˆéƒ½ä¸æ‰§è¡Œï¼›</li>
</ul>

<p>æ­£å¸¸æ“ä½œçš„ <strong>DIRTY</strong> é…å¯¹ <strong>CLEAN</strong> æˆ– <strong>REMOVE</strong>ï¼Œå¦åˆ™å°±æ˜¯è„æ•°æ®ä¸”éœ€è¦åˆ é™¤ã€‚</p>

<h4 id="54-processjournal">5.4 processJournal</h4>

<p>æŠŠè®¡ç®—åˆå§‹å¤§å°å’Œæ”¶é›†åƒåœ¾æ“ä½œä½œä¸ºæ‰“å¼€ç¼“å­˜çš„ä¸€éƒ¨åˆ†ã€‚è„æ¡ç›®ä¼šå‡å®šä¸ºä¸ä¸€è‡´è¦è¢«åˆ é™¤ã€‚<strong>DIRTY</strong> æ“ä½œçš„ <strong>currentEditor</strong> ä¸ä¸ºç©ºï¼Œè¡¨æ˜æ—§å†…å®¹å·²åºŸå¼ƒã€æ–°å†…å®¹ä¹Ÿæ²¡æ­£ç¡®å®Œæˆï¼Œæ‰€ä»¥æ–°æ—§æ–‡ä»¶éƒ½è¦ç§»é™¤ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">processJournal</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="c1">// åˆ é™¤å·²ç»å­˜åœ¨çš„ä¸´æ—¶æ—¥å¿—æ–‡ä»¶</span>
  <span class="n">deleteIfExists</span><span class="o">(</span><span class="n">journalFileTmp</span><span class="o">);</span>
  <span class="c1">// é€ä¸ªéå†lruEntries</span>
  <span class="k">for</span> <span class="o">(</span><span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Entry</span><span class="o">&gt;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">lruEntries</span><span class="o">.</span><span class="na">values</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span> <span class="n">i</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span> <span class="o">)</span> <span class="o">{</span>
    <span class="nc">Entry</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">currentEditor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ç´¯è®¡å·²ç¼“å­˜æœ‰æ•ˆæ•°æ®çš„æ€»å¤§å°</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">valueCount</span><span class="o">;</span> <span class="n">t</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">entry</span><span class="o">.</span><span class="na">lengths</span><span class="o">[</span><span class="n">t</span><span class="o">];</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// DIRTYæ“ä½œçš„currentEditorä¸ä¸ºç©º</span>
      <span class="c1">// è¿™æ•°æ®ä¸èƒ½ç”¨ï¼Œæ–°æ—§æ–‡ä»¶éƒ½è¦ç§»é™¤</span>
      <span class="n">entry</span><span class="o">.</span><span class="na">currentEditor</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">valueCount</span><span class="o">;</span> <span class="n">t</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">deleteIfExists</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getCleanFile</span><span class="o">(</span><span class="n">t</span><span class="o">));</span>
        <span class="n">deleteIfExists</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getDirtyFile</span><span class="o">(</span><span class="n">t</span><span class="o">));</span>
      <span class="o">}</span>
      <span class="c1">// ä»lruEntriesç§»é™¤è¯¥è®°å½•</span>
      <span class="n">i</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="55-rebuildjournal">5.5 rebuildJournal</h4>

<p>ä»¥ä¸‹å‡ ç§æƒ…å†µä¼šé‡å»ºæ—¥å¿—ï¼š</p>

<ol>
  <li>ç¼“å­˜æ˜¯æ–°å»ºç«‹çš„ï¼Œæ²¡æœ‰æ—¥å¿—ï¼Œæ‰€ä»¥ç”¨é‡å»ºæ“ä½œå®Œæˆæ–°å»ºæ—¥å¿—æ–‡ä»¶ï¼›</li>
  <li>æ—¥å¿—å¤´éƒ¨å†…å®¹éªŒè¯ä¸é€šè¿‡ï¼Œä¸¢å¼ƒè¯¥æ–‡ä»¶å¹¶æ–°å»ºæ—¥å¿—ï¼›</li>
  <li>å¯åŠ¨ç¼“å­˜è¿‡ç¨‹ä¸­è¯»å–å·²æœ‰æ—¥å¿—å†…å®¹å‡ºé”™ï¼Œè¦ç”¨è¯»å–æˆåŠŸçš„å†…å®¹é‡å»ºæ–‡ä»¶æ›¿æ¢å·²æœ‰æ—¥å¿—ï¼›</li>
  <li>æ—¥å¿—è®°å½•å†…å®¹è¿‡å¤šä¼šå½±å“ioï¼Œæ‰€ä»¥é€šè¿‡é‡å»ºå»é™¤å†—ä½™è®°å½•ï¼›</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">rebuildJournal</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">journalWriter</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">journalWriter</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="c1">// ç»™journalFileTmpåˆ›å»ºä¸€ä¸ªç¼“å†²å†™å…¥</span>
  <span class="nc">Writer</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">OutputStreamWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">journalFileTmp</span><span class="o">),</span> <span class="nc">Util</span><span class="o">.</span><span class="na">US_ASCII</span><span class="o">));</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="c1">// ç¬¬ä¸€è¡Œï¼Œå†™å…¥é­”æ•°String</span>
    <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="no">MAGIC</span><span class="o">);</span>
    <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="c1">// ç¬¬äºŒè¡Œï¼ŒDiskLruçš„ç‰ˆæœ¬å·</span>
    <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="no">VERSION_1</span><span class="o">);</span>
    <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="c1">// ç¬¬ä¸‰è¡Œï¼ŒAppçš„ç‰ˆæœ¬å·</span>
    <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">appVersion</span><span class="o">));</span>
    <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="c1">// ç¬¬å››è¡Œï¼Œæ¡ç›®å¯åŒ…å«å€¼çš„æ•°é‡</span>
    <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">valueCount</span><span class="o">));</span>
    <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="c1">// ç¬¬äº”è¡Œï¼Œç©ºè¡Œ</span>
    <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>

    <span class="c1">// æŠŠlruEntriesæœ‰æ•ˆè®°å½•å†™å…¥æ—¥å¿—</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Entry</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">lruEntries</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">currentEditor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// æ–‡æ¡£ç°åœ¨è¿˜æ²¡å…³é—­</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="no">DIRTY</span> <span class="o">+</span> <span class="sc">' '</span> <span class="o">+</span> <span class="n">entry</span><span class="o">.</span><span class="na">key</span> <span class="o">+</span> <span class="sc">'\n'</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// æ–‡ä»¶å·²ç»æ­£ç¡®å…³é—­</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="no">CLEAN</span> <span class="o">+</span> <span class="sc">' '</span> <span class="o">+</span> <span class="n">entry</span><span class="o">.</span><span class="na">key</span> <span class="o">+</span> <span class="n">entry</span><span class="o">.</span><span class="na">getLengths</span><span class="o">()</span> <span class="o">+</span> <span class="sc">'\n'</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
  
  <span class="c1">// å¦‚æœå·²æœ‰æ—¥å¿—æ–‡ä»¶å­˜åœ¨ï¼Œå°±æŠŠæ–‡ä»¶å¤‡ä»½èµ·æ¥</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">journalFile</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">renameTo</span><span class="o">(</span><span class="n">journalFile</span><span class="o">,</span> <span class="n">journalFileBackup</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// ä¸´æ—¶æ–‡ä»¶å˜ä¸ºæ­£å¼æ–‡ä»¶</span>
  <span class="n">renameTo</span><span class="o">(</span><span class="n">journalFileTmp</span><span class="o">,</span> <span class="n">journalFile</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
  <span class="c1">// åˆ é™¤å¤‡ä»½æ–‡ä»¶</span>
  <span class="n">journalFileBackup</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>

  <span class="c1">// æ›´æ¢journalWriteråˆ°æ–°æ—¥å¿—æ–‡ä»¶</span>
  <span class="n">journalWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">OutputStreamWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">journalFile</span><span class="o">,</span> <span class="kc">true</span><span class="o">),</span> <span class="nc">Util</span><span class="o">.</span><span class="na">US_ASCII</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="56-deleteifexists">5.6 deleteIfExists</h4>

<p>åˆ é™¤å·²å­˜åœ¨æ–‡ä»¶ï¼Œåˆ é™¤å¤±è´¥ä¼šæŠ›å‡ºIOException</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">deleteIfExists</span><span class="o">(</span><span class="nc">File</span> <span class="n">file</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">file</span><span class="o">.</span><span class="na">delete</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="57-renameto">5.7 renameTo</h4>

<p>æ–‡ä»¶é‡å‘½åï¼Œå¹¶æ ¹æ® <strong>deleteDestination</strong> å†³å®šæ˜¯å¦åˆ é™¤å·²å­˜åœ¨çš„ <strong>to</strong> æ–‡ä»¶ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">renameTo</span><span class="o">(</span><span class="nc">File</span> <span class="n">from</span><span class="o">,</span> <span class="nc">File</span> <span class="n">to</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">deleteDestination</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="c1">// æ˜¯å¦å…ˆåˆ é™¤å·²å­˜åœ¨çš„ç›®æ ‡æ–‡ä»¶</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">deleteDestination</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">deleteIfExists</span><span class="o">(</span><span class="n">to</span><span class="o">);</span>
  <span class="o">}</span>
  
  <span class="c1">// é‡å‘½åfromä¸ºto</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">from</span><span class="o">.</span><span class="na">renameTo</span><span class="o">(</span><span class="n">to</span><span class="o">))</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="58-get">5.8 get</h4>

<p>è¿”å›é”®åä¸º <strong>key</strong> æ¡ç›®çš„å¿«ç…§ï¼Œè‹¥æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸å¯è¯»æ—¶è¿”å›nullã€‚å¦‚æœæœ‰å€¼è¢«è¿”å›ï¼Œåˆ™è¯¥å€¼ä¼šè¢«ç§»åˆ°LRUé˜Ÿåˆ—çš„å¤´éƒ¨ä¸Šã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">synchronized</span> <span class="nc">Value</span> <span class="nf">get</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="n">checkNotClosed</span><span class="o">();</span>
  <span class="nc">Entry</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">lruEntries</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
  <span class="c1">// å®ä½“ä¸å­˜åœ¨ï¼Œè¿”å›null</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">entry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// æ–‡ä»¶ä¸å¯è¯»ï¼Œè¿”å›null</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">entry</span><span class="o">.</span><span class="na">readable</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// å¦‚æœæ–‡ä»¶æ˜¯å¯ä»¥è¯»å–çš„</span>
  <span class="k">for</span> <span class="o">(</span><span class="nc">File</span> <span class="n">file</span> <span class="o">:</span> <span class="n">entry</span><span class="o">.</span><span class="na">cleanFiles</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ä½†æ£€æŸ¥æ—¶å‘ç°æ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‚£è‚¯å®šæ˜¯åˆšåˆšè¢«åˆ é™¤äº†</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// è®°å½•è¯»å–æ“ä½œçš„æ—¥å¿—</span>
  <span class="n">redundantOpCount</span><span class="o">++;</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">READ</span><span class="o">);</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">' '</span><span class="o">);</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'\n'</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">journalRebuildRequired</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">cleanupCallable</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="k">new</span> <span class="nf">Value</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">entry</span><span class="o">.</span><span class="na">sequenceNumber</span><span class="o">,</span> <span class="n">entry</span><span class="o">.</span><span class="na">cleanFiles</span><span class="o">,</span> <span class="n">entry</span><span class="o">.</span><span class="na">lengths</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="59-edit">5.9 edit</h4>

<p>è¿”å› <strong>key</strong> å¯¹åº”æ¡ç›®çš„ç¼–è¾‘å™¨ï¼Œå¦‚æœå…¶ä»–ç¼–è¾‘æ“ä½œæ­£åœ¨è¿›è¡Œåˆ™è¿”å›nullã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">Editor</span> <span class="nf">edit</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="k">return</span> <span class="nf">edit</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="no">ANY_SEQUENCE_NUMBER</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»¥ä¸Šæ–¹æ³•è°ƒç”¨äº†æ­¤æ–¹æ³•ï¼Œ<strong>expectedSequenceNumber</strong> å‚æ•°ä¸º <strong>ANY_SEQUENCE_NUMBER</strong>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">synchronized</span> <span class="nc">Editor</span> <span class="nf">edit</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">expectedSequenceNumber</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="n">checkNotClosed</span><span class="o">();</span>
  <span class="nc">Entry</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">lruEntries</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">expectedSequenceNumber</span> <span class="o">!=</span> <span class="no">ANY_SEQUENCE_NUMBER</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">entry</span> <span class="o">==</span> <span class="kc">null</span>
      <span class="o">||</span> <span class="n">entry</span><span class="o">.</span><span class="na">sequenceNumber</span> <span class="o">!=</span> <span class="n">expectedSequenceNumber</span><span class="o">))</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// å€¼å·²ç»è¢«åºŸå¼ƒ</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">entry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ä¸ºä¸å­˜åœ¨çš„é”®åˆ›å»ºæ–°æ¡ç›®</span>
    <span class="n">entry</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Entry</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
    <span class="n">lruEntries</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">entry</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">currentEditor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// å¦ä¸€ä¸ªç¼–è¾‘æ­£åœ¨è¿›è¡Œ</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
  
  <span class="c1">// ä¸ºç¼–è¾‘çš„æ–‡ä»¶åˆ›å»ºEditor</span>
  <span class="nc">Editor</span> <span class="n">editor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Editor</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
  <span class="n">entry</span><span class="o">.</span><span class="na">currentEditor</span> <span class="o">=</span> <span class="n">editor</span><span class="o">;</span>

  <span class="c1">// åœ¨åˆ›å»ºæ–‡ä»¶ä¹‹å‰åˆ·æ–°æ—¥å¿—ä»¥é˜²æ­¢æ–‡ä»¶ä¿®æ”¹è®°å½•å‡ºç°é—æ¼</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">DIRTY</span><span class="o">);</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">' '</span><span class="o">);</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'\n'</span><span class="o">);</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
  <span class="k">return</span> <span class="n">editor</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="510-getter">5.10 getter</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="c1">// è¿”å›æ­¤ç¼“å­˜å­˜å‚¨æ•°æ®çš„ç›®å½•</span>
<span class="kd">public</span> <span class="nc">File</span> <span class="nf">getDirectory</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">directory</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// è¿”å›ç¼“å­˜å¯ç”¨äºå­˜å‚¨æ•°æ®çš„æœ€å¤§å­—èŠ‚æ•°</span>
<span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">long</span> <span class="nf">getMaxSize</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">maxSize</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// è¿”å›å½“å‰å·²ç”¨äºå­˜å‚¨ç¼“å­˜çš„å­—èŠ‚æ•°</span>
<span class="c1">// å¦‚æœåå°åˆ é™¤æ“ä½œå¤„äºå¾…å¤„ç†ä¸­ï¼Œåˆ™è¯¥å€¼å¯èƒ½å¤§äºæœ€å¤§å¤§å°</span>
<span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">long</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">size</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="511-setter">5.11 setter</h4>

<p>å¦‚æœ‰å¿…è¦ï¼Œæ›´æ”¹ç¼“å­˜å¯ä»¥å­˜å‚¨çš„æœ€å¤§å­—èŠ‚æ•°ï¼ŒæŠŠå®‰æ’åå°ä»»åŠ¡å‡å°‘å·²å­˜åœ¨å­˜å‚¨å†…å®¹çš„å ç”¨ç©ºé—´ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">setMaxSize</span><span class="o">(</span><span class="kt">long</span> <span class="n">maxSize</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">maxSize</span> <span class="o">=</span> <span class="n">maxSize</span><span class="o">;</span>
  <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">cleanupCallable</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="512-completeedit">5.12 completeEdit</h4>

<p>æ€»ç»“ä¸ºä»¥ä¸‹æµç¨‹ï¼š</p>

<ul>
  <li>æ²¡æœ‰å¤„äºç¼–è¾‘çŠ¶æ€çš„æ¡ç›®ä¸èƒ½è°ƒç”¨æ­¤æ–¹æ³•ï¼Œå¦åˆ™æŠ›å‡ºIllegalStateExceptionï¼›</li>
  <li><strong>success</strong> ä¸º <strong>true</strong>ï¼Œç”¨ <strong>DirtyFile</strong> æ›´æ–° <strong>CleanFile</strong>ï¼Œå¦åˆ™åˆ é™¤ <strong>DirtyFile</strong> ï¼›</li>
  <li>æœ€åå‘æ—¥å¿—æ–‡ä»¶å†™å…¥ç›¸å…³æœ€æ–°æ“ä½œï¼›</li>
  <li>æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æ˜¯å¦å¤ªå¤§ï¼Œæœ‰æ²¡æœ‰å¿…è¦è¿›è¡Œæ¸…ç†ï¼›</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">completeEdit</span><span class="o">(</span><span class="nc">Editor</span> <span class="n">editor</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">success</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="nc">Entry</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="na">entry</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">currentEditor</span> <span class="o">!=</span> <span class="n">editor</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="c1">// é¦–æ¬¡åˆ›å»ºå®ä½“çš„è¯ï¼Œentry.readableä¸ºfalseï¼Œä¸”æ¯ä¸ªç´¢å¼•å¿…é¡»è¦æœ‰ä¸€ä¸ªå€¼</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">entry</span><span class="o">.</span><span class="na">readable</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">valueCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="c1">// æ²¡æœ‰å†™å…¥å†…å®¹å°±æŠ›å‡ºIllegalStateException</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">editor</span><span class="o">.</span><span class="na">written</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="o">{</span>
        <span class="n">editor</span><span class="o">.</span><span class="na">abort</span><span class="o">();</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Newly created entry didn't create value for index "</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">entry</span><span class="o">.</span><span class="na">getDirtyFile</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">editor</span><span class="o">.</span><span class="na">abort</span><span class="o">();</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">valueCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="nc">File</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getDirtyFile</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">success</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dirty</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// æŠŠdirtyFileé‡å‘½åä¸ºcleanFile</span>
        <span class="nc">File</span> <span class="n">clean</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getCleanFile</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="n">dirty</span><span class="o">.</span><span class="na">renameTo</span><span class="o">(</span><span class="n">clean</span><span class="o">);</span>
        <span class="kt">long</span> <span class="n">oldLength</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">lengths</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
        <span class="kt">long</span> <span class="n">newLength</span> <span class="o">=</span> <span class="n">clean</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
        <span class="n">entry</span><span class="o">.</span><span class="na">lengths</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">newLength</span><span class="o">;</span>
        <span class="c1">// æ›´æ–°ä¿å­˜å†…å®¹çš„æ€»å¤§å°</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">oldLength</span> <span class="o">+</span> <span class="n">newLength</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// å†™å…¥å‡ºç°å¼‚å¸¸ï¼Œåˆ é™¤è„æ–‡ä»¶</span>
      <span class="n">deleteIfExists</span><span class="o">(</span><span class="n">dirty</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">redundantOpCount</span><span class="o">++;</span>
  <span class="n">entry</span><span class="o">.</span><span class="na">currentEditor</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="c1">// ç¼–è¾‘çš„å†…å®¹å·²ç»æˆåŠŸå†™å…¥æ–‡ä»¶ç³»ç»Ÿï¼Œå†æ·»åŠ æ—¥å¿—è®°å½•</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">readable</span> <span class="o">|</span> <span class="n">success</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">entry</span><span class="o">.</span><span class="na">readable</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">CLEAN</span><span class="o">);</span>
    <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">' '</span><span class="o">);</span>
    <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
    <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getLengths</span><span class="o">());</span>
    <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'\n'</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">success</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">entry</span><span class="o">.</span><span class="na">sequenceNumber</span> <span class="o">=</span> <span class="n">nextSequenceNumber</span><span class="o">++;</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="c1">// ä¸æˆåŠŸåˆ™å¢åŠ ç§»é™¤è®°å½•</span>
    <span class="n">lruEntries</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
    <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">REMOVE</span><span class="o">);</span>
    <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">' '</span><span class="o">);</span>
    <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
    <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'\n'</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// åˆ·æ–°æ—¥å¿—æ–‡ä»¶å†…å®¹</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">maxSize</span> <span class="o">||</span> <span class="n">journalRebuildRequired</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">cleanupCallable</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h4 id="513-journalrebuildrequired">5.13 journalRebuildRequired</h4>

<p>ä»…å½“å†—ä½™æ“ä½œæ•°è¶…è¿‡2000ï¼Œä¸”è¯¥å€¼å¤§äº <strong>lruEntries</strong> é”®å€¼å¯¹çš„æ•°é‡æ—¶é‡å»ºæ—¥å¿—</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">journalRebuildRequired</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="kt">int</span> <span class="n">redundantOpCompactThreshold</span> <span class="o">=</span> <span class="mi">2000</span><span class="o">;</span>
  <span class="k">return</span> <span class="n">redundantOpCount</span> <span class="o">&gt;=</span> <span class="n">redundantOpCompactThreshold</span>
      <span class="o">&amp;&amp;</span> <span class="n">redundantOpCount</span> <span class="o">&gt;=</span> <span class="n">lruEntries</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="514-remove">5.14 remove</h4>

<p>é€šè¿‡ <strong>key</strong> åˆ é™¤å­˜åœ¨çš„æ¡ç›®ï¼Œä½†æ­£åœ¨ç¼–è¾‘çš„æ¡ç›®ä¸èƒ½è¢«ç§»é™¤ã€‚è‹¥æ¡ç›®ç§»é™¤æˆåŠŸï¼Œæ–¹æ³•è¿”å›å€¼ä¸ºtrueã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="n">checkNotClosed</span><span class="o">();</span>
  <span class="nc">Entry</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">lruEntries</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
  <span class="c1">// æ¡ç›®ä¸å­˜åœ¨ï¼Œæ­£åœ¨ç¼–è¾‘ä¸èƒ½åˆ é™¤</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">entry</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">entry</span><span class="o">.</span><span class="na">currentEditor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">valueCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="c1">// åˆ é™¤æ–‡ä»¶</span>
    <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getCleanFile</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">file</span><span class="o">.</span><span class="na">delete</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"failed to delete "</span> <span class="o">+</span> <span class="n">file</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">size</span> <span class="o">-=</span> <span class="n">entry</span><span class="o">.</span><span class="na">lengths</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
    <span class="n">entry</span><span class="o">.</span><span class="na">lengths</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// ä¸ºç§»é™¤æ“ä½œå†™å…¥æ—¥å¿—</span>
  <span class="n">redundantOpCount</span><span class="o">++;</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">REMOVE</span><span class="o">);</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">' '</span><span class="o">);</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'\n'</span><span class="o">);</span>

  <span class="c1">// ä»lruEntriesç§»é™¤è¯¥æ¡ç›®è®°å½•</span>
  <span class="n">lruEntries</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>

  <span class="c1">// æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å»ºæ—¥å¿—æ–‡ä»¶</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">journalRebuildRequired</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">cleanupCallable</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="515-å…¶ä»–">5.15 å…¶ä»–</h4>

<p>ç¼“å­˜å·²ç»å…³é—­æ—¶è¿”å›true</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">boolean</span> <span class="nf">isClosed</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">journalWriter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ£€æŸ¥ <strong>journalWriter</strong> æ˜¯å¦å·²å…³é—­ï¼Œå¦‚æœå·²å…³é—­ä¼šæŠ›å‡º <strong>IllegalStateException</strong>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkNotClosed</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">journalWriter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"cache is closed"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¼ºåˆ¶ç¼“å†²æ‰€æœ‰æ“ä½œåˆ°æ–‡ä»¶ç³»ç»Ÿ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">flush</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="n">checkNotClosed</span><span class="o">();</span>
  <span class="n">trimToSize</span><span class="o">();</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…³é—­æ­¤ç¼“å­˜ï¼Œå·²å­˜å‚¨çš„å€¼å°†ä¿ç•™åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">journalWriter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// æ–‡ä»¶å¥æŸ„å·²å…³é—­</span>
    <span class="k">return</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// ç»ˆæ­¢æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„ç¼–è¾‘</span>
  <span class="k">for</span> <span class="o">(</span><span class="nc">Entry</span> <span class="n">entry</span> <span class="o">:</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Entry</span><span class="o">&gt;(</span><span class="n">lruEntries</span><span class="o">.</span><span class="na">values</span><span class="o">()))</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">currentEditor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">entry</span><span class="o">.</span><span class="na">currentEditor</span><span class="o">.</span><span class="na">abort</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="n">trimToSize</span><span class="o">();</span>
  <span class="n">journalWriter</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="n">journalWriter</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç§»é™¤æ¡ç›®ç›´åˆ°ç¼“å­˜å ç”¨æ²¡æœ‰è¶…è¿‡é™åˆ¶</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">trimToSize</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="k">while</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">maxSize</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Entry</span><span class="o">&gt;</span> <span class="n">toEvict</span> <span class="o">=</span> <span class="n">lruEntries</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
    <span class="n">remove</span><span class="o">(</span><span class="n">toEvict</span><span class="o">.</span><span class="na">getKey</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…³é—­ç¼“å­˜å¹¶åˆ é™¤æ‰€æœ‰å·²ä¿å­˜çš„å€¼ã€‚åŒæ—¶ï¼Œæ‰€æœ‰ä¿å­˜åœ¨ç¼“å­˜ç›®å½•çš„æ–‡ä»¶ä¹Ÿä¼šåˆ é™¤ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="n">close</span><span class="o">();</span>
  <span class="nc">Util</span><span class="o">.</span><span class="na">deleteContents</span><span class="o">(</span><span class="n">directory</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æŠŠè¾“å…¥æµæ ¹æ® <strong>UTF_8</strong> å­—ç¬¦é›†æ‹¼æ¥æˆå­—ç¬¦ä¸²</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">inputStreamToString</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">in</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="k">return</span> <span class="nc">Util</span><span class="o">.</span><span class="na">readFully</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="nc">Util</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å…­value">å…­ã€Value</h2>

<p>æ¡ç›®æ‰€å«å€¼çš„å¿«ç…§</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Value</span> <span class="o">{</span>
  <span class="c1">// æ¡ç›®çš„Key</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">key</span><span class="o">;</span>
  <span class="c1">// å¿«ç…§åºåˆ—å·</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">sequenceNumber</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span><span class="o">[]</span> <span class="n">lengths</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">File</span><span class="o">[]</span> <span class="n">files</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">Value</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">sequenceNumber</span><span class="o">,</span> <span class="nc">File</span><span class="o">[]</span> <span class="n">files</span><span class="o">,</span> <span class="kt">long</span><span class="o">[]</span> <span class="n">lengths</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">sequenceNumber</span> <span class="o">=</span> <span class="n">sequenceNumber</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">files</span> <span class="o">=</span> <span class="n">files</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">lengths</span> <span class="o">=</span> <span class="n">lengths</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// è¿”å›æ­¤å¿«ç…§ä¸­å®ä½“çš„ç¼–è¾‘å™¨</span>
  <span class="c1">// è‹¥æ¡ç›®ä»å¿«ç…§åˆ›å»ºå¼€å§‹å·²æ”¹å˜ï¼Œæˆ–å¦ä¸€ä¸ªç¼–è¾‘æ“ä½œæ­£åœ¨è¿›è¡Œï¼Œæ–¹æ³•è¿”å›null</span>
  <span class="kd">public</span> <span class="nc">Editor</span> <span class="nf">edit</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">DiskLruCache</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">edit</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">sequenceNumber</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">File</span> <span class="nf">getFile</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">files</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
  <span class="o">}</span>

  <span class="c1">// è¿”å›æŒ‡å®šç´¢å¼•ä¸‹æ–‡ä»¶çš„Stringå€¼</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getString</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">files</span><span class="o">[</span><span class="n">index</span><span class="o">]);</span>
    <span class="k">return</span> <span class="nf">inputStreamToString</span><span class="o">(</span><span class="n">is</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// è¿”å›æŒ‡å®šç´¢å¼•ä¸‹å­—èŠ‚çš„é•¿åº¦</span>
  <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getLength</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">lengths</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸ƒeditor">ä¸ƒã€Editor</h2>

<p>ç¼–è¾‘ä¸€ä¸ªæ¡ç›®çš„(å¤šä¸ª)å€¼</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Editor</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Entry</span> <span class="n">entry</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span><span class="o">[]</span> <span class="n">written</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">committed</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nf">Editor</span><span class="o">(</span><span class="nc">Entry</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">written</span> <span class="o">=</span> <span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">readable</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="k">new</span> <span class="kt">boolean</span><span class="o">[</span><span class="n">valueCount</span><span class="o">];</span>
  <span class="o">}</span>

  <span class="c1">// è¿”å›æ— ç¼“å†²è¾“å…¥æµä»¥ä¾¿è¯»å–æœ€åä¸€æ¬¡æäº¤çš„å€¼ã€‚è‹¥æ²¡æœ‰æäº¤å€¼ï¼Œåˆ™æ–¹æ³•è¿”å›null</span>
  <span class="kd">private</span> <span class="nc">InputStream</span> <span class="nf">newInputStream</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">DiskLruCache</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">currentEditor</span> <span class="o">!=</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">entry</span><span class="o">.</span><span class="na">readable</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">FileInputStream</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getCleanFile</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FileNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// æŠŠæœ€åä¸€æ¬¡æäº¤çš„å€¼ä»¥Stringè¿”å›ï¼Œå¦‚æœæ²¡æœ‰å€¼æäº¤è¿‡å°±è¿”å›null</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getString</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">newInputStream</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">in</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">inputStreamToString</span><span class="o">(</span><span class="n">in</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">File</span> <span class="nf">getFile</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">DiskLruCache</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">currentEditor</span> <span class="o">!=</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">entry</span><span class="o">.</span><span class="na">readable</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">written</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="nc">File</span> <span class="n">dirtyFile</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getDirtyFile</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">directory</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">directory</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">dirtyFile</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// æŠŠindexæ‰€æŒ‡çš„å€¼ä¿®æ”¹ä¸ºæ–°å€¼value</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="nc">String</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">Writer</span> <span class="n">writer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// åˆ›å»ºä¸€ä¸ªè¾“å‡ºæµ</span>
      <span class="nc">OutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">getFile</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
      <span class="c1">// é€šè¿‡è¾“å‡ºæµæ„å»ºWriter</span>
      <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OutputStreamWriter</span><span class="o">(</span><span class="n">os</span><span class="o">,</span> <span class="nc">Util</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
      <span class="c1">// æŠŠå€¼å†™å…¥åˆ°ç´¢å¼•æ‰€æŒ‡</span>
      <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="c1">// å…³é—­Writer</span>
      <span class="nc">Util</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">writer</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// æäº¤æ‰€æœ‰ç¼–è¾‘æ“ä½œæ‰€åšä¿®æ”¹ï¼Œä»¥ä¾¿æ–°æ•°æ®å¯¹æ‰€æœ‰è¯»å–è€…å¯è§</span>
  <span class="c1">// æäº¤æ“ä½œåç¼–è¾‘é”ä¼šé‡Šæ”¾ï¼Œè®©å…¶ä»–ç¼–è¾‘æ“ä½œå¯åœ¨åŒä¸€ä¸ªkeyä¸Šå¼€å§‹</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="c1">// The object using this Editor must catch and handle any errors</span>
    <span class="c1">// during the write. If there is an error and they call commit</span>
    <span class="c1">// anyway, we will assume whatever they managed to write was valid.</span>
    <span class="c1">// Normally they should call abort.</span>
    <span class="n">completeEdit</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="n">committed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// ç»ˆæ­¢æ­¤æ¬¡ç¼–è¾‘ã€‚æ­¤æ“ä½œä¼šé‡Šæ”¾æ¡ç›®çš„ç¼–è¾‘é”ï¼Œå¹¶å…è®¸å…¶ä»–ç¼–è¾‘æ“ä½œåœ¨åŒä¸€ä¸ªkeyä¸Šå¼€å±•ç¼–è¾‘å·¥ä½œ</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">abort</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="n">completeEdit</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">abortUnlessCommitted</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">committed</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">abort</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å…«entry">å…«ã€Entry</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">key</span><span class="o">;</span>

  <span class="c1">// æŒæœ‰æ–‡ä»¶çš„é•¿åº¦</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span><span class="o">[]</span> <span class="n">lengths</span><span class="o">;</span>

  <span class="nc">File</span><span class="o">[]</span> <span class="n">cleanFiles</span><span class="o">;</span>
  <span class="nc">File</span><span class="o">[]</span> <span class="n">dirtyFiles</span><span class="o">;</span>

  <span class="c1">// æ¡ç›®å·²ç»å‘å¸ƒçš„è¯æ­¤å€¼ä¸ºTrue</span>
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">readable</span><span class="o">;</span>

  <span class="c1">// æ­£åœ¨è¿›è¡Œçš„ç¼–è¾‘ï¼Œå¦‚æœæœªç¼–è¾‘æ­¤æ¡ç›®ï¼Œåˆ™è¿”å›null</span>
  <span class="kd">private</span> <span class="nc">Editor</span> <span class="n">currentEditor</span><span class="o">;</span>

  <span class="c1">// æ­¤æ¡ç›®æœ€è¿‘æäº¤çš„ç¼–è¾‘çš„åºåˆ—å·ã€‚</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">sequenceNumber</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nf">Entry</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">lengths</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">long</span><span class="o">[</span><span class="n">valueCount</span><span class="o">];</span>
    <span class="n">cleanFiles</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">[</span><span class="n">valueCount</span><span class="o">];</span>
    <span class="n">dirtyFiles</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">[</span><span class="n">valueCount</span><span class="o">];</span>

    <span class="c1">// åå­—éƒ½æ˜¯é‡å¤çš„ï¼Œæ‰€ä»¥é‡ç”¨åŒä¸€ä¸ªæ„é€ å™¨é¿å…å†…å­˜ç”³è¯·</span>
    <span class="nc">StringBuilder</span> <span class="n">fileBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="n">key</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="sc">'.'</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">truncateTo</span> <span class="o">=</span> <span class="n">fileBuilder</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">valueCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">fileBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="n">cleanFiles</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="n">fileBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="n">fileBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">".tmp"</span><span class="o">);</span>
        <span class="n">dirtyFiles</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="n">fileBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="n">fileBuilder</span><span class="o">.</span><span class="na">setLength</span><span class="o">(</span><span class="n">truncateTo</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getLengths</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">StringBuilder</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">size</span> <span class="o">:</span> <span class="n">lengths</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">' '</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="c1">// ä½¿ç”¨ç±»ä¼¼"10123"çš„åè¿›åˆ¶æ•°å­—è®¾ç½®é•¿åº¦</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setLengths</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">strings</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">strings</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="n">valueCount</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="nf">invalidLengths</span><span class="o">(</span><span class="n">strings</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strings</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">lengths</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">strings</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NumberFormatException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="nf">invalidLengths</span><span class="o">(</span><span class="n">strings</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">IOException</span> <span class="nf">invalidLengths</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">strings</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"unexpected journal line: "</span> <span class="o">+</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">strings</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="c1">// æ ¹æ®ç´¢å¼•ä»File[]è·å–Fileå¯¹è±¡</span>
  <span class="kd">public</span> <span class="nc">File</span> <span class="nf">getCleanFile</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">cleanFiles</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
  <span class="o">}</span>
    
  <span class="c1">// æ ¹æ®ç´¢å¼•ä»File[]è·å–Fileå¯¹è±¡</span>
  <span class="kd">public</span> <span class="nc">File</span> <span class="nf">getDirtyFile</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">dirtyFiles</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
:ET