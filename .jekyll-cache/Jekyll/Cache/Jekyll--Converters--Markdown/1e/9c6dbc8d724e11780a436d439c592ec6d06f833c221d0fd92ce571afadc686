I"*Ø<p>æ–‡ç« åˆ—è¡¨ï¼š</p>
<ul>
  <li><a href="/2018/11/15/EventBus_1_Register/">EventBusæºç å‰–æ(1) â€“ è®¢é˜…æ³¨å†Œä¸æ³¨é”€</a></li>
  <li><a href="/2018/12/01/EventBus_2_EventBusBuilder/">EventBusæºç å‰–æ(2) â€“ EventBusBuilder</a></li>
  <li><a href="/2018/12/03/EventBus_3_ThreadMode/">EventBusæºç å‰–æ(3) â€“ çº¿ç¨‹æ¨¡å¼</a></li>
  <li><a href="/2018/12/06/EventBus_4_Subscription/">EventBusæºç å‰–æ(4) â€“ è®¢é˜…è®°å½•</a></li>
  <li><a href="/2018/12/10/EventBus_5_Poster/">EventBusæºç å‰–æ(5) â€“ Poster</a></li>
</ul>

<h2 id="ä¸€ç®€ä»‹">ä¸€ã€ç®€ä»‹</h2>

<h4 id="11-ç‰¹æ€§">1.1 ç‰¹æ€§</h4>

<p><strong>EventBus</strong> æ˜¯ä¸º <strong>Android</strong> è€Œè®¾ï¼Œå¤„äºä¸­å¿ƒçš„ <strong>publish/subscribe (å‘å¸ƒ/è®¢é˜…)</strong> äº‹ä»¶ç³»ç»Ÿã€‚äº‹ä»¶é€šè¿‡ <strong>post(Object)</strong> æäº¤åˆ°æ€»çº¿ï¼Œæ€»çº¿æŠŠäº‹ä»¶æŠ•é€’ç»™è®¢é˜…è€…ã€‚è€Œè¯¥è®¢é˜…è€…éœ€å«æœ‰åŒ¹é…ç±»å‹æ¶ˆæ¯çš„å¤„ç†æ–¹æ³•ã€‚</p>

<p><img src="/img/android/EventBus/EventBus-Publish-Subscribe.png" alt="EventBus-Publish-Subscribe" /></p>

<p>ä¸ºäº†èƒ½æ¥æ”¶äº‹ä»¶ï¼Œè®¢é˜…è€…éœ€é€šè¿‡ <strong>register(Object)</strong> æŠŠè‡ªå·±æ³¨å†Œåˆ°äº‹ä»¶æ€»çº¿ä¸Šã€‚ä¸€æ—¦æˆåŠŸæ³¨å†Œï¼Œè®¢é˜…è€…å¯ä»¥æŒç»­æ¥æ”¶å…³å¿ƒçš„äº‹ä»¶ï¼Œç›´è‡³é€šè¿‡ <strong>unregister(Object)</strong> ç»“æŸè®¢é˜…ã€‚</p>

<p>å¤„ç†äº‹ä»¶çš„æ–¹æ³•éœ€æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>

<ul>
  <li>ç”¨ <strong>@Subscribe</strong> è¿›è¡Œæ³¨è§£ï¼›</li>
  <li>æ–¹æ³•å¯è§æ€§ä¸º <strong>public</strong>ï¼›</li>
  <li>æ–¹æ³•è¿”å›å€¼ä¸º <strong>void</strong>ï¼›</li>
  <li>ä»…å«æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä¸”å½¢å‚ä¸ºäº‹ä»¶ç±»ï¼›</li>
</ul>

<p>ç”±äºæŠŠ <strong>Subscription</strong> ç¿»è¯‘ä¸ºåè¯æ€§çš„â€œè®¢é˜…â€åï¼Œå’Œå­—é¢åŠ¨è¯æ€§â€œè®¢é˜…â€æ²¡æ³•åŒºåˆ†ã€‚æ‰€ä»¥æœ¬ç³»åˆ—æ–‡ç« æŠŠè¯¥è¯ç¿»è¯‘ä¸ºæ›´è´´åˆ‡çš„åè¯ï¼šâ€œè®¢é˜…è®°å½•â€ï¼Œè¿™ä¸ªè¯ä¼šå°†åœ¨åç»­æ–‡ç« ç»§ç»­æ²¿ç”¨ã€‚</p>

<h4 id="12-ä¼˜ç‚¹">1.2 ä¼˜ç‚¹</h4>

<ul>
  <li>ç®€åŒ–ä¸åŒç»„ä»¶é—´é€šè®¯
    <ul>
      <li>å¯¹äº‹ä»¶å‘é€è€…å’Œæ¥æ”¶è€…è¿›è¡Œè§£è€¦</li>
      <li>ä¸Activitiesã€ Fragmentsã€å’Œåå°çº¿ç¨‹è¿è¡Œè‰¯å¥½</li>
      <li>é¿å…å¤æ‚ã€æ˜“é”™çš„ä¾èµ–å’Œç”Ÿå‘½å‘¨æœŸé—®é¢˜</li>
    </ul>
  </li>
  <li>ä»¤å®ç°ä»£ç æ›´ç®€æ´</li>
  <li>è¿è¡Œé€Ÿåº¦å¿«</li>
  <li>åº“ä½“ç§¯å° (çº¦50KB)</li>
  <li>å·²ç»è¿‡ç´¯è®¡ 100,000,000+ å®‰è£…é‡çš„åº”ç”¨éªŒè¯</li>
  <li>åŒ…å«æ¶ˆæ¯åˆ†å‘çº¿ç¨‹ã€è®¢é˜…è€…ä¼˜å…ˆçº§ç­‰é«˜çº§ç‰¹æ€§</li>
</ul>

<p>å®˜æ–¹æ–‡æ¡£æ²¡æœ‰æåŠï¼Œ<strong>EventBus</strong> åœ¨è¿›ç¨‹(VM)åˆ›å»ºå•ä¾‹ï¼Œæ‰€æœ‰æ¶ˆæ¯é€åˆ°åŒè¿›ç¨‹çš„æ¶ˆæ¯ä¸­å¿ƒï¼Œç”±æ¶ˆæ¯ä¸­å¿ƒåˆ†å‘ç»™åŒè¿›ç¨‹çš„å®ä¾‹ï¼Œè¿è¡Œåœ¨ä¸åŒè¿›ç¨‹çš„é¡µé¢æ²¡æ³•æ”¶åˆ°æ¥è‡ªå…¶ä»–è¿›ç¨‹çš„æ¶ˆæ¯ã€‚è¦å®ç°è·¨è¿›ç¨‹æ¶ˆæ¯åˆ†å‘å¿…é¡»ä½¿ç”¨ <strong>Socket</strong>ã€<strong>Binder</strong> ç­‰æ–¹æ³•ã€‚</p>

<h4 id="13-ç‰ˆæœ¬">1.3 ç‰ˆæœ¬</h4>

<p><strong>EventBus</strong> è‡ª17å¹´å¹´åº•å¼€å§‹ï¼ŒåŸºæœ¬åœæ­¢ä»£ç æäº¤ï¼Œå¯è®¤ä¸º <strong>EventBus</strong> åŠŸèƒ½ç¨³å®šæ— å˜åŠ¨ã€‚å¤„äºè¿™ç§çŠ¶å†µçš„å¼€æºåº“éå¸¸åˆé€‚è¿›è¡Œæºç å‰–æï¼Œè€Œæœ¬ç¯‡æ–‡ç« åŸºäºå½“æ—¶æœ€æ–°æ­£å¼ç‰ˆ <strong>3.1.1</strong> å¼€å±•ã€‚</p>

<h2 id="äºŒç”¨æ³•">äºŒã€ç”¨æ³•</h2>

<h4 id="21-è®¢é˜…è€…">2.1 è®¢é˜…è€…</h4>

<p>è®¢é˜…è€…éœ€è¦åœ¨åˆé€‚çš„ç”Ÿå‘½å‘¨æœŸï¼ŒæŠŠè‡ªå·±æ³¨å†Œåˆ°æ¶ˆæ¯æ€»çº¿ã€‚ç”±äºäº‹ä»¶çš„åŸºæœ¬æ¥æ”¶å•ä½æ˜¯æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦ç»™æ¥æ”¶äº‹ä»¶çš„æ–¹æ³•æ·»åŠ æ³¨è§£ï¼Œä»¥ä¾¿ <strong>EventBus</strong> é€šè¿‡æ³¨è§£å‘ç°è¯¥æ–¹æ³•ã€‚</p>

<p>æ¥æ”¶è€…æ–¹æ³•éœ€è¦éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š</p>

<ul>
  <li>ä½¿ç”¨ <strong>EventBus</strong> çš„æ³¨è§£ä¿®é¥°æ–¹æ³•ï¼›</li>
  <li>æ–¹æ³•ä¸èƒ½ä¸º <strong>private</strong>ï¼Œæ‰èƒ½è®© <strong>EventBus</strong> è·å–è¯¥æ–¹æ³•ï¼›</li>
  <li>æ–¹æ³•å¿…é¡»åªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œä¸”å‚æ•°ç±»å‹å°±æ˜¯æ‰€å…³å¿ƒäº‹ä»¶çš„ç±»å‹ï¼›</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">MainActivity</span> <span class="o">:</span> <span class="nc">AppCompatActivity</span><span class="o">()</span> <span class="o">{</span>

    <span class="n">override</span> <span class="n">fun</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nl">savedInstanceState:</span> <span class="nc">Bundle</span><span class="o">?)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">)</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">)</span>

        <span class="k">if</span> <span class="o">(</span><span class="nc">EventBus</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">isRegistered</span><span class="o">(</span><span class="k">this</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">EventBus</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="c1">// æ³¨å†Œç±»å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ¥æ”¶äº‹ä»¶çš„æ–¹æ³•</span>
    <span class="nd">@Subscribe</span><span class="o">(</span><span class="n">threadMode</span> <span class="o">=</span> <span class="nc">ThreadMode</span><span class="o">.</span><span class="na">MAIN</span><span class="o">,</span> <span class="n">sticky</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="o">)</span>
    <span class="n">fun</span> <span class="nf">onEventReceived</span><span class="o">(</span><span class="nl">event:</span> <span class="nc">UserEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">val</span> <span class="n">name</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">name</span>
        <span class="n">val</span> <span class="n">age</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">age</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Event received, Name: $name, Age: $age."</span><span class="o">)</span>
    <span class="o">}</span>
    
    <span class="n">override</span> <span class="n">fun</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">()</span>
        <span class="nc">EventBus</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">unregister</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¯ä¸ªæ¥æ”¶è€…ç±»åªéœ€å‘ <strong>EventBus</strong> æ³¨å†Œä¸€æ¬¡ã€‚ä¸ºé¿å…å¤šæ¬¡æ³¨å†Œï¼Œå¯ä»¥åƒä¸Šè¿°ä»£ç ä¸€æ ·åœ¨æ³¨å†Œå‰å…ˆè¿›è¡Œæ£€æŸ¥ã€‚å½“æ¥æ”¶è€…ç±»å¯¹äº‹ä»¶ä¸å†å…³å¿ƒæ—¶ï¼Œéœ€è¦åœ¨åˆé€‚æ—¶é—´ç‚¹æ³¨é”€è®¢é˜…ã€‚</p>

<h4 id="22-å‘å¸ƒè€…">2.2 å‘å¸ƒè€…</h4>

<p>å¯¹äº‹ä»¶å‘å¸ƒè€…æ¥è¯´äº‹æƒ…å°±ç®€å•å¤šäº†ã€‚åªéœ€æ„å»ºç›®æ ‡äº‹ä»¶ï¼ŒæŠŠæ•°æ®æˆ–è´Ÿè½½å†…å®¹åŒ…å«åœ¨äº‹ä»¶ä¸­å‘å‡ºå³å¯ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">fun</span> <span class="nf">postEvent</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">val</span> <span class="n">user</span> <span class="o">=</span> <span class="nc">UserEvent</span><span class="o">(</span><span class="s">"Mike"</span><span class="o">,</span> <span class="mi">24</span><span class="o">)</span>
    <span class="nc">EventBus</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">post</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="23-äº‹ä»¶æ¶ˆæ¯ä½“">2.3 äº‹ä»¶æ¶ˆæ¯ä½“</h4>

<p>è¿™æ˜¯ç¤ºä¾‹çš„æ¶ˆæ¯ä½“ï¼Œæ¶ˆæ¯ä½“åŒ…å«ç”¨æˆ·çš„åå­—å’Œå¹´é¾„</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nf">UserEvent</span><span class="o">(</span><span class="n">val</span> <span class="nl">name:</span> <span class="nc">String</span><span class="o">,</span> <span class="n">val</span> <span class="nl">age:</span> <span class="nc">Int</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœæ¶ˆæ¯åªæ˜¯ç®€å•é€šçŸ¥ï¼Œäº‹ä»¶ç±»ç”šè‡³å¯ä»¥ä¸å«ä»»ä½•æ•°æ®æˆå‘˜ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">Notification</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸‰åˆå§‹åŒ–">ä¸‰ã€åˆå§‹åŒ–</h2>

<h4 id="31-å•ä¾‹">3.1 å•ä¾‹</h4>

<p>æ•´ä¸ª <strong>EventBus</strong> é€šè¿‡ä»¥ä¸‹æ–¹æ³•åˆ›å»ºå•ä¾‹ã€‚æ‰€æœ‰åœ¨æ­¤å•ä¾‹å‘é€çš„äº‹ä»¶ï¼Œåªå¯¹æ³¨å†Œåœ¨å•ä¾‹é‡Œçš„è®¢é˜…è€…æœ‰æ•ˆã€‚ä¸ºä¿è¯æ‰€æœ‰äº‹ä»¶èƒ½åœ¨åŒä¸€ä¸ª <strong>EventBus</strong> å†…æµåŠ¨ï¼Œä¸€å®šè¦ä»æ­¤æ–¹æ³•è·å– <strong>EventBus</strong> å®ä¾‹ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EventBus</span> <span class="o">{</span>
    <span class="c1">// å˜é‡ä½¿ç”¨volatileä¿®é¥°</span>
    <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">EventBus</span> <span class="n">defaultInstance</span><span class="o">;</span>

    <span class="c1">// åŒä¸€è¿›ç¨‹å†…æœ‰æ•ˆï¼ŒåŒé‡æ£€éªŒé”å®ç°å•ä¾‹</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">EventBus</span> <span class="nf">getDefault</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">defaultInstance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">EventBus</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">defaultInstance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">defaultInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EventBus</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">defaultInstance</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è°ƒç”¨ <strong>getDefault()</strong> æ–¹æ³•æ—¶ï¼ŒåŒç±»ä¸¤ä¸ªå¸¸é‡ä¹Ÿè·å¾—åˆå§‹åŒ–ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">EventBusBuilder</span> <span class="no">DEFAULT_BUILDER</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EventBusBuilder</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>äº‹ä»¶ç±»å‹ç¼“å­˜ï¼Œå®ä¾‹ä¸º <strong>HashMap&lt;Class&lt;?&gt;, List&lt;Class&lt;?&gt;&gt;&gt;</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;&gt;</span> <span class="n">eventTypesCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="32-åŸºç¡€æ„é€ ">3.2 åŸºç¡€æ„é€ </h4>

<p>å•ä¾‹çš„åˆå§‹åŒ–è°ƒç”¨æ­¤æ„é€ æ–¹æ³•ï¼Œç„¶åæ–¹æ³•å†…åˆè°ƒç”¨å¦ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nf">EventBus</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="no">DEFAULT_BUILDER</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="33-æ·±å…¥æ„é€ ">3.3 æ·±å…¥æ„é€ </h4>

<p>æ„é€ è¿‡ç¨‹å¯¹ä»¥ä¸‹æ•°æ®æˆå‘˜è¿›è¡Œèµ‹å€¼</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="c1">// æŒ‰ç…§äº‹ä»¶ç±»å‹åˆ†ç±»è®¢é˜…ï¼Œäº‹ä»¶ç±»å‹ä¸å¯¹åº”çš„è®¢é˜…è®°å½•</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;</span><span class="nc">Subscription</span><span class="o">&gt;&gt;</span> <span class="n">subscriptionsByEventType</span><span class="o">;</span>

<span class="c1">// æŒ‰ç…§è®¢é˜…è€…ç±»å‹åˆ†ç±»</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;&gt;</span> <span class="n">typesBySubscriber</span><span class="o">;</span>

<span class="c1">// ç²˜æ€§äº‹ä»¶</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">stickyEvents</span><span class="o">;</span>

<span class="c1">// ç”¨äºæä¾›è®¿é—®ä¸»çº¿ç¨‹çš„èƒ½åŠ›</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">MainThreadSupport</span> <span class="n">mainThreadSupport</span><span class="o">;</span>

<span class="c1">// ä¸»çº¿ç¨‹æ¶ˆæ¯åˆ†å‘å™¨</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Poster</span> <span class="n">mainThreadPoster</span><span class="o">;</span>

<span class="c1">// åå°çº¿ç¨‹æ¶ˆæ¯åˆ†å‘å™¨</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">BackgroundPoster</span> <span class="n">backgroundPoster</span><span class="o">;</span>

<span class="c1">// å¼‚æ­¥æ¶ˆæ¯å‘å¸ƒå™¨</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">AsyncPoster</span> <span class="n">asyncPoster</span><span class="o">;</span>

<span class="c1">// è®¢é˜…è€…æ–¹æ³•æŸ¥æ‰¾å™¨</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">SubscriberMethodFinder</span> <span class="n">subscriberMethodFinder</span><span class="o">;</span>

<span class="c1">// ExecutorService</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">ExecutorService</span> <span class="n">executorService</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">throwSubscriberException</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">logSubscriberExceptions</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">logNoSubscriberMessages</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">sendSubscriberExceptionEvent</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">sendNoSubscriberEvent</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">eventInheritance</span><span class="o">;</span>

<span class="c1">// ç´¢å¼•æ€»è®¡</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">indexCount</span><span class="o">;</span>

<span class="c1">// æ—¥å¿—ç±»</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ„é€ æ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="nc">EventBus</span><span class="o">(</span><span class="nc">EventBusBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ä»EventBusBuilderè·å–Logger</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">getLogger</span><span class="o">();</span>
    
    <span class="c1">// åˆå§‹åŒ–å®¹å™¨</span>
    <span class="n">subscriptionsByEventType</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">typesBySubscriber</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">stickyEvents</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
    
    <span class="c1">// ä»EventBusBuilderè·å–MainThreadSupport</span>
    <span class="n">mainThreadSupport</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">getMainThreadSupport</span><span class="o">();</span>
    <span class="n">mainThreadPoster</span> <span class="o">=</span> <span class="n">mainThreadSupport</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">mainThreadSupport</span><span class="o">.</span><span class="na">createPoster</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>

    <span class="c1">// æ„å»ºBackgroundPoster</span>
    <span class="n">backgroundPoster</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BackgroundPoster</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

    <span class="c1">// æ„å»ºAsyncPoster</span>
    <span class="n">asyncPoster</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AsyncPoster</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

    <span class="c1">// æ³¨è§£å¤„ç†å™¨æ‰€ç”Ÿæˆè®¢é˜…è€…ä¿¡æ¯çš„æ•°é‡</span>
    <span class="n">indexCount</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">subscriberInfoIndexes</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">builder</span><span class="o">.</span><span class="na">subscriberInfoIndexes</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">:</span> <span class="mi">0</span><span class="o">;</span>

    <span class="c1">// åˆå§‹åŒ–è®¢é˜…è€…æ–¹æ³•æŸ¥æ‰¾å™¨åˆå§‹åŒ–</span>
    <span class="n">subscriberMethodFinder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SubscriberMethodFinder</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">subscriberInfoIndexes</span><span class="o">,</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">strictMethodVerification</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">ignoreGeneratedIndex</span><span class="o">);</span>

    <span class="c1">// åˆå§‹åŒ–å„ç§æ ‡å¿—ä½</span>
    <span class="n">logSubscriberExceptions</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">logSubscriberExceptions</span><span class="o">;</span>
    <span class="n">logNoSubscriberMessages</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">logNoSubscriberMessages</span><span class="o">;</span>
    <span class="n">sendSubscriberExceptionEvent</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">sendSubscriberExceptionEvent</span><span class="o">;</span>
    <span class="n">sendNoSubscriberEvent</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">sendNoSubscriberEvent</span><span class="o">;</span>
    <span class="n">throwSubscriberException</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">throwSubscriberException</span><span class="o">;</span>
    <span class="n">eventInheritance</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">eventInheritance</span><span class="o">;</span>
    
    <span class="c1">// ExecutorService</span>
    <span class="n">executorService</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">executorService</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="34-postingthreadstate">3.4 PostingThreadState</h4>

<p>å•ä¾‹åˆå§‹åŒ–è¿‡ç¨‹è¿˜åˆå§‹åŒ–äº† <strong>ThreadLocal</strong> å®ä¾‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">PostingThreadState</span><span class="o">&gt;</span> <span class="n">currentPostingThreadState</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">PostingThreadState</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">PostingThreadState</span> <span class="nf">initialValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">PostingThreadState</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>PostingThreadState</strong> æ˜¯å˜é‡çš„å°è£…ï¼Œæ”¾åœ¨ <strong>ThreadLocal</strong> ä¸­ï¼Œä»¥ä¾¿å¿«é€Ÿè®¾ç½®ã€è·å–å½“å‰çº¿ç¨‹çŠ¶æ€çš„å¤šä¸ªå˜é‡ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">PostingThreadState</span> <span class="o">{</span>
    <span class="c1">// å½“å‰çº¿ç¨‹çš„äº‹ä»¶é˜Ÿåˆ—</span>
    <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">eventQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="c1">// æ¶ˆæ¯æ˜¯å¦åœ¨æŠ•é€’ä¸­</span>
    <span class="kt">boolean</span> <span class="n">isPosting</span><span class="o">;</span>

    <span class="c1">// æ˜¯å¦ä¸ºä¸»çº¿ç¨‹</span>
    <span class="kt">boolean</span> <span class="n">isMainThread</span><span class="o">;</span>

    <span class="c1">// è®¢é˜…è®°å½•</span>
    <span class="nc">Subscription</span> <span class="n">subscription</span><span class="o">;</span>

    <span class="c1">// äº‹ä»¶</span>
    <span class="nc">Object</span> <span class="n">event</span><span class="o">;</span>

    <span class="c1">// æ˜¯å¦å·²è¢«å–æ¶ˆæŠ•é€’</span>
    <span class="kt">boolean</span> <span class="n">canceled</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å››æ³¨å†Œäº‹ä»¶">å››ã€æ³¨å†Œäº‹ä»¶</h2>

<h4 id="41-register">4.1 register</h4>

<p>æ‰€æœ‰è®¢é˜…è€…é€šè¿‡æ­¤æ–¹æ³•å‘ <strong>EventBus</strong> æ³¨å†Œï¼Œä»¥ä¾¿åœ¨æ³¨å†Œåæ”¶å–æ‰€å…³å¿ƒçš„äº‹ä»¶ã€‚æ³¨é”€è®¢é˜…åˆ™é€šè¿‡æ–¹æ³• <strong>unregister(Object)</strong>ï¼Œè¿™æ ·è§‚å¯Ÿè€…å¯åœ¨ä¸å…³å¿ƒäº‹ä»¶çš„æ—¶å€™å–æ¶ˆè®¢é˜…ã€‚</p>

<p>ä»ä¸‹é¢çš„å®ç°å¤§æ¦‚å¯çŸ¥ï¼Œå¦‚æœè®¢é˜…è€…åœ¨ç”Ÿå‘½å‘¨æœŸç»“æŸåä¸ç§»é™¤è®¢é˜…è€…ï¼Œé¡µé¢ä¼šå‡ºç°å†…å­˜æ³„æ¼ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="nc">Object</span> <span class="n">subscriber</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// è·å–è®¢é˜…è€…Class</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">subscriberClass</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>

    <span class="c1">// æ ¹æ®è®¢é˜…è€…ç±»å‹è·å–æ¥æ”¶äº‹ä»¶çš„æ–¹æ³•</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SubscriberMethod</span><span class="o">&gt;</span> <span class="n">subscriberMethods</span> <span class="o">=</span> <span class="n">subscriberMethodFinder</span><span class="o">.</span><span class="na">findSubscriberMethods</span><span class="o">(</span><span class="n">subscriberClass</span><span class="o">);</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// é€ä¸ªæ³¨å†Œè®¢é˜…è€…ä¸­çš„è®¢é˜…æ–¹æ³•</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">SubscriberMethod</span> <span class="n">subscriberMethod</span> <span class="o">:</span> <span class="n">subscriberMethods</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">subscribe</span><span class="o">(</span><span class="n">subscriber</span><span class="o">,</span> <span class="n">subscriberMethod</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="42-subscribe">4.2 subscribe</h4>

<p>æ­¤æ–¹æ³•åœ¨åŒæ­¥å—ä¸­è°ƒç”¨ï¼ŒæŠŠè®¢é˜…æ–¹æ³•æŒ‰ç…§è®¢é˜…äº‹ä»¶åˆ†ç±»ã€‚è¿‡ç¨‹ä¼šæ£€æŸ¥è®¢é˜…è€…æ˜¯å¦å‡ºç°é‡å¤æ³¨å†Œé—®é¢˜ï¼Œåæ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦åˆ†å‘ç²˜æ€§äº‹ä»¶ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">subscribe</span><span class="o">(</span><span class="nc">Object</span> <span class="n">subscriber</span><span class="o">,</span> <span class="nc">SubscriberMethod</span> <span class="n">subscriberMethod</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// è®¢é˜…è€…æ–¹æ³•çš„äº‹ä»¶ç±»å‹ï¼Œå³è®¢é˜…è€…æ–¹æ³•å”¯ä¸€å‚æ•°</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventType</span> <span class="o">=</span> <span class="n">subscriberMethod</span><span class="o">.</span><span class="na">eventType</span><span class="o">;</span>

    <span class="c1">// æ„å»ºæ–°è®°å½•</span>
    <span class="nc">Subscription</span> <span class="n">newSubscription</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Subscription</span><span class="o">(</span><span class="n">subscriber</span><span class="o">,</span> <span class="n">subscriberMethod</span><span class="o">);</span>

    <span class="c1">// ç”¨äº‹ä»¶ç±»å‹è·å–æ‰€æœ‰è®¢é˜…è®°å½•åˆ—è¡¨</span>
    <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;</span><span class="nc">Subscription</span><span class="o">&gt;</span> <span class="n">subscriptions</span> <span class="o">=</span> <span class="n">subscriptionsByEventType</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">eventType</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">subscriptions</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// è®¢é˜…è®°å½•åˆ—è¡¨ä¸ºç©ºï¼Œè¿›è¡Œåˆå§‹åŒ–</span>
        <span class="n">subscriptions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="c1">// ä¿å­˜äº‹ä»¶ç±»å‹å’Œå¯¹åº”è®¢é˜…è®°å½•</span>
        <span class="n">subscriptionsByEventType</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">eventType</span><span class="o">,</span> <span class="n">subscriptions</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// æ£€æŸ¥è¯¥è®¢é˜…è€…æ˜¯å¦å‡ºç°é‡å¤æ³¨å†Œ</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">subscriptions</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">newSubscription</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">EventBusException</span><span class="o">(</span><span class="s">"Subscriber "</span> <span class="o">+</span> <span class="n">subscriber</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">+</span> <span class="s">" already registered to event "</span>
                    <span class="o">+</span> <span class="n">eventType</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// è·å–åŒä¸€äº‹ä»¶çš„è®¢é˜…è®°å½•æ•°é‡</span>
    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">subscriptions</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="c1">// æ ¹æ®æ–¹æ³•æ³¨è§£è®¾ç½®çš„priorityå€¼é™åºæ’åºï¼Œå¹¶æ’å…¥æ–°è®°å½•äº‹ä»¶è®°å½•</span>
        <span class="c1">// priorityå€¼è¶Šå¤§è¶Šä¼˜å…ˆæ¥æ”¶æ¶ˆæ¯ï¼Œé»˜è®¤å€¼ä¸º0</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">size</span> <span class="o">||</span> <span class="n">subscriberMethod</span><span class="o">.</span><span class="na">priority</span> <span class="o">&gt;</span> <span class="n">subscriptions</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">subscriberMethod</span><span class="o">.</span><span class="na">priority</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">subscriptions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">newSubscription</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// é€šè¿‡è®¢é˜…è€…ç±»å‹è·å–ï¼Œè¯¥è®¢é˜…è€…å·²è®¢é˜…äº‹ä»¶ç±»å‹</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">subscribedEvents</span> <span class="o">=</span> <span class="n">typesBySubscriber</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">subscriber</span><span class="o">);</span>
    <span class="c1">// å¦‚æœè®¢é˜…è€…é¦–æ¬¡æ³¨å†Œåˆ™è¯¥åˆ—è¡¨ä¸ºç©ºï¼Œå¹¶å­˜å…¥åˆšè®¢é˜…çš„äº‹ä»¶</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">subscribedEvents</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">subscribedEvents</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="c1">// åŒä¸€è®¢é˜…è€…è®¢é˜…çš„äº‹ä»¶</span>
        <span class="n">typesBySubscriber</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">subscriber</span><span class="o">,</span> <span class="n">subscribedEvents</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// å‘è®¢é˜…è€…è®¢é˜…äº‹ä»¶åˆ—è¡¨å¢åŠ æ–°äº‹ä»¶ç±»å‹</span>
    <span class="n">subscribedEvents</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">eventType</span><span class="o">);</span>

    <span class="c1">// è®¢é˜…æ–¹æ³•çš„stickyä¸ºtrueï¼ŒæŠŠå†å²ç²˜æ€§äº‹ä»¶å‘é€ç»™æ–°è®¢é˜…æ–¹æ³•</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">subscriberMethod</span><span class="o">.</span><span class="na">sticky</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// eventInheritanceä¸ºtrueï¼Œè¡¨ç¤ºè®¢é˜…subscriberMethodå­ç±»æ¶ˆæ¯çš„è®¢é˜…è€…ä¹Ÿæ¥æ”¶ç²˜æ€§äº‹ä»¶</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">eventInheritance</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// æ¶ˆæ¯ç±»å‹æ‰€æœ‰å­ç±»çš„å·²å­˜åœ¨ç²˜æ€§äº‹ä»¶ï¼Œéƒ½éœ€è¦å—åˆ°å…³æ³¨</span>
            <span class="c1">// æœ‰éå¸¸å¤šç²˜æ€§äº‹ä»¶æ—¶è¿›è¡Œäº‹ä»¶éå†æ˜¯ä½æ•ˆçš„ï¼Œæ•°æ®ç»“æ„éœ€åœ¨éå†ä¸Šå˜å¾—æ›´é«˜æ•ˆ</span>
            <span class="c1">// ä¾‹å¦‚ï¼šä½¿ç”¨é¢å¤–çš„mapå­˜å‚¨çˆ¶ç±»çš„å­ç±»ï¼šClass -&gt; List&lt;Class&gt;</span>
            <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">entries</span> <span class="o">=</span> <span class="n">stickyEvents</span><span class="o">.</span><span class="na">entrySet</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">entries</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// å€™é€‰äº‹ä»¶ç±»å‹</span>
                <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">candidateEventType</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
                <span class="c1">// æ£€æŸ¥eventTypeæ˜¯å¦ä¸ºcandidateEventTypeçš„çˆ¶ç±»æˆ–åŒç±»</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">eventType</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">candidateEventType</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// æŠŠå­ç±»äº‹ä»¶å‘é€ç»™æ³¨å†Œä¸ºçˆ¶ç±»äº‹ä»¶çš„è®¢é˜…è€…</span>
                    <span class="nc">Object</span> <span class="n">stickyEvent</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
                    <span class="n">checkPostStickyEventToSubscription</span><span class="o">(</span><span class="n">newSubscription</span><span class="o">,</span> <span class="n">stickyEvent</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// ä»…å‘é€ç±»å‹å®Œå…¨åŒ¹é…çš„è®¢é˜…äº‹ä»¶</span>
            <span class="nc">Object</span> <span class="n">stickyEvent</span> <span class="o">=</span> <span class="n">stickyEvents</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">eventType</span><span class="o">);</span>
            <span class="n">checkPostStickyEventToSubscription</span><span class="o">(</span><span class="n">newSubscription</span><span class="o">,</span> <span class="n">stickyEvent</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="43-checkpoststickyeventtosubscription">4.3 checkPostStickyEventToSubscription</h4>

<p>æŠ•é€’ç²˜æ€§äº‹ä»¶ç»™è®¢é˜…è€…ã€‚å¦‚æœè®¢é˜…è€…å°è¯•ç»ˆæ­¢è¯¥äº‹ä»¶ä¼šå¤±è´¥ï¼Œå› ä¸ºäº‹ä»¶æ²¡æ³•é€šè¿‡æŠ•é€’çŠ¶æ€è¿›è¡Œè·Ÿè¸ªã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkPostStickyEventToSubscription</span><span class="o">(</span><span class="nc">Subscription</span> <span class="n">newSubscription</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">stickyEvent</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// æ£€æŸ¥ç²˜æ€§äº‹ä»¶æ˜¯å¦ä¸ºnull</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">stickyEvent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// æŠŠç²˜æ€§äº‹ä»¶ä½œä¸ºæ™®é€šäº‹ä»¶å‘é€ç»™è®¢é˜…è€…</span>
        <span class="n">postToSubscription</span><span class="o">(</span><span class="n">newSubscription</span><span class="o">,</span> <span class="n">stickyEvent</span><span class="o">,</span> <span class="n">isMainThread</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="44-posttosubscription">4.4 postToSubscription</h4>

<p><strong>ThreadMode</strong> ä¸­å‡ ç§ç±»åˆ«çš„ä¸»è¦å«ä¹‰åœ¨åç»­æ–‡ç« è¯¦è§£</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">postToSubscription</span><span class="o">(</span><span class="nc">Subscription</span> <span class="n">subscription</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">event</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isMainThread</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// è·å–è®¢é˜…è€…æ–¹æ³•æŒ‡å®šçº¿ç¨‹çš„ç±»åˆ«</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">subscription</span><span class="o">.</span><span class="na">subscriberMethod</span><span class="o">.</span><span class="na">threadMode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nl">POSTING:</span>
            <span class="n">invokeSubscriber</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>

        <span class="k">case</span> <span class="nl">MAIN:</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isMainThread</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// å¤„äºä¸»çº¿ç¨‹å°±ç›´æ¥è§¦å‘è®¢é˜…è€…</span>
                <span class="n">invokeSubscriber</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// å¤„åœ¨å…¶ä»–çº¿ç¨‹ï¼Œå‘ä¸»çº¿ç¨‹Handlerå‘é€æ¶ˆæ¯</span>
                <span class="n">mainThreadPoster</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>

        <span class="k">case</span> <span class="nl">MAIN_ORDERED:</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mainThreadPoster</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// ä¼˜å…ˆæ”¾å…¥ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ç­‰å¾…å¤„ç†</span>
                <span class="n">mainThreadPoster</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// temporary: technically not correct as poster not decoupled from subscriber</span>
                <span class="n">invokeSubscriber</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>

        <span class="k">case</span> <span class="nl">BACKGROUND:</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isMainThread</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// å½“å‰çº¿ç¨‹æ˜¯ä¸»çº¿ç¨‹ï¼ŒæŠŠäº‹ä»¶æ”¾å…¥åå°çº¿ç¨‹å¤„ç†é˜Ÿåˆ—</span>
                <span class="n">backgroundPoster</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// ç°åœ¨æ˜¯åå°çº¿ç¨‹ï¼Œç›´æ¥è°ƒç”¨è®¢é˜…è€…æ–¹æ³•</span>
                <span class="n">invokeSubscriber</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>

        <span class="k">case</span> <span class="nl">ASYNC:</span>
            <span class="c1">// æ”¾å…¥å¼‚æ­¥é˜Ÿåˆ—å¤„ç†</span>
            <span class="n">asyncPoster</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>

        <span class="k">default</span><span class="o">:</span>
            <span class="c1">// ä¼ å…¥æœªçŸ¥threadMode</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Unknown thread mode: "</span> <span class="o">+</span> <span class="n">subscription</span><span class="o">.</span><span class="na">subscriberMethod</span><span class="o">.</span><span class="na">threadMode</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¸Šè¿°æ³¨å†Œæµç¨‹ç®€åŒ–ä¸ºå¦‚ä¸‹æµç¨‹å›¾ï¼š</p>

<p><img src="/img/android/EventBus/EventBus_register.png" alt="register" /></p>

<h2 id="äº”æ³¨é”€è®¢é˜…">äº”ã€æ³¨é”€è®¢é˜…</h2>

<h4 id="51-unregister">5.1 unregister</h4>

<p>æŠŠæŒ‡å®šè®¢é˜…è€…ä»æ¶ˆæ¯æ€»çº¿ä¸­æ³¨é”€</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">unregister</span><span class="o">(</span><span class="nc">Object</span> <span class="n">subscriber</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// è®¢é˜…è€…è®¢é˜…çš„äº‹ä»¶ç±»å‹</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">subscribedTypes</span> <span class="o">=</span> <span class="n">typesBySubscriber</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">subscriber</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">subscribedTypes</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// é€ä¸ªæ³¨é”€è®¢é˜…è€…è®¢é˜…çš„äº‹ä»¶</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventType</span> <span class="o">:</span> <span class="n">subscribedTypes</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">unsubscribeByEventType</span><span class="o">(</span><span class="n">subscriber</span><span class="o">,</span> <span class="n">eventType</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// ä»typesBySubscriberç§»é™¤subscriber</span>
        <span class="n">typesBySubscriber</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">subscriber</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// æ­¤è®¢é˜…è€…ä¹‹å‰æœªæ›¾æ³¨å†Œè¿‡ï¼Œå´è¿›è¡Œæ³¨é”€æ“ä½œ</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="nc">Level</span><span class="o">.</span><span class="na">WARNING</span><span class="o">,</span> <span class="s">"Subscriber to unregister was not registered before: "</span> <span class="o">+</span> <span class="n">subscriber</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="52-unsubscribebyeventtype">5.2 unsubscribeByEventType</h4>

<p>åªæ›´æ–° <strong>subscriptionsByEventType</strong>ï¼Œè€Œä¸æ˜¯ <strong>typesBySubscriber</strong>ï¼Œå› ä¸º <strong>typesBySubscriber</strong> ç”±è°ƒç”¨è€…æ›´æ–°ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">unsubscribeByEventType</span><span class="o">(</span><span class="nc">Object</span> <span class="n">subscriber</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventType</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// æ ¹æ®äº‹ä»¶ç±»å‹è·å–è®¢é˜…è®°å½•</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Subscription</span><span class="o">&gt;</span> <span class="n">subscriptions</span> <span class="o">=</span> <span class="n">subscriptionsByEventType</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">eventType</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">subscriptions</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// è®¢é˜…è®°å½•æ•°é‡</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">subscriptions</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="c1">// æŸ¥æ‰¾å¹¶ç§»é™¤æ‰€æœ‰ç›¸å…³è®¢é˜…è®°å½•</span>
            <span class="nc">Subscription</span> <span class="n">subscription</span> <span class="o">=</span> <span class="n">subscriptions</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">subscription</span><span class="o">.</span><span class="na">subscriber</span> <span class="o">==</span> <span class="n">subscriber</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// subscriptionè®¾ç½®ä¸ºä¸æ´»åŠ¨</span>
                <span class="n">subscription</span><span class="o">.</span><span class="na">active</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="c1">// ä»åˆ—è¡¨ä¸­ç§»é™¤</span>
                <span class="n">subscriptions</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="n">i</span><span class="o">--;</span>
                <span class="n">size</span><span class="o">--;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¸Šè¿°æ³¨é”€æµç¨‹ç®€åŒ–ä¸ºå¦‚ä¸‹æµç¨‹å›¾ï¼š</p>

<p><img src="/img/android/EventBus/EventBus_unregister.png" alt="register" /></p>

<p>ä¸‹ä¸€ç« å°†ç»§ç»­ä»‹ç» <strong>EventBus</strong> åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œ<strong>EventBusBuilder</strong> çš„ä½œç”¨ã€‚</p>
:ET