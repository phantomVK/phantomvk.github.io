I"²<p>æ–‡ç« åˆ—è¡¨ï¼š</p>
<ul>
  <li><a href="/2018/11/15/EventBus_1_Register/">EventBusæºç å‰–æ(1) â€“ è®¢é˜…æ³¨å†Œä¸æ³¨é”€</a></li>
  <li><a href="/2018/12/01/EventBus_2_EventBusBuilder/">EventBusæºç å‰–æ(2) â€“ EventBusBuilder</a></li>
  <li><a href="/2018/12/03/EventBus_3_ThreadMode/">EventBusæºç å‰–æ(3) â€“ çº¿ç¨‹æ¨¡å¼</a></li>
  <li><a href="/2018/12/06/EventBus_4_Subscription/">EventBusæºç å‰–æ(4) â€“ è®¢é˜…è®°å½•</a></li>
  <li><a href="/2018/12/10/EventBus_5_Poster/">EventBusæºç å‰–æ(5) â€“ Poster</a></li>
</ul>

<h2 id="ä¸€poster">ä¸€ã€Poster</h2>

<p>è¿™æ˜¯æ‰€æœ‰ <strong>Poster</strong> å®ç°çš„å…±åŒæ¥å£ï¼ŒåŒ…å«ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ã€‚å­ç±»å®ç°è¯¥æŠ½è±¡æ–¹æ³•åï¼Œå¯æ¥æ”¶åˆ°è®¢é˜…è®°å½• <strong>Subscription</strong> å’Œäº‹ä»¶ <strong>Object</strong>ã€‚å®ç°ç±»éœ€è¦æ ¹æ®è‡ªèº«ç‰¹æ€§ï¼ŒæŠŠäº‹ä»¶æŒ‰ç…§æ—¢å®šæ¨¡å¼å‘é€ç»™è®¢é˜…è€…çš„æ¥æ”¶æ–¹æ³•ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kd">interface</span> <span class="nc">Poster</span> <span class="o">{</span>
    <span class="c1">// æŠŠéœ€è¦å‘é€ç»™æŒ‡å®šSubscriptionçš„äº‹ä»¶åŠ åˆ°é˜Ÿåˆ—ä¸­</span>
    <span class="c1">// @param subscription äº‹ä»¶è®°å½•Subscription</span>
    <span class="c1">// @param event å‘é€ç»™è®¢é˜…è€…çš„äº‹ä»¶</span>
    <span class="kt">void</span> <span class="nf">enqueue</span><span class="o">(</span><span class="nc">Subscription</span> <span class="n">subscription</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">event</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ‰€æœ‰å®ç°å­ç±»ï¼š</p>

<p><img src="/img/android/EventBus/EventBus_Poster.png" alt="EventBus_Poster" /></p>

<h2 id="äºŒasyncposter">äºŒã€AsyncPoster</h2>

<p>åœ¨åå°å¼‚æ­¥æŠ•é€’äº‹ä»¶ï¼Œæ¯ä¸ªä½¿ç”¨ <strong>AsyncPoster</strong> çš„ <strong>Runnable</strong> éƒ½æœ‰è‡ªå·±çš„çº¿ç¨‹ï¼Œé€‚åˆè€—æ—¶ä½†ä¸å ç”¨å¤„ç†å™¨æ—¶é—´ç‰‡çš„ioæ“ä½œï¼Œä»»åŠ¡è¿è¡Œå®Œæ¯•åçº¿ç¨‹å½’è¿˜ç»™çº¿ç¨‹æ± ã€‚</p>

<p><strong>AsyncPoster</strong> å’Œ <strong>BackgroundPoster</strong> å…±äº«åŒä¸€ä¸ª <strong>EventBus</strong> çº¿ç¨‹æ± ï¼Œè¯¥çº¿ç¨‹æ± ç±»å‹ä¸º <strong>Executors.newCachedThreadPool()</strong>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">AsyncPoster</span> <span class="kd">implements</span> <span class="nc">Runnable</span><span class="o">,</span> <span class="nc">Poster</span> <span class="o">{</span>
    <span class="c1">// äº‹ä»¶æŠ•é€’é˜Ÿåˆ—</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">PendingPostQueue</span> <span class="n">queue</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">EventBus</span> <span class="n">eventBus</span><span class="o">;</span>

    <span class="nc">AsyncPoster</span><span class="o">(</span><span class="nc">EventBus</span> <span class="n">eventBus</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">eventBus</span> <span class="o">=</span> <span class="n">eventBus</span><span class="o">;</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PendingPostQueue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// å‘é˜Ÿåˆ—å­˜å…¥è®¢é˜…è®°å½•å’Œäº‹ä»¶ï¼Œå¹¶æ¿€æ´»çº¿ç¨‹æ± è¿›è¡Œäº‹ä»¶æ´¾å‘</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">enqueue</span><span class="o">(</span><span class="nc">Subscription</span> <span class="n">subscription</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// åˆ›å»ºPendingPostå®ä¾‹ï¼Œå­˜å…¥è®¢é˜…è®°å½•subscriptionå’Œäº‹ä»¶event</span>
        <span class="nc">PendingPost</span> <span class="n">pendingPost</span> <span class="o">=</span> <span class="nc">PendingPost</span><span class="o">.</span><span class="na">obtainPendingPost</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
        <span class="c1">// PendingPostå®ä¾‹æ”¾å…¥é˜Ÿåˆ—ç­‰å¾…æ´¾å‘</span>
        <span class="n">queue</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">pendingPost</span><span class="o">);</span>
        <span class="c1">// ä»»åŠ¡æ”¾å…¥çº¿ç¨‹æ± ç­‰å¾…æ‰§è¡Œ</span>
        <span class="n">eventBus</span><span class="o">.</span><span class="na">getExecutorService</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// ä»äº‹ä»¶æŠ•é€’é˜Ÿåˆ—è·å–ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ</span>
        <span class="nc">PendingPost</span> <span class="n">pendingPost</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
        <span class="c1">// pendingPostä¸èƒ½ä¸ºç©º</span>
        <span class="k">if</span><span class="o">(</span><span class="n">pendingPost</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"No pending post available"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// æŠŠäº‹ä»¶å‘é€ç»™è®¢é˜…è€…</span>
        <span class="n">eventBus</span><span class="o">.</span><span class="na">invokeSubscriber</span><span class="o">(</span><span class="n">pendingPost</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸‰backgroundposter">ä¸‰ã€BackgroundPoster</h2>

<h4 id="31-backgroundposter">3.1 BackgroundPoster</h4>

<p><strong>BackgroundPoster</strong> å®ç°åå°æŠ•é€’äº‹ä»¶ã€‚<strong>BackgroundPoster</strong> æœ¬èº«åŒæ—¶å®ç° <strong>Runnable</strong> æ¥å£ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠç±»å®ä¾‹ç›´æ¥é€åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚çº¿ç¨‹æ± ä»äº‹ä»¶é˜Ÿåˆ—è·å–éœ€è¦æ´¾å‘çš„ä»»åŠ¡å¹¶æ‰§è¡Œã€‚</p>

<p><strong>BackgroundPoster</strong> åªæœ‰ä¸€ä¸ªè¿è¡Œçº¿ç¨‹ï¼ŒæŒ‰ä»»åŠ¡è¿›å…¥é˜Ÿåˆ—çš„é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œé€‚åˆå¤§é‡çŸ­å°çš„ä»»åŠ¡ã€‚å¦‚æœé˜Ÿåˆ—æ²¡æœ‰ä»»åŠ¡ï¼Œè¯¥ <strong>Runnable</strong> ä¼šé€€å‡ºï¼Œçº¿ç¨‹ä¹Ÿä¼šå½’è¿˜ç»™çº¿ç¨‹æ± ã€‚ä»å‰æ–‡ä»‹ç»å¯çŸ¥ï¼Œçº¿ç¨‹æ± å®ç°æ˜¯ <strong>Executors.newCachedThreadPool()</strong>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="nc">BackgroundPoster</span> <span class="kd">implements</span> <span class="nc">Runnable</span><span class="o">,</span> <span class="nc">Poster</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">PendingPostQueue</span> <span class="n">queue</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">EventBus</span> <span class="n">eventBus</span><span class="o">;</span>
    
    <span class="c1">// executoræ˜¯å¦æ­£åœ¨è¿è¡Œ</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">executorRunning</span><span class="o">;</span>

    <span class="nc">BackgroundPoster</span><span class="o">(</span><span class="nc">EventBus</span> <span class="n">eventBus</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">eventBus</span> <span class="o">=</span> <span class="n">eventBus</span><span class="o">;</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PendingPostQueue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// è®¢é˜…è®°å½•å’Œå…¶è®¢é˜…çš„äº‹ä»¶è¿›é˜Ÿ</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">enqueue</span><span class="o">(</span><span class="nc">Subscription</span> <span class="n">subscription</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ä»PendingPostç¼“å­˜æ± ä¸­è·å–ç¼“å­˜å¯¹è±¡ï¼Œç”¨äºä¿å­˜subscriptionå’Œevent</span>
        <span class="nc">PendingPost</span> <span class="n">pendingPost</span> <span class="o">=</span> <span class="nc">PendingPost</span><span class="o">.</span><span class="na">obtainPendingPost</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
        <span class="c1">// æŠŠè®¾ç½®å®Œæ¯•çš„PendingPostå®ä¾‹å­˜å…¥é˜Ÿåˆ—ä¸­</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">queue</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">pendingPost</span><span class="o">);</span>
            <span class="c1">// æ¿€æ´»è¿è¡Œ</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">executorRunning</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">executorRunning</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="c1">// å®ç°äº†Runnableæ¥å£ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ</span>
                <span class="n">eventBus</span><span class="o">.</span><span class="na">getExecutorService</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="c1">// æŠŠæœ¬ç±»çš„å®ä¾‹æ”¾å…¥çº¿ç¨‹æ± ä¹‹åï¼Œç”±çº¿ç¨‹æ± è°ƒåº¦æ‰§è¡Œ</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// å¾ªç¯æ‰§è¡Œï¼Œç›´åˆ°å®ŒæˆPendingPostQueueé˜Ÿåˆ—é‡Œæ‰€æœ‰ä»»åŠ¡</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// ä»PendingPostQueueé˜Ÿåˆ—è·å–PendingPostå®ä¾‹</span>
                    <span class="nc">PendingPost</span> <span class="n">pendingPost</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                    <span class="c1">// è·å–è¶…æ—¶ä¼šå‡ºç°PendingPostå®ä¾‹ä¸ºç©º</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">pendingPost</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                            <span class="c1">// åŠ é”åå†åˆ°é˜Ÿåˆ—è·å–PendingPostå®ä¾‹</span>
                            <span class="n">pendingPost</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
                            <span class="c1">// é˜Ÿåˆ—ä¸­å·²ç»æ²¡æœ‰ä»»åŠ¡ï¼Œé€€å‡ºæ‰§è¡Œ</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">pendingPost</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">executorRunning</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                                <span class="k">return</span><span class="o">;</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="c1">// åœ¨çº¿ç¨‹æ± çš„çº¿ç¨‹ä¸­æ‰§è¡Œäº‹ä»¶æ´¾å‘</span>
                    <span class="n">eventBus</span><span class="o">.</span><span class="na">invokeSubscriber</span><span class="o">(</span><span class="n">pendingPost</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// æœ¬æ–¹æ³•åœ¨çº¿ç¨‹æ± æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«ä¸­æ–­ï¼Œæ•è·InterruptedException</span>
                <span class="n">eventBus</span><span class="o">.</span><span class="na">getLogger</span><span class="o">().</span><span class="na">log</span><span class="o">(</span><span class="nc">Level</span><span class="o">.</span><span class="na">WARNING</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" was interruppted"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// ç»“æŸè¿è¡Œï¼ŒæŠŠexecutorRunningè®¾ç½®ä¸ºfalse</span>
            <span class="n">executorRunning</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="32-pendingpost">3.2 PendingPost</h4>

<p>å†çœ‹çœ‹å­˜æ”¾è®¢é˜…ä¿¡æ¯å’Œäº‹ä»¶ <strong>PendingPost</strong> ç±»çš„å†…éƒ¨æ„é€ ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="nc">PendingPost</span> <span class="o">{</span>
    <span class="c1">// æ‰€æœ‰PendingPostå…±äº«ç›¸åŒArrayList&lt;PendingPost&gt;ç¼“å­˜æ± ï¼Œæœ€å¤§å®¹é‡ä¸º10000</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">PendingPost</span><span class="o">&gt;</span> <span class="n">pendingPostPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">PendingPost</span><span class="o">&gt;();</span>

    <span class="c1">// å°†è¦å¤„ç†çš„äº‹ä»¶</span>
    <span class="nc">Object</span> <span class="n">event</span><span class="o">;</span>
    
    <span class="c1">// æ¥æ”¶äº‹ä»¶çš„è®¢é˜…è€…ä¿¡æ¯</span>
    <span class="nc">Subscription</span> <span class="n">subscription</span><span class="o">;</span>
    
    <span class="c1">// æŒ‡å‘ä¸‹ä¸€ä¸ªPendingPostå®ä¾‹çš„å¼•ç”¨ï¼Œåœ¨PendingPostQueueä¸­ä½¿ç”¨</span>
    <span class="nc">PendingPost</span> <span class="n">next</span><span class="o">;</span>

    <span class="c1">// æ„é€ æ–¹æ³•ï¼Œå¯çŸ¥æ„é€ æ–°å®ä¾‹æ—¶nextä¸ºnull</span>
    <span class="kd">private</span> <span class="nf">PendingPost</span><span class="o">(</span><span class="nc">Object</span> <span class="n">event</span><span class="o">,</span> <span class="nc">Subscription</span> <span class="n">subscription</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">subscription</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="c1">// ä»ç¼“å­˜æ± ä¸­è·å–ç¼“å­˜å®ä¾‹ï¼Œå¹¶æŠŠè®¢é˜…ä¿¡æ¯å’Œäº‹ä»¶æ”¾å…¥å–å¾—çš„å®ä¾‹ä¸­</span>
    <span class="kd">static</span> <span class="nc">PendingPost</span> <span class="nf">obtainPendingPost</span><span class="o">(</span><span class="nc">Subscription</span> <span class="n">subscription</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">pendingPostPool</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">pendingPostPool</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="c1">// ç¼“å­˜æ± éç©º</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// ä»ç¼“å­˜æ± ä¸­è·å–æœ€åä¸€ä¸ªå®ä¾‹</span>
                <span class="nc">PendingPost</span> <span class="n">pendingPost</span> <span class="o">=</span> <span class="n">pendingPostPool</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
                <span class="c1">// æ”¾å…¥é€šçŸ¥äº‹ä»¶</span>
                <span class="n">pendingPost</span><span class="o">.</span><span class="na">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">;</span>
                <span class="c1">// æ”¾å…¥è®¢é˜…ä¿¡æ¯</span>
                <span class="n">pendingPost</span><span class="o">.</span><span class="na">subscription</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">;</span>
                <span class="c1">// åˆå§‹åŒ–nextä¸ºnull</span>
                <span class="n">pendingPost</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">return</span> <span class="n">pendingPost</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// ç¼“å­˜æ± æ²¡æœ‰å·²ç¼“å­˜çš„å®ä¾‹ï¼Œç›´æ¥åˆ›å»ºæ–°å®ä¾‹</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">PendingPost</span><span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="n">subscription</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// PendingPostè´Ÿè½½çš„äº‹ä»¶å·²ç»å‘é€ç»™è®¢é˜…æ–¹æ³•ï¼Œå›æ”¶PendingPoståˆ°ç¼“å­˜æ± </span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">releasePendingPost</span><span class="o">(</span><span class="nc">PendingPost</span> <span class="n">pendingPost</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ç›¸å…³æ•°æ®æˆå‘˜ç½®ç©º</span>
        <span class="n">pendingPost</span><span class="o">.</span><span class="na">event</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">pendingPost</span><span class="o">.</span><span class="na">subscription</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">pendingPost</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">pendingPostPool</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// é™åˆ¶ç¼“å­˜æ± æœ€å¤§å®¹é‡ä¸º10000ï¼Œé¿å…ç¼“å­˜æ± æ— é™æ‰©å®¹</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pendingPostPool</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// ç¼“å­˜å¯¹è±¡æ”¾å…¥ç¼“å­˜é˜Ÿåˆ—ä¸­</span>
                <span class="n">pendingPostPool</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pendingPost</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="33-pendingpostqueue">3.3 PendingPostQueue</h4>

<p><strong>AsyncPoster</strong> å’Œ <strong>BackgroundPoster</strong> æ‹¥æœ‰å„è‡ªçš„ <strong>PendingPostQueue</strong>ï¼Œç”¨äºå­˜æ”¾æ‰€æœ‰å¾…å®Œæˆçš„ä»»åŠ¡ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="nc">PendingPostQueue</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">PendingPost</span> <span class="n">head</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">PendingPost</span> <span class="n">tail</span><span class="o">;</span>

    <span class="c1">// å­˜å…¥PendingPostå®ä¾‹</span>
    <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">enqueue</span><span class="o">(</span><span class="nc">PendingPost</span> <span class="n">pendingPost</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ä¸èƒ½å‘é˜Ÿåˆ—å­˜å…¥ç©ºä»»åŠ¡</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pendingPost</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span><span class="s">"null cannot be enqueued"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// é˜Ÿåˆ—å·²æœ‰å…¶ä»–ä»»åŠ¡ï¼Œæ–°ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—å°¾éƒ¨</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tail</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">tail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">pendingPost</span><span class="o">;</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="n">pendingPost</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">head</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// é˜Ÿåˆ—æ˜¯ç©ºçš„ï¼Œæ–°ä»»åŠ¡ç›´æ¥è¿›é˜Ÿ</span>
            <span class="n">head</span> <span class="o">=</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">pendingPost</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Head present, but no tail"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">notifyAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// åŒæ­¥ä»é˜Ÿåˆ—ä¸­è·å–ä»»ä»»åŠ¡</span>
    <span class="kd">synchronized</span> <span class="nc">PendingPost</span> <span class="nf">poll</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">PendingPost</span> <span class="n">pendingPost</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">head</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">head</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">head</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">tail</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">pendingPost</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// ç­‰å¾…maxMillisToWaitæ¯«ç§’æˆ–è¢«notifyAllï¼Œå†ä»é˜Ÿåˆ—å–ä»»åŠ¡</span>
    <span class="kd">synchronized</span> <span class="nc">PendingPost</span> <span class="nf">poll</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxMillisToWait</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">head</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">wait</span><span class="o">(</span><span class="n">maxMillisToWait</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">poll</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å››handlerposter">å››ã€HandlerPoster</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HandlerPoster</span> <span class="kd">extends</span> <span class="nc">Handler</span> <span class="kd">implements</span> <span class="nc">Poster</span> <span class="o">{</span>
    <span class="c1">// å¤„ç†é˜Ÿåˆ—</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">PendingPostQueue</span> <span class="n">queue</span><span class="o">;</span>
    <span class="c1">// æ‰§è¡Œæ¶ˆæ¯çš„è¶…æ—¶æ—¶é—´</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">maxMillisInsideHandleMessage</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">EventBus</span> <span class="n">eventBus</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">handlerActive</span><span class="o">;</span>

    <span class="c1">// æ„é€ æ–¹æ³•</span>
    <span class="kd">protected</span> <span class="nf">HandlerPoster</span><span class="o">(</span><span class="nc">EventBus</span> <span class="n">eventBus</span><span class="o">,</span> <span class="nc">Looper</span> <span class="n">looper</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxMillisInsideHandleMessage</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">looper</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">eventBus</span> <span class="o">=</span> <span class="n">eventBus</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">maxMillisInsideHandleMessage</span> <span class="o">=</span> <span class="n">maxMillisInsideHandleMessage</span><span class="o">;</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PendingPostQueue</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="c1">// å­˜å…¥PendingPostå®ä¾‹</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">enqueue</span><span class="o">(</span><span class="nc">Subscription</span> <span class="n">subscription</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// åˆ›å»ºPendingPostå®ä¾‹ï¼Œå­˜å…¥è®¢é˜…è®°å½•å’Œäº‹ä»¶</span>
        <span class="nc">PendingPost</span> <span class="n">pendingPost</span> <span class="o">=</span> <span class="nc">PendingPost</span><span class="o">.</span><span class="na">obtainPendingPost</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// PendingPostå®ä¾‹æ”¾å…¥é˜Ÿåˆ—ç­‰å¾…æ´¾å‘</span>
            <span class="n">queue</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">pendingPost</span><span class="o">);</span>
            <span class="c1">// handleræ²¡åœ¨è¿è¡Œ</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">handlerActive</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// å‘Handlerå‘é€ä¸€ä¸ªMessage</span>
                <span class="n">handlerActive</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="c1">// å‘é€Messageå¤±è´¥</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">sendMessage</span><span class="o">(</span><span class="n">obtainMessage</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">EventBusException</span><span class="o">(</span><span class="s">"Could not send handler message"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">rescheduled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">started</span> <span class="o">=</span> <span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡</span>
                <span class="nc">PendingPost</span> <span class="n">pendingPost</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">pendingPost</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// åœ¨åŒæ­¥ä¸‹å†æ¬¡æ£€æŸ¥</span>
                        <span class="n">pendingPost</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
                        <span class="c1">// é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">pendingPost</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">handlerActive</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                            <span class="k">return</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="c1">// å·²è·å¾—ä»»åŠ¡ï¼ŒæŠŠä»»åŠ¡çš„äº‹ä»¶å‘ç»™å¯¹åº”è®¢é˜…æ–¹æ³•</span>
                <span class="n">eventBus</span><span class="o">.</span><span class="na">invokeSubscriber</span><span class="o">(</span><span class="n">pendingPost</span><span class="o">);</span>
                <span class="c1">// è®¡ç®—æ¥æ”¶è€…æ–¹æ³•å¤„ç†äº‹ä»¶è€—è´¹çš„æ—¶é•¿</span>
                <span class="kt">long</span> <span class="n">timeInMethod</span> <span class="o">=</span> <span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">started</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">timeInMethod</span> <span class="o">&gt;=</span> <span class="n">maxMillisInsideHandleMessage</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">sendMessage</span><span class="o">(</span><span class="n">obtainMessage</span><span class="o">()))</span> <span class="o">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">EventBusException</span><span class="o">(</span><span class="s">"Could not send handler message"</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">rescheduled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">handlerActive</span> <span class="o">=</span> <span class="n">rescheduled</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="äº”mainthreadsupport">äº”ã€MainThreadSupport</h2>

<p>åœ¨ä¸»çº¿ç¨‹æŠ•é€’äº‹ä»¶ï¼Œåœ¨Androidä¸­æ˜¯UIçº¿ç¨‹ã€‚å¦‚æœåœ¨å…¶ä»–ç³»ç»Ÿä¸­ä½¿ç”¨ï¼Œå¯ä»¥è‡ªè¡ŒæŒ‡å®šç‰¹å®šçº¿ç¨‹ä¸ºâ€ä¸»çº¿ç¨‹â€ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MainThreadSupport</span> <span class="o">{</span>

    <span class="kt">boolean</span> <span class="nf">isMainThread</span><span class="o">();</span>

    <span class="nc">Poster</span> <span class="nf">createPoster</span><span class="o">(</span><span class="nc">EventBus</span> <span class="n">eventBus</span><span class="o">);</span>

    <span class="c1">// å†…éƒ¨ç±»å®ç°å¤–éƒ¨æ¥å£</span>
    <span class="kd">class</span> <span class="nc">AndroidHandlerMainThreadSupport</span> <span class="kd">implements</span> <span class="nc">MainThreadSupport</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Looper</span> <span class="n">looper</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">AndroidHandlerMainThreadSupport</span><span class="o">(</span><span class="nc">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">looper</span> <span class="o">=</span> <span class="n">looper</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isMainThread</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">looper</span> <span class="o">==</span> <span class="nc">Looper</span><span class="o">.</span><span class="na">myLooper</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Poster</span> <span class="nf">createPoster</span><span class="o">(</span><span class="nc">EventBus</span> <span class="n">eventBus</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">HandlerPoster</span><span class="o">(</span><span class="n">eventBus</span><span class="o">,</span> <span class="n">looper</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

:ET