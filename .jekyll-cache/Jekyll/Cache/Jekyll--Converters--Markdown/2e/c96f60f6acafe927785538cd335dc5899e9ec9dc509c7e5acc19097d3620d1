I"½;<p>æ–‡ç« åˆ—è¡¨ï¼š</p>
<ul>
  <li><a href="/2018/11/15/EventBus_1_Register/">EventBusæºç å‰–æ(1) â€“ è®¢é˜…æ³¨å†Œä¸æ³¨é”€</a></li>
  <li><a href="/2018/12/01/EventBus_2_EventBusBuilder/">EventBusæºç å‰–æ(2) â€“ EventBusBuilder</a></li>
  <li><a href="/2018/12/03/EventBus_3_ThreadMode/">EventBusæºç å‰–æ(3) â€“ çº¿ç¨‹æ¨¡å¼</a></li>
  <li><a href="/2018/12/06/EventBus_4_Subscription/">EventBusæºç å‰–æ(4) â€“ è®¢é˜…è®°å½•</a></li>
  <li><a href="/2018/12/10/EventBus_5_Poster/">EventBusæºç å‰–æ(5) â€“ Poster</a></li>
</ul>

<h2 id="ä¸€ç®€ä»‹">ä¸€ã€ç®€ä»‹</h2>

<p><strong>EventBus</strong> æ¶ˆæ¯æ”¯æŒé€šè¿‡ä¸åŒçº¿ç¨‹æ¨¡å¼å‘é€å¹¶è°ƒèµ·ç›®æ ‡æ–¹æ³•ï¼Œä»¥æ»¡è¶³ <strong>Android</strong> ä¸åŒåº”ç”¨åœºæ™¯ã€‚é€šè¿‡è®¢é˜…è€…çš„<a href="/2018/11/14/EventBus_1_Register/#21-è®¢é˜…è€…">è®¢é˜…æ–¹æ³•</a>å¯çŸ¥ï¼Œçº¿ç¨‹æ¨¡å¼é€šè¿‡æ³¨è§£å‚æ•°è¿›è¡Œé…ç½®ã€‚</p>

<h2 id="äºŒç”¨æ³•">äºŒã€ç”¨æ³•</h2>

<p>æ³¨å†Œç±»å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ¥æ”¶äº‹ä»¶çš„æ–¹æ³•ï¼Œå¦‚æœä¸æ»¡è¶³æ­¤æ¡ä»¶ï¼Œè®¢é˜…ç±»æ³¨å†Œåˆ° <strong>EventBus</strong> æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚è‹¥æ²¡æœ‰è®¾ç½® <strong>threadMode</strong> ï¼Œè®¢é˜…æ–¹æ³•é»˜è®¤åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nd">@Subscribe</span><span class="o">(</span><span class="n">threadMode</span> <span class="o">=</span> <span class="nc">ThreadMode</span><span class="o">.</span><span class="na">MAIN</span><span class="o">,</span> <span class="n">sticky</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="o">)</span>
<span class="n">fun</span> <span class="nf">onEventReceived</span><span class="o">(</span><span class="nl">event:</span> <span class="nc">UserEvent</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">val</span> <span class="n">name</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">name</span>
    <span class="n">val</span> <span class="n">age</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">age</span>
    <span class="nc">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Event received, Name: $name, Age: $age."</span><span class="o">)</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸‰ç±»ä»‹ç»">ä¸‰ã€ç±»ä»‹ç»</h2>

<p><strong>Subscribe</strong> æ¥å£æ˜¯ç”¨äºä¿®é¥°è®¢é˜…æ–¹æ³•çš„æ³¨è§£ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nd">@Documented</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">})</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">Subscribe</span> <span class="o">{</span>
    <span class="nc">ThreadMode</span> <span class="nf">threadMode</span><span class="o">()</span> <span class="k">default</span> <span class="nc">ThreadMode</span><span class="o">.</span><span class="na">POSTING</span><span class="o">;</span>
    <span class="o">....</span>
    <span class="o">....</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>EventBus</strong> æ”¯æŒçš„çº¿ç¨‹æ¨¡å¼éƒ½ä¿å­˜åœ¨æšä¸¾ç±»ä¸­ã€‚æ¯ä¸ªè®¢é˜…è€…æ–¹æ³•å«æœ‰é»˜è®¤çº¿ç¨‹æ¨¡å¼ï¼Œè¯¥æ¨¡å¼å†³å®šå¦‚ä½•è°ƒç”¨è®¢é˜…è€…æ–¹æ³•ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">enum</span> <span class="nc">ThreadMode</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å››çº¿ç¨‹æ¨¡å¼">å››ã€çº¿ç¨‹æ¨¡å¼</h2>

<p><strong>ThreadMode</strong> æšä¸¾ç±»åŒ…å«5ç§çº¿ç¨‹æ¨¡å¼ï¼š</p>

<p><img src="/img/android/EventBus/EventBus_ThreadMode.png" alt="EventBus-Publish-Subscribe" /></p>

<h4 id="41-posting">4.1 POSTING</h4>

<p>è®¢é˜…æ–¹æ³•åœ¨å‘å¸ƒçº¿ç¨‹ä¸Šè°ƒèµ·ï¼Œè¿™æ˜¯ <strong>EventBus</strong> çš„é»˜è®¤çº¿ç¨‹æ¨¡å¼ã€‚å› ä¸ºèƒ½å®Œå…¨é¿å…çº¿ç¨‹åˆ‡æ¢ï¼Œæ„å‘³ç€æ­¤çº¿ç¨‹æ¨¡å¼çš„äº‹ä»¶åˆ†å‘èƒ½å‡å°‘æ€§èƒ½å¼€é”€ã€‚æ‰€ä»¥å¯åœ¨çŸ­æ—¶é—´ã€ä¸»çº¿ç¨‹å®Œæˆçš„ä»»åŠ¡ï¼Œæœ¬æ¨¡å¼æ˜¯é¦–è¦æ¨èçš„ã€‚å°±æ˜¯è¯´æ­¤æ¨¡å¼å¤„ç†äº‹ä»¶æ—¶ï¼Œæ–¹æ³•éœ€è¦è¿…é€Ÿæ‰§è¡Œå®Œæ¯•ï¼Œå¹¶è¿”å›æ–¹æ³•é¿å…é˜»å¡(ä¸»çº¿ç¨‹)å‘å¸ƒçº¿ç¨‹ã€‚</p>

<h4 id="42-main">4.2 MAIN</h4>

<p>å¦‚æœ <strong>EventBus</strong> åœ¨ <strong>Android</strong> ä¸­ä½¿ç”¨ï¼Œè®¢é˜…è€…ä¼šåœ¨ä¸»çº¿ç¨‹ä¸­è¿›è¡Œè°ƒç”¨ã€‚å¦‚æœæ¶ˆæ¯å‘å¸ƒçº¿ç¨‹å°±æ˜¯ä¸»çº¿ç¨‹ï¼Œåˆ™è®¢é˜…æ–¹æ³•ç›´æ¥è°ƒç”¨ï¼Œå¹¶é˜»å¡å‘å¸ƒçº¿ç¨‹ã€‚å¦åˆ™ï¼Œäº‹ä»¶åœ¨æ¶ˆæ¯é˜Ÿåˆ—ç­‰å¾…ä¸»çº¿ç¨‹(éé˜»å¡æ€§çš„)åˆ†æ´¾ã€‚</p>

<p>ç”±äºæ¥æ”¶è€…æ–¹æ³•æ‰§è¡Œåœ¨ä¸»çº¿ç¨‹ä¸Šï¼Œæ‰€ä»¥æ–¹æ³•é€»è¾‘åº”è½»å·§ï¼Œæˆ–åœ¨å†…éƒ¨å¼€å¯å­çº¿ç¨‹æ‰§è¡Œé‡é‡çº§æ“ä½œï¼Œä»¥æ­¤é¿å…é˜»å¡ä¸»çº¿ç¨‹è¿è¡Œã€‚æ¨ç†å¯çŸ¥ï¼Œå¦‚æœè®¢é˜…æ–¹æ³•åç»­è¿˜æœ‰æ›´å¤šäº‹ä»¶éœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸Šå‘å‡ºï¼Œé‚£ä¹ˆè¿™äº›äº‹ä»¶ä¹Ÿä¼šå—åˆ°è¯¥æ¬¡é˜»å¡çš„å½±å“ã€‚</p>

<p>å¦‚æœ <strong>EventBus</strong> æ‰€åœ¨ç¯å¢ƒä¸æ˜¯ <strong>Android</strong> ï¼Œåˆ™æœ¬æ¨¡å¼çš„æ‰§è¡Œè¡Œä¸ºå’Œ <strong>POSTING</strong> æ¨¡å¼ç›¸åŒã€‚</p>

<h4 id="43-main_ordered">4.3 MAIN_ORDERED</h4>

<p>åœ¨ <strong>Android</strong> ä¸­è®¢é˜…è€…æ–¹æ³•ä¹Ÿæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è¢«è°ƒç”¨ã€‚ä½†å’Œ <strong>MAIN</strong> æ¨¡å¼ä¸åŒçš„ï¼Œæ˜¯æœ¬æ¨¡å¼çš„æ¶ˆæ¯è¿›å…¥å±äºä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œï¼Œè€Œä¸æ˜¯é˜»å¡ä¸»çº¿ç¨‹ç›´æ¥è¿è¡Œã€‚</p>

<h4 id="44-background">4.4 BACKGROUND</h4>

<p>åœ¨ <strong>Android</strong> ä¸­ï¼Œæ­¤æ¨¡å¼çš„è®¢é˜…è€…ä¼šåœ¨åå°çº¿ç¨‹è°ƒç”¨ã€‚å¦‚æœå‘å¸ƒæ¶ˆæ¯çš„çº¿ç¨‹ä¸æ˜¯ä¸»çº¿ç¨‹ï¼Œåˆ™è®¢é˜…è€…æ–¹æ³•ç›´æ¥åœ¨å‘å¸ƒçº¿ç¨‹ä¸Šè°ƒç”¨ã€‚å¦‚æœæ¶ˆæ¯å‘å¸ƒçº¿ç¨‹æ˜¯ä¸»çº¿ç¨‹ï¼Œ<strong>EventBus</strong> ä¼šä½¿ç”¨å•ä¸ªåå°çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹ä¼šé¡ºåºåˆ†æ´¾æ‰€æœ‰äº‹ä»¶ã€‚å¦‚æœè®¢é˜…è€…ä½¿ç”¨æ­¤ç§æ¨¡å¼ï¼Œå°±åº”è¯¥å¿«é€Ÿä»æ–¹æ³•ä¸­è¿”å›ï¼Œé¿å…é˜»å¡è¿™ä¸ªå•ä¸€åå°çº¿ç¨‹çš„è¿è¡Œã€‚åœ¨é <strong>Android</strong> ç›´æ¥ä½¿ç”¨ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œä¸åŒºåˆ†ä¸»çº¿ç¨‹ã€‚</p>

<h4 id="45-async">4.5 ASYNC</h4>

<p>è®¢é˜…è€…ä¼šåœ¨åˆ†ç¦»çš„çº¿ç¨‹ä¸Šè°ƒç”¨ã€‚æ­¤çº¿ç¨‹ç‹¬ç«‹äºäº‹ä»¶å‘å¸ƒçº¿ç¨‹å’Œä¸»çº¿ç¨‹ã€‚ä½¿ç”¨è¿™ç§æ¨¡å¼æ—¶ï¼Œå‘é€äº‹ä»¶ä¸ä¼šç­‰å¾…è®¢é˜…è€…æ–¹æ³•ã€‚å¯ä½¿ç”¨è¿™ä¸ªæ¨¡å¼å¤„ç†è®¢é˜…è€…æ–¹æ³•çš„è€—æ—¶äº‹ä»¶ï¼Œä¾‹å¦‚ï¼šè¿›è¡Œç½‘ç»œè®¿é—®ã€‚ä¸ºäº†é¿å…åŒæ—¶è§¦å‘å¤§é‡ã€é•¿æœŸè¿è¡Œçš„è®¢é˜…è€…æ–¹æ³•ï¼Œ<strong>EventBus</strong> ä½¿ç”¨äº†çº¿ç¨‹æ± ï¼Œä»å·²å®Œæˆçš„å¼‚æ­¥è®¢é˜…è€…é€šçŸ¥å¤ç”¨çº¿ç¨‹ã€‚</p>

<h2 id="å®ç°">å®ç°</h2>

<p>ä¸Šæ–‡æåˆ°å®ç°æ–¹æ³• <a href="/2018/11/14/EventBus_1_Register/#44-posttosubscription">EventBus.postToSubscription()</a> çš„é€»è¾‘å°±ä¸éš¾ç†è§£äº†ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">postToSubscription</span><span class="o">(</span><span class="nc">Subscription</span> <span class="n">subscription</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">event</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isMainThread</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// è·å–è®¢é˜…è€…æ–¹æ³•æŒ‡å®šçº¿ç¨‹çš„ç±»åˆ«</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">subscription</span><span class="o">.</span><span class="na">subscriberMethod</span><span class="o">.</span><span class="na">threadMode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nl">POSTING:</span>
            <span class="n">invokeSubscriber</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>

        <span class="k">case</span> <span class="nl">MAIN:</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isMainThread</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// å¤„äºä¸»çº¿ç¨‹å°±ç›´æ¥è§¦å‘è®¢é˜…è€…</span>
                <span class="n">invokeSubscriber</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// å¤„åœ¨å…¶ä»–çº¿ç¨‹ï¼Œå‘ä¸»çº¿ç¨‹Handlerå‘é€æ¶ˆæ¯</span>
                <span class="n">mainThreadPoster</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>

        <span class="k">case</span> <span class="nl">MAIN_ORDERED:</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mainThreadPoster</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mainThreadPoster</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// temporary: technically not correct as poster not decoupled from subscriber</span>
                <span class="n">invokeSubscriber</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>

        <span class="k">case</span> <span class="nl">BACKGROUND:</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isMainThread</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">backgroundPoster</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">invokeSubscriber</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>

        <span class="k">case</span> <span class="nl">ASYNC:</span>
            <span class="n">asyncPoster</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>

        <span class="c1">// ä¼ å…¥æœªçŸ¥threadModeå¼•èµ·å¼‚å¸¸</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Unknown thread mode: "</span> <span class="o">+</span> <span class="n">subscription</span><span class="o">.</span><span class="na">subscriberMethod</span><span class="o">.</span><span class="na">threadMode</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨æ¶ˆæ¯å‘é€è€…æ‰€åœ¨çº¿ç¨‹ä¸Šè°ƒç”¨ç›®æ ‡æ–¹æ³•ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">invokeSubscriber</span><span class="o">(</span><span class="nc">Subscription</span> <span class="n">subscription</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// subscription.subscriberï¼šè®¢é˜…æ–¹æ³•æ‰€åœ¨å®ä¾‹</span>
        <span class="c1">// eventï¼šè°ƒç”¨æ—¶ä¼ é€’ç»™æ–¹æ³•çš„å‚æ•°ï¼Œå³æ–¹æ³•æ¥æ”¶çš„æ¶ˆæ¯</span>
        <span class="n">subscription</span><span class="o">.</span><span class="na">subscriberMethod</span><span class="o">.</span><span class="na">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">subscription</span><span class="o">.</span><span class="na">subscriber</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// æ•è·è®¢é˜…è€…æ–¹æ³•è¿è¡Œæ—¶å¼‚å¸¸ï¼Œé¿å…EventBuså´©æºƒ</span>
        <span class="n">handleSubscriberException</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Unexpected exception"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
:ET